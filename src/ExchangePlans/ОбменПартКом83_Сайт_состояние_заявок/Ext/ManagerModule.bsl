#Область ВыгрузкаДанных
Функция ПолучитьМетаданные()
	Возврат Метаданные.ПланыОбмена.ОбменПартКом83_Сайт_состояние_заявок;
КонецФункции

Функция URIПространстваИмен() 
	
	Возврат "http://ws-02.part-kom.ru/partkom83/hs/SiteExchange/XMLSchema";
	
КонецФункции

Функция ТипПоОбъектуМетаданных(вхОбъектМетаданных) Экспорт
	
	Результат = Неопределено;
	лИмяТипа = ИмяТипаПоОбъектуМетаданных(вхОбъектМетаданных);
	Если НЕ ПустаяСтрока(лИмяТипа) тогда
		Результат = ФабрикаXDTO.Тип(URIПространстваИмен(), лИмяТипа);
	КонецЕсли;
	Возврат Результат;
	
КонецФункции

Функция ИмяТипаПоОбъектуМетаданных(вхОбъектМетаданных) 
	Возврат	ОбщегоНазначения.ИмяБазовогоТипаПоОбъектуМетаданных(вхОбъектМетаданных) + "." + вхОбъектМетаданных.Имя;
КонецФункции

Функция ВыгрузитьСообщениеОбмена_ИсторияЗаявок(ИдентификаторУзлаОбмена, НомерПринятого) Экспорт
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_ВыгрузитьСообщениеОбмена_ИсторияЗаявок";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		АлгоритмыЗначениеВозврата = Неопределено;		
		Выполнить(лЗамена);		
		Возврат АлгоритмыЗначениеВозврата;		
	КонецЕсли;	
	///////////////////////////////////////////////////////////////////////////
	
	//Семенов И.П. 31.01.2019 XX-1768(
	ОбменДаннымиКлиентСервер.НачатьЗаписьВИсториюОбменовПоОбъектам();
	//)Семенов И.П.
	
	Если Константы.ВключитьРегистрациюDataExchageModule.Получить() Тогда
		ЗаписьЖурналаРегистрации("Обмен данными.Выгрузка." + Метаданные.ПланыОбмена.ОбменПартКом83_Сайт_состояние_заявок.Синоним,
				УровеньЖурналаРегистрации.Ошибка,,,"Номер сообщения: " + НомерПринятого);
	КонецЕсли;
	
	Узел1С = ОбменДаннымиКлиентСервер.ПолучитьВходящийУзелОбмена(ПолучитьМетаданные(), ИдентификаторУзлаОбмена);
	Если НЕ ЗначениеЗаполнено(Узел1С) тогда
		//Семенов И.П. 31.01.2019 XX-1768(
		ОбменДаннымиКлиентСервер.ЗафиксироватьСообщениеВИсторииОбмена(0,ПустаяСсылка(),"",Истина,Истина,"Неправильный параметр номер 1(Узел 1С)");
		//)Семенов И.П.
		ВызватьИсключение "[ВыгрузитьСообщениеОбмена_ИсторияЗаявок]: неправильный параметр номер 1(Узел 1С)";
	КонецЕсли;
	
	УзелСайт = ОбменДаннымиКлиентСервер.ПолучитьИсходящийУзелОбмена(ПолучитьМетаданные(), ИдентификаторУзлаОбмена);
	Если НЕ ЗначениеЗаполнено(УзелСайт) тогда
		//Семенов И.П. 31.01.2019 XX-1768(
		ОбменДаннымиКлиентСервер.ЗафиксироватьСообщениеВИсторииОбмена(0,ПустаяСсылка(),"",Истина,Истина,"Неправильный параметр номер 1.(Узел Сайт)");
		//)Семенов И.П.
		ВызватьИсключение "[ВыгрузитьСообщениеОбмена_ИсторияЗаявок]: неправильный параметр номер 1.(Узел Сайт)";
	КонецЕсли;
	
	НомерОтправленного = УзелСайт.НомерПринятого;
	Если НомерПринятого > НомерОтправленного Тогда
		//ВызватьИсключение "[ВыгрузитьСообщениеОбмена_ИсторияЗаявок]: Сообщение №"+ НомерПринятого + " ещё не отправлялось(последнее №" + НомерОтправленного + ")";
		//Иногда разбегаются счетчики, номер принятого на 1 превышает номер отправленного, обычно ночью такое//
		ТекстОшибки = "Расхождение счетчиков, ReceivedNo:" + НомерПринятого + ", НомерОтправленного:" + НомерОтправленного;
		ЗаписьЖурналаРегистрации("Обмен данными.Выгрузка.ОбменПартКом83_Сайт_состояние_заявок", УровеньЖурналаРегистрации.Ошибка,,,ТекстОшибки);
		НомерСообщения = НомерПринятого + 1;
		НомерПринятого = НомерОтправленного;
	Иначе
		НомерСообщения = НомерОтправленного + 1;
	КонецЕсли;
	
	ФиксацияПринятогоСообщения(УзелСайт, НомерПринятого);
	
	ТипОбъекты = ФабрикаXDTO.Тип(URIПространстваИмен(), "Объекты");
	ТипСообщениеОбмена = ФабрикаXDTO.Тип(URIПространстваИмен(), "СообщениеОбмена");
	
	Узел = УзелСайт.ПолучитьОбъект();
	Узел.НомерПринятого = НомерСообщения;
	Узел.Записать();
	
	СообщениеОбмена = ФабрикаXDTO.Создать(ТипСообщениеОбмена);
	СообщениеОбмена.ПланОбмена = "orders_nn";
	СообщениеОбмена.Отправитель = ЭтотУзел().ИдентификаторУзла;
	СообщениеОбмена.Получатель = ИдентификаторУзлаОбмена;
	СообщениеОбмена.НомерСообщения = НомерСообщения;
	СообщениеОбмена.НомерПринятого = Узел1С.НомерОтправленного;
	
	Объекты = ФабрикаXDTO.Создать(ТипОбъекты);
	СписокОбъектов = Объекты.ПолучитьСписок("Объект");
	
	РегистрыСведений._ИсторияСтрокЗаявок.ДобавитьДанныеИсторииСтрокЗаявок(СписокОбъектов, НомерСообщения);
	ДобавитьДанныеПодтверждений(СписокОбъектов, НомерСообщения);
	
	СообщениеОбмена.Объекты = Объекты;
	
	ЗаписьХМЛ = Новый ЗаписьXML;
	ЗаписьХМЛ.УстановитьСтроку("utf-8");
	ЗаписьХМЛ.ЗаписатьОбъявлениеXML();
	ФабрикаXDTO.ЗаписатьXML(ЗаписьХМЛ, СообщениеОбмена);
	
	//Семенов И.П. 31.01.2019 XX-1768(
	//Возврат ЗаписьХМЛ.Закрыть();
	ТекстСообщения = ЗаписьХМЛ.Закрыть();
	ОбменДаннымиКлиентСервер.ЗафиксироватьСообщениеВИсторииОбмена(НомерСообщения, УзелСайт, ТекстСообщения, Истина);
	Возврат ТекстСообщения;
	//)Семенов И.П.
	
КонецФункции

Процедура ФиксацияПринятогоСообщения(ИсходящийУзел, НомерПринятогоСообщения)
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_ФиксацияПринятогоСообщения";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		Выполнить(лЗамена);
		Возврат;
	КонецЕсли;
	///////////////////////////////////////////////////////////////////////////
	
	//Зафиксируем принятые сообщения о логе загрузки
	Запрос = Новый Запрос("ВЫБРАТЬ
	                      |	ЛогОбменовССайтом.ПланОбмена,
	                      |	ЛогОбменовССайтом.Ссылка,
	                      |	ЛогОбменовССайтом.SiteID
	                      |ИЗ
	                      |	РегистрСведений.ЛогОбменовССайтом КАК ЛогОбменовССайтом
	                      |ГДЕ
	                      |	ЛогОбменовССайтом.ПланОбмена В (ЗНАЧЕНИЕ(Перечисление.ПланыОбменаССайтом.ПодтвержениеПолученияЗаявок), ЗНАЧЕНИЕ(Перечисление.ПланыОбменаССайтом.ПодтверждениеОтменыЗаявок))
	                      |	И НЕ ЛогОбменовССайтом.СайтСообщениеОбработал
	                      |	И ЛогОбменовССайтом.НомерСообщенияИсходящий МЕЖДУ 1 И &НомерПринятогоСообщения");
	Запрос.УстановитьПараметр("НомерПринятогоСообщения", НомерПринятогоСообщения);
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		Запись = РегистрыСведений.ЛогОбменовССайтом.СоздатьМенеджерЗаписи();
		ЗаполнитьЗначенияСвойств(Запись, Выборка, "Ссылка,ПланОбмена,SiteID");
		Запись.Прочитать();
		Запись.ДатаОбработкиСайтом = ТекущаяДата();
		Запись.СайтСообщениеОбработал = Истина;
		Запись.Записать();
	КонецЦикла;
	
	РегистрыСведений._ИсторияСтрокЗаявок.ФиксацияПринятогоСообщения(НомерПринятогоСообщения);
	
КонецПроцедуры
Процедура ДобавитьДанныеПодтверждений(СписокОбъектов, НомерСообщения)
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_ДобавитьДанныеПодтверждений";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		Выполнить(лЗамена);
		Возврат;
	КонецЕсли;
	///////////////////////////////////////////////////////////////////////////
	
	КоличествоОбъектов = РегистрыСведений.НастройкиПодсистем.ЗначениеПараметра("Обмен (Общее)","Количество объектов в обмене", 1000);
	ПодтвержениеПолученияЗаявок = ФабрикаXDTO.Тип(URIПространстваИмен(), "Документы.ЗаявкаПокупателя.Загрузка");
	ПодтверждениеОтменыЗаявок = ФабрикаXDTO.Тип(URIПространстваИмен(), "Документы.ЗаявкаПокупателяОтмена.Загрузка");
	Запрос = Новый Запрос("ВЫБРАТЬ ПЕРВЫЕ 1234
	                      |	ЛогОбменовССайтом.Ссылка,
	                      |	ЛогОбменовССайтом.ПланОбмена,
	                      |	ЛогОбменовССайтом.SiteID,
	                      |	ЛогОбменовССайтом.Ошибка,
	                      |	ЛогОбменовССайтом.ТекстОшибки
	                      |ИЗ
	                      |	РегистрСведений.ЛогОбменовССайтом КАК ЛогОбменовССайтом
	                      |ГДЕ
	                      |	ЛогОбменовССайтом.ПланОбмена В (ЗНАЧЕНИЕ(Перечисление.ПланыОбменаССайтом.ПодтвержениеПолученияЗаявок), ЗНАЧЕНИЕ(Перечисление.ПланыОбменаССайтом.ПодтверждениеОтменыЗаявок))
	                      |	И НЕ ЛогОбменовССайтом.СайтСообщениеОбработал");
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "1234", Формат(КоличествоОбъектов, "ЧГ="));
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		
		ТипОбъектаXDTO = ?(Выборка.ПланОбмена = Перечисления.ПланыОбменаССайтом.ПодтвержениеПолученияЗаявок, ПодтвержениеПолученияЗаявок, ПодтверждениеОтменыЗаявок);
		
		ОбъектXDTO = ФабрикаXDTO.Создать(ТипОбъектаXDTO);
		ЗаполнитьЗначенияСвойств(ОбъектXDTO, Выборка,, "Ссылка");
		ОбъектXDTO.Ссылка = Выборка.Ссылка;
		Если Выборка.ПланОбмена = Перечисления.ПланыОбменаССайтом.ПодтверждениеОтменыЗаявок Тогда
			ОбъектXDTO.IDSite = Выборка.SiteID;
		КонецЕсли;
		
		//Семенов И.П. 31.01.2019 XX-1768(
		УИДСсылки = Новый УникальныйИдентификатор(Выборка.Ссылка);
		СсылкаНаОбъект = Документы.ЗаявкаПокупателя.ПолучитьСсылку(УИДСсылки);
		ОбменДаннымиКлиентСервер.ДобавитьСтрокуИсторииПоОбъекту(СсылкаНаОбъект, ОбъектXDTO);
		//)Семенов И.П.
		
		СписокОбъектов.Добавить(ОбъектXDTO);
		
		Запись = РегистрыСведений.ЛогОбменовССайтом.СоздатьМенеджерЗаписи();
		ЗаполнитьЗначенияСвойств(Запись, Выборка, "Ссылка,ПланОбмена,SiteID");
		Запись.Прочитать();
		Запись.НомерСообщенияИсходящий = НомерСообщения;
		Запись.Записать();
	КонецЦикла;
	
КонецПроцедуры
#КонецОбласти

#Область ЗагрузкаДанных
Функция ОбработатьПакетЗаявокССайта(СписокОбъектовXDTO, URI, НомерСообщения, Экспресс = Ложь) Экспорт
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_ОбработатьПакетЗаявокССайта";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		АлгоритмыЗначениеВозврата = Неопределено;		
		Выполнить(лЗамена);		
		Возврат АлгоритмыЗначениеВозврата;		
	КонецЕсли;	
	///////////////////////////////////////////////////////////////////////////
	
	МассивЗаявок = Новый Массив;
	Для Каждого ОбъектXDTO Из СписокОбъектовXDTO цикл
		Если ОбъектXDTO.Тип() = ФабрикаXDTO.Тип(URI, "Документы.ЗаявкаПокупателя") Тогда
			СтруктураДокумента = СтруктураДокументаЗаявкаПокупателя(ОбъектXDTO, НомерСообщения);
			КонтрольЗаполненияДокумента(СтруктураДокумента);
			ЗаписатьДокументЗаявки(СтруктураДокумента, МассивЗаявок);
			СформироватьСамовывозПоЗаявке(СтруктураДокумента);
			ЗаписатьЛогЗагрузкиДокумента(СтруктураДокумента, НомерСообщения, Экспресс);
			//Семенов И.П. 28.01.2019 XX-1768(	
			ОбменДаннымиКлиентСервер.ДобавитьСтрокуИсторииПоОбъекту(СтруктураДокумента.СсылкаНаДокумент, ОбъектXDTO, ,СтруктураДокумента.Отказ,СтруктураДокумента.ТекстОшибки);
			//)Семенов И.П.
		ИначеЕсли ОбъектXDTO.Тип() = ФабрикаXDTO.Тип(URI, "Документы.ЗаявкаПокупателяОтмена") Тогда
			СтруктураОбъекта = СтруктураОтменыЗаявки(ОбъектXDTO);
			КонтрольВозможностиОтменыЗаявки(СтруктураОбъекта);
			ОтменитьСтрокуЗаявки(СтруктураОбъекта);
			ЗаписатьЛогОтменыЗаявки(СтруктураОбъекта, НомерСообщения, Экспресс);
			//Семенов И.П. 31.01.2019 XX-1768(
			СсылкаНаДокумент = ?(СтруктураОбъекта.Свойство("СсылкаНаДокумент"),СтруктураОбъекта.СсылкаНаДокумент,СтруктураОбъекта.ИсходнаяЗаявка);
			ОбменДаннымиКлиентСервер.ДобавитьСтрокуИсторииПоОбъекту(СсылкаНаДокумент, ОбъектXDTO, ,СтруктураОбъекта.Отказ,СтруктураОбъекта.ТекстОшибки);
			//)Семенов И.П.
		КонецЕсли;
	КонецЦикла;
	DataExchangeModule.ОтметитьОтправкуОбъектов(МассивЗаявок, Перечисления.ВидыОбменов.ОбменСайт_1С_Заявки, НомерСообщения);
			
КонецФункции

// 07.03.19 Строганов Роман > 
Функция ОбработатьОбъектЗаявкиССайта(ДанныеОбъекта, НомерСообщения, Экспресс = Ложь, СтруктураОтчета) Экспорт
	
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_ОбработатьОбъектЗаявкиССайта";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		АлгоритмыЗначениеВозврата = Неопределено;
		Выполнить(лЗамена);
		Возврат АлгоритмыЗначениеВозврата;
	КонецЕсли;
	///////////////////////////////////////////////////////////////////////////
	
	СтруктураДанныхСайта = ЗначениеИзСтрокиВнутр(ДанныеОбъекта);
	
	МассивЗаявок = Новый Массив;
	
	Если Не СтруктураДанныхСайта.items.Количество() Тогда 
		Возврат Неопределено; 
	КонецЕсли;
	
	СтруктураДокумента = СтруктураДокументаЗаявкаПокупателя(СтруктураДанныхСайта, НомерСообщения);
	КонтрольЗаполненияДокумента(СтруктураДокумента);
	ЗаписатьДокументЗаявки(СтруктураДокумента, МассивЗаявок, СтруктураОтчета);
	СформироватьСамовывозПоЗаявке(СтруктураДокумента);
	ЗаписатьЛогЗагрузкиДокумента(СтруктураДокумента, НомерСообщения, Экспресс);
	//ОбменДаннымиКлиентСервер.ДобавитьСтрокуИсторииПоОбъекту(СтруктураДокумента.СсылкаНаДокумент, ДанныеОбъекта, ,СтруктураДокумента.Отказ,СтруктураДокумента.ТекстОшибки);
	// 12.03.19 Строганов Роман <
	
	DataExchangeModule.ОтметитьОтправкуОбъектов(МассивЗаявок, Перечисления.ВидыОбменов.ОбменСайт_1С_Заявки, НомерСообщения);;
	
КонецФункции
// 07.03.19 Строганов Роман <

// 11.03.19 Строганов Роман > 
Функция ОбработатьОбъектОтменыЗаявкиССайта(ДанныеОбъекта, НомерСообщения, Экспресс = Ложь, СтруктураОтчета) Экспорт
	
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_ОбработатьОбъектОтменыЗаявкиССайта";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		АлгоритмыЗначениеВозврата = Неопределено;
		Выполнить(лЗамена);
		Возврат АлгоритмыЗначениеВозврата;
	КонецЕсли;
	///////////////////////////////////////////////////////////////////////////
	
	СтруктураДанныхСайта = ЗначениеИзСтрокиВнутр(ДанныеОбъекта);
		
	МассивЗаявок = Новый Массив;
	
	СтруктураОбъекта = СтруктураОтменыЗаявки(СтруктураДанныхСайта);
	КонтрольВозможностиОтменыЗаявки(СтруктураОбъекта);
	ОтменитьСтрокуЗаявки(СтруктураОбъекта, СтруктураОтчета);
	ЗаписатьЛогОтменыЗаявки(СтруктураОбъекта, НомерСообщения, Экспресс);
	СсылкаНаДокумент = ?(СтруктураОбъекта.Свойство("СсылкаНаДокумент"),СтруктураОбъекта.СсылкаНаДокумент,СтруктураОбъекта.ИсходнаяЗаявка);
	ОбменДаннымиКлиентСервер.ДобавитьСтрокуИсторииПоОбъекту(СсылкаНаДокумент, ДанныеОбъекта, ,СтруктураОбъекта.Отказ,СтруктураОбъекта.ТекстОшибки);
	
	DataExchangeModule.ОтметитьОтправкуОбъектов(МассивЗаявок, Перечисления.ВидыОбменов.ОбменСайт_1С_Заявки, НомерСообщения);;
	
КонецФункции

// 11.03.19 Строганов Роман <

// 06.03.19 Строганов Роман > 
Процедура ОбработатьОбъекты(НомерПотока = Неопределено, ИдентификаторУзлаОбмена) Экспорт
	
	ИмяПланаОбмена =  ОбменДаннымиПовтИсп.ПолучитьИмяПланаОбмена(ЭтотУзел());
	Отправитель = ОбменДаннымиКлиентСервер.ПолучитьВходящийУзелОбмена(ИмяПланаОбмена, ИдентификаторУзлаОбмена);
	ОбменССайтомСервер.ОбработатьОбъектыОбмена(Отправитель, НомерПотока);
		
КонецПроцедуры
// 06.03.19 Строганов Роман <

//Загрузка заявок
Функция СтруктураДокументаЗаявкаПокупателя(ОбъектXDTO, НомерСообщения) Экспорт
	
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_СтруктураДокументаЗаявкаПокупателя";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		АлгоритмыЗначениеВозврата = Неопределено;		
		Выполнить(лЗамена);		
		Возврат АлгоритмыЗначениеВозврата;		
	КонецЕсли;	
	///////////////////////////////////////////////////////////////////////////
	
	СтруктураОбъекта = Новый Структура("Отказ,ТекстОшибки", Ложь, "");
	СтруктураОбъекта.Вставить("ОшибкаЗаполненияСроковЗаказа", Ложь);
	СтруктураОбъекта.Вставить("ТекстОшибкиЗаполненияСроковЗаказа", "");
	СтруктураОбъекта.Вставить("ОшибкаСозданияСамовывоза", Ложь);
	СтруктураОбъекта.Вставить("ТекстОшибкиСозданияСамовывоза", "");
	СтруктураОбъекта.Вставить("ОшибкаСозданияЗаявкиНаПополнение", Ложь);
	СтруктураОбъекта.Вставить("ТекстОшибкиСозданияЗаявкиНаПополнение", "");
	СтруктураОбъекта.Вставить("ДоговорИзОсновногоДоговора", РегистрыСведений.НастройкиПодсистем.ЗначениеПараметра("Обмен 1С-Сайт","Загрузка заявок: Использовать основной договор", Ложь));
	УстановитьСсылкуНаДокумент(СтруктураОбъекта, ОбъектXDTO.Ссылка);
	УстановитьКонтрагентаПоЛогину(СтруктураОбъекта, ОбъектXDTO.ТТ_Логин);
	СтруктураОбъекта.Вставить("ИсточникЗаявки", ИсточникЗаявки(ОбъектXDTO.Source,СтруктураОбъекта.Контрагент));
	УстановитьДоговорПоставщика(СтруктураОбъекта, ОбъектXDTO);  //ХудинВВ XX-2851 18072019 
	УстановитьРеквизитыКонтрагента(СтруктураОбъекта, Строка(ОбъектXDTO.ДоговорКонтрагента));
	УстановитьАукцион(СтруктураОбъекта, ОбъектXDTO);
	СтруктураОбъекта.Вставить("Ответственный", ПараметрыСеанса.ТекущийПользователь);
	СтруктураОбъекта.Вставить("Подтверждена", ОбъектXDTO.Подтверждена);
	СтруктураОбъекта.Вставить("СтатусДокумента", ?(СтруктураОбъекта.Подтверждена, Справочники.СтатусыДокументов.ЗаявкаПокупателяПодтвержден, Справочники.СтатусыДокументов.ЗаявкаПокупателяНеПодтвержден));
	СтруктураОбъекта.Вставить("ОбщаяСкидка", 0);
	СтруктураОбъекта.Вставить("Комментарий", "Загружено с сайта:" + ТекущаяДата() + ", № пакета:" + НомерСообщения);
	СтруктураОбъекта.Вставить("Склад", Константы.СкладОсновной.Получить());
	СтруктураОбъекта.Вставить("Самовывоз", ОбъектXDTO.Самовывоз);
	СтруктураОбъекта.Вставить("МаршрутДоставки", Справочники.МаршрутыДоставки.ПустаяСсылка());
	СтруктураОбъекта.Вставить("РеквизитыПоставщика", Новый Соответствие);
	
	СтруктураОбъекта.Вставить("Склады", Новый Массив);
	
	// 14.03.19 Строганов Роман > 
	Если Константы.EMEX_ОбменВключен.Получить() Тогда
		СоответствиеPriceLogo = Новый Соответствие;
		СтруктураОбъекта.Вставить("СоответствиеPriceLogo", СоответствиеPriceLogo);
	КонецЕсли;
	// 14.03.19 Строганов Роман <

	// 25.07.19 Строганов Роман > XX-2633 Загрузка заявки (Самовывоз) 
	Если ЭтоАктивнаяЗадачаJirа(Справочники.ЗадачиJira.XX2633) Тогда
		СтруктураОбъекта.Вставить("ФлагСамовывоз", ОбъектXDTO.ФлагСамовывоз);
		СтруктураОбъекта.Вставить("СамовывозИмя", ОбъектXDTO.СамовывозИмя);
		СтруктураОбъекта.Вставить("СамовывозТелефон",ОбъектXDTO.СамовывозТелефон);
		СтруктураОбъекта.Вставить("СамовывозСклад", Документы.ЗаявкаПокупателя.ПолучитьСсылку(Новый УникальныйИдентификатор(ОбъектXDTO.СамовывозСклад)));
		СтруктураОбъекта.Вставить("ТипДоставки", ?(ОбъектXDTO.ФлагСамовывоз, Справочники.ТипыДоставки.СамовывозНовый, Справочники.ТипыДоставки.ПустаяСсылка()));
	КонецЕсли;
	// 25.07.19 Строганов Роман < XX-2633 Загрузка заявки (Самовывоз)
	
	ИспользоватьЦенуСоСкидкой = Ценообразование.ИспользоватьЦенуСоСкидкойВДокументах();

	ТаблицаТовары = Документы.ЗаявкаПокупателя.ПустаяСсылка().Товары.ВыгрузитьКолонки();
	
	// 06.03.19 Строганов Роман > 
	Если ТипЗнч(ОбъектXDTO) = Тип("Структура") Тогда
		
		Для Каждого СтрокаXDTO Из ОбъектXDTO.items Цикл
			СтрокаТовары = ТаблицаТовары.Добавить();
			УстановитьРеквизитыПрайса(СтруктураОбъекта, СтрокаТовары, СтрокаXDTO.ПрайсПоставщика_Код);
			УстановитьРеквизитыНоменклатуры(СтруктураОбъекта, СтрокаТовары, СтрокаXDTO.Номенклатура, СтрокаXDTO.Номенклатура_Наименование);
			СтрокаТовары.Качество = Справочники.Качество.Новый;
			СтрокаТовары.Цена = СтрокаXDTO.Цена;
			СтрокаТовары.Количество = СтрокаXDTO.Количество;
			СтрокаТовары.Сумма = СтрокаXDTO.Сумма;
			СтрокаТовары.ЦенаЗакупки = СтрокаXDTO.ЦенаЗакупки;
			СтрокаТовары.СрокГарантированный = СтрокаXDTO.СрокГарантированный;
			СтрокаТовары.СрокОжидаемый = СтрокаXDTO.СрокОжидаемый;
			СтрокаТовары.СрокГарантированныйЗаказа = СтрокаXDTO.СрокГарантированныйЗаказа;
			СтрокаТовары.СрокОжидаемыйЗаказа = СтрокаXDTO.СрокОжидаемыйЗаказа;
			СтрокаТовары.IDSite = СтрокаXDTO.IDSite;
			СтрокаТовары.КомментарийИзСайта = ПолучитьКомментарий(СтрокаXDTO.КомментарийИзСайта);
			//Семенов И.П. 16.05.2019 XX-2226(
			СтрокаТовары.ОснованияДляПредоставленияСкидки = СтрокаXDTO.ОснованияДляПредоставленияСкидки;
			//)Семенов И.П.
			СтрокаТовары.ЦенаСоСкидкой = ?(ИспользоватьЦенуСоСкидкой, СтрокаТовары.Цена, 0); 
			
			ДополнительныеДанные = Новый Структура("ИзготовительПоставщика,АртикулПоставщика", СтрокаXDTO.Номенклатура_ИзготовительПоставщика, СтрокаXDTO.Номенклатура_АртикулПоставщика);
			ДополнительныеДанные.Вставить("ТипПоставки", ТипПоставки(СтрокаXDTO.ТипПоставки));
			ДополнительныеДанные.Вставить("ДнейДоставкиДоДомашнегоСклада", ?(ЗначениеЗаполнено(СтрокаXDTO.ДнейДоставкиДоДомашнегоСклада), СтрокаXDTO.ДнейДоставкиДоДомашнегоСклада, 0));
			
			// 14.03.19 Строганов Роман > 
			Если Константы.EMEX_ОбменВключен.Получить() И СтрокаXDTO.Свойство("PriceLogo") И ЗначениеЗаполнено(СтрокаXDTO.PriceLogo) Тогда
				СоответствиеPriceLogo.Вставить(СтрокаXDTO.IDSite, СтрокаXDTO.PriceLogo);
			КонецЕсли;
			// 14.03.19 Строганов Роман <
			
			СтруктураОбъекта.РеквизитыПоставщика.Вставить(СтрокаТовары.IDSite, ДополнительныеДанные);
			
			СтрокаТовары.СуммаНДС = УчетНДС.РассчитатьСуммуНДС(СтрокаТовары.Сумма, СтруктураОбъекта.УчитыватьНДС, СтруктураОбъекта.СуммаВключаетНДС, УчетНДС.ПолучитьСтавкуНДС(СтрокаТовары.СтавкаНДС));
			КонтрольЗаполненияСроковЗаказа(СтруктураОбъекта, СтрокаТовары);
			
		КонецЦикла;

	Иначе
		Для Каждого СтрокаXDTO Из ОбъектXDTO.items.ПолучитьСписок("item") Цикл
			СтрокаТовары = ТаблицаТовары.Добавить();
			УстановитьРеквизитыПрайса(СтруктураОбъекта, СтрокаТовары, СтрокаXDTO.ПрайсПоставщика_Код);
			УстановитьРеквизитыНоменклатуры(СтруктураОбъекта, СтрокаТовары, СтрокаXDTO.Номенклатура, СтрокаXDTO.Номенклатура_Наименование);
			СтрокаТовары.Качество = Справочники.Качество.Новый;
			СтрокаТовары.Цена = СтрокаXDTO.Цена;
			СтрокаТовары.Количество = СтрокаXDTO.Количество;
			СтрокаТовары.Сумма = СтрокаXDTO.Сумма;
			СтрокаТовары.ЦенаЗакупки = СтрокаXDTO.ЦенаЗакупки;
			СтрокаТовары.СрокГарантированный = СтрокаXDTO.СрокГарантированный;
			СтрокаТовары.СрокОжидаемый = СтрокаXDTO.СрокОжидаемый;
			СтрокаТовары.СрокГарантированныйЗаказа = СтрокаXDTO.СрокГарантированныйЗаказа;
			СтрокаТовары.СрокОжидаемыйЗаказа = СтрокаXDTO.СрокОжидаемыйЗаказа;
			СтрокаТовары.IDSite = СтрокаXDTO.IDSite;
			СтрокаТовары.КомментарийИзСайта = ПолучитьКомментарий(СтрокаXDTO.КомментарийИзСайта);
			//Семенов И.П. 16.05.2019 XX-2226(
			СтрокаТовары.ОснованияДляПредоставленияСкидки = СтрокаXDTO.ОснованияДляПредоставленияСкидки;
			//)Семенов И.П.
			СтрокаТовары.ЦенаСоСкидкой = ?(ИспользоватьЦенуСоСкидкой, СтрокаТовары.Цена, 0); 
			
			ДополнительныеДанные = Новый Структура("ИзготовительПоставщика,АртикулПоставщика", СтрокаXDTO.Номенклатура_ИзготовительПоставщика, СтрокаXDTO.Номенклатура_АртикулПоставщика);
			ДополнительныеДанные.Вставить("ТипПоставки", ТипПоставки(СтрокаXDTO.ТипПоставки));
			ДополнительныеДанные.Вставить("ДнейДоставкиДоДомашнегоСклада", ?(ЗначениеЗаполнено(СтрокаXDTO.ДнейДоставкиДоДомашнегоСклада), СтрокаXDTO.ДнейДоставкиДоДомашнегоСклада, 0));
			
			// 14.03.19 Строганов Роман > 
			Если Константы.EMEX_ОбменВключен.Получить() И СтрокаXDTO.Свойства().Получить("PriceLogo") <> Неопределено Тогда
				СоответствиеPriceLogo.Вставить(СтрокаXDTO.IDSite, СтрокаXDTO.PriceLogo);
			КонецЕсли;
			// 14.03.19 Строганов Роман <

			СтруктураОбъекта.РеквизитыПоставщика.Вставить(СтрокаТовары.IDSite, ДополнительныеДанные);
			
			СтрокаТовары.СуммаНДС = УчетНДС.РассчитатьСуммуНДС(СтрокаТовары.Сумма, СтруктураОбъекта.УчитыватьНДС, СтруктураОбъекта.СуммаВключаетНДС, УчетНДС.ПолучитьСтавкуНДС(СтрокаТовары.СтавкаНДС));
			КонтрольЗаполненияСроковЗаказа(СтруктураОбъекта, СтрокаТовары);
			
		КонецЦикла;
	КонецЕсли;
	
	СтруктураОбъекта.Вставить("Товары", ТаблицаТовары);
	СтруктураОбъекта.Вставить("СуммаДокумента", СтруктураОбъекта.Товары.Итог("Сумма"));
	
	УстановитьСкладПополнения(СтруктураОбъекта); //ХудинВВ XX-2298 22052019
	УстановитьСкладДокумента(СтруктураОбъекта, ОбъектXDTO.СкладЦС);
	УстановитьВидОперации(СтруктураОбъекта);	
	КорректировкаЦенБонусныхСкладов(СтруктураОбъекта);
	
	Возврат СтруктураОбъекта;
	
КонецФункции

Процедура КонтрольЗаполненияДокумента(СтруктураДокумента)
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_КонтрольЗаполненияДокумента";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда		
		Выполнить(лЗамена);		
		Возврат;		
	КонецЕсли;	
	///////////////////////////////////////////////////////////////////////////
	
	//Проверяем пустые цены
	Склад = СтруктураДокумента.Склад;
	Если НЕ Склад.Пустая() И НЕ Склад.Сувенирный И НЕ Склад.Бонусный Тогда
		Для Каждого Строка Из СтруктураДокумента.Товары.НайтиСтроки(Новый Структура("Цена",0)) Цикл
			СтруктураДокумента.Отказ = Истина;
			ТекстОшибки = "Нулевая цена в строке SiteID:" + Строка.IDSite;
			ДополнитьОшибку(СтруктураДокумента.ТекстОшибки, ТекстОшибки);	
		КонецЦикла;
	КонецЕсли;
	
	//Проверяем количество заявок в аукционе
	Если СтруктураДокумента.АукционнаяЗаявка Тогда
		ТЧЗаявки = СтруктураДокумента.АукционОбъект.Заявки;
		Если ТЧЗаявки.Количество() > СтруктураДокумента.АукционОбъект.ОбщееЧислоЗаявок Тогда
			СтруктураДокумента.Отказ = Истина;
			ТекстОшибки = "Количество заявок в указанном аукционе превышает установленное <ID:" + Формат(СтруктураДокумента.АукционОбъект.ИдентификаторАукциона, "ЧГ=") + ">";
			ДополнитьОшибку(СтруктураДокумента.ТекстОшибки, ТекстОшибки);	
		КонецЕсли;
	КонецЕсли;
	
	//Проверяем пустую организацию
	//Если пустая в договоре, то будет пустая в документе
	Если НЕ ЗначениеЗаполнено(СтруктураДокумента.Организация) Тогда
		СтруктураДокумента.Отказ = Истина;
		ТекстОшибки = "Не определена организация договора: <" + СтруктураДокумента.ДоговорКонтрагента.Код + ">";
		ДополнитьОшибку(СтруктураДокумента.ТекстОшибки, ТекстОшибки);	
	КонецЕсли;
	
	//ХудинВВ XX-2751 04072019 ((
	Если ЗначениеЗаполнено(СтруктураДокумента.СкладПополнения) Тогда
		
		ДатаНачалаЗапретаЗаявокНаПополнениеСклада = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СтруктураДокумента.СкладПополнения, "ДатаНачалаЗапретаЗаявокНаПополнениеСклада");
		Если ЗначениеЗаполнено(ДатаНачалаЗапретаЗаявокНаПополнениеСклада) И ТекущаяДата() >= ДатаНачалаЗапретаЗаявокНаПополнениеСклада Тогда
			СтруктураДокумента.Отказ = Истина;
			СтруктураДокумента.ОшибкаСозданияЗаявкиНаПополнение = Истина;
			ТекстОшибки = "Для склада "+СтруктураДокумента.СкладПополнения+" установлен запрет заявок на пополнение с "+Формат(ДатаНачалаЗапретаЗаявокНаПополнениеСклада, "ДФ=dd.MM.yyyy");
			ДополнитьОшибку(СтруктураДокумента.ТекстОшибки, ТекстОшибки);
			ДополнитьОшибку(СтруктураДокумента.ТекстОшибкиСозданияЗаявкиНаПополнение, ТекстОшибки);
		КонецЕсли;
		
	КонецЕсли;
	//))
	
КонецПроцедуры

Процедура ЗаписатьДокументЗаявки(СтруктураДокумента, МассивЗаявок, СтруктураОтчета = Неопределено)
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_ЗаписатьДокументЗаявки";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда		
		Выполнить(лЗамена);		
		Возврат;		
	КонецЕсли;	
	///////////////////////////////////////////////////////////////////////////
	
	РезрешеноПерезаписыватьЗаявки = Ложь;
	
	Если НЕ СтруктураДокумента.Отказ Тогда
		СсылкаНаДокумент = СтруктураДокумента.СсылкаНаДокумент;
		ЗаявкаСуществует = ЗначениеЗаполнено(ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СсылкаНаДокумент,"ВерсияДанных"));
		
		Если	ЗаявкаСуществует И НЕ РезрешеноПерезаписыватьЗаявки Тогда
			СтруктураДокумента.Отказ = Истина;
			ТекстОшибки = "Документ существует, перезапись существующих документов запрещена. (" + Строка(СсылкаНаДокумент) + ", GUID = <" + СсылкаНаДокумент.УникальныйИдентификатор() + ">)";
			ДополнитьОшибку(СтруктураДокумента.ТекстОшибки, ТекстОшибки);
			// 13.03.19 Строганов Роман > 
			Если СтруктураОтчета <> Неопределено Тогда
				СтруктураОтчета.Ошибка = Истина;
				ДополнитьОшибку(СтруктураОтчета.ТекстОшибки, ТекстОшибки);
				СтруктураОтчета.Вставить("СсылкаНаОбъект", СсылкаНаДокумент);
			КонецЕсли;
			// 06.03.19 Строганов Роман <
		Иначе
			Если ЗаявкаСуществует Тогда
				Документ = СсылкаНаДокумент.ПолучитьОбъект();
			Иначе
				Документ = Документы.ЗаявкаПокупателя.СоздатьДокумент();
				Документ.УстановитьСсылкуНового(СсылкаНаДокумент);
			КонецЕсли;
			ЗаполнитьЗначенияСвойств(Документ, СтруктураДокумента, ,"Товары");
			Документ.Товары.Загрузить(СтруктураДокумента.Товары);
			
			Если СтруктураДокумента.АукционнаяЗаявка Тогда
				СтруктураДокумента.АукционОбъект.Записать();
				Документ.Аукцион = СтруктураДокумента.АукционОбъект.Ссылка;
			КонецЕсли;
			
			Попытка
				Документ.ДополнительныеСвойства.Вставить("ЗагрузкаССайта", Истина);
				Документ.ДополнительныеСвойства.Вставить("РеквизитыПоставщика", СтруктураДокумента.РеквизитыПоставщика);				
				
				// 14.03.19 Строганов Роман > 
				Если Константы.EMEX_ОбменВключен.Получить() И СтруктураДокумента.Свойство("СоответствиеPriceLogo") Тогда
					Документ.ДополнительныеСвойства.Вставить("СоответствиеPriceLogo", СтруктураДокумента.СоответствиеPriceLogo);
				КонецЕсли;
				// 14.03.19 Строганов Роман <
				
				// 25.07.19 Строганов Роман > XX-2633 Загрузка заявки (Самовывоз) 
				Если ЭтоАктивнаяЗадачаJirа(Справочники.ЗадачиJira.XX2633) Тогда
					РегистрыСведений.Документ_ЗаявкаПокупателя_ДополнительныеРеквизиты.ЗафиксироватьДопСвойство(СсылкаНаДокумент, "ФлагСамовывоз"		, СтруктураДокумента.ФлагСамовывоз);
					РегистрыСведений.Документ_ЗаявкаПокупателя_ДополнительныеРеквизиты.ЗафиксироватьДопСвойство(СсылкаНаДокумент, "СамовывозИмя"		, СтруктураДокумента.СамовывозИмя);
					РегистрыСведений.Документ_ЗаявкаПокупателя_ДополнительныеРеквизиты.ЗафиксироватьДопСвойство(СсылкаНаДокумент, "СамовывозТелефон" 	, СтруктураДокумента.СамовывозТелефон);
					РегистрыСведений.Документ_ЗаявкаПокупателя_ДополнительныеРеквизиты.ЗафиксироватьДопСвойство(СсылкаНаДокумент, "СамовывозСклад"		, СтруктураДокумента.СамовывозСклад);
				КонецЕсли;
				// 25.07.19 Строганов Роман < XX-2633 Загрузка заявки (Самовывоз)
				
				Документ.Записать(РежимЗаписиДокумента.Проведение);
				МассивЗаявок.Добавить(Документ.Ссылка);
				// 11.03.19 Строганов Роман > 
				Если СтруктураОтчета <> Неопределено Тогда
					СтруктураОтчета.Вставить("СсылкаНаОбъект", Документ.Ссылка);
				КонецЕсли;
				// 11.03.19 Строганов Роман <
			Исключение
				СтруктураДокумента.Отказ = Истина;
				ТекстОшибки = "Ошибка записи документа: " + Символы.ПС + ОписаниеОшибки();
				ДополнитьОшибку(СтруктураДокумента.ТекстОшибки, ТекстОшибки);
				
				// 06.03.19 Строганов Роман > 
				Если СтруктураОтчета <> Неопределено Тогда
					СтруктураОтчета.Ошибка = Истина;
					ДополнитьОшибку(СтруктураОтчета.ТекстОшибки, ТекстОшибки);
					СтруктураОтчета.Вставить("СсылкаНаОбъект", Документы.ЗаявкаПокупателя.ПустаяСсылка());
				КонецЕсли;
				// 06.03.19 Строганов Роман <
			КонецПопытки;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаписатьЛогЗагрузкиДокумента(СтруктураДокумента, НомерСообщения, Экспресс)
	
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_ЗаписатьЛогЗагрузкиДокумента";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		Выполнить(лЗамена);
		Возврат;
	КонецЕсли;
	///////////////////////////////////////////////////////////////////////////
	
	
	Запись = РегистрыСведений.ЛогОбменовССайтом.СоздатьМенеджерЗаписи();
	Запись.ПланОбмена = ?(Экспресс, Перечисления.ПланыОбменаССайтом.ПодтвержениеПолученияЗаявок_express, Перечисления.ПланыОбменаССайтом.ПодтвержениеПолученияЗаявок);
	Запись.Ссылка = СтруктураДокумента.СсылкаНаДокумент.УникальныйИдентификатор();
	Запись.НомерСообщенияВходящий = НомерСообщения;
	Запись.Ошибка = СтруктураДокумента.Отказ;
	Запись.ТекстОшибки = СтруктураДокумента.ТекстОшибки + ?(СтруктураДокумента.Самовывоз, СтруктураДокумента.ТекстОшибкиСозданияСамовывоза, "");
	Запись.Записать();
	
	Если СтруктураДокумента.ОшибкаЗаполненияСроковЗаказа Тогда
		ТекстСообщения = ?(Экспресс,"(Express)","") + "От сайта пришла подтвержденная заявка с незаполненными сроками заказа (Заявка: <" + СтруктураДокумента.СсылкаНаДокумент + ">, (" + СтруктураДокумента.ТекстОшибкиЗаполненияСроковЗаказа + ")";
		РассылкаСообщенийОбОшибках.ОтправитьЭлектронноеСообщениеБезСохранения(Справочники.СобытияДляОтправкиЭлектронныхПисем.ОшибкаОбменаССайтом, ТекстСообщения, "Ошибка заполнения сроков заказа");
		
		КритическиеСобытияСервер.ЗарегистрироватьКритическоеСобытие(СтруктураДокумента.СсылкаНаДокумент, 
		Справочники.СобытияДляОтправкиЭлектронныхПисем.ОшибкаОбменаССайтом,
		ТекстСообщения,
		, 
		Истина);		
	КонецЕсли;
	
	Если СтруктураДокумента.ОшибкаСозданияСамовывоза Тогда
		ТекстСообщения = ?(Экспресс,"(Express)","") + "Ошибка создания реализации(самовывоз) по заявке: <" + СтруктураДокумента.СсылкаНаДокумент + ">, (" + СтруктураДокумента.ТекстОшибкиСозданияСамовывоза + ")";
		РассылкаСообщенийОбОшибках.ОтправитьЭлектронноеСообщениеБезСохранения(Справочники.СобытияДляОтправкиЭлектронныхПисем.ОшибкаОбменаССайтом, ТекстСообщения, "Ошибка формирования заявки с самовывозом");
		
		КритическиеСобытияСервер.ЗарегистрироватьКритическоеСобытие(СтруктураДокумента.СсылкаНаДокумент, 
		Справочники.СобытияДляОтправкиЭлектронныхПисем.ОшибкаОбменаССайтом,
		ТекстСообщения,
		, 
		Истина);
	КонецЕсли;
	
	Если СтруктураДокумента.ОшибкаСозданияЗаявкиНаПополнение Тогда
		ТекстСообщения = "Пришла заявка на пополнение неактуального склада: <" + СтруктураДокумента.СсылкаНаДокумент + ">, (" + СтруктураДокумента.ТекстОшибкиСозданияЗаявкиНаПополнение + ")";
		РассылкаСообщенийОбОшибках.ОтправитьЭлектронноеСообщениеБезСохранения(Справочники.СобытияДляОтправкиЭлектронныхПисем.ОшибкаОбменаССайтом, ТекстСообщения, "Ошибка формирования заявки на пополнение");
		
		КритическиеСобытияСервер.ЗарегистрироватьКритическоеСобытие(СтруктураДокумента.СсылкаНаДокумент, 
		Справочники.СобытияДляОтправкиЭлектронныхПисем.ОшибкаОбменаССайтом,
		ТекстСообщения,
		, 
		Истина);
	КонецЕсли;

	
КонецПроцедуры

//Создание реализации при самовывозе
Процедура СформироватьСамовывозПоЗаявке(СтруктураДокумента)
	
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_СформироватьСамовывозПоЗаявке";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда		
		Выполнить(лЗамена);		
		Возврат;		
	КонецЕсли;	
	///////////////////////////////////////////////////////////////////////////
	
	Если СтруктураДокумента.Самовывоз И НЕ СтруктураДокумента.Отказ Тогда
		КонтрольВозможностиСозданияРеализации(СтруктураДокумента);
		Если НЕ СтруктураДокумента.ОшибкаСозданияСамовывоза Тогда
			ДокументЗаявки = СтруктураДокумента.СсылкаНаДокумент;
			СтруктураРеализации = СтруктураРеализации(ДокументЗаявки);
			ВыборкаПоРезервам = ДанныеРезервовПоЗаявке(ДокументЗаявки, СтруктураРеализации);
			ДокументыРеализации = ДокументыРеализации(ВыборкаПоРезервам, СтруктураРеализации, СтруктураДокумента);
			ЗаписатьДокументыРеализации(ДокументыРеализации, СтруктураДокумента);
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Функция СтруктураРеализации(ДокументЗаявки)
	
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_СтруктураРеализации";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		АлгоритмыЗначениеВозврата = Неопределено;		
		Выполнить(лЗамена);		
		Возврат АлгоритмыЗначениеВозврата;		
	КонецЕсли;
	
	///////////////////////////////////////////////////////////////////////////
	
	Структура = Новый Структура("Организация,Контрагент,Склад,ДоговорКонтрагента,ТипЦен,ВалютаДокумента,КурсВзаиморасчетов,КратностьВзаиморасчетов,УчитыватьНДС,СуммаВключаетНДС,Филиал,Менеджер,МаршрутДоставки");
	ЗаполнитьЗначенияСвойств(Структура, ДокументЗаявки);
	Структура.Вставить("Дата", ТекущаяДата());
	Структура.Вставить("Источник", Перечисления.ИсточникиРеализаций.Сайт);
	Структура.Вставить("Комментарий", "Самовывоз заявки: " + ДокументЗаявки);
	Структура.Вставить("ТипДоставки", Справочники.ТипыДоставки.Самовывоз);
	Структура.Вставить("ДокументОснование", ДокументЗаявки);
	Структура.Вставить("БанковскийСчетОрганизации", ДокументЗаявки.Организация.ОсновнойБанковскийСчет);
	Структура.Вставить("СтатусДокумента", Справочники.СтатусыДокументов.РеализацияТоваровУслугСборка);
	
	Возврат Структура;
	
КонецФункции

Функция ДанныеРезервовПоЗаявке(ДокументЗаявки, ДокументРеализации)
	
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_ДанныеРезервовПоЗаявке";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		АлгоритмыЗначениеВозврата = Неопределено;		
		Выполнить(лЗамена);		
		Возврат АлгоритмыЗначениеВозврата;		
	КонецЕсли;
	
	///////////////////////////////////////////////////////////////////////////
	
	Запрос = Новый Запрос("ВЫБРАТЬ
	                      |	ЗаявкаПокупателяТовары.СтрокаЗаявки,
	                      |	ЗаявкаПокупателяТовары.Номенклатура,
	                      |	ЗаявкаПокупателяТовары.СтавкаНДС,
	                      |	ЗаявкаПокупателяТовары.Количество КАК КоличествоЗаявка,
	                      |	ЗаявкаПокупателяТовары.Цена,
	                      |	ЗаявкаПокупателяТовары.ЦенаСоСкидкой,
	                      |	ЗаявкаПокупателяТовары.Качество,
	                      |	ЗаявкаПокупателяТовары.ЕдиницаИзмерения,
	                      |	ЗаявкаПокупателяТовары.Коэффициент,
	                      |	ЗаявкаПокупателяТовары.КомментарийИзСайта,
	                      |	ЗаявкаПокупателяТовары.IDSite,
	                      |	ЗаявкаПокупателяТовары.ПроцентСкидкиНаценки,
	                      |	ЗаявкаПокупателяТовары.ЦенаЗакупки,
	                      |	ЗаявкаПокупателяТовары.Прибыль,
	                      |	ЕСТЬNULL(ЗаявкаПокупателяТовары.СтрокаЗаявки.ДнейДоставкиДоДомашнегоСклада, 0) КАК ОтсрочкаДоставкиДоДомашнегоСклада,
	                      |	ЕСТЬNULL(ОсобыеУсловияОтсрочки.ДопустимоеЧислоДнейЗадолженности, 0) КАК ОтсрочкаПоСпецУсловиям,
	                      |	ЕСТЬNULL(ОсобыеУсловияОтсрочки.ВидРасчетаДней, ЗНАЧЕНИЕ(Перечисление.ВидыРасчетаДней.ПоКалендарнымДням)) КАК ВидРасчетаДнейПоОтсрочкеПоСпецУсловиям
	                      |ПОМЕСТИТЬ ВТ_ДанныеДокумента
	                      |ИЗ
	                      |	Документ.ЗаявкаПокупателя.Товары КАК ЗаявкаПокупателяТовары
	                      |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ОсобыеУсловияОтсрочки КАК ОсобыеУсловияОтсрочки
	                      |		ПО ЗаявкаПокупателяТовары.Номенклатура.Изготовитель = ОсобыеУсловияОтсрочки.Изготовитель
	                      |			И ЗаявкаПокупателяТовары.СтрокаЗаявки.ТипПоставки = ОсобыеУсловияОтсрочки.ТипПоставки
	                      |			И (ОсобыеУсловияОтсрочки.ДоговорКонтрагента = &ДоговорКонтрагента)
	                      |			И (ОсобыеУсловияОтсрочки.ДатаОкончания >= &ДатаРеализации)
	                      |ГДЕ
	                      |	ЗаявкаПокупателяТовары.Ссылка = &ДокументЗаявки
	                      |;
	                      |
	                      |////////////////////////////////////////////////////////////////////////////////
	                      |ВЫБРАТЬ
	                      |	ВТ_ДанныеДокумента.СтрокаЗаявки,
	                      |	ВТ_ДанныеДокумента.Номенклатура,
	                      |	ВТ_ДанныеДокумента.СтавкаНДС,
	                      |	ВТ_ДанныеДокумента.Цена,
	                      |	ВТ_ДанныеДокумента.ЦенаСоСкидкой,
	                      |	ВТ_ДанныеДокумента.КоличествоЗаявка,
	                      |	ВТ_ДанныеДокумента.Качество,
	                      |	ВТ_ДанныеДокумента.ЕдиницаИзмерения,
	                      |	ВТ_ДанныеДокумента.Коэффициент,
	                      |	ВТ_ДанныеДокумента.КомментарийИзСайта,
	                      |	ВТ_ДанныеДокумента.IDSite,
	                      |	ВТ_ДанныеДокумента.ПроцентСкидкиНаценки,
	                      |	ВТ_ДанныеДокумента.ЦенаЗакупки,
	                      |	ВТ_ДанныеДокумента.Прибыль,
	                      |	ВТ_ДанныеДокумента.ОтсрочкаДоставкиДоДомашнегоСклада,
	                      |	ВТ_ДанныеДокумента.ОтсрочкаПоСпецУсловиям,
	                      |	ВТ_ДанныеДокумента.ВидРасчетаДнейПоОтсрочкеПоСпецУсловиям,
	                      |	ЕСТЬNULL(РезервыТоваровОбороты.СтрокаПрихода, ЗНАЧЕНИЕ(Справочник.ИдентификаторыСтрокПриходов.ПустаяСсылка)) КАК СтрокаПрихода,
	                      |	ЕСТЬNULL(РезервыТоваровОбороты.КоличествоПриход, 0) КАК КоличествоРезерв
	                      |ИЗ
	                      |	ВТ_ДанныеДокумента КАК ВТ_ДанныеДокумента
	                      |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.РезервыТоваров.Обороты(
	                      |				,
	                      |				,
	                      |				Регистратор,
	                      |				Склад = &Склад
	                      |					И Номенклатура В
	                      |						(ВЫБРАТЬ
	                      |							ВТ_ДанныеДокумента.Номенклатура
	                      |						ИЗ
	                      |							ВТ_ДанныеДокумента КАК ВТ_ДанныеДокумента)
	                      |					И СтрокаЗаявки В
	                      |						(ВЫБРАТЬ
	                      |							ВТ_ДанныеДокумента.СтрокаЗаявки
	                      |						ИЗ
	                      |							ВТ_ДанныеДокумента КАК ВТ_ДанныеДокумента)) КАК РезервыТоваровОбороты
	                      |		ПО ВТ_ДанныеДокумента.СтрокаЗаявки = РезервыТоваровОбороты.СтрокаЗаявки
	                      |			И ВТ_ДанныеДокумента.Номенклатура = РезервыТоваровОбороты.Номенклатура");
	Запрос.УстановитьПараметр("ДокументЗаявки", ДокументЗаявки);
	Запрос.УстановитьПараметр("ДоговорКонтрагента", ДокументРеализации.ДоговорКонтрагента);
	Запрос.УстановитьПараметр("ДатаРеализации", ДокументРеализации.Дата);
	Запрос.УстановитьПараметр("Склад", ДокументЗаявки.Склад);
	
	Возврат Запрос.Выполнить().Выбрать();
	
КонецФункции

Функция ДокументыРеализации(ВыборкаПоРезервам, СтруктураРеализации, СтруктураДокумента)
	
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_ДокументыРеализации";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		АлгоритмыЗначениеВозврата = Неопределено;		
		Выполнить(лЗамена);		
		Возврат АлгоритмыЗначениеВозврата;		
	КонецЕсли;
	
	///////////////////////////////////////////////////////////////////////////
	
	ИспользоватьЦенуСоСкидкой = Ценообразование.ИспользоватьЦенуСоСкидкойВДокументах();
	ДокументыРеализации = Новый Соответствие;
	Пока ВыборкаПоРезервам.Следующий() Цикл
		Если ВыборкаПоРезервам.КоличествоРезерв > 0 Тогда
			ДатаОплаты = ДатаОплатыСОтсрочками(СтруктураРеализации, ВыборкаПоРезервам);
			Документ = ДокументРеализации(ДокументыРеализации, ДатаОплаты, СтруктураРеализации);
			
			НоваяСтрока = Документ.Товары.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, ВыборкаПоРезервам, "Номенклатура,Качество,Цена,ЕдиницаИзмерения,Коэффициент,СтавкаНДС,СтрокаЗаявки,КомментарийИзСайта,IDSite,ПроцентСкидкиНаценки,ЦенаЗакупки,Прибыль");
			НоваяСтрока.КлючСвязи = НоваяСтрока.НомерСтроки;
			НоваяСтрока.Количество = ВыборкаПоРезервам.КоличествоРезерв;
			НоваяСтрока.КоличествоПлан = ВыборкаПоРезервам.КоличествоРезерв;
			
			Если ИспользоватьЦенуСоСкидкой И ВыборкаПоРезервам.ЦенаСоСкидкой <> 0 Тогда
				НоваяСтрока.ЦенаСоСкидкой =  ВыборкаПоРезервам.ЦенаСоСкидкой;
				СтруктураДействий = Новый Структура;
				СтруктураДействий.Вставить("ПересчитатьСумму", 0);
				СтруктураДействий.Вставить("ПересчитатьПрибыль",);
				СтруктураДействий.Вставить("РассчитатьСуммуНДС", Документ);
				
				мКэшированныеЗначения = Неопределено;
				ОбработкаТабличныхЧастей.ПересчитатьСтрокуТабличнойЧасти(НоваяСтрока, СтруктураДействий, мКэшированныеЗначения); 
			Иначе
				НоваяСтрока.Сумма = НоваяСтрока.Количество * НоваяСтрока.Цена * (1 - НоваяСтрока.ПроцентСкидкиНаценки / 100);
				ОбработкаТабличныхЧастей.РассчитатьСуммуНДСТабЧасти(НоваяСтрока, Документ);
			КонецЕсли;
		Иначе
			СтруктураДокумента.ОшибкаСозданияСамовывоза = Истина;
			ТекстОшибки = "Заявка не сформировала резерв по строке IDSite:" + ВыборкаПоРезервам.IDSite;
			ДополнитьОшибку(СтруктураДокумента.ТекстОшибкиСозданияСамовывоза, ТекстОшибки);
		КонецЕсли;
	КонецЦикла;
	
	Возврат  ДокументыРеализации;
	
КонецФункции

Процедура ЗаписатьДокументыРеализации(ДокументыРеализации, СтруктураДокумента)
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_ЗаписатьДокументыРеализации";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		Выполнить(лЗамена);
		Возврат;
	КонецЕсли;
	///////////////////////////////////////////////////////////////////////////
	
	Если ДокументыРеализации.Количество() > 0 Тогда
		Для Каждого ВыборкаДокументов Из ДокументыРеализации Цикл
			Документ = ВыборкаДокументов.Значение;
			Попытка
				Документ.Записать(РежимЗаписиДокумента.Проведение);
				//Семенов И.П. 06.02.2019 XX-1768(
				ОбменДаннымиКлиентСервер.ДобавитьСтрокуИсторииПоОбъекту(Документ.Ссылка, "Документ создан на основании заявки "+Документ.ДокументОснование);
				//)Семенов И.П.
			Исключение
				ОписаниеОшибки = ОписаниеОшибки();
				Документ.Записать(РежимЗаписиДокумента.Запись);
				ДополнитьОшибку(СтруктураДокумента.ТекстОшибкиСозданияСамовывоза, "Ошибка проведения документа реализации:" + Документ + Символы.ПС + ОписаниеОшибки);
				//Семенов И.П. 06.02.2019 XX-1768(
				ОбменДаннымиКлиентСервер.ДобавитьСтрокуИсторииПоОбъекту(Документ.Ссылка, "Документ создан на основании заявки "+Документ.ДокументОснование,,Истина,ОписаниеОшибки);
				//)Семенов И.П.
			КонецПопытки;
		КонецЦикла;
	Иначе
		СтруктураДокумента.ТекстОшибкиСозданияСамовывоза = "Заявка не зарезервировала товары. Реализация не сформирована";
	КонецЕсли;
	
КонецПроцедуры

Процедура КонтрольВозможностиСозданияРеализации(СтруктураДокумента)
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_КонтрольВозможностиСозданияРеализации";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		Выполнить(лЗамена);
		Возврат;
	КонецЕсли;
	///////////////////////////////////////////////////////////////////////////

	Если СтруктураДокумента.Подтверждена Тогда

		//ХудинВВ 25032019 XX-2204 Изменен алгоритм проверки
		ТекстОшибкиСозданияСамовывоза = "";
		Если ОтгрузкаПоКонтрагентуЗаблокирована(СтруктураДокумента.Контрагент, СтруктураДокумента.ДоговорКонтрагента, ТекстОшибкиСозданияСамовывоза) Тогда
			СтруктураДокумента.ОшибкаСозданияСамовывоза 		= Истина;
			СтруктураДокумента.ТекстОшибкиСозданияСамовывоза 	= ТекстОшибкиСозданияСамовывоза;
		КонецЕсли;
		
		// Отключено
		//Контрагент = СтруктураДокумента.Контрагент;
		//ДатаБлокировкиРеализаций = Контрагент.Блокировка_Отгрузок_Дата;
		//Если ЗначениеЗаполнено(ДатаБлокировкиРеализаций) И ДатаБлокировкиРеализаций <= ТекущаяДата() Тогда
		//	СтруктураДокумента.ОшибкаСозданияСамовывоза = Истина;
		//	СтруктураДокумента.ТекстОшибкиСозданияСамовывоза = "У контрагента заблокирована реализация: " + Контрагент.Блокировка_Отгрузок_Коммент;
		//КонецЕсли;
	Иначе
		СтруктураДокумента.ОшибкаСозданияСамовывоза = Истина;
		СтруктураДокумента.ТекстОшибкиСозданияСамовывоза = "По неподтвержденной заявке нельзя сформировать самовывоз";
	КонецЕсли;
	
КонецПроцедуры

//ХудинВВ 25032019 XX-2204
Функция ОтгрузкаПоКонтрагентуЗаблокирована(Контрагент, ДоговорКонтрагента, ТекстОшибки = "") Экспорт
	
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_ОтгрузкаПоКонтрагентуЗаблокирована";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		АлгоритмыЗначениеВозврата = Неопределено;		
		Выполнить(лЗамена);		
		Возврат АлгоритмыЗначениеВозврата;		
	КонецЕсли;
	
	///////////////////////////////////////////////////////////////////////////
	Если Не ЗначениеЗаполнено(Контрагент)
		ИЛИ НЕ ЗначениеЗаполнено(ДоговорКонтрагента) Тогда
		ВызватьИсключение "Ошибка проверки блокировки отгрузки по контрагенту. Не задан контрагент/договор.";
	КонецЕсли;	
	
	ОтгрузкаПоКонтрагентуЗаблокирована = Ложь;
	
	РеквизитыКонтрагента 	= ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Контрагент, "Блокировка_Отгрузок_Дата, ГоловнойКонтрагент, ГоловнойКонтрагент.ОсновнойДоговорКонтрагента.ДоговорПриостановлен, ГоловнойКонтрагент.Блокировка_Отгрузок_Дата, Блокировка_Отгрузок_Коммент, ГоловнойКонтрагент.Блокировка_Отгрузок_Коммент");
	РеквизитыДоговора		= ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ДоговорКонтрагента, "ДоговорПриостановлен");
	
	УстановленаБлокировкаКонтрагента = ЗначениеЗаполнено(РеквизитыКонтрагента.Блокировка_Отгрузок_Дата) 
										И РеквизитыКонтрагента.Блокировка_Отгрузок_Дата <= ТекущаяДата() 
										И Не ЗначениеЗаполнено(РеквизитыКонтрагента.ГоловнойКонтрагент);
	
	УстановленаБлокировкаДоговораКонтрагента = РеквизитыДоговора.ДоговорПриостановлен = Истина 
												И Не ЗначениеЗаполнено(РеквизитыКонтрагента.ГоловнойКонтрагент);
	
	УстановленаБлокировкаГолКонтрагента = ЗначениеЗаполнено(РеквизитыКонтрагента.ГоловнойКонтрагентБлокировка_Отгрузок_Дата) 
											И РеквизитыКонтрагента.ГоловнойКонтрагентБлокировка_Отгрузок_Дата <= ТекущаяДата();
	
	УстановленаБлокировкаДоговораГолКонтрагента = РеквизитыКонтрагента.ГоловнойКонтрагентОсновнойДоговорКонтрагентаДоговорПриостановлен = Истина;
	
	Если УстановленаБлокировкаКонтрагента
		ИЛИ УстановленаБлокировкаДоговораКонтрагента
		ИЛИ УстановленаБлокировкаГолКонтрагента
		ИЛИ УстановленаБлокировкаДоговораГолКонтрагента Тогда
		
		ОтгрузкаПоКонтрагентуЗаблокирована = Истина;
		
		Если УстановленаБлокировкаДоговораКонтрагента ИЛИ УстановленаБлокировкаДоговораГолКонтрагента Тогда
			ДопОписание = "Договор приостановлен";
		ИначеЕсли УстановленаБлокировкаКонтрагента Тогда
			ДопОписание = ""+РеквизитыКонтрагента.Блокировка_Отгрузок_Коммент;
		ИначеЕсли УстановленаБлокировкаГолКонтрагента Тогда
			ДопОписание = ""+РеквизитыКонтрагента.ГоловнойКонтрагентБлокировка_Отгрузок_Коммент;
		Иначе
			ДопОписание = "";
		КонецЕсли;
		
		ТекстОшибки = "У контрагента заблокирована реализация: " + ДопОписание;
	КонецЕсли;
	
	Возврат ОтгрузкаПоКонтрагентуЗаблокирована;
	
КонецФункции

Функция ДатаОплатыСОтсрочками(СтруктураРеализации, ВыборкаПоРезервам)
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_ДатаОплатыСОтсрочками";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		АлгоритмыЗначениеВозврата = Неопределено;		
		Выполнить(лЗамена);		
		Возврат АлгоритмыЗначениеВозврата;		
	КонецЕсли;	
	///////////////////////////////////////////////////////////////////////////
	
	Договор = СтруктураРеализации.ДоговорКонтрагента;
	ДатаОплаты = УправлениеВзаиморасчетами.ПолучитьДатуОплатыПоДатеДокумента(СтруктураРеализации.Дата, 1, Перечисления.ВидыРасчетаДней.ПоКалендарнымДням, Истина);
	ДатаОплаты = УправлениеВзаиморасчетами.ПолучитьДатуОплатыПоДатеДокумента(ДатаОплаты, Договор.ДопустимоеЧислоДнейЗадолженности, Договор.ВидРасчетаДней, Истина);
	ДатаОплаты = УправлениеВзаиморасчетами.ПолучитьДатуОплатыПоДатеДокумента(ДатаОплаты, ВыборкаПоРезервам.ОтсрочкаДоставкиДоДомашнегоСклада, Перечисления.ВидыРасчетаДней.ПоБанковскимДням, Истина);
	ДатаОплаты = УправлениеВзаиморасчетами.ПолучитьДатуОплатыПоДатеДокумента(ДатаОплаты, ВыборкаПоРезервам.ОтсрочкаПоСпецУсловиям, ВыборкаПоРезервам.ВидРасчетаДнейПоОтсрочкеПоСпецУсловиям, Договор.ОплатаВЛюбойДень);
	
	Возврат ДатаОплаты;
	
КонецФункции

Функция ДокументРеализации(Соответствие, ДатаОплаты, СтруктураРеализации)
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_ДокументРеализации";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		АлгоритмыЗначениеВозврата = Неопределено;		
		Выполнить(лЗамена);		
		Возврат АлгоритмыЗначениеВозврата;		
	КонецЕсли;	
	///////////////////////////////////////////////////////////////////////////
	
	Документ = Соответствие[ДатаОплаты];
	Если Документ = Неопределено Тогда
		Документ = Документы.РеализацияТоваровУслуг.СоздатьДокумент();
		ЗаполнитьЗначенияСвойств(Документ, СтруктураРеализации);
		Документ.ДатаОплаты = ДатаОплаты;
		Соответствие.Вставить(ДатаОплаты, Документ);
	КонецЕсли;
	
	Возврат Документ;
	
КонецФункции

//Отмена заявок
Функция СтруктураОтменыЗаявки(ОбъектXDTO)
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_СтруктураОтменыЗаявки";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		АлгоритмыЗначениеВозврата = Неопределено;		
		Выполнить(лЗамена);		
		Возврат АлгоритмыЗначениеВозврата;		
	КонецЕсли;	
	///////////////////////////////////////////////////////////////////////////
	
	СтруктураОбъекта = Новый Структура("Отказ,ТекстОшибки", Ложь, "");
	УстановитьРеквизитыЗаявки(СтруктураОбъекта, ОбъектXDTO);
	
	Возврат СтруктураОбъекта; 
	
КонецФункции

Процедура КонтрольВозможностиОтменыЗаявки(СтруктураОбъекта)
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_КонтрольВозможностиОтменыЗаявки";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		Выполнить(лЗамена);
		Возврат;
	КонецЕсли;
	///////////////////////////////////////////////////////////////////////////
	
	Если НЕ СтруктураОбъекта.Отказ Тогда
		Если СтруктураОбъекта.Сток Тогда
			Запрос = Новый Запрос("ВЫБРАТЬ ПЕРВЫЕ 1
			                      |	РеализацияТоваровУслугТовары.Ссылка
			                      |ИЗ
			                      |	Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
			                      |ГДЕ
			                      |	РеализацияТоваровУслугТовары.СтрокаЗаявки = &СтрокаЗаявки
			                      |	И НЕ РеализацияТоваровУслугТовары.Ссылка.ПометкаУдаления
			                      |
			                      |СГРУППИРОВАТЬ ПО
			                      |	РеализацияТоваровУслугТовары.Ссылка");
			Запрос.УстановитьПараметр("СтрокаЗаявки", СтруктураОбъекта.ИдентификаторСтрокиЗаявки);
			Результат = Запрос.Выполнить().Выбрать();
			Если Результат.Следующий() Тогда
				СтруктураОбъекта.Отказ = Истина;
				ТекстОшибки = "По строке заявки(Сток) уже сформирована реализация: " + Результат.Ссылка;
				ДополнитьОшибку(СтруктураОбъекта.ТекстОшибки, ТекстОшибки);
			КонецЕсли;
		Иначе
			Если НЕ СтруктураОбъекта.ИдентификаторСтрокиЗаявки.Заказ.Пустая() Тогда
				СтруктураОбъекта.Отказ = Истина;
				ТекстОшибки = "По строке заявки(Кросс) уже сформирован заказ";
				ДополнитьОшибку(СтруктураОбъекта.ТекстОшибки, ТекстОшибки);
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Процедура ОтменитьСтрокуЗаявки(СтруктураОбъекта, СтруктураОтчета = Неопределено)
	
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_ОтменитьСтрокуЗаявки";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		Выполнить(лЗамена);
		Возврат;
	КонецЕсли;
	///////////////////////////////////////////////////////////////////////////
	
	Если НЕ СтруктураОбъекта.Отказ Тогда
		Документ = СтруктураОбъекта.СсылкаНаДокумент;
		
		Если ТипЗнч(Документ) = Тип("ДокументСсылка.КорректировкаЗаявкиПокупателя") Тогда
			ИзменяемыйОбъект = Документ.Скопировать();
			ИзменяемыйОбъект.Дата = ТекущаяДата();
		Иначе
			ИзменяемыйОбъект = Документ.ПолучитьОбъект();
			ИзменяемыйОбъект.ДополнительныеСвойства.Свойство("СоздаватьКорректировку", Истина);
		КонецЕсли;
		
		СтрокаДокумента = ИзменяемыйОбъект.Товары[СтруктураОбъекта.НомерСтроки];
		КлючСвязи = СтрокаДокумента.КлючСвязи;
		КоличествоИсходное = СтрокаДокумента.Количество;
		КоличествоОтказ = ОтказыПоСтрокеЗаявки(СтрокаДокумента.СтрокаЗаявки);
		
		ОтказыСайта = КоличествоИсходное - КоличествоОтказ;
		Если ОтказыСайта > 0 Тогда
			Строка = ИзменяемыйОбъект.ПричиныОтказов.Добавить();
			Строка.КлючСвязи = КлючСвязи;
			Строка.ПричинаОтмены = Справочники.СостоянияСтрокДокументов.ОтказССайта;
			Строка.Количество = ОтказыСайта;
			Попытка
				ИзменяемыйОбъект.Записать(РежимЗаписиДокумента.Проведение); 
				
				// 05.04.19 Строганов Роман > 
				ОбменДаннымиКлиентСервер.ЗафиксироватьРезультатВСтруктуреОтчета(СтруктураОтчета, ИзменяемыйОбъект.Ссылка, Истина, Ложь);
				// 05.04.19 Строганов Роман <
			Исключение
				ТекстОшибки = ОписаниеОшибки();
				ЗаписьЖурналаРегистрации("Загрузка заявок с сайта", 
				УровеньЖурналаРегистрации.Ошибка, , ИзменяемыйОбъект.Ссылка,
				"Ключ связи: "+КлючСвязи+", Ошибка отмены заявки: " + ТекстОшибки);
				
				// 05.04.19 Строганов Роман > 
				ОбменДаннымиКлиентСервер.ЗафиксироватьРезультатВСтруктуреОтчета(СтруктураОтчета, ИзменяемыйОбъект.Ссылка, Истина, Истина, ТекстОшибки);
				// 05.04.19 Строганов Роман <
			КонецПопытки;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры 

Процедура ЗаписатьЛогОтменыЗаявки(СтруктураДокумента, НомерСообщения, Экспресс)
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_ОтменитьСтрокуЗаявки";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		Выполнить(лЗамена);
		Возврат;
	КонецЕсли;
	///////////////////////////////////////////////////////////////////////////
	
	Запись = РегистрыСведений.ЛогОбменовССайтом.СоздатьМенеджерЗаписи();
	Запись.ПланОбмена = ?(Экспресс, Перечисления.ПланыОбменаССайтом.ПодтверждениеОтменыЗаявок_express, Перечисления.ПланыОбменаССайтом.ПодтверждениеОтменыЗаявок);
	Запись.Ссылка = СтруктураДокумента.ИсходнаяЗаявка.УникальныйИдентификатор();
	Запись.SiteID = СтруктураДокумента.IDSite;
	Запись.НомерСообщенияВходящий = НомерСообщения;
	Запись.Ошибка = СтруктураДокумента.Отказ;
	Запись.ТекстОшибки = СтруктураДокумента.ТекстОшибки;
	Запись.Записать();
	
КонецПроцедуры

//Дополнительные функции
Процедура УстановитьДоговорПоставщика(СтруктураОбъекта, ОбъектXDTO)
	
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_УстановитьДоговорПоставщика";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		Выполнить(лЗамена);
		Возврат;
	КонецЕсли;
	///////////////////////////////////////////////////////////////////////////
	
	СтруктураОбъекта.Вставить("ДоговорПоставщика", Неопределено);
	
	Если ЭтоАктивнаяЗадачаJirа(Справочники.ЗадачиJira.XX2851) И СтруктураОбъекта.ИсточникЗаявки = Перечисления.ИсточникиЗаявок.Inventor Тогда
		//ХудинВВ XX-2851 23072019 
		
		КодПрайса = "";
		Прайс = Неопределено;	
		Если ТипЗнч(ОбъектXDTO) = Тип("Структура") Тогда
			Для Каждого СтрокаXDTO Из ОбъектXDTO.items Цикл
				КодПрайса = СтрокаXDTO.ПрайсПоставщика_Код;
				Прервать;
			КонецЦикла;
		Иначе
			Для Каждого СтрокаXDTO Из ОбъектXDTO.items.ПолучитьСписок("item") Цикл
				КодПрайса = СтрокаXDTO.ПрайсПоставщика_Код;
				Прервать;
			КонецЦикла;
		КонецЕсли;
		
		Если ЗначениеЗаполнено(КодПрайса) Тогда
			Прайс  = Справочники.ПрайсыПоставщиков.НайтиПоКоду(КодПрайса);
		КонецЕсли;
		
		Если ЗначениеЗаполнено(Прайс) Тогда
			ДоговорПоставщика = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Прайс, "Владелец.Владелец.ОсновнойДоговорКонтрагентаЗакупка");
			Если ЗначениеЗаполнено(ДоговорПоставщика) Тогда
				СтруктураОбъекта.ДоговорПоставщика = ДоговорПоставщика;
			КонецЕсли;	
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Процедура УстановитьСсылкуНаДокумент(СтруктураОбъекта, UUID)
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_УстановитьСсылкуНаДокумент";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		Выполнить(лЗамена);
		Возврат;
	КонецЕсли;
	///////////////////////////////////////////////////////////////////////////
	
	СсылкаНаДокумент = Документы.ЗаявкаПокупателя.ПолучитьСсылку(Новый УникальныйИдентификатор(UUID));
	РеквизитыОбъекта = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(СсылкаНаДокумент,"Дата,ВерсияДанных");
	СтруктураОбъекта.Вставить("СсылкаНаДокумент", СсылкаНаДокумент);
	СтруктураОбъекта.Вставить("Дата", ?(ЗначениеЗаполнено(РеквизитыОбъекта.ВерсияДанных), РеквизитыОбъекта.Дата, ТекущаяДата()));
	
КонецПроцедуры

Процедура УстановитьКонтрагентаПоЛогину(СтруктураОбъекта, Логин)
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_УстановитьКонтрагентаПоЛогину";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		Выполнить(лЗамена);
		Возврат;
	КонецЕсли;
	///////////////////////////////////////////////////////////////////////////
	
	СтруктураОбъекта.Вставить("Контрагент", Справочники.Контрагенты.ПустаяСсылка());
	СтруктураОбъекта.Вставить("ТорговаяТочка", Справочники.ТорговыеТочки.ПустаяСсылка());
	СтруктураОбъекта.Вставить("Филиал", Справочники.Филиалы.ПустаяСсылка());
	СтруктураОбъекта.Вставить("Менеджер", Справочники.Менеджеры.ПустаяСсылка());
	
	Запрос = Новый Запрос("ВЫБРАТЬ
	                      |	УчетныеЗаписиСайта.Владелец КАК ТорговаяТочка,
	                      |	УчетныеЗаписиСайта.Владелец.Владелец.Ссылка КАК Контрагент,
	                      |	ЕСТЬNULL(МенеджерыТорговыхТочекСрезПоследних.Менеджер, ЗНАЧЕНИЕ(Справочник.Менеджеры.ПустаяСсылка)) КАК Менеджер,
	                      |	ЕСТЬNULL(УчетныеЗаписиСайта.Владелец.Регион.Филиал, ЗНАЧЕНИЕ(Справочник.Филиалы.ПустаяСсылка)) КАК Филиал
	                      |ИЗ
	                      |	Справочник.УчетныеЗаписиСайта КАК УчетныеЗаписиСайта
	                      |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.МенеджерыТорговыхТочек.СрезПоследних КАК МенеджерыТорговыхТочекСрезПоследних
	                      |		ПО УчетныеЗаписиСайта.Владелец = МенеджерыТорговыхТочекСрезПоследних.ТорговаяТочка
	                      |			И (МенеджерыТорговыхТочекСрезПоследних.ВидМенеджера = ЗНАЧЕНИЕ(Перечисление.ВидыМенеджеров.Продажи))
	                      |ГДЕ
	                      |	УчетныеЗаписиСайта.Код = &Логин");
	Запрос.УстановитьПараметр("Логин", Логин);
	
	Результат = Запрос.Выполнить().Выбрать();
	Если Результат.Следующий() Тогда
		ЗаполнитьЗначенияСвойств(СтруктураОбъекта, Результат);
	Иначе
		СтруктураОбъекта.Отказ = Истина;
		ТекстОшибки = "Не определен контрагент по логину: <" + Логин + ">";
		ДополнитьОшибку(СтруктураОбъекта.ТекстОшибки, ТекстОшибки);
	КонецЕсли;
	
КонецПроцедуры

Процедура УстановитьРеквизитыКонтрагента(СтруктураОбъекта, UUIDДоговора)
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_УстановитьРеквизитыКонтрагента";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		Выполнить(лЗамена);
		Возврат;
	КонецЕсли;
	///////////////////////////////////////////////////////////////////////////
	
	ВалютаРубль = Константы.ВалютаРубль.Получить();
	ВалютаДоллар = Константы.ВалютаДоллар.Получить();
	ВалютаЕвро = Константы.ВалютаЕвро.Получить();
	
	СтруктураОбъекта.Вставить("ДоговорКонтрагента", Справочники.ДоговорыКонтрагентов.ПустаяСсылка());
	СтруктураОбъекта.Вставить("Организация", Справочники.Организации.ПустаяСсылка());
	СтруктураОбъекта.Вставить("ВалютаДокумента", ВалютаРубль);
	СтруктураОбъекта.Вставить("БанковскийСчет", Справочники.БанковскиеСчета.ПустаяСсылка());
	СтруктураОбъекта.Вставить("КурсВзаиморасчетов", 1);
	СтруктураОбъекта.Вставить("КратностьВзаиморасчетов", 1);
	СтруктураОбъекта.Вставить("ТипЦен", Константы.ТипЦен_дляСайта.Получить());
	СтруктураОбъекта.Вставить("УчитыватьНДС", Ложь);
	СтруктураОбъекта.Вставить("СуммаВключаетНДС", Истина);
	СтруктураОбъекта.Вставить("БанковскийСчет ", Справочники.БанковскиеСчета.ПустаяСсылка());
	СтруктураОбъекта.Вставить("ДатаОплаты", СтруктураОбъекта.Дата);
	
	ДанныеДоговора = ДанныеДоговора(СтруктураОбъекта, UUIDДоговора);
	
	Если ДанныеДоговора.Следующий() Тогда
		
		ЗаполнитьЗначенияСвойств(СтруктураОбъекта, ДанныеДоговора,,"ВалютаДокумента, ТипЦен");
		СтруктураОбъекта.ТипЦен = ?(ЗначениеЗаполнено(ДанныеДоговора.ТипЦен), ДанныеДоговора.ТипЦен, СтруктураОбъекта.ТипЦен);
		СтруктураОбъекта.ДатаОплаты = РассчитатьДатуОплаты(СтруктураОбъекта.Дата, ДанныеДоговора.ВидРасчетаДней, ДанныеДоговора.ГлубинаКредита);
		
		//ХудинВВ XX-2851 17072019 ((
		Если ЭтоАктивнаяЗадачаJirа(Справочники.ЗадачиJira.XX2851) Тогда
			СтруктураОбъекта.ВалютаДокумента = ?(ЗначениеЗаполнено(ДанныеДоговора.ВалютаДокумента), ДанныеДоговора.ВалютаДокумента, СтруктураОбъекта.ВалютаДокумента);
			Если  СтруктураОбъекта.ВалютаДокумента <> ВалютаРубль Тогда
				СтруктураОбъекта.УчитыватьНДС = Ложь;
				//Если  СтруктураОбъекта.ВалютаДокумента = ВалютаДоллар Тогда
				//	СтруктураОбъекта.ТипЦен = Константы.ЗакупочныйТипЦенДолл;
				//ИначеЕсли СтруктураОбъекта.ВалютаДокумента = ВалютаЕвро Тогда
				//	СтруктураОбъекта.ТипЦен = Константы.ЗакупочныйТипЦенЕвро;
				//КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		//))
		
	Иначе
		СтруктураОбъекта.Отказ = Истина;
		ТекстОшибки = "Не определен договор по UUID: <" + UUIDДоговора + ">";
		ДополнитьОшибку(СтруктураОбъекта.ТекстОшибки, ТекстОшибки);
	КонецЕсли;
	
КонецПроцедуры

Функция ПолучитьДоговорКонтрагентаЗаявки(СтруктураОбъекта, UUID)
	
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_ПолучитьДоговорКонтрагентаЗаявки";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		АлгоритмыЗначениеВозврата = Неопределено;		
		Выполнить(лЗамена);		
		Возврат АлгоритмыЗначениеВозврата;		
	КонецЕсли;	
	///////////////////////////////////////////////////////////////////////////
	
	Договор = Справочники.ДоговорыКонтрагентов.ПустаяСсылка();
	Если СтруктураОбъекта.ИсточникЗаявки = Перечисления.ИсточникиЗаявок.Inventor
		И ЗначениеЗаполнено(СтруктураОбъекта.ДоговорПоставщика) Тогда
		//Ищем договор соответствующий валюте договора поставщика
		ВалютаДоговораПоставщика = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СтруктураОбъекта.ДоговорПоставщика, "ВалютаВзаиморасчетов");
		
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	ДоговорыКонтрагентов.Ссылка
		|ИЗ
		|	Справочник.ДоговорыКонтрагентов КАК ДоговорыКонтрагентов
		|ГДЕ
		|	ДоговорыКонтрагентов.Владелец = &Владелец
		|	И НЕ ДоговорыКонтрагентов.ПометкаУдаления
		|	И НЕ ДоговорыКонтрагентов.ДоговорПриостановлен
		|	И ДоговорыКонтрагентов.ВалютаВзаиморасчетов = &ВалютаВзаиморасчетов
		|	И ДоговорыКонтрагентов.ВидДоговора = &ВидДоговора";
		
		Запрос.УстановитьПараметр("ВалютаВзаиморасчетов", ВалютаДоговораПоставщика);
		Запрос.УстановитьПараметр("ВидДоговора", Перечисления.ВидыДоговоровКонтрагентов.СПокупателем);
		Запрос.УстановитьПараметр("Владелец", СтруктураОбъекта.Контрагент);
		
		РезультатЗапроса = Запрос.Выполнить();
		
		Выборка = РезультатЗапроса.Выбрать();
		
		Если Выборка.Следующий() Тогда
			Договор = Выборка.Ссылка;
		Иначе
			СтруктураОбъекта.Отказ = Истина;
			ТекстОшибки = "Не найден договор контрагента "+СтруктураОбъекта.Контрагент+" с видом ""с покупателем"", валютой "+ВалютаДоговораПоставщика;
			ДополнитьОшибку(СтруктураОбъекта.ТекстОшибки, ТекстОшибки);
		КонецЕсли;
		
	ИначеЕсли СтруктураОбъекта.ДоговорИзОсновногоДоговора И ЗначениеЗаполнено(СтруктураОбъекта.Контрагент.ОсновнойДоговорКонтрагента) Тогда
		Договор = СтруктураОбъекта.Контрагент.ОсновнойДоговорКонтрагента;
	Иначе
		Договор = Справочники.ДоговорыКонтрагентов.ПолучитьСсылку(Новый УникальныйИдентификатор(UUID));
	КонецЕсли;
	
	Возврат Договор;
	
КонецФункции

Функция ДанныеДоговора(СтруктураОбъекта, UUID)
	
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_ДанныеДоговора";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		АлгоритмыЗначениеВозврата = Неопределено;		
		Выполнить(лЗамена);		
		Возврат АлгоритмыЗначениеВозврата;		
	КонецЕсли;	
	///////////////////////////////////////////////////////////////////////////
	
	Контрагент = СтруктураОбъекта.Контрагент; 
	
	Если ЭтоАктивнаяЗадачаJirа(Справочники.ЗадачиJira.XX2851)  Тогда
		//ХудинВВ XX-2851 23072019 
		Договор = ПолучитьДоговорКонтрагентаЗаявки(СтруктураОбъекта, UUID);
	Иначе
		//28.06.2018: PaSe - Договор по умолчанию решили брать из основного договора контрагента//
		Если СтруктураОбъекта.ДоговорИзОсновногоДоговора И ЗначениеЗаполнено(Контрагент.ОсновнойДоговорКонтрагента) Тогда
			Договор = Контрагент.ОсновнойДоговорКонтрагента;
		Иначе
			Договор = Справочники.ДоговорыКонтрагентов.ПолучитьСсылку(Новый УникальныйИдентификатор(UUID));
		КонецЕсли;
	КонецЕсли;
	
	Запрос = Новый Запрос("ВЫБРАТЬ
	                      |	ДоговорыКонтрагентов.Ссылка КАК ДоговорКонтрагента,
	                      |	ДоговорыКонтрагентов.ГлубинаКредита,
	                      |	ДоговорыКонтрагентов.ВидРасчетаДней,
	                      |	ДоговорыКонтрагентов.Организация,
	                      |	ДоговорыКонтрагентов.ВалютаВзаиморасчетов,
	                      |	ДоговорыКонтрагентов.ВалютаВзаиморасчетов КАК ВалютаДокумента,
	                      |	ДоговорыКонтрагентов.ТипЦен,
	                      |	ВЫБОР
	                      |		КОГДА ДоговорыКонтрагентов.Организация.ВариантУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыУчетаНДС.ПоВидуОплаты)
	                      |			ТОГДА НЕ ДоговорыКонтрагентов.ВидОплаты = ЗНАЧЕНИЕ(Перечисление.ВидыДенежныхСредств.Наличные)
	                      |		ИНАЧЕ ДоговорыКонтрагентов.Организация.ВариантУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыУчетаНДС.Учитывать)
	                      |	КОНЕЦ КАК УчитыватьНДС,
	                      |	ВЫБОР
	                      |		КОГДА ДоговорыКонтрагентов.Организация.ВариантУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыУчетаНДС.ПоВидуОплаты)
	                      |			ТОГДА НЕ ДоговорыКонтрагентов.ВидОплаты = ЗНАЧЕНИЕ(Перечисление.ВидыДенежныхСредств.Наличные)
	                      |		ИНАЧЕ ДоговорыКонтрагентов.Организация.ВариантУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыУчетаНДС.Учитывать)
	                      |	КОНЕЦ КАК СуммаВключаетНДС,
	                      |	ВЫБОР
	                      |		КОГДА ДоговорыКонтрагентов.Владелец.НашРасчетныйСчет <> ЗНАЧЕНИЕ(Справочник.БанковскиеСчета.ПустаяСсылка)
	                      |				И ДоговорыКонтрагентов.Владелец.НашРасчетныйСчет.Владелец = ДоговорыКонтрагентов.Организация
	                      |			ТОГДА ЕСТЬNULL(ДоговорыКонтрагентов.Владелец.НашРасчетныйСчет, ЗНАЧЕНИЕ(Справочник.БанковскиеСчета.ПустаяСсылка))
	                      |		ИНАЧЕ ЕСТЬNULL(ДоговорыКонтрагентов.Организация.ОсновнойБанковскийСчет, ЗНАЧЕНИЕ(Справочник.БанковскиеСчета.ПустаяСсылка))
	                      |	КОНЕЦ КАК БанковскийСчет,
	                      |	ЕСТЬNULL(КурсыВалютСрезПоследних.Курс, 1) КАК КурсВзаиморасчетов,
	                      |	ЕСТЬNULL(КурсыВалютСрезПоследних.Кратность, 1) КАК КратностьВзаиморасчетов
	                      |ИЗ
	                      |	Справочник.ДоговорыКонтрагентов КАК ДоговорыКонтрагентов
	                      |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КурсыВалют.СрезПоследних(&Период, ) КАК КурсыВалютСрезПоследних
	                      |		ПО ДоговорыКонтрагентов.ВалютаВзаиморасчетов = КурсыВалютСрезПоследних.Валюта
	                      |ГДЕ
	                      |	ДоговорыКонтрагентов.Ссылка = &Договор");
	Запрос.УстановитьПараметр("Договор", Договор);
	Запрос.УстановитьПараметр("Период", СтруктураОбъекта.Дата);
	
	//ХудинВВ XX-2851 17072019 Добавил валюту документа

	
	Возврат Запрос.Выполнить().Выбрать();
	
КонецФункции


//ХудинВВ XX-2298 22052019
Процедура УстановитьСкладПополнения(СтруктураОбъекта)
	
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_УстановитьСкладПополнения";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		Выполнить(лЗамена);
		Возврат;
	КонецЕсли;
	///////////////////////////////////////////////////////////////////////////
	
	СтруктураОбъекта.Вставить("СкладПополнения", Справочники.Склады.ПустаяСсылка());
	
	Запрос = Новый Запрос("ВЫБРАТЬ ПЕРВЫЕ 1
	                      |	Склады.Ссылка КАК Склад
	                      |ИЗ
	                      |	Справочник.Склады КАК Склады
	                      |ГДЕ
	                      |	Склады.КонтрагентПополнениеСклада = &Контрагент
	                      |	И НЕ Склады.ПометкаУдаления
	                      |
	                      |УПОРЯДОЧИТЬ ПО
	                      |	Склады.ОсновнойСкладРегиона УБЫВ");
	Запрос.УстановитьПараметр("Контрагент", СтруктураОбъекта.Контрагент);
	РезультатЗапроса = Запрос.Выполнить().Выбрать();
	Если РезультатЗапроса.Следующий() Тогда
		СтруктураОбъекта.СкладПополнения = РезультатЗапроса.Склад;
	КонецЕсли;
	
КонецПроцедуры


Процедура УстановитьВидОперации(СтруктураОбъекта)
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_УстановитьВидОперации";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		Выполнить(лЗамена);
		Возврат;
	КонецЕсли;
	///////////////////////////////////////////////////////////////////////////
	
	
	//ХудинВВ XX-2298 22052019
	Если ЗначениеЗаполнено(СтруктураОбъекта.СкладПополнения) Тогда
		СтруктураОбъекта.Вставить("ВидОперации",Перечисления.ВидыОперацийЗаявкаПокупателя.ПополнениеСклада);
	ИначеЕсли ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СтруктураОбъекта.Склад,"Код") = "000000031" тогда
		//#XX-2298 Kalinin V.A. ( 2019-04-17 )  /*
		////позже перепишу на нормальный признак
		СтруктураОбъекта.Вставить("ВидОперации", Перечисления.ВидыОперацийЗаявкаПокупателя.БонусыБезСборки);
	Иначе
		СтруктураОбъекта.Вставить("ВидОперации", Перечисления.ВидыОперацийЗаявкаПокупателя.ЗаявкаПокупателя);
	КонецЕсли;
	
	
	////#XX-2298 Kalinin V.A. ( 2019-04-17 )  /*
	////позже перепишу на нормальный признак
	//Если ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СтруктураОбъекта.Склад,"Код") = "000000031" тогда
	//////если   ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СтруктураОбъекта.Склад,"Бонусный") тогда 
	//	СтруктураОбъекта.Вставить("ВидОперации", Перечисления.ВидыОперацийЗаявкаПокупателя.БонусыБезСборки);
	//иначе
	//	СтруктураОбъекта.Вставить("ВидОперации", Перечисления.ВидыОперацийЗаявкаПокупателя.ЗаявкаПокупателя);
	//КонецЕсли;	
	//// */
	//
	//СтруктураОбъекта.Вставить("СкладПополнения", Справочники.Склады.ПустаяСсылка());
	//
	//Запрос = Новый Запрос("ВЫБРАТЬ ПЕРВЫЕ 1
	//                      |	Склады.Ссылка КАК Склад
	//                      |ИЗ
	//                      |	Справочник.Склады КАК Склады
	//                      |ГДЕ
	//                      |	Склады.КонтрагентПополнениеСклада = &Контрагент
	//                      |	И НЕ Склады.ПометкаУдаления
	//                      |
	//                      |УПОРЯДОЧИТЬ ПО
	//                      |	Склады.ОсновнойСкладРегиона УБЫВ");
	//Запрос.УстановитьПараметр("Контрагент", СтруктураОбъекта.Контрагент);
	//РезультатЗапроса = Запрос.Выполнить().Выбрать();
	//Если РезультатЗапроса.Следующий() Тогда
	//	СтруктураОбъекта.ВидОперации = Перечисления.ВидыОперацийЗаявкаПокупателя.ПополнениеСклада;
	//	СтруктураОбъекта.СкладПополнения = РезультатЗапроса.Склад;
	//КонецЕсли;
	
КонецПроцедуры

Процедура УстановитьАукцион(СтруктураОбъекта, ОбъектXDTO)
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_УстановитьАукцион";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		Выполнить(лЗамена);
		Возврат;
	КонецЕсли;
	///////////////////////////////////////////////////////////////////////////
	
	IDАукциона = ОбъектXDTO.АукционID;
	СтруктураОбъекта.Вставить("АукционОбъект", Неопределено);
	СтруктураОбъекта.Вставить("АукционнаяЗаявка", Ложь);
	
	Если ЗначениеЗаполнено(IDАукциона) Тогда
		АукционСсылка = Справочники.АукционПоставщиков.НайтиПоРеквизиту("ИдентификаторАукциона", IDАукциона);
		Если АукционСсылка.Пустая() Тогда
			АукционОбъект = Справочники.АукционПоставщиков.СоздатьЭлемент();
			АукционОбъект.ОбщееЧислоЗаявок = ОбъектXDTO.КоличествоЗаявокВАукционе;
			АукционОбъект.ИдентификаторАукциона = IDАукциона;
			// 11.03.19 Строганов Роман > 
			АукционОбъект.Записать();
			// 11.03.19 Строганов Роман <
		Иначе
			АукционОбъект = АукционСсылка.ПолучитьОбъект();
		КонецЕсли;
		
		Если АукционОбъект.Заявки.Найти(СтруктураОбъекта.СсылкаНаДокумент, "Заявка") = Неопределено Тогда
			Строка = АукционОбъект.Заявки.Добавить();
			Строка.Заявка = СтруктураОбъекта.СсылкаНаДокумент;
		КонецЕсли;
		
		СтруктураОбъекта.АукционОбъект = АукционОбъект;
		СтруктураОбъекта.АукционнаяЗаявка = Истина;
	КонецЕсли;
	
КонецПроцедуры

Процедура УстановитьРеквизитыНоменклатуры(СтруктураОбъекта, Строка, UUID, НаименованиеНоменклатуры)
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_УстановитьРеквизитыНоменклатуры";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		Выполнить(лЗамена);
		Возврат;
	КонецЕсли;
	///////////////////////////////////////////////////////////////////////////
	
	Строка.Номенклатура = НоменклатураПоUUID(Строка(UUID), СтруктураОбъекта, НаименованиеНоменклатуры);
	//Перенесено в общий модуль, можно будет заменить после проверки//
	//Строка.Номенклатура = DataExchangeModule.НоменклатураПоUUID(Строка(UUID), СтруктураОбъекта, НаименованиеНоменклатуры);
	Если Строка.Номенклатура.Пустая() Тогда
		СтруктураОбъекта.Отказ = Истина;
		ТекстОшибки = "Не удалось определить номенклатуру: UUID = <" + UUID + ">";
		ДополнитьОшибку(СтруктураОбъекта.ТекстОшибки, ТекстОшибки);
	Иначе
		Строка.ЕдиницаИзмерения = Строка.Номенклатура.ЕдиницаХраненияОстатков;
		Строка.Коэффициент = ?(ЗначениеЗаполнено(Строка.ЕдиницаИзмерения), Строка.ЕдиницаИзмерения.Коэффициент, 1);
		Строка.СтавкаНДС = Строка.Номенклатура.СтавкаНДС;
		
		// 15.07.19 Строганов Роман > XX-2842 
		Если Не СтроковыеФункцииКлиентСервер.ЕстьКириллицаВСтроке(Строка.Номенклатура.Наименование) Тогда
			НоменклатураОбъект = Строка.Номенклатура.ПолучитьОбъект();
			СтруктураВозврата = НоменклатураОбъект.ПроверитьНаименование();
			Если Не СтруктураВозврата.Ошибка Тогда
				НоменклатураОбъект.ОбменДанными.Загрузка = Истина;
				НоменклатураОбъект.Записать();
			КонецЕсли;
		КонецЕсли;
		// 15.07.19 Строганов Роман < XX-2842
	КонецЕсли;
	
КонецПроцедуры

Процедура УстановитьРеквизитыПрайса(СтруктураОбъекта, СтрокаТовары, КодПрайсаПоставщика)
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_УстановитьРеквизитыПрайса";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		Выполнить(лЗамена);
		Возврат;
	КонецЕсли;
	///////////////////////////////////////////////////////////////////////////
	
	СтрокаТовары.ПрайсПоставщика = Справочники.ПрайсыПоставщиков.НайтиПоКоду(КодПрайсаПоставщика);
	Если СтрокаТовары.ПрайсПоставщика.Пустая() Тогда
		СтруктураОбъекта.Отказ = Истина;
		ТекстОшибки = "Не удалось определить прайс поставщика: Код = <" + КодПрайсаПоставщика + ">";
		ДополнитьОшибку(СтруктураОбъекта.ТекстОшибки, ТекстОшибки);		
	Иначе
		Склад = СтрокаТовары.ПрайсПоставщика.Склад;
		МассивСкладов = СтруктураОбъекта.Склады;
		Если ЗначениеЗаполнено(Склад) И МассивСкладов.Найти(Склад) = Неопределено Тогда
			МассивСкладов.Добавить(Склад);
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Процедура УстановитьСкладДокумента(СтруктураОбъекта, ЦентральныйСклад)
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_УстановитьСкладДокумента";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		Выполнить(лЗамена);
		Возврат;
	КонецЕсли;
	///////////////////////////////////////////////////////////////////////////	
	
	Если НЕ ЦентральныйСклад Тогда
		Если СтруктураОбъекта.Склады.Количество() > 0 Тогда
			СтруктураОбъекта.Склад = СтруктураОбъекта.Склады[0];
		ИначеЕсли ЗначениеЗаполнено(СтруктураОбъекта.СкладПополнения) Тогда
			СтруктураОбъекта.Склад = СтруктураОбъекта.СкладПополнения;
		КонецЕсли;
	КонецЕсли;
	
	//ХудинВВ XX-2750 04072019 ((
	Если ЭтоАктивнаяЗадачаJirа(Справочники.ЗадачиJira.XX2750) Тогда
		
		СтарыйСкладМосквы 	= Константы.Склад_Москва.Получить();
		НовыйСкладМосквы 	= Константы.Склад_Москва_новый.Получить();
		
		Если ЗначениеЗаполнено(СтарыйСкладМосквы) И СтруктураОбъекта.Склад = СтарыйСкладМосквы Тогда
			СтруктураОбъекта.Склад = НовыйСкладМосквы;
		КонецЕсли;

	КонецЕсли;
	// ))

	
	////#XX-2298 Kalinin V.A. ( 2019-04-17 )  /*	
	//если  ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СтруктураОбъекта.Склад,"Бонусный") тогда 
	//	СтруктураОбъекта.Вставить("ВидОперации", Перечисления.ВидыОперацийЗаявкаПокупателя.БонусыБезСборки);
	//КонецЕсли;	
	//// */
	
	Если СтруктураОбъекта.Филиал.Пустая() И НЕ СтруктураОбъекта.Склад.Пустая() Тогда
		СтруктураОбъекта.Филиал = СтруктураОбъекта.Склад.Филиал;
	КонецЕсли;
	
	Если ЭтоАктивнаяЗадачаJirа(Справочники.ЗадачиJira.XX2768) Тогда
		Если СтруктураОбъекта.ТипДоставки = ПредопределенноеЗначение("Справочник.ТипыДоставки.СамовывозНовый") И ЗначениеЗаполнено(СтруктураОбъекта.СамовывозСклад) Тогда
			СтруктураОбъекта.МаршрутДоставки = СтруктураОбъекта.СамовывозСклад.МаршрутДоставкиСамовывоза;
		ИначеЕсли СтруктураОбъекта.Самовывоз И ЗначениеЗаполнено(СтруктураОбъекта.Склад) Тогда 
			СтруктураОбъекта.МаршрутДоставки = СтруктураОбъекта.Склад.МаршрутДоставкиСамовывоза;
		КонецЕсли;
	Иначе
		Если СтруктураОбъекта.Самовывоз И ЗначениеЗаполнено(СтруктураОбъекта.Склад) Тогда
			СтруктураОбъекта.МаршрутДоставки = СтруктураОбъекта.Склад.МаршрутДоставкиСамовывоза;
		КонецЕсли;
	КонецЕсли;
	
	Если СтруктураОбъекта.Склад.Пустая() Тогда
		СтруктураОбъекта.Отказ = Истина;
		ТекстОшибки = "Не удалось определить склад. Требуется указать <Основной склад> в константах";
		ДополнитьОшибку(СтруктураОбъекта.ТекстОшибки, ТекстОшибки);	
	КонецЕсли;
	
КонецПроцедуры

Процедура ДополнитьОшибку(Строка, Дополнение)
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_ДополнитьОшибку";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		Выполнить(лЗамена);
		Возврат;
	КонецЕсли;
	///////////////////////////////////////////////////////////////////////////
	
	Строка = Строка + ?(Строка = "", "", Символы.ПС) + Дополнение;
	
КонецПроцедуры

Процедура КорректировкаЦенБонусныхСкладов(СтруктураОбъекта)
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_КорректировкаЦенБонусныхСкладов";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		Выполнить(лЗамена);
		Возврат;
	КонецЕсли;
	///////////////////////////////////////////////////////////////////////////
	
	Если НЕ СтруктураОбъекта.Склад.Пустая() И СтруктураОбъекта.Склад.Бонусный Тогда
		СтруктураОбъекта.Товары.ЗаполнитьЗначения(0,"Цена,ЦенаСоСкидкой,Сумма,СуммаНДС");
	КонецЕсли;
	
КонецПроцедуры

Процедура КонтрольЗаполненияСроковЗаказа(СтруктураОбъекта, Строка)
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_КонтрольЗаполненияСроковЗаказа";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		Выполнить(лЗамена);
		Возврат;
	КонецЕсли;
	///////////////////////////////////////////////////////////////////////////
	
	Если	(НЕ ЗначениеЗаполнено(Строка.СрокГарантированный) ИЛИ НЕ ЗначениеЗаполнено(Строка.СрокОжидаемый) ИЛИ
			 НЕ ЗначениеЗаполнено(Строка.СрокГарантированныйЗаказа) ИЛИ НЕ ЗначениеЗаполнено(Строка.СрокОжидаемыйЗаказа)) И СтруктураОбъекта.Подтверждена Тогда
			 
			СтруктураОбъекта.Подтверждена = Ложь;
			ТекстОшибки = "Не заполнены сроки выполнения заказа в строке IDSite: <" + Строка.IDSite + ">";
			ДополнитьОшибку(СтруктураОбъекта.ТекстОшибки, ТекстОшибки);
			
			СтруктураОбъекта.ОшибкаЗаполненияСроковЗаказа = Истина;
			ТекстОшибки = "IDSite: <" + Строка.IDSite + ">";
			ДополнитьОшибку(СтруктураОбъекта.ТекстОшибкиЗаполненияСроковЗаказа, ТекстОшибки);

	КонецЕсли;
	
КонецПроцедуры

Функция РассчитатьДатуОплаты(ДатаДокумента, ВариантРасчетаДней, ГлубинаКредита)
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_РассчитатьДатуОплаты";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		АлгоритмыЗначениеВозврата = Неопределено;		
		Выполнить(лЗамена);		
		Возврат АлгоритмыЗначениеВозврата;		
	КонецЕсли;	
	///////////////////////////////////////////////////////////////////////////
	
	ДатаОплаты = ДатаДокумента;
	
	Если ВариантРасчетаДней = Перечисления.ВидыРасчетаДней.ПоКалендарнымДням Тогда
		ДатаОплаты = ДатаОплаты + ГлубинаКредита*24*60*60;
	ИначеЕсли ГлубинаКредита > 0 Тогда
		Запрос = Новый Запрос("ВЫБРАТЬ ПЕРВЫЕ 12345
		                      |	ДатыКалендарей.ДатаКалендаря
		                      |ИЗ
		                      |	РегистрСведений.ДатыКалендарей КАК ДатыКалендарей
		                      |ГДЕ
		                      |	ДатыКалендарей.ДатаКалендаря > &НачальнаяДата
		                      |	И ДатыКалендарей.Календарь = ЗНАЧЕНИЕ(Справочник.Календари.Регламентированный)
		                      |	И ДатыКалендарей.ВидДня В (ЗНАЧЕНИЕ(Перечисление.ВидыДнейКалендаря.Рабочий), ЗНАЧЕНИЕ(Перечисление.ВидыДнейКалендаря.Предпраздничный))");
		Запрос.УстановитьПараметр("НачальнаяДата", ДатаДокумента);
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "12345", Формат(ГлубинаКредита, "ЧГ="));
		Результат = Запрос.Выполнить().Выгрузить();
		Если Результат.Количество() = ГлубинаКредита Тогда
			ДатаОплаты = Результат[ГлубинаКредита-1].ДатаКалендаря;
		Иначе
			СчетчикДней = ГлубинаКредита;
			Пока СчетчикДней > 0 Цикл
				ДатаОплаты = ДатаОплаты + 24*60*60;
				ДеньНедели = ДеньНедели(ДатаОплаты);
				ЭтоБуднийДень = (ДеньНедели = 6) Или (ДеньНедели = 7);
				СчетчикДней = СчетчикДней - ?(ЭтоБуднийДень, 1, 0);
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;
	
	Возврат ДатаОплаты;
	
КонецФункции

Функция СледующийДень(Дата)
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_СледующийДень";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		АлгоритмыЗначениеВозврата = Неопределено;		
		Выполнить(лЗамена);		
		Возврат АлгоритмыЗначениеВозврата;		
	КонецЕсли;	
	///////////////////////////////////////////////////////////////////////////
	
	Возврат КонецДня(КонецДня(Дата)+10);
	
КонецФункции

Функция ПолучитьКомментарий(Строка)
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_ПолучитьКомментарий";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		АлгоритмыЗначениеВозврата = Неопределено;		
		Выполнить(лЗамена);		
		Возврат АлгоритмыЗначениеВозврата;		
	КонецЕсли;	
	///////////////////////////////////////////////////////////////////////////
	
	Подстрока = СокрЛП(Строка);
	Подстрока = СтрЗаменить(Подстрока, Символ(13), " ");
	Подстрока = СтрЗаменить(Подстрока, Символ(10), "");
	Подстрока = СтрЗаменить(Подстрока, "'"," ");
	Подстрока = СтрЗаменить(Подстрока, "\","/");
	
	Возврат Подстрока;
	
КонецФункции

Функция ДанныеНоменклатурыПоUUID(UUID, Отказ)
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_ДанныеНоменклатурыПоUUID";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		АлгоритмыЗначениеВозврата = Неопределено;		
		Выполнить(лЗамена);		
		Возврат АлгоритмыЗначениеВозврата;		
	КонецЕсли;	
	///////////////////////////////////////////////////////////////////////////
	
	Заголовки = Новый Соответствие;
	Заголовки.Вставить("Content-Type", "application/x-www-form-urlencoded");
	
	ПараметрыЗапроса = "uuid=" + UUID;
	
	HTTPСоединение = Новый HTTPСоединение(АдресWEBСервиса());
	HTTPЗапрос = Новый HTTPЗапрос("/uuid/part_by_uuid", Заголовки); 
	HTTPЗапрос.УстановитьТелоИзСтроки(ПараметрыЗапроса, КодировкаТекста.UTF8, ИспользованиеByteOrderMark.НеИспользовать);
	Ответ = HTTPСоединение.ОтправитьДляОбработки(HTTPЗапрос);
	
	Если Ответ.КодСостояния = 200 Тогда
		Текст = Ответ.ПолучитьТелоКакСтроку();
			
		ЧтениеXML = Новый ЧтениеXML;
		ЧтениеXML.УстановитьСтроку(Текст);

		ПостроительDOM = Новый ПостроительDOM;
		ДокументDOM  = ПостроительDOM.Прочитать(ЧтениеXML);
	Иначе
		Отказ = Истина;
		ДокументDOM = Неопределено;
	КонецЕсли;
	
	Возврат ДокументDOM;
	
КонецФункции

Функция АдресWEBСервиса()
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_АдресWEBСервиса";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		АлгоритмыЗначениеВозврата = Неопределено;		
		Выполнить(лЗамена);		
		Возврат АлгоритмыЗначениеВозврата;		
	КонецЕсли;	
	///////////////////////////////////////////////////////////////////////////
	
	Настройка = Справочники.НастройкиРеквизитовДляОбменов.API_Сайт;
	
	Если ОбщегоНазначения.ЭтоРабочаяИнформационнаяБаза() Тогда
		Адрес = Настройка.СтрокаДляРабочейБазы;
	Иначе
		Адрес = Настройка.СтрокаДляТестовойБазы;
	КонецЕсли;
	
	Возврат Адрес;
	
КонецФункции

Функция ЗначениеЭлементаDOM(ДокументDOM, Путь, Разыменователь, ЗначениеПоУмолчанию)
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_ЗначениеЭлементаDOM";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		АлгоритмыЗначениеВозврата = Неопределено;		
		Выполнить(лЗамена);		
		Возврат АлгоритмыЗначениеВозврата;		
	КонецЕсли;	
	///////////////////////////////////////////////////////////////////////////
	
	РезультатXPath = ДокументDOM.ВычислитьВыражениеXPath (Путь, ДокументDOM, Разыменователь);
	ПолученныйЭлемент = РезультатXPath.ПолучитьСледующий();
	
	Возврат ?(ПолученныйЭлемент = Неопределено, ЗначениеПоУмолчанию, ПолученныйЭлемент.ТекстовоеСодержимое);
	
КонецФункции
Функция НоменклатураПоUUID(UUID, СтруктураОбъекта, НаименованиеНоменклатуры)
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_НоменклатураПоUUID";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		АлгоритмыЗначениеВозврата = Неопределено;		
		Выполнить(лЗамена);		
		Возврат АлгоритмыЗначениеВозврата;		
	КонецЕсли;	
	///////////////////////////////////////////////////////////////////////////
	
	НоменклатураСсылка = Справочники.Номенклатура.ПолучитьСсылку(Новый УникальныйИдентификатор(UUID));
	Если ЗначениеЗаполнено(НоменклатураСсылка.ВерсияДанных) Тогда
		Номенклатура = НоменклатураСсылка;
	Иначе
		Номенклатура = Справочники.Номенклатура.ПустаяСсылка();
		Отказ = Ложь;
		//Получили реквизиты номенклатуры с WS Сайта//
		ДокументDOM  = ДанныеНоменклатурыПоUUID(UUID, Отказ);
		Если НЕ Отказ Тогда
			//Сайт выдал читаемый результат//
			Разыменователь = Новый РазыменовательПространствИменDOM(ДокументDOM);
			
			НоменклатураНайдена = (ЗначениеЭлементаDOM(ДокументDOM, "/response/success", Разыменователь, 0) = "1");
			Если НоменклатураНайдена Тогда
				//Сайт выдал реквизиты номенклатуры
				//Наименование = ЗначениеЭлементаDOM(ДокументDOM, "/response/data/name", Разыменователь, "");
				//У сайта есть наше наименование и наименование поставщика, зависящее от прайса,
				//т.к. часто сайт возвращает пустое или левое наименование, теперь берем его непосредственно из заявки
				Наименование = НаименованиеНоменклатуры;
				БрендНаименование = ЗначениеЭлементаDOM(ДокументDOM, "/response/data/brand/name", Разыменователь, "");
				БрендUUID = ЗначениеЭлементаDOM(ДокументDOM, "/response/data/brand/uuid", Разыменователь, "");
				Артикул = ЗначениеЭлементаDOM(ДокументDOM, "/response/data/number", Разыменователь, "");
				
				Бренд = БрендПоUUID(БрендUUID, Наименование);
				
				Попытка
					//Создаем новый элемент с нужными реквизитами//
					ЕдиницаИзмерения = Справочники.ЕдиницыИзмерения.СоздатьЭлемент();
					ЕдиницаИзмерения.Владелец = НоменклатураСсылка;
					ЕдиницаИзмерения.ЕдиницаПоКлассификатору = Константы.ОсновнаяЕдиницаПоКлассификатору.Получить();
					ЕдиницаИзмерения.Коэффициент = 1;
					ЕдиницаИзмерения.Наименование = ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Наименование;
					ЕдиницаИзмерения.ОбменДанными.Загрузка = Истина;
					ЕдиницаИзмерения.УстановитьНовыйКод();
					ЕдиницаИзмерения.Записать();
					
					НовыйЭлемент = Справочники.Номенклатура.СоздатьЭлемент();
					НовыйЭлемент.УстановитьСсылкуНового(НоменклатураСсылка);
					НовыйЭлемент.Наименование = Наименование;
					// + 20181012 Пушкин XX-1114
					НовыйЭлемент.НаименованиеПолное = Наименование;
					// - 20181012 Пушкин XX-1114
					
					//Добавлено Валиахметов А.А. 25.01.2019 XX-878
					НовыйЭлемент.ВидЛиквидности = Перечисления.ВидыЛиквидности.НеЛиквидный;
					//Конец Добавлено Валиахметов А.А. 25.01.2019 XX-878
					
					НовыйЭлемент.Изготовитель = Бренд;
					НовыйЭлемент.Артикул = Артикул;
					НовыйЭлемент.ЕдиницаХраненияОстатков = ЕдиницаИзмерения.Ссылка;
					НовыйЭлемент.СтавкаНДС = Перечисления.СтавкиНДС.НДС20;
					НовыйЭлемент.ДатаСоздания = ТекущаяДата();
					НовыйЭлемент.ОбменДанными.Загрузка = Истина;
					НовыйЭлемент.УстановитьНовыйКод();
					НовыйЭлемент.Записать();
					
					Номенклатура = НовыйЭлемент.Ссылка;
					//Семенов И.П. 28.01.2019 XX-1768(
					ОбменДаннымиКлиентСервер.ДобавитьСтрокуИсторииПоОбъекту(Номенклатура, ДокументDOM);
					//)Семенов И.П.
				Исключение
					СтруктураОбъекта.Отказ = Истина;
					ТекстОшибки = "Не записать номенклатуру: UUID = <" + UUID + ">" + ОписаниеОшибки();
					ДополнитьОшибку(СтруктураОбъекта.ТекстОшибки, ТекстОшибки);
					//Семенов И.П. 28.01.2019 XX-1768(
					ОбменДаннымиКлиентСервер.ДобавитьСтрокуИсторииПоОбъекту(UUID, ДокументDOM, "Справочник.Номенклатура",Истина,ОписаниеОшибки());
					//)Семенов И.П.
				КонецПопытки;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	Возврат Номенклатура;
	
КонецФункции

Функция БрендПоUUID(UUID, Наименование)
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_БрендПоUUID";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		АлгоритмыЗначениеВозврата = Неопределено;		
		Выполнить(лЗамена);		
		Возврат АлгоритмыЗначениеВозврата;		
	КонецЕсли;	
	///////////////////////////////////////////////////////////////////////////
	
	БрендСсылка = Справочники.Изготовители.ПолучитьСсылку(Новый УникальныйИдентификатор(UUID));
	Если НЕ ЗначениеЗаполнено(БрендСсылка.ВерсияДанных) Тогда
		
		НовыйЭлемент = Справочники.Изготовители.СоздатьЭлемент();
		НовыйЭлемент.УстановитьСсылкуНового(БрендСсылка);
		НовыйЭлемент.Наименование = Наименование;
		НовыйЭлемент.Записать();
		
	КонецЕсли;
	
	Возврат БрендСсылка;
	
КонецФункции

Процедура УстановитьРеквизитыЗаявки(СтруктураОбъекта, ОбъектXDTO)
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_УстановитьРеквизитыЗаявки";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		Выполнить(лЗамена);
		Возврат;
	КонецЕсли;
	///////////////////////////////////////////////////////////////////////////
	
	Документ = Документы.ЗаявкаПокупателя.ПолучитьСсылку(ОбъектXDTO.Ссылка);
	СтруктураОбъекта.Вставить("ИсходнаяЗаявка", Документ);
	СтруктураОбъекта.Вставить("IDSite", ОбъектXDTO.IDSite);
	Если ЗначениеЗаполнено(Документ.ВерсияДанных) Тогда
		СтруктураОбъекта.Вставить("СсылкаНаДокумент", Документы.ЗаявкаПокупателя.ПолучитьПоследнийДокументКорректировки(Документ));
		СтрокиПоIDSite = Документ.Товары.НайтиСтроки(Новый Структура("IDSite", ОбъектXDTO.IDSite));
		Если СтрокиПоIDSite.Количество() = 0 Тогда
			СтруктураОбъекта.Отказ = Истина;
			ТекстОшибки = "Не определена строка заявки по IDSite";
			ДополнитьОшибку(СтруктураОбъекта.ТекстОшибки, ТекстОшибки);
		ИначеЕсли СтрокиПоIDSite.Количество() > 1 Тогда
			СтруктураОбъекта.Отказ = Истина;
			ТекстОшибки = "Несколько строк с указанным IDSite";
			ДополнитьОшибку(СтруктураОбъекта.ТекстОшибки, ТекстОшибки);
		Иначе
			Строка = СтрокиПоIDSite[0];
			СтруктураОбъекта.Вставить("ИдентификаторСтрокиЗаявки", Строка.СтрокаЗаявки);
			СтруктураОбъекта.Вставить("НомерСтроки", Строка.НомерСтроки - 1);
			СтруктураОбъекта.Вставить("Сток", НЕ КроссЗаявка(Документ, Строка.ПрайсПоставщика));
			Если СтруктураОбъекта.ИдентификаторСтрокиЗаявки.Пустая() Тогда
				СтруктураОбъекта.Отказ = Истина;
				ТекстОшибки = "В строке не указан идентификатор строки заявки";
				ДополнитьОшибку(СтруктураОбъекта.ТекстОшибки, ТекстОшибки);
			КонецЕсли;
		КонецЕсли;
	Иначе
		СтруктураОбъекта.Отказ = Истина;
		ТекстОшибки = "Не определен документ заявки";
		ДополнитьОшибку(СтруктураОбъекта.ТекстОшибки, ТекстОшибки);
	КонецЕсли;
	
КонецПроцедуры

Функция ОтказыПоСтрокеЗаявки(СтрокаЗаявки)
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_ОтказыПоСтрокеЗаявки";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		АлгоритмыЗначениеВозврата = Неопределено;		
		Выполнить(лЗамена);		
		Возврат АлгоритмыЗначениеВозврата;		
	КонецЕсли;	
	///////////////////////////////////////////////////////////////////////////
	
	Запрос = Новый Запрос("ВЫБРАТЬ
	                      |	ОтказыПоЗаявкамОбороты.КоличествоОборот КАК Отказы
	                      |ИЗ
	                      |	РегистрНакопления.ОтказыПоЗаявкам.Обороты(, , , СтрокаЗаявки = &СтрокаЗаявки) КАК ОтказыПоЗаявкамОбороты");
	Запрос.УстановитьПараметр("СтрокаЗаявки", СтрокаЗаявки);
	Выборка = Запрос.Выполнить().Выбрать();
	
	Возврат ?(Выборка.Следующий(), Выборка.Отказы, 0);
	
КонецФункции

Функция КроссЗаявка(Документ, ПрайсПоставщика)
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_КроссЗаявка";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		АлгоритмыЗначениеВозврата = Неопределено;		
		Выполнить(лЗамена);		
		Возврат АлгоритмыЗначениеВозврата;		
	КонецЕсли;	
	///////////////////////////////////////////////////////////////////////////
	
	КроссЗаявка = Истина;
	Если Документ.ВидОперации <> Перечисления.ВидыОперацийЗаявкаПокупателя.ПополнениеСклада Тогда
		Если ПрайсПоставщика.Пустая() Тогда
			КроссЗаявка = Ложь;
		ИначеЕсли НЕ ПрайсПоставщика.Склад.Пустая() Тогда
			КроссЗаявка = Ложь;
		КонецЕсли;
	КонецЕсли;
	
	Возврат КроссЗаявка;
	
КонецФункции

Функция ТипПоставки(ТипПоставкиСтрока)
	 лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_ТипПоставки";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		АлгоритмыЗначениеВозврата = Неопределено;		
		Выполнить(лЗамена);		
		Возврат АлгоритмыЗначениеВозврата;		
	КонецЕсли;	
	///////////////////////////////////////////////////////////////////////////
	
	Если Нрег(ТипПоставкиСтрока) = "vmi" Тогда
		ТипПоставки = Перечисления.ТипПоставки.VMI;
	ИначеЕсли Нрег(ТипПоставкиСтрока) = "cross" Тогда
		ТипПоставки = Перечисления.ТипПоставки.Кросс;
	ИначеЕсли Нрег(ТипПоставкиСтрока) = "inventor" Тогда
		ТипПоставки = Перечисления.ТипПоставки.ПополнениеСклада;
	Иначе
		ТипПоставки = Перечисления.ТипПоставки.Сток;
	КонецЕсли;
	
	Возврат ТипПоставки;
	
КонецФункции

Функция Узел(Входящий = Истина) Экспорт
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_Узел";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		АлгоритмыЗначениеВозврата = Неопределено;		
		Выполнить(лЗамена);		
		Возврат АлгоритмыЗначениеВозврата;		
	КонецЕсли;	
	///////////////////////////////////////////////////////////////////////////
	
	Запрос = Новый Запрос("ВЫБРАТЬ ПЕРВЫЕ 1
	                      |	ОбменПартКом83_Сайт_состояние_заявок.Ссылка
	                      |ИЗ
	                      |	ПланОбмена.ОбменПартКом83_Сайт_состояние_заявок КАК ОбменПартКом83_Сайт_состояние_заявок
	                      |ГДЕ
	                      |	НЕ ОбменПартКом83_Сайт_состояние_заявок.ЭтотУзел
	                      |	И (&Входящий
	                      |				И ОбменПартКом83_Сайт_состояние_заявок.Входящий
	                      |			ИЛИ НЕ &Входящий
	                      |				И ОбменПартКом83_Сайт_состояние_заявок.Исходящий)");
	Запрос.УстановитьПараметр("Входящий", Входящий);
	Выборка = Запрос.Выполнить().Выбрать();
	
	Возврат ?(Выборка.Следующий(), Выборка.Ссылка, ПланыОбмена.ОбменПартКом83_Сайт_состояние_заявок.ПустаяСсылка());
	
КонецФункции

Функция ИсточникЗаявки(Source,Контрагент = Неопределено)
	лКлючАлгоритма = "ПланОбмена_ОбменПартКом83_Сайт_состояние_заявок_МодульМенеджера_ИсточникЗаявки";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		АлгоритмыЗначениеВозврата = Неопределено;		
		Выполнить(лЗамена);		
		Возврат АлгоритмыЗначениеВозврата;		
	КонецЕсли;	
	///////////////////////////////////////////////////////////////////////////
	
	Если Source = "inventor" Тогда
		ИсточникЗаявки = Перечисления.ИсточникиЗаявок.Inventor;
	ИначеЕсли Source = "4RM" Тогда
		ИсточникЗаявки = Перечисления.ИсточникиЗаявок._4RM;
	ИначеЕсли Source = "webservice" Тогда
		ИсточникЗаявки = Перечисления.ИсточникиЗаявок.Webservice;
	ИначеЕсли Source = "4orders" Тогда
		ИсточникЗаявки = Перечисления.ИсточникиЗаявок._4orders;
	//#XX-2284 Kalinin V.A. ( 2019-06-13 )  /*	
	ИначеЕсли  ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Контрагент,"РольКонтрагента") = ПредопределенноеЗначение("Справочник.РолиКонтрагентов.СлужебныйРозничныйОтдел") тогда 
		ИсточникЗаявки = Перечисления.ИсточникиЗаявок.РозничныйОтдел;	
	// */	
	Иначе 	
		ИсточникЗаявки = Перечисления.ИсточникиЗаявок.СайтОпт;
	КонецЕсли;
	
	Возврат ИсточникЗаявки;
	
КонецФункции
#КонецОбласти