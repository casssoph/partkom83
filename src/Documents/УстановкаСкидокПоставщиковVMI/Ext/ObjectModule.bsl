
Процедура ОбработкаПроверкиЗаполнения(Отказ, ПроверяемыеРеквизиты)
	Если ВидСкидки = Перечисления.ВидыСкидок.СОграничениемПоОбщейСумме Тогда 
		ПроверяемыеРеквизиты.Добавить("МаксимальнаяСуммаСкидки");
	КонецЕсли;
КонецПроцедуры

Процедура ОбработкаПроведения(Отказ, РежимПроведения)
	Документы.УстановкаСкидокПоставщиковVMI.ВыполнитьПроведение(Ссылка, Отказ);
КонецПроцедуры

Процедура ОбработкаУдаленияПроведения(Отказ)
	Документы.УстановкаСкидокПоставщиковVMI.ВыполнитьОтменуПроведения(Ссылка, Отказ);
КонецПроцедуры

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	Если ДатаОкончания < Дата Тогда 
		Сообщить("Дата окончания должна быть больше даты начала");
		Отказ = Истина;
	КонецЕсли;
	
	Если ЕстьСкидка() Тогда 
		Сообщить("У предыдущей скидки не кончился срок действия. Новый документ создавать нельзя.");
		Отказ = Истина;  
	КонецЕсли;

КонецПроцедуры

Функция ЕстьСкидка()
	//Если Не РеквизитФормыВЗначение("Объект").ЭтоНовый() Тогда 
	//	Возврат Ложь;
	//КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	УстановкаСкидокПоставщиковVMI.Ссылка
	               |ИЗ
	               |	Документ.УстановкаСкидокПоставщиковVMI КАК УстановкаСкидокПоставщиковVMI
	               |ГДЕ
	               |	(УстановкаСкидокПоставщиковVMI.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания
	               |			ИЛИ УстановкаСкидокПоставщиковVMI.ДатаОкончания МЕЖДУ &ДатаНачала И &ДатаОкончания)
	               |	И УстановкаСкидокПоставщиковVMI.Проведен
	               |	И УстановкаСкидокПоставщиковVMI.Контрагент = &Контрагент
	               |	И (УстановкаСкидокПоставщиковVMI.Склад = &Склад
	               |			ИЛИ &ПоВсемСкладам)
	               |	И УстановкаСкидокПоставщиковVMI.Ссылка <> &Ссылка";
	
	Запрос.УстановитьПараметр("Контрагент", Контрагент);
	Запрос.УстановитьПараметр("Склад", Склад);
	Запрос.УстановитьПараметр("ПоВсемСкладам", Не ЗначениеЗаполнено(Склад));
	Запрос.УстановитьПараметр("ДатаНачала", Дата);
	Запрос.УстановитьПараметр("ДатаОкончания", ДатаОкончания);
	Запрос.УстановитьПараметр("Ссылка", Ссылка); 
	Результат = Запрос.Выполнить();
	Если Не Результат.Пустой() Тогда 
		Выборка = Результат.Выбрать();
		Пока Выборка.Следующий() Цикл 
			Сообщить("Имеется документ с установленной скидкой за данный период: " + Выборка.Ссылка);
		КонецЦикла;
		
		Возврат Истина;
		
	КонецЕсли;
	
	Возврат Ложь;

КонецФункции