Процедура ВыполнитьРегламентноеЗадание() Экспорт
	
	Настройка = Справочники.НастройкиРеквизитовДляОбменов.Обмен_1С_ОП;
	АдресВебСервиса = ?(ОбщегоНазначения.ЭтоРабочаяИнформационнаяБаза(), Справочники.НастройкиРеквизитовДляОбменов.Обмен_1С_ОП.СтрокаДляРабочейБазы, Справочники.НастройкиРеквизитовДляОбменов.Обмен_1С_ОП.СтрокаДляТестовойБазы);
	
	Если НЕ ЗначениеЗаполнено(ИдентификаторУзлаОбмена) тогда
		ВызватьИсключение "Не заполнен реквизит ""Узел обмена"".";		
	КонецЕсли;
	
	МетаданныеПланаОбмена = Метаданные.ПланыОбмена.ОбменПартКом83_ОкноПоставщика;
	МенеджерПланаОбмена = ПланыОбмена.ОбменПартКом83_ОкноПоставщика;;
	
	КодПолучателя = МенеджерПланаОбмена.ЭтотУзел().ИдентификаторУзла;
	
	Отправитель = ОбменДаннымиКлиентСервер.ПолучитьВходящийУзелОбмена(МетаданныеПланаОбмена, ИдентификаторУзлаОбмена);
	КодОтправителя = Отправитель.ИдентификаторУзла;
	НомерПринятого = Отправитель.НомерПринятого;
	
	Определения = Новый WSОпределения(АдресВебСервиса);
	Прокси = Новый WSПрокси(Определения, Определения.Сервисы[0].URIПространстваИмен, Определения.Сервисы[0].Имя, Определения.Сервисы[0].ТочкиПодключения[0].Имя);
	
	ОтветСервера = Прокси.GetExchangeMessage("ОбменПартКом83_ОкноПоставщика", КодПолучателя, НомерПринятого);
	СообщениеОбмена = ОбменДаннымиСервер.РаспаковатьСообщениеОбмена(ОтветСервера);
	
	ТипСообщениеОбмена = ФабрикаXDTO.Тип("http://ws-02.part-kom.ru/partkom83/hs/SiteExchange/XMLSchema", "СообщениеОбмена");
	ЧтениеХМЛ = Новый ЧтениеXML;
	ЧтениеХМЛ.УстановитьСтроку(СообщениеОбмена);
	ДанныеХДТО = ФабрикаXDTO.ПрочитатьXML(ЧтениеХМЛ, ТипСообщениеОбмена);

	СписокОбъектов = ДанныеХДТО.Объекты.ПолучитьСписок("Объект");
	Если СписокОбъектов.Количество() > 0 Тогда
		ОбменДаннымиВызовСервера.ЗарегистрироватьСообщениеВИсторииОбменаССайтом(КодОтправителя, КодПолучателя, ОтветСервера, НомерПринятого);
		МенеджерПланаОбмена.ЗагрузитьСообщениеОбмена(СписокОбъектов, ДанныеХДТО.Отправитель, ДанныеХДТО.Получатель, ДанныеХДТО.НомерСообщения);
	КонецЕсли;
	
КонецПроцедуры

