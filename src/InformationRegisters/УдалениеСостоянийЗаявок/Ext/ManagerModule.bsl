Процедура ДобавитьДанныеУдаленияСостоянийСтрокЗаявок(Список, НомерСообщения, СтруктураХранения) Экспорт
	лКлючАлгоритма = "РегистрСведений_УдалениеСостоянийЗаявок_МодульМенеджера_ДобавитьДанныеУдаленияСостоянийСтрокЗаявок";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		Выполнить(лЗамена);
		Возврат;
	КонецЕсли;
	///////////////////////////////////////////////////////////////////////////
	
	ОтборЗаявок = Новый Массив;
	ОтборЗаявокРозница = новый Массив;
	
	ТипОбъектаXDTO = ФабрикаXDTO.Тип(ОбменССайтомСервер.ПространствоИмен(), "УдалениеОбъекта");
	Выборка = ВыборкаУдаленыхДокументовИстории();
	
	Пока Выборка.Следующий() Цикл
		                                                           
		ОбъектXDTO = ФабрикаXDTO.Создать(ТипОбъектаXDTO);
		ОбъектXDTO.ТипОбъекта = "ИсторияСтрокЗаявок";
		ОбъектXDTO.Ссылка  = Выборка.Документ.УникальныйИдентификатор();
		Список.Добавить(ОбъектXDTO);
		
		ОтметитьВыгрузкуНаСайт(Выборка.Документ,НомерСообщения);
	КонецЦикла;
	
КонецПроцедуры

Процедура ОтметитьВыгрузкуНаСайт(Документ,НомерСообщения)
	ЗаписьУдаления = РегистрыСведений.УдалениеСостоянийЗаявок.СоздатьМенеджерЗаписи();
	ЗаписьУдаления.Документ = Документ;
	ЗаписьУдаления.ПолученоСайтом = Истина;
	ЗаписьУдаления.ДатаОбработкиСайтом = ТекущаяДата();
	ЗаписьУдаления.НомерСообщенияОтправленного = НомерСообщения;
	ЗаписьУдаления.Записать();
КонецПроцедуры

Функция ВыборкаУдаленыхДокументовИстории()
	КоличествоОбъектов = РегистрыСведений.НастройкиПодсистем.ЗначениеПараметра("Обмен (Общее)","Количество объектов в обмене", 1000);	
	
	ЗапросУдаленых  = новый Запрос;
	ТекстЗапроса = "ВЫБРАТЬ Первые %1
	|	УдалениеСостоянийЗаявок.Документ
	|ИЗ
	|	РегистрСведений.УдалениеСостоянийЗаявок КАК УдалениеСостоянийЗаявок
	|ГДЕ
	|	УдалениеСостоянийЗаявок.ПолученоСайтом = ЛОЖЬ";
	
	ЗапросУдаленых.Текст  = СтрШаблон(ТекстЗапроса,Формат(КоличествоОбъектов, "ЧГ="));
	
	Возврат ЗапросУдаленых.Выполнить().Выбрать();

КонецФункции	