

Процедура ДобавитьДанныеИсторияЗаявокПокупателя(Список, НомерСообщения, СтруктураХранения) Экспорт
	лКлючАлгоритма = "РегистрСведений_ИсторияЗаявокПокупателя_МодульМенеджера_ДобавитьДанныеИсторияЗаявокПокупателя";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		Выполнить(лЗамена);
		Возврат;
	КонецЕсли;
	///////////////////////////////////////////////////////////////////////////	
	
	Если НЕ РегистрыСведений.НастройкиПодсистем.ЗначениеПараметра("Обмен 1С-Сайт","Выгружать историю строк заявок", Ложь) Тогда
		Возврат;
	КонецЕсли;

	УстанавливаемыеПоля = Новый Структура;
	УстанавливаемыеПоля.Вставить("НомерСообщенияОтправленного", НомерСообщения);
	УстанавливаемыеПоля.Вставить("ДатаОтправки", ТекущаяДата());
	
	КлючевыеПоля = Новый Структура;
	КлючевыеПоля.Вставить("Период");	
	КлючевыеПоля.Вставить("Регистратор");	
	КлючевыеПоля.Вставить("НомерСтроки");	
	КлючевыеПоля.Вставить("СтрокаЗаявки");	
	КлючевыеПоля.Вставить("СтрокаПрихода");	
	КлючевыеПоля.Вставить("Отказ");	
	КлючевыеПоля.Вставить("Порядок");	
	
	Структура = Новый Структура("ИмяТаблицы", "РегистрСведений.ИсторияЗаявокПокупателя");
	Структура.Вставить("КлючевыеПоля", КлючевыеПоля);
	Структура.Вставить("УстанавливаемыеПоля", УстанавливаемыеПоля);
	
	Структура.Вставить("СтруктураХранения", СтруктураХранения);

	РаботаСSQL.УстановитьИменаПолей(Структура);
	РаботаСSQL.УстановитьПоляSet(Структура);
	ВнутренняяТаблица = "";
	
	ТипОбъектаXDTO = ФабрикаXDTO.Тип("http://ws-02.part-kom.ru/partkom83/hs/SiteExchange/XMLSchema", "ИсторияСтрокЗаявок");
	ВыборкаИсторииСтрокЗаявок = ВыборкаИсторииСтрокЗаявок();
	ТаблицаОтбора = "";
	
	Пока ВыборкаИсторииСтрокЗаявок.Следующий() Цикл
		
		ОбъектXDTO = ФабрикаXDTO.Создать(ТипОбъектаXDTO);
		ЗаполнитьЗначенияСвойств(ОбъектXDTO, ВыборкаИсторииСтрокЗаявок, "IDSite,Количество,НомерЗаявки,Артикул,Цена,ЗакупочнаяЦена,Розница");
		ОбъектXDTO.IDHistory = ВыборкаИсторииСтрокЗаявок.Документ.УникальныйИдентификатор();
		ОбъектXDTO.Состояние = ВыборкаИсторииСтрокЗаявок.Состояние.УникальныйИдентификатор();
		ОбъектXDTO.ВерсияДанных = ВыборкаИсторииСтрокЗаявок.Период;
		ОбъектXDTO.Склад = ВыборкаИсторииСтрокЗаявок.Склад.УникальныйИдентификатор();
		ОбъектXDTO.ТипДоставки   =  ВыборкаИсторииСтрокЗаявок.ТипДоставки.УникальныйИдентификатор();
		Список.Добавить(ОбъектXDTO);
		
		ВнутренняяТаблица = ВнутренняяТаблица + ?(ВнутренняяТаблица = "", "", ",") + "(" + 
							РаботаСSQL.ЗначениеSQL(ВыборкаИсторииСтрокЗаявок.Период) + "," + 
							РаботаСSQL.ЗначениеSQL(ВыборкаИсторииСтрокЗаявок.Регистратор) + "," + 
							РаботаСSQL.ЗначениеSQL(ВыборкаИсторииСтрокЗаявок.НомерСтроки) + "," + 
							РаботаСSQL.ЗначениеSQL(ВыборкаИсторииСтрокЗаявок.СтрокаЗаявки) + "," + 
							РаботаСSQL.ЗначениеSQL(ВыборкаИсторииСтрокЗаявок.СтрокаПрихода) + "," + 
							РаботаСSQL.ЗначениеSQL(ВыборкаИсторииСтрокЗаявок.Отказ) + "," + 
							РаботаСSQL.ЗначениеSQL(ВыборкаИсторииСтрокЗаявок.Порядок) + ")";
							
	КонецЦикла;
	
	//ХудинВВ 22072019 XX-2939
	//Добавил выбор из values во временную таблицу, соединение сразу с values периодически вызывало эскалацию
	СтрокаПолейВыбораВТ = "vtPeriod,vtRegistrator,vtNomerStroki,vtStrokaZayavki,vtStrokaPrihoda,vtOtkaz,vtPoryadok";					

	втТекстЗапроса = "IF OBJECT_ID(N'tempdb..#vt_valuesdata', N'U') IS NOT NULL   
						|DROP TABLE #vt_valuesdata; 
						|
						|CREATE TABLE #vt_valuesdata
						|	(vtPeriod [datetime] NOT NULL,
						|	vtRegistrator [binary](16) NOT NULL,
						|	vtNomerStroki [numeric](9, 0) NOT NULL,
						|   vtStrokaZayavki [binary](16) NOT NULL, 
						|   vtStrokaPrihoda [binary](16) NOT NULL, 
						|   vtOtkaz [binary](1) NOT NULL, 
						|   vtPoryadok [numeric](2, 0) NOT NULL); 
						|
						|CREATE INDEX vt_values_index on #vt_valuesdata ("+СтрокаПолейВыбораВТ+");
						|
						|   INSERT INTO #vt_valuesdata
						|	SELECT *
						|   FROM
						|   (VALUES "+ВнутренняяТаблица+") as vt
						|   ("+СтрокаПолейВыбораВТ+");
						|  
						|";
						
						
	СтрокаJoin =	Структура.Поля["Период"] + "=#vt_valuesdata.vtPeriod and " +
					Структура.Поля["Регистратор"] + "=#vt_valuesdata.vtRegistrator and " +
					Структура.Поля["НомерСтроки"] + "=#vt_valuesdata.vtNomerStroki and " +
					Структура.Поля["СтрокаЗаявки"] + "=#vt_valuesdata.vtStrokaZayavki and " +
					Структура.Поля["СтрокаПрихода"] + "=#vt_valuesdata.vtStrokaPrihoda and " +
					Структура.Поля["Отказ"] + "=#vt_valuesdata.vtOtkaz and " +
					Структура.Поля["Порядок"] + "=#vt_valuesdata.vtPoryadok";
					
	ВнутренняяТаблица =  " inner join " + Символы.ПС + "#vt_valuesdata on " + СтрокаJoin;
	Структура.Вставить("ВнутренняяТаблица", ВнутренняяТаблица);
	
	ТекстЗапроса = втТекстЗапроса+"update " + Структура.ИмяТаблицыХранения + Структура.Set + "from " + Структура.ИмяТаблицыХранения + ВнутренняяТаблица+"; drop table #vt_valuesdata";
	
	ОписаниеОшибки = РаботаСSQL.ВыполнитьЗапросSQL(ТекстЗапроса);
	
КонецПроцедуры

Процедура устарелаДобавитьДанныеИсторияЗаявокПокупателя(Список, НомерСообщения, СтруктураХранения) Экспорт
	лКлючАлгоритма = "РегистрСведений_ИсторияЗаявокПокупателя_МодульМенеджера_устарелаДобавитьДанныеИсторияЗаявокПокупателя";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		Выполнить(лЗамена);
		Возврат;
	КонецЕсли;
	///////////////////////////////////////////////////////////////////////////	
	
	Если НЕ РегистрыСведений.НастройкиПодсистем.ЗначениеПараметра("Обмен 1С-Сайт","Выгружать историю строк заявок", Ложь) Тогда
		Возврат;
	КонецЕсли;

	УстанавливаемыеПоля = Новый Структура;
	УстанавливаемыеПоля.Вставить("НомерСообщенияОтправленного", НомерСообщения);
	УстанавливаемыеПоля.Вставить("ДатаОтправки", ТекущаяДата());
	
	КлючевыеПоля = Новый Структура;
	КлючевыеПоля.Вставить("Период");	
	КлючевыеПоля.Вставить("Регистратор");	
	КлючевыеПоля.Вставить("НомерСтроки");	
	КлючевыеПоля.Вставить("СтрокаЗаявки");	
	КлючевыеПоля.Вставить("СтрокаПрихода");	
	КлючевыеПоля.Вставить("Отказ");	
	КлючевыеПоля.Вставить("Порядок");	
	
	Структура = Новый Структура("ИмяТаблицы", "РегистрСведений.ИсторияЗаявокПокупателя");
	Структура.Вставить("КлючевыеПоля", КлючевыеПоля);
	Структура.Вставить("УстанавливаемыеПоля", УстанавливаемыеПоля);
	
	Структура.Вставить("СтруктураХранения", СтруктураХранения);

	РаботаСSQL.УстановитьИменаПолей(Структура);
	РаботаСSQL.УстановитьПоляSet(Структура);
	ВнутренняяТаблица = "";
	
	ТипОбъектаXDTO = ФабрикаXDTO.Тип("http://ws-02.part-kom.ru/partkom83/hs/SiteExchange/XMLSchema", "ИсторияСтрокЗаявок");
	ВыборкаИсторииСтрокЗаявок = ВыборкаИсторииСтрокЗаявок();
	ТаблицаОтбора = "";
	
	Пока ВыборкаИсторииСтрокЗаявок.Следующий() Цикл
		
		ОбъектXDTO = ФабрикаXDTO.Создать(ТипОбъектаXDTO);
		ЗаполнитьЗначенияСвойств(ОбъектXDTO, ВыборкаИсторииСтрокЗаявок, "IDSite,Количество,НомерЗаявки,Артикул,Цена,ЗакупочнаяЦена,Розница");
		ОбъектXDTO.IDHistory = ВыборкаИсторииСтрокЗаявок.Документ.УникальныйИдентификатор();
		ОбъектXDTO.Состояние = ВыборкаИсторииСтрокЗаявок.Состояние.УникальныйИдентификатор();
		ОбъектXDTO.ВерсияДанных = ВыборкаИсторииСтрокЗаявок.Период;
		ОбъектXDTO.Склад = ВыборкаИсторииСтрокЗаявок.Склад.УникальныйИдентификатор();
		ОбъектXDTO.ТипДоставки   =  ВыборкаИсторииСтрокЗаявок.ТипДоставки.УникальныйИдентификатор();
		Список.Добавить(ОбъектXDTO);
		
		ВнутренняяТаблица = ВнутренняяТаблица + ?(ВнутренняяТаблица = "", "", ",") + "(" + 
							РаботаСSQL.ЗначениеSQL(ВыборкаИсторииСтрокЗаявок.Период) + "," + 
							РаботаСSQL.ЗначениеSQL(ВыборкаИсторииСтрокЗаявок.Регистратор) + "," + 
							РаботаСSQL.ЗначениеSQL(ВыборкаИсторииСтрокЗаявок.НомерСтроки) + "," + 
							РаботаСSQL.ЗначениеSQL(ВыборкаИсторииСтрокЗаявок.СтрокаЗаявки) + "," + 
							РаботаСSQL.ЗначениеSQL(ВыборкаИсторииСтрокЗаявок.СтрокаПрихода) + "," + 
							РаботаСSQL.ЗначениеSQL(ВыборкаИсторииСтрокЗаявок.Отказ) + "," + 
							РаботаСSQL.ЗначениеSQL(ВыборкаИсторииСтрокЗаявок.Порядок) + ")";
		
	КонецЦикла;
	
	
	СтрокаJoin =	Структура.Поля["Период"] + "=t.f1 and " +
					Структура.Поля["Регистратор"] + "=t.f2 and " +
					Структура.Поля["НомерСтроки"] + "=t.f3 and " +
					Структура.Поля["СтрокаЗаявки"] + "=t.f4 and " +
					Структура.Поля["СтрокаПрихода"] + "=t.f5 and " +
					Структура.Поля["Отказ"] + "=t.f6 and " +
					Структура.Поля["Порядок"] + "=t.f7";
	ВнутренняяТаблица =  " inner join " + Символы.ПС + "(values" + ВнутренняяТаблица + ") t (f1,f2,f3,f4,f5,f6,f7) on " + СтрокаJoin;;
	Структура.Вставить("ВнутренняяТаблица", ВнутренняяТаблица);
	ТекстЗапроса = "update " + Структура.ИмяТаблицыХранения + Структура.Set + "from " + Структура.ИмяТаблицыХранения + ВнутренняяТаблица;
	
	ОписаниеОшибки = РаботаСSQL.ВыполнитьЗапросSQL(ТекстЗапроса);
	
КонецПроцедуры

Функция ВыборкаИсторииСтрокЗаявок()
	лКлючАлгоритма = "РегистрСведений_ИсторияЗаявокПокупателя_МодульМенеджера_ВыборкаИсторииСтрокЗаявок";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		АлгоритмыЗначениеВозврата = Неопределено;		
		Выполнить(лЗамена);		
		Возврат АлгоритмыЗначениеВозврата;		
	КонецЕсли;	
	////////////////////////////////////////////////
	
	КоличествоОбъектов = РегистрыСведений.НастройкиПодсистем.ЗначениеПараметра("Обмен (Общее)","Количество объектов в обмене", 1000);
	ОбратныйПорядокВыборки = РегистрыСведений.НастройкиПодсистем.ЗначениеПараметра("Обмен (Общее)","Обратный порядок выборки", Истина);
	УсловиеОтбора = РегистрыСведений.НастройкиПодсистем.ЗначениеПараметра("Обмен (Общее)","Условие запроса истории строк заявок", "");
	
	Запрос = Новый Запрос("ВЫБРАТЬ ПЕРВЫЕ 1234
	                      |	ИсторияЗаявокПокупателя.IDSite,
	                      |	ИсторияЗаявокПокупателя.Период КАК Период,
	                      |	ВЫБОР
	                      |		КОГДА ИсторияЗаявокПокупателя.СтрокаЗаявки.Заявка.ИсточникЗаявки = ЗНАЧЕНИЕ(Перечисление.ИсточникиЗаявок.СайтРозница)
	                      |			ТОГДА ЕСТЬNULL(ИсторияЗаявокПокупателя.СтрокаЗаявки.Заявка.НомерРозничнойЗаявки, """")
	                      |		ИНАЧЕ ЕСТЬNULL(ИсторияЗаявокПокупателя.СтрокаЗаявки.Заявка.Номер, """")
	                      |	КОНЕЦ КАК НомерЗаявки,
	                      |	ИсторияЗаявокПокупателя.Склад,
	                      |	ИсторияЗаявокПокупателя.Количество,
	                      |	ЕСТЬNULL(ИсторияЗаявокПокупателя.СтрокаЗаявки.Цена, 0) КАК Цена,
	                      |	ИсторияЗаявокПокупателя.СтрокаЗаявки,
	                      |	ЕСТЬNULL(ИсторияЗаявокПокупателя.СтрокаЗаявки.ЦенаЗакупки, 0) КАК ЗакупочнаяЦена,
	                      |	ИсторияЗаявокПокупателя.Состояние,
	                      |	ИсторияЗаявокПокупателя.СтрокаПрихода,
	                      |	ИсторияЗаявокПокупателя.Отказ,
	                      |	ИсторияЗаявокПокупателя.Порядок,
	                      |	ИсторияЗаявокПокупателя.ДатаСобытия КАК ДатаСобытия,
	                      |	ИсторияЗаявокПокупателя.Номенклатура,
	                      |	ИсторияЗаявокПокупателя.Регистратор,
	                      |	ИсторияЗаявокПокупателя.НомерСтроки,
	                      |	ЕСТЬNULL(ИсторияЗаявокПокупателя.Номенклатура.Артикул, """") КАК Артикул,
	                      |	ВЫБОР
	                      |		КОГДА ИсторияЗаявокПокупателя.СтрокаЗаявки.Заявка.ИсточникЗаявки = ЗНАЧЕНИЕ(Перечисление.ИсточникиЗаявок.СайтРозница)
	                      |			ТОГДА ИСТИНА
	                      |		ИНАЧЕ ЛОЖЬ
	                      |	КОНЕЦ КАК Розница,
	                      |	ИсторияЗаявокПокупателя.Регистратор КАК Документ,
	                      |	ВЫБОР
	                      |		КОГДА ИсторияЗаявокПокупателя.Регистратор ССЫЛКА Документ.РеализацияТоваровУслуг
	                      |			ТОГДА ВЫРАЗИТЬ(ИсторияЗаявокПокупателя.Регистратор КАК Документ.РеализацияТоваровУслуг).ТипДоставки
	                      |		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ТипыДоставки.ПустаяСсылка)
	                      |	КОНЕЦ КАК ТипДоставки
	                      |ИЗ
	                      |	РегистрСведений.ИсторияЗаявокПокупателя КАК ИсторияЗаявокПокупателя
	                      |ГДЕ
	                      |	НЕ ИсторияЗаявокПокупателя.ПолученоСайтом
	                      |	И ИСТИНА
	                      |
	                      |УПОРЯДОЧИТЬ ПО
	                      |	ДатаСобытия УБЫВ");
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "1234", Формат(КоличествоОбъектов, "ЧГ="));
	Если НЕ ОбратныйПорядокВыборки Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, " УБЫВ", "");
	КонецЕсли;
	Если ЗначениеЗаполнено(УсловиеОтбора) Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "И ИСТИНА", "И " + УсловиеОтбора);
	КонецЕсли;
	
	Возврат Запрос.Выполнить().Выбрать();
	
КонецФункции

Процедура ФиксацияПринятогоСообщения(НомерСообщения, СтруктураХранения) Экспорт
	
	УстанавливаемыеПоля = Новый Структура;
	УстанавливаемыеПоля.Вставить("ПолученоСайтом", Истина);
	УстанавливаемыеПоля.Вставить("ДатаОбработкиСайтом", ТекущаяДата());

	ОтборПоНомеруСообщения = Новый Структура;
	ОтборПоНомеруСообщения.Вставить("ВидСравнения", ВидСравнения.Интервал);
	ОтборПоНомеруСообщения.Вставить("Минимум", 1);
	ОтборПоНомеруСообщения.Вставить("Максимум", НомерСообщения);
	
	ПоляОтбора = Новый Структура;
	ПоляОтбора.Вставить("НомерСообщенияОтправленного", ОтборПоНомеруСообщения);
	ПоляОтбора.Вставить("ПолученоСайтом", Ложь);
	
	Структура = Новый Структура("ИмяТаблицы", "РегистрСведений.ИсторияЗаявокПокупателя");
	Структура.Вставить("УстанавливаемыеПоля", УстанавливаемыеПоля);
	Структура.Вставить("ПоляОтбора", ПоляОтбора);
	Структура.Вставить("СтруктураХранения", СтруктураХранения);
	
	ОписаниеОшибки = РаботаСSQL.UpdateAtWhere(Структура);
	
КонецПроцедуры

Процедура СнятьРегистрациюСЗаписей(Выборка) Экспорт
	
	УстанавливаемыеПоля = Новый Структура;
	УстанавливаемыеПоля.Вставить("НомерСообщенияОтправленного", 0);
	УстанавливаемыеПоля.Вставить("ДатаОтправки", '00010101');
	УстанавливаемыеПоля.Вставить("ДатаОбработкиСайтом", '00010101');
	УстанавливаемыеПоля.Вставить("ПолученоСайтом", Ложь);
	
	КлючевыеПоля = Новый Структура;
	КлючевыеПоля.Вставить("Период");	
	КлючевыеПоля.Вставить("Регистратор");	
	КлючевыеПоля.Вставить("НомерСтроки");	
	КлючевыеПоля.Вставить("СтрокаЗаявки");	
	КлючевыеПоля.Вставить("СтрокаПрихода");	
	КлючевыеПоля.Вставить("Отказ");	
	КлючевыеПоля.Вставить("Порядок");	
	
	Структура = Новый Структура("ИмяТаблицы", "РегистрСведений.ИсторияЗаявокПокупателя");
	Структура.Вставить("КлючевыеПоля", КлючевыеПоля);
	Структура.Вставить("УстанавливаемыеПоля", УстанавливаемыеПоля);
	Структура.Вставить("ВыборкаДанных", Выборка);
	
	ОписаниеОшибки = РаботаСSQL.UpdateAtJOIN(Структура);
	
КонецПроцедуры

Процедура ОтметитьЗаписиКакВыгруженные(Выборка) Экспорт
	
	УстанавливаемыеПоля = Новый Структура;
	УстанавливаемыеПоля.Вставить("НомерСообщенияОтправленного", 0);
	УстанавливаемыеПоля.Вставить("ДатаОтправки", ТекущаяДата());
	УстанавливаемыеПоля.Вставить("ДатаОбработкиСайтом", ТекущаяДата());
	УстанавливаемыеПоля.Вставить("ПолученоСайтом", Истина);
	
	КлючевыеПоля = Новый Структура;
	КлючевыеПоля.Вставить("Период");	
	КлючевыеПоля.Вставить("Регистратор");	
	КлючевыеПоля.Вставить("НомерСтроки");	
	КлючевыеПоля.Вставить("СтрокаЗаявки");	
	КлючевыеПоля.Вставить("СтрокаПрихода");	
	КлючевыеПоля.Вставить("Отказ");	
	КлючевыеПоля.Вставить("Порядок");	
	
	Структура = Новый Структура("ИмяТаблицы", "РегистрСведений.ИсторияЗаявокПокупателя");
	Структура.Вставить("КлючевыеПоля", КлючевыеПоля);
	Структура.Вставить("УстанавливаемыеПоля", УстанавливаемыеПоля);
	Структура.Вставить("ВыборкаДанных", Выборка);
	
	ОписаниеОшибки = РаботаСSQL.UpdateAtJOIN(Структура);
	
КонецПроцедуры

Функция ИмяПоляТаблицы(ОписаниеПолей, ИмяПоля, Отказ)
	
	ИмяПоляХранения = "";	
	Строка = ОписаниеПолей.Найти(ИмяПоля, "ИмяПоля");
	Если Строка = Неопределено Тогда
		Отказ = Истина;
	Иначе
		ИмяПоляХранения = Строка.ИмяПоляХранения;
	КонецЕсли;
	
	Возврат ИмяПоляХранения;
	
КонецФункции