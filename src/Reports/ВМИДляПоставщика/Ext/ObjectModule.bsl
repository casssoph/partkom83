
Функция ОстаткиДляСайта(Контрагент,Склад,НачалоПериода,КонецПериода) Экспорт
	
	Попытка
		Период=КонецДня(ТекущаяДата());
		Если Строка(Контрагент)="" Тогда 
			Сообщить("Укажите контрагента!",СтатусСообщения.ОченьВажное);
			Отказ=Истина;
			СтрукураВозврата = Новый Структура;
			СтрукураВозврата.Вставить("Результат",Новый ТаблицаЗначений);
			СтрукураВозврата.Вставить("Ошибка",Отказ);
			СтрукураВозврата.Вставить("ОписаниеОшибк","Нет контрагента в запросе");
			Возврат СтрукураВозврата;
		КонецЕсли;	
		//Если Строка(Склад)="" Тогда 
		//	Предупреждение("Укажите склад!");
		//	Отказ=Истина;
		//	Возврат
		//КонецЕсли;	
		Запрос=Новый Запрос;
		
		Запрос.Текст=
		"ВЫБРАТЬ
		|	ПоступлениеТоваровУслуг.Номенклатура КАК Номенклатура,
		|	СУММА(ПоступлениеТоваровУслуг.Количество) КАК Приход,
		|	СУММА(0) КАК Расход,
		|	ПоступлениеТоваровУслуг.Номенклатура.Артикул КАК Артикул,
		|	ПоступлениеТоваровУслуг.Номенклатура.Изготовитель КАК Изготовитель,
		|	СУММА(ПоступлениеТоваровУслуг.КоличествоНеПринято) КАК НеПринято,
		|	СУММА(ПоступлениеТоваровУслуг.КоличествоРазмещено) КАК Размещено,
		|	СУММА(0) КАК Цена,
		|	ПоступлениеТоваровУслуг.Ссылка.Склад,
		|	СУММА(0) КАК Остаток,
		|	ВложенныйЗапрос.АртикулПоставщика,
		|	ВложенныйЗапрос.ИзготовительПоставщика
		|ИЗ
		|	(ВЫБРАТЬ
		|		НоменклатураКонтрагентов.Номенклатура КАК Номенклатура,
		|		НоменклатураКонтрагентов.Артикул КАК Артикул,
		|		НоменклатураКонтрагентов.Изготовитель КАК Изготовитель,
		|		НоменклатураКонтрагентов.АртикулПоставщика КАК АртикулПоставщика,
		|		НоменклатураКонтрагентов.ИзготовительПоставщика КАК ИзготовительПоставщика
		|	ИЗ
		|		Справочник.НоменклатураКонтрагентов КАК НоменклатураКонтрагентов
		|	ГДЕ
		|		НоменклатураКонтрагентов.Владелец = &Контрагент) КАК ВложенныйЗапрос
		|		ПРАВОЕ СОЕДИНЕНИЕ Документ.ПоступлениеТоваровУслуг.Товары КАК ПоступлениеТоваровУслуг
		|		ПО ВложенныйЗапрос.Номенклатура = ПоступлениеТоваровУслуг.Номенклатура
		|ГДЕ
		|	ПоступлениеТоваровУслуг.Ссылка.Дата МЕЖДУ &НачалоПериода И &КонецПериода
		|	И ПоступлениеТоваровУслуг.Ссылка.Проведен = ИСТИНА
		|	И ПоступлениеТоваровУслуг.Ссылка.ВидОперацииПоступления = &ВидОперацииVMI
		|	И ПоступлениеТоваровУслуг.Ссылка.ДоговорКонтрагента.ВидДоговора = &ВидДоговора
		|	И ПоступлениеТоваровУслуг.Ссылка.Контрагент = &Контрагент";
		Если НЕ Строка(Склад)="" Тогда 
			Запрос.Текст=Запрос.Текст+"
			|	И ПоступлениеТоваровУслуг.Ссылка.Склад = &Склад";
		КонецЕсли;	
		Запрос.Текст=Запрос.Текст+"
		|
		|СГРУППИРОВАТЬ ПО
		|	ВложенныйЗапрос.АртикулПоставщика,
		|	ПоступлениеТоваровУслуг.Ссылка.Склад,
		|	ВложенныйЗапрос.ИзготовительПоставщика,
		|	ПоступлениеТоваровУслуг.Номенклатура,
		|	ПоступлениеТоваровУслуг.Номенклатура.Артикул,
		|	ПоступлениеТоваровУслуг.Номенклатура.Изготовитель
		|
		|УПОРЯДОЧИТЬ ПО
		|	Номенклатура";
		
		Запрос.УстановитьПараметр("ВидОперацииVMI",Перечисления.ВидыПоступленияТоваров.ОтветХранение);
		Запрос.УстановитьПараметр("НачалоПериода",НачалоДня(НачалоПериода));
		Запрос.УстановитьПараметр("КонецПериода",КонецДня(КонецПериода));
		Запрос.УстановитьПараметр("Склад",Склад);
		Запрос.УстановитьПараметр("СтатусПартии",Перечисления.СтатусыПартии.ПринятыйНаОтветХранение);
		Запрос.УстановитьПараметр("Контрагент",Контрагент);
		Запрос.УстановитьПараметр("ВидДоговора",Перечисления.ВидыДоговоровКонтрагентов.ОтветХранение);
		Рез=Запрос.Выполнить().Выгрузить();
		ТЧ1=Рез;
		
		Запрос=Новый Запрос;
		
		Запрос.Текст=
		"ВЫБРАТЬ
		|	СУММА(ПартииТоваровОстаткиИОбороты.КоличествоРасход) КАК Расход,
		|	СУММА(0) КАК Приход,
		|	ПартииТоваровОстаткиИОбороты.Номенклатура КАК Номенклатура,
		|	ПартииТоваровОстаткиИОбороты.Номенклатура.Артикул КАК Артикул,
		|	ПартииТоваровОстаткиИОбороты.Номенклатура.Изготовитель КАК Изготовитель,
		|	СУММА(ПартииТоваровОстаткиИОбороты.КоличествоНачальныйОстаток) КАК Остаток,
		|	ПартииТоваровОстаткиИОбороты.Склад,
		|	СУММА(0) КАК Цена,
		|	СУММА(0) КАК НеПринято,
		|	СУММА(0) КАК Размещено,
		|	ВложенныйЗапрос.АртикулПоставщика,
		|	ВложенныйЗапрос.ИзготовительПоставщика
		|ИЗ
		|	(ВЫБРАТЬ
		|		НоменклатураКонтрагентов.Номенклатура КАК Номенклатура,
		|		НоменклатураКонтрагентов.Артикул КАК Артикул,
		|		НоменклатураКонтрагентов.Изготовитель КАК Изготовитель,
		|		НоменклатураКонтрагентов.АртикулПоставщика КАК АртикулПоставщика,
		|		НоменклатураКонтрагентов.ИзготовительПоставщика КАК ИзготовительПоставщика
		|	ИЗ
		|		Справочник.НоменклатураКонтрагентов КАК НоменклатураКонтрагентов
		|	ГДЕ
		|		НоменклатураКонтрагентов.Владелец = &Контрагент) КАК ВложенныйЗапрос
		|		ПРАВОЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииТоваров.ОстаткиИОбороты(&НачалоПериода, &КонецПериода, , , ) КАК ПартииТоваровОстаткиИОбороты
		|		ПО ВложенныйЗапрос.Номенклатура = ПартииТоваровОстаткиИОбороты.Номенклатура
		|ГДЕ
		|	ПартииТоваровОстаткиИОбороты.СтатусПартии = &СтатусПартии
		|	И ПартииТоваровОстаткиИОбороты.СтрокаПрихода.ДоговорКонтрагента.ВидДоговора = &ВидДоговора
		|	И ПартииТоваровОстаткиИОбороты.СтрокаПрихода.ДоговорКонтрагента.Владелец = &Контрагент";
		Если НЕ Строка(Склад)="" Тогда 
			Запрос.Текст=Запрос.Текст+"
			|	И ПартииТоваровОстаткиИОбороты.Склад = &Склад";
		КонецЕсли;	
		Запрос.Текст=Запрос.Текст+"
		|
		|СГРУППИРОВАТЬ ПО
		|	ПартииТоваровОстаткиИОбороты.Номенклатура,
		|	ПартииТоваровОстаткиИОбороты.Склад,
		|	ВложенныйЗапрос.ИзготовительПоставщика,
		|	ВложенныйЗапрос.АртикулПоставщика,
		|	ПартииТоваровОстаткиИОбороты.Номенклатура.Артикул,
		|	ПартииТоваровОстаткиИОбороты.Номенклатура.Изготовитель";
		Запрос.УстановитьПараметр("ВидОперацииVMI",Перечисления.ВидыПоступленияТоваров.ОтветХранение);
		Запрос.УстановитьПараметр("НачалоПериода",НачалоДня(НачалоПериода));
		Запрос.УстановитьПараметр("КонецПериода",КонецДня(КонецПериода));
		Запрос.УстановитьПараметр("Склад",Склад);
		Запрос.УстановитьПараметр("СтатусПартии",Перечисления.СтатусыПартии.ПринятыйНаОтветХранение);
		Запрос.УстановитьПараметр("Контрагент",Контрагент);
		Запрос.УстановитьПараметр("ВидДоговора",Перечисления.ВидыДоговоровКонтрагентов.ОтветХранение);
		Рез=Запрос.Выполнить().Выгрузить();
		ТЧ2=Рез;
		
		Запрос=Новый Запрос;
		
		Запрос.Текст=
		"ВЫБРАТЬ
		|	ЦеныНоменклатурыКонтрагентовСрезПоследних.Номенклатура КАК НоменклатураПоставщика,
		|	ЦеныНоменклатурыКонтрагентовСрезПоследних.АртикулПоставщика,
		|	ЦеныНоменклатурыКонтрагентовСрезПоследних.ИзготовительПоставщика,
		|	ЦеныНоменклатурыКонтрагентовСрезПоследних.Номенклатура.Номенклатура КАК Номенклатура,
		|	ЦеныНоменклатурыКонтрагентовСрезПоследних.Номенклатура.Артикул КАК Артикул,
		|	ЦеныНоменклатурыКонтрагентовСрезПоследних.Номенклатура.Изготовитель КАК Изготовитель,
		|	ВЫБОР
		|		КОГДА ВложенныйЗапрос.Цена > 0
		|			ТОГДА ВложенныйЗапрос.Цена
		|		ИНАЧЕ ЦеныНоменклатурыКонтрагентовСрезПоследних.Цена
		|	КОНЕЦ КАК Цена,
		|	0 КАК Расход,
		|	0 КАК Приход,
		|	0 КАК Остаток,
		|	0 КАК НеПринято,
		|	0 КАК Размещено
		|ИЗ
		|	РегистрСведений.ЦеныНоменклатурыКонтрагентов.СрезПоследних(&Период, ) КАК ЦеныНоменклатурыКонтрагентовСрезПоследних
		|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		|			ПереоценкаОстатковПоставщикаТоварыПоставщика.НоменклатураПоставщика КАК НоменклатураКА,
		|			ПереоценкаОстатковПоставщикаТоварыПоставщика.Цена КАК Цена,
		|			ПереоценкаОстатковПоставщикаТоварыПоставщика.ИзготовительПоставщика КАК ИзготовительПоставщика,
		|			ПереоценкаОстатковПоставщикаТоварыПоставщика.АртикулПоставщика КАК АртикулПоставщика,
		|			ПереоценкаОстатковПоставщикаТоварыПоставщика.НоменклатураПоставщика.Номенклатура КАК Номенклатура,
		|			ПереоценкаОстатковПоставщикаТоварыПоставщика.НоменклатураПоставщика.Артикул КАК Артикул,
		|			ПереоценкаОстатковПоставщикаТоварыПоставщика.НоменклатураПоставщика.Изготовитель КАК Изготовитель
		|		ИЗ
		|			Документ.ПереоценкаОстатковПоставщика.ТоварыПоставщика КАК ПереоценкаОстатковПоставщикаТоварыПоставщика
		|		ГДЕ
		|			ПереоценкаОстатковПоставщикаТоварыПоставщика.Ссылка.Дата МЕЖДУ &СегодняНачало И &СегодняКонец
		|			И НЕ ПереоценкаОстатковПоставщикаТоварыПоставщика.Ссылка.Проведен) КАК ВложенныйЗапрос
		|		ПО ВложенныйЗапрос.НоменклатураКА = ЦеныНоменклатурыКонтрагентовСрезПоследних.Номенклатура
		|ГДЕ
		|	ЦеныНоменклатурыКонтрагентовСрезПоследних.Номенклатура.Владелец = &КА";
		Запрос.УстановитьПараметр("СегодняКонец", КонецДня(Период));
		Запрос.УстановитьПараметр("СегодняНачало", НачалоДня(Период));
		Запрос.УстановитьПараметр("Период", КонецДня(Период));
		Запрос.УстановитьПараметр("КА", Контрагент);
		Рез=Запрос.Выполнить().Выгрузить();
		ТЧ3=Рез;
		
		Для Каждого СтрокаТЗ ИЗ ТЧ2 Цикл
			НовСтрока = ТЧ1.Добавить();
			ЗаполнитьЗначенияСвойств(НовСтрока, СтрокаТЗ);
		КонецЦикла;
		Для Каждого СтрокаТЗ ИЗ ТЧ3 Цикл
			НовСтрока = ТЧ1.Добавить();
			ЗаполнитьЗначенияСвойств(НовСтрока, СтрокаТЗ);
		КонецЦикла;
		ТЧ1.Свернуть("Артикул,Изготовитель,АртикулПоставщика,ИзготовительПоставщика,Склад","Приход,Расход,Цена,Остаток,НеПринято,Размещено");
		МассивУдаляемыхСтрок = Новый Массив;
		Для Каждого Стр Из ТЧ1 Цикл
			Если Стр.Приход=0 И Стр.Расход=0 И Стр.Остаток=0 И Стр.НеПринято=0 И Стр.Размещено=0 Тогда 
				МассивУдаляемыхСтрок.Добавить(Стр);
			КонецЕсли;	
		КонецЦикла;	
		Для Каждого Строка Из МассивУдаляемыхСтрок Цикл
			ТЧ1.Удалить(Строка);
		КонецЦикла;
		ТЧСКЛ=ТЧ1.Скопировать();
		ТЧСКЛ.Свернуть("Склад");
		
		ДокументРезультат=новый ТабличныйДокумент;//ЭлементыФормы.РезультатТЧ;
		//ДокументРезультат.Очистить();
		
		ДокументРезультат.ОриентацияСтраницы = ОриентацияСтраницы.Портрет;
		ДокументРезультат.ПолеСверху         = 10;
		ДокументРезультат.ПолеСнизу          = 10;
		ДокументРезультат.ПолеСлева          = 20;
		ДокументРезультат.ПолеСправа         = 20;
		
		ДокументРезультат.ИмяПараметровПечати = "ПАРАМЕТРЫ_ПЕЧАТИ_Отчет_МХ";
		
		Макет = ПолучитьМакет("Макет");
		ОбластьЗаголовок = Макет.ПолучитьОбласть("Заголовок");
		
		ОбластьЗаголовок.Параметры.Поставщик = "Поставщик: "+Строка(Контрагент);
		Попытка
			ОбластьЗаголовок.Параметры.Заголовок = "Остатки с "+строка(НачалоПериода)+" по "+строка(КонецПериода);
		Исключение
		КонецПопытки;	
		//ОбластьЗаголовок.Параметры.Период = Строка(Формат(НачалоПериода,"ДФ=дд.ММ.гг"))+" - "+Строка(Формат(КонецПериода,"ДФ=дд.ММ.гг"));
		ДокументРезультат.Вывести(ОбластьЗаголовок);
		
		Если НЕ Строка(Склад)="" Тогда 
			ОбластьЗаголовок = Макет.ПолучитьОбласть("Шапка");
			ОбластьЗаголовок.Параметры.Цена = "Текущая цена на ("+строка(Период)+")";
			ОбластьЗаголовок.Параметры.Склад = Склад;
			ДокументРезультат.Вывести(ОбластьЗаголовок);
		Иначе 	
			ОбластьЗаголовок = Макет.ПолучитьОбласть("Шапка|Товар");
			ОбластьЗаголовок.Параметры.Цена = "Текущая цена на ("+строка(Период)+")";
			ДокументРезультат.Вывести(ОбластьЗаголовок);
			Для Каждого СтрСК Из ТЧСКЛ Цикл 
				ОбластьСкл = Макет.ПолучитьОбласть("Шапка|Склад");
				ОбластьСкл.Параметры.Склад = СтрСК.Склад;
				ДокументРезультат.Присоединить(ОбластьСкл);
			КонецЦикла;	
		КонецЕсли;	
		
		Итог=0;
		Принято=0;
		Расход=0;
		Для Каждого Стр из ТЧ1 Цикл
			Если НЕ Строка(Склад)="" Тогда 
				ОбластьДок = Макет.ПолучитьОбласть("Строка");
				ОбластьДок.Параметры.АртикулПоставщика = Стр.АртикулПоставщика;
				ОбластьДок.Параметры.Артикул = Стр.Артикул;
				ОбластьДок.Параметры.Изготовитель = Стр.Изготовитель;
				ОбластьДок.Параметры.ИзготовительПоставщика = Стр.ИзготовительПоставщика;
				ОбластьДок.Параметры.Цена = Стр.Цена;
				ОбластьДок.Параметры.Принято = Стр.Остаток+Стр.Приход;
				ОбластьДок.Параметры.НеПринято = Стр.НеПринято;
				ОбластьДок.Параметры.КРазмещению = Стр.Приход-Стр.НеПринято;
				ДокументРезультат.Вывести(ОбластьДок);
			Иначе
				ОбластьДок = Макет.ПолучитьОбласть("Строка|Товар");
				ОбластьДок.Параметры.АртикулПоставщика = Стр.АртикулПоставщика;
				ОбластьДок.Параметры.Артикул = Стр.Артикул;
				ОбластьДок.Параметры.Изготовитель = Стр.Изготовитель;
				ОбластьДок.Параметры.ИзготовительПоставщика = Стр.ИзготовительПоставщика;
				ОбластьДок.Параметры.Цена = Стр.Цена;
				ДокументРезультат.Вывести(ОбластьДок);
				Для Каждого СтрСК Из ТЧСКЛ Цикл 
					ОбластьСКЛ = Макет.ПолучитьОбласть("Строка|Склад");
					Если СтрСК.Склад=Стр.Склад Тогда 
						ОбластьСКЛ.Параметры.Принято = Стр.Остаток+Стр.Приход;
						ОбластьСКЛ.Параметры.НеПринято = Стр.НеПринято;
						ОбластьСКЛ.Параметры.КРазмещению = Стр.Приход-Стр.НеПринято;
					КонецЕсли;	
					ДокументРезультат.Присоединить(ОбластьСКЛ);
				КонецЦикла;	
			КонецЕсли;	
		КонецЦикла;	
		СтрукураВозврата = Новый Структура;
		СтрукураВозврата.Вставить("Результат",ДокументРезультат);
		СтрукураВозврата.Вставить("Ошибка",Ложь);
		СтрукураВозврата.Вставить("ОписаниеОшибк","");
	Исключение
		СтрукураВозврата = Новый Структура;
		СтрукураВозврата.Вставить("Результат",Новый ТаблицаЗначений);
		СтрукураВозврата.Вставить("Ошибка",Истина);
		СтрукураВозврата.Вставить("ОписаниеОшибк",ОписаниеОшибки());
	КонецПопытки;
	Возврат СтрукураВозврата;
КонецФункции
