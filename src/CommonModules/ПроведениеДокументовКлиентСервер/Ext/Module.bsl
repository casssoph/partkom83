
Функция ДанныеСтруктурыРегистраНакопления(вхРегистрНакопления) Экспорт
	
	лМетаданныеРегистра = Неопределено;
	Если (ТипЗнч(вхРегистрНакопления) = Тип("Строка")) тогда
		лМетаданныеРегистра = Метаданные.РегистрыНакопления.Найти(вхРегистрНакопления);
	ИначеЕсли (ТипЗнч(вхРегистрНакопления) = Тип("ОбъектМетаданных")) И Метаданные.РегистрыНакопления.Содержит(вхРегистрНакопления) тогда
		лМетаданныеРегистра = вхРегистрНакопления;
	КонецЕсли;
	
	Если (лМетаданныеРегистра = Неопределено) тогда
		ВызватьИсключение "[ДанныеСтруктурыРегистраНакопления]: неправильный параметр номер 1.";	
	КонецЕсли;		
	
	Результат = Новый Структура;
	Результат.Вставить("Период", лМетаданныеРегистра.СтандартныеРеквизиты.Период.Тип);
	Результат.Вставить("Регистратор", лМетаданныеРегистра.СтандартныеРеквизиты.Регистратор.Тип);
	
	Если (лМетаданныеРегистра.ВидРегистра = Метаданные.СвойстваОбъектов.ВидРегистраНакопления.Остатки) тогда
		Результат.Вставить("ВидДвижения", лМетаданныеРегистра.СтандартныеРеквизиты.ВидДвижения.Тип);
	КонецЕсли;
	
	Для Каждого лОбъектМетаданных Из лМетаданныеРегистра.Измерения цикл
		Результат.Вставить(лОбъектМетаданных.Имя, лОбъектМетаданных.Тип);
	КонецЦикла;
	
	Для Каждого лОбъектМетаданных Из лМетаданныеРегистра.Ресурсы цикл
		Результат.Вставить(лОбъектМетаданных.Имя, лОбъектМетаданных.Тип);
	КонецЦикла;
	
	Для Каждого лОбъектМетаданных Из лМетаданныеРегистра.Реквизиты цикл
		Результат.Вставить(лОбъектМетаданных.Имя, лОбъектМетаданных.Тип);
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

Функция ДанныеСтруктурыРегистраСведений(вхРегистрСведений) Экспорт
	
	лМетаданныеРегистра = Неопределено;
	Если (ТипЗнч(вхРегистрСведений) = Тип("Строка")) тогда
		лМетаданныеРегистра = Метаданные.РегистрыСведений.Найти(вхРегистрСведений);
	ИначеЕсли (ТипЗнч(вхРегистрСведений) = Тип("ОбъектМетаданных")) И Метаданные.РегистрыСведений.Содержит(вхРегистрСведений) тогда
		лМетаданныеРегистра = вхРегистрСведений;
	КонецЕсли;
	
	Если (лМетаданныеРегистра = Неопределено) тогда
		ВызватьИсключение "[ДанныеСтруктурыРегистраСведений]: неправильный параметр номер 1.";	
	КонецЕсли;		
	
	Результат = Новый Структура;
	Если (лМетаданныеРегистра.ПериодичностьРегистраСведений <> Метаданные.СвойстваОбъектов.ПериодичностьРегистраСведений.Непериодический) тогда
		Результат.Вставить("Период", лМетаданныеРегистра.СтандартныеРеквизиты.Период.Тип);
	КонецЕсли;
	Если (лМетаданныеРегистра.РежимЗаписи = Метаданные.СвойстваОбъектов.РежимЗаписиРегистра.ПодчинениеРегистратору) тогда
		Результат.Вставить("Регистратор", лМетаданныеРегистра.СтандартныеРеквизиты.Регистратор.Тип);
	КонецЕсли;
		
	Для Каждого лОбъектМетаданных Из лМетаданныеРегистра.Измерения цикл
		Результат.Вставить(лОбъектМетаданных.Имя, лОбъектМетаданных.Тип);
	КонецЦикла;
	
	Для Каждого лОбъектМетаданных Из лМетаданныеРегистра.Ресурсы цикл
		Результат.Вставить(лОбъектМетаданных.Имя, лОбъектМетаданных.Тип);
	КонецЦикла;
	
	Для Каждого лОбъектМетаданных Из лМетаданныеРегистра.Реквизиты цикл
		Результат.Вставить(лОбъектМетаданных.Имя, лОбъектМетаданных.Тип);
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

Функция ДанныеСтруктурыПоследовательности(вхПоследовательность) Экспорт
	
	лМетаданныеПоследовательности = Неопределено;
	Если (ТипЗнч(вхПоследовательность) = Тип("Строка")) тогда
		лМетаданныеПоследовательности = Метаданные.Последовательности.Найти(вхПоследовательность);
	ИначеЕсли (ТипЗнч(вхПоследовательность) = Тип("ОбъектМетаданных")) И Метаданные.Последовательности.Содержит(вхПоследовательность) тогда
		лМетаданныеПоследовательности = вхПоследовательность;
	КонецЕсли;
	
	Если (лМетаданныеПоследовательности = Неопределено) тогда
		ВызватьИсключение "[ДанныеСтруктурыПоследовательности]: неправильный параметр номер 1.";	
	КонецЕсли;		
	
	Результат = Новый Структура;
	Результат.Вставить("Период", Новый ОписаниеТипов("Дата", , , Новый КвалификаторыДаты(ЧастиДаты.ДатаВремя)));
	лМассивТипов = Новый Массив;
	Для Каждого лМетаданныеДокумента Из лМетаданныеПоследовательности.Документы цикл
		лМассивТипов.Добавить(Тип("ДокументСсылка." + лМетаданныеДокумента.Имя));
	КонецЦикла;
	Результат.Вставить("Регистратор", Новый ОписаниеТипов(лМассивТипов));
		
	Для Каждого лОбъектМетаданных Из лМетаданныеПоследовательности.Измерения цикл
		Результат.Вставить(лОбъектМетаданных.Имя, лОбъектМетаданных.Тип);
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

Процедура ОчиститьДвиженияДокумента(вхСсылкаНаДокумент, вхОчищаемыеРегистры = Неопределено) Экспорт
	
	лМетаданныеДокумента = Метаданные.НайтиПоТипу(ТипЗнч(вхСсылкаНаДокумент));
	Если (лМетаданныеДокумента = Неопределено) тогда
		Возврат;
	КонецЕсли;
	
	лОчищаемыеРегистры = Неопределено;
	лТип = ТипЗнч(вхОчищаемыеРегистры);
	Если (лТип = Тип("Строка")) тогда
		лОчищаемыеРегистры = Новый Структура(вхОчищаемыеРегистры);
	ИначеЕсли (лТип = Тип("Массив")) тогда
		лОчищаемыеРегистры = Новый Структура;
		Для Каждого лРегистр Из лОчищаемыеРегистры цикл
			лОчищаемыеРегистры.Вставить(лРегистр);
		КонецЦикла;
	ИначеЕсли (лТип = Тип("Структура")) тогда
		лОчищаемыеРегистры = вхОчищаемыеРегистры;
	ИначеЕсли (лТип = Тип("ОбъектМетаданных")) тогда
		лОчищаемыеРегистры = Новый Структура(вхОчищаемыеРегистры.Имя);
	КонецЕсли;
	
	лВсеРегистры = (лОчищаемыеРегистры = Неопределено);
	
	// очистка движений
	Для Каждого лМетаданныеРегистра Из лМетаданныеДокумента.Движения цикл
		Если НЕ лВсеРегистры И НЕ лОчищаемыеРегистры.Свойство(лМетаданныеРегистра.Имя) тогда
			Продолжить;
		КонецЕсли;
		
		лМенеджерОбъекта = ОбщегоНазначения.МенеджерОбъектаПоМетаданным(лМетаданныеРегистра);
		лНаборЗаписей = лМенеджерОбъекта.СоздатьНаборЗаписей();
		лНаборЗаписей.Отбор.Регистратор.Установить(вхСсылкаНаДокумент);
		лНаборЗаписей.Записать(Истина);
		
	КонецЦикла;
	
КонецПроцедуры

Функция ЗначенияДвиженийДокумента(вхСсылкаНаДокумент, вхМетаданныеРегистра, вхФильтр = Неопределено) Экспорт
	
	лМетаданныеДокумента = Метаданные.НайтиПоТипу(ТипЗнч(вхСсылкаНаДокумент));
	Если НЕ((лМетаданныеДокумента <> Неопределено) И Метаданные.Документы.Содержит(лМетаданныеДокумента)) тогда
		ВызватьИсключение "[ЗначенияДвиженийДокумента]: неправильный параметр номер 1.";
	КонецЕсли;
	
	Если лМетаданныеДокумента.Проведение <> Метаданные.СвойстваОбъектов.Проведение.Разрешить тогда
		ВызватьИсключение "[ЗначенияДвиженийДокумента]: неправильный параметр номер 1.";
	КонецЕсли;
	
	Если НЕ лМетаданныеДокумента.Движения.Содержит(вхМетаданныеРегистра) тогда
		ВызватьИсключение "[ЗначенияДвиженийДокумента]: регистр не входит в коллекцию движений документа.";
	КонецЕсли;
	
	ТекстПолей = "";
	СтруктураРеквизитов = Новый Структура;
	Если Метаданные.РегистрыНакопления.Содержит(вхМетаданныеРегистра) тогда
		лДанныеСтруктуры = ДанныеСтруктурыРегистраНакопления(вхМетаданныеРегистра);
	ИначеЕсли Метаданные.РегистрыСведений.Содержит(вхМетаданныеРегистра) тогда
		лДанныеСтруктуры = ДанныеСтруктурыРегистраСведений(вхМетаданныеРегистра);
	Иначе
		ВызватьИсключение "[ЗначенияДвиженийДокумента]: неправильный параметр номер 2.";
	КонецЕсли;
	
	Для Каждого лЭлементСтруктуры Из лДанныеСтруктуры цикл
		СтруктураРеквизитов.Вставить(лЭлементСтруктуры.Ключ);	
	КонецЦикла;
	
	Для Каждого КлючИЗначение Из СтруктураРеквизитов Цикл
		
		ИмяПоля   = ?(ЗначениеЗаполнено(КлючИЗначение.Значение),
		СокрЛП(КлючИЗначение.Значение),
		СокрЛП(КлючИЗначение.Ключ));
		
		Псевдоним = СокрЛП(КлючИЗначение.Ключ);
		
		ТекстПолей  = ТекстПолей + ?(ПустаяСтрока(ТекстПолей), "", ",") + "
		|	" + ИмяПоля + " КАК " + Псевдоним;
		
	КонецЦикла;
	
	лТекстУсловияФильтр = "";
	Если (ТипЗнч(вхФильтр) = Тип("Структура")) тогда
		Для Каждого лЭлементСтруктуры Из вхФильтр цикл
			лТекстУсловияФильтр = лТекстУсловияФильтр + "
			|	И ПсевдонимЗаданнойТаблицы." + лЭлементСтруктуры.Ключ + " = &" + лЭлементСтруктуры.Ключ;
		КонецЦикла;
	КонецЕсли;
		
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Ссылка", вхСсылкаНаДокумент);
	
	лТекстУсловияФильтр = "";
	Если (ТипЗнч(вхФильтр) = Тип("Структура")) тогда
		Для Каждого лЭлементСтруктуры Из вхФильтр цикл
			лТекстУсловияФильтр = лТекстУсловияФильтр + "
			|	И ПсевдонимЗаданнойТаблицы." + лЭлементСтруктуры.Ключ + " = &" + лЭлементСтруктуры.Ключ;
			Запрос.УстановитьПараметр(лЭлементСтруктуры.Ключ, лЭлементСтруктуры.Значение);
		КонецЦикла;
	КонецЕсли;
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|" + ТекстПолей + "
	|ИЗ
	|	" + вхМетаданныеРегистра.ПолноеИмя() + " КАК ПсевдонимЗаданнойТаблицы
	|ГДЕ
	|	ПсевдонимЗаданнойТаблицы.Регистратор = &Ссылка" + лТекстУсловияФильтр;
	
	//" ДЛЯ ИЗМЕНЕНИЯ " + вхМетаданныеРегистра.ПолноеИмя();
	
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции

Функция ЗначенияПоследовательностейДокумента(вхСсылкаНаДокумент, вхМетаданныеПоследовательности, вхФильтр = Неопределено) Экспорт
	
	лМетаданныеДокумента = Метаданные.НайтиПоТипу(ТипЗнч(вхСсылкаНаДокумент));
	Если НЕ((лМетаданныеДокумента <> Неопределено) И Метаданные.Документы.Содержит(лМетаданныеДокумента)) тогда
		ВызватьИсключение "[ЗначенияПоследовательностейДокумента]: неправильный параметр номер 1.";
	КонецЕсли;
	
	Если лМетаданныеДокумента.Проведение <> Метаданные.СвойстваОбъектов.Проведение.Разрешить тогда
		ВызватьИсключение "[ЗначенияПоследовательностейДокумента]: неправильный параметр номер 1.";
	КонецЕсли;
	
	Если НЕ вхМетаданныеПоследовательности.Документы.Содержит(лМетаданныеДокумента) тогда
		ВызватьИсключение "[ЗначенияПоследовательностейДокумента]: документ не входит в состав последовательности.";
	КонецЕсли;
	
	ТекстПолей = "";
	СтруктураРеквизитов = Новый Структура;
	лДанныеСтруктуры = ДанныеСтруктурыПоследовательности(вхМетаданныеПоследовательности);
	Для Каждого лЭлементСтруктуры Из лДанныеСтруктуры цикл
		СтруктураРеквизитов.Вставить(лЭлементСтруктуры.Ключ);	
	КонецЦикла;
	
	Для Каждого КлючИЗначение Из СтруктураРеквизитов Цикл
		
		ИмяПоля   = ?(ЗначениеЗаполнено(КлючИЗначение.Значение),
		СокрЛП(КлючИЗначение.Значение),
		СокрЛП(КлючИЗначение.Ключ));
		
		Псевдоним = СокрЛП(КлючИЗначение.Ключ);
		
		ТекстПолей  = ТекстПолей + ?(ПустаяСтрока(ТекстПолей), "", ",") + "
		|	" + ИмяПоля + " КАК " + Псевдоним;
		
	КонецЦикла;
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Ссылка", вхСсылкаНаДокумент);
	
	лТекстУсловияФильтр = "";
	Если (ТипЗнч(вхФильтр) = Тип("Структура")) тогда
		Для Каждого лЭлементСтруктуры Из вхФильтр цикл
			лТекстУсловияФильтр = лТекстУсловияФильтр + "
			|	И ПсевдонимЗаданнойТаблицы." + лЭлементСтруктуры.Ключ + " = &" + лЭлементСтруктуры.Ключ;
			Запрос.УстановитьПараметр(лЭлементСтруктуры.Ключ, лЭлементСтруктуры.Значение);
		КонецЦикла;
	КонецЕсли;
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|" + ТекстПолей + "
	|ИЗ
	|	" + вхМетаданныеПоследовательности.ПолноеИмя() + " КАК ПсевдонимЗаданнойТаблицы
	|ГДЕ
	|	ПсевдонимЗаданнойТаблицы.Регистратор = &Ссылка" + лТекстУсловияФильтр;
	
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции

Функция ПолучитьМоментыВремени(вхПоследовательность, вхДвижения) Экспорт
	
	лМетаданныеПоследовательности = Неопределено;	
	Если (ТипЗнч(вхПоследовательность) = Тип("Строка")) тогда
		лМетаданныеПоследовательности = Метаданные.Последовательности.Найти(вхПоследовательность);
	ИначеЕсли (ТипЗнч(вхПоследовательность) = Тип("ОбъектМетаданных")) И Метаданные.Последовательности.Содержит(вхПоследовательность) тогда
		лМетаданныеПоследовательности = вхПоследовательность;
	КонецЕсли;
	
	Если (лМетаданныеПоследовательности = Неопределено) тогда
		ВызватьИсключение "[ПолучитьМоментыВремени]: неправильный параметр номер 2.";
	КонецЕсли;
	
	лДанныеСтруктуры = ДанныеСтруктурыПоследовательности(лМетаданныеПоследовательности);
	лФильтр = Новый Структура;
	Результат = Новый ТаблицаЗначений;
	Результат.Колонки.Добавить("Период", лДанныеСтруктуры.Период);
	Результат.Колонки.Добавить("Регистратор", лДанныеСтруктуры.Регистратор);
	Для Каждого лИзмерение Из лМетаданныеПоследовательности.Измерения цикл
		Результат.Колонки.Добавить(лИзмерение.Имя, лИзмерение.Тип);
		лФильтр.Вставить(лИзмерение.Имя, );
	КонецЦикла;
	
	// обход таблицы движений и получение минимальных периодов
	Для Каждого лСтрокаДвижения Из вхДвижения цикл
		ЗаполнитьЗначенияСвойств(лФильтр, лСтрокаДвижения);
		лСтрокаРезультат = ОбщегоНазначения.НайтиСтрокуТаблицы(Результат, лФильтр);
		Если (лСтрокаРезультат = Неопределено) тогда
			лСтрокаРезультат = Результат.Добавить();
			ЗаполнитьЗначенияСвойств(лСтрокаРезультат, лСтрокаДвижения);
		Иначе
			Если (лСтрокаРезультат.Период > лСтрокаДвижения.Период) тогда
				лСтрокаРезультат.Период = лСтрокаДвижения.Период;
			КонецЕсли;
		КонецЕсли;		
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

Процедура ЗаписатьДвижения(вхСсылкаНаДокумент, вхОбъектМетаданных, вхДанныеДвижений, вхБазовыеДвижения = Неопределено, вхПараметры = Неопределено) Экспорт
	
	лКлючАлгоритма = "ОбщийМодуль_ПроведениеДокументовКлиентСервер_ЗаписатьДвижения";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		Выполнить(лЗамена);
		Возврат;
	КонецЕсли;
	///////////////////////////////////////////////////////////////////////////
	
	Если НЕ вхДанныеДвижений.Замещать И (вхДанныеДвижений.Движения.Количество() = 0) тогда
		Возврат;
	КонецЕсли;
	
	лГруппировки = "";
	лРесурсы = "";
	лФильтр = Неопределено;
	лМенеджерОбъекта = ОбщегоНазначения.МенеджерОбъектаПоМетаданным(вхОбъектМетаданных);
	
	Если Метаданные.РегистрыНакопления.Содержит(вхОбъектМетаданных) тогда
		лФильтр = Новый Структура;
		лДанныеСтруктуры = ДанныеСтруктурыРегистраНакопления(вхОбъектМетаданных);
		Для Каждого лКолонка Из вхДанныеДвижений.Движения.Колонки цикл
			Если (вхОбъектМетаданных.Ресурсы.Найти(лКолонка.Имя) = Неопределено) тогда
				лГруппировки = лГруппировки + лКолонка.Имя + ",";
			Иначе
				лФильтр.Вставить(лКолонка.Имя, 0);
				лРесурсы = лРесурсы + лКолонка.Имя + ",";
			КонецЕсли;
		КонецЦикла;
	Иначе
		Для Каждого лКолонка Из вхДанныеДвижений.Движения.Колонки цикл
			лГруппировки = лГруппировки + лКолонка.Имя + ",";
		КонецЦикла;
	КонецЕсли;
	
	лТабДвиж = вхДанныеДвижений.Движения.Скопировать();
	
	// заполняем данные по умолчанию
	Если ДвиженияДатойДокумента(вхСсылкаНаДокумент) Тогда
		лТабДвиж.ЗаполнитьЗначения(ОбщегоНазначения.ЗначениеРеквизитаОбъекта(вхСсылкаНаДокумент, "Дата"), "Период");
	КонецЕсли;
	лТабДвиж.ЗаполнитьЗначения(вхСсылкаНаДокумент, "Регистратор");
	
	лТабДвиж.Свернуть(лГруппировки, лРесурсы);
	
	// удаляем нулевые строки
	Если (лФильтр <> Неопределено) тогда
		лСтрокиУдаления = лТабДвиж.НайтиСтроки(лФильтр);	
		Для Каждого лСтрокаУдаления Из лСтрокиУдаления цикл
			лТабДвиж.Удалить(лСтрокаУдаления);
		КонецЦикла;
	КонецЕсли;
	
	// дополняем базовыми движениями
	Если вхДанныеДвижений.Замещать И (ТипЗнч(вхБазовыеДвижения) = Тип("ТаблицаЗначений")) тогда
		Для Каждого лСтрокаБазовыеДвижения Из вхБазовыеДвижения цикл
			лСтрокаТабДвиж = лТабДвиж.Добавить();
			ЗаполнитьЗначенияСвойств(лСтрокаТабДвиж, лСтрокаБазовыеДвижения);
		КонецЦикла;		
	КонецЕсли;
		
	// запись движений
	ОбщегоНазначения.ЗаписатьДвиженияДокументаБезОбработки(вхСсылкаНаДокумент, лМенеджерОбъекта, лТабДвиж, вхДанныеДвижений.Замещать, вхПараметры);
	
КонецПроцедуры

Функция ДвиженияДатойДокумента(вхСсылкаНаДокумент)
	
	ДвиженияДатойДокумента = Истина;
	
	Если ТипЗнч(вхСсылкаНаДокумент) = Тип("ДокументСсылка.ВозвратТоваровОтПокупателя")
		И ОбщегоНазначения.ЗначениеРеквизитаОбъекта(вхСсылкаНаДокумент, "ВидОперации") = Перечисления.ВидыОперацийВозвратаОтПокупателя.МФП Тогда
		
		ДвиженияДатойДокумента = Ложь;
		
	КонецЕсли;
	
	Возврат ДвиженияДатойДокумента;
	
КонецФункции

Функция ПрочитатьЗначение(вхСтруктура, вхПутьКДанным, выхЗначение) Экспорт
	
	Если НЕ ОбщегоНазначения.ЭтоПрограммныйИдентификатор(вхПутьКДанным, Истина) тогда
		ВызватьИсключение "[ПрочитатьЗначение]: неправильный параметр номер 2.";
	КонецЕсли;
	
	Если ТипЗнч(вхСтруктура) <> Тип("Структура") тогда
		Возврат Ложь;
	КонецЕсли;
	
	лПодстроки = ОбщегоНазначения.РазложитьСтрокуВМассивПодстрок(вхПутьКДанным, ".");
	лТекущийИсточник = вхСтруктура;
	Для Каждого лПодстрока Из лПодстроки цикл
		лПромЗнач = Неопределено;
		Если (ТипЗнч(лТекущийИсточник) = Тип("Структура")) И лТекущийИсточник.Свойство(лПодстрока, лПромЗнач) тогда
			лТекущийИсточник = лПромЗнач;
		Иначе
			Возврат Ложь;
		КонецЕсли;
	КонецЦикла;
	
	выхЗначение = лТекущийИсточник;
	Возврат Истина;
	
КонецФункции

Процедура ЗаписатьЗначение(вхСтруктура, вхПутьКДанным, вхЗначение) Экспорт
	
	Если ТипЗнч(вхСтруктура) <> Тип("Структура") тогда
		вхСтруктура = Новый Структура;
	КонецЕсли;
	
	Если НЕ ОбщегоНазначения.ЭтоПрограммныйИдентификатор(вхПутьКДанным, Истина) тогда
		ВызватьИсключение "[ЗаписатьЗначение]: неправильный параметр номер 2.";
	КонецЕсли;
	
	лПодстроки = ОбщегоНазначения.РазложитьСтрокуВМассивПодстрок(вхПутьКДанным, ".");
	лКоличество = лПодстроки.Количество();
	лТекущийИсточник = вхСтруктура;
	лСчетчик = 0;
	Для Каждого лПодстрока Из лПодстроки цикл
		лСчетчик = лСчетчик + 1;
		Если (лСчетчик = лКоличество) тогда
			лТекущийИсточник.Вставить(лПодстрока, вхЗначение);
		Иначе
			Если НЕ лТекущийИсточник.Свойство(лПодстрока) тогда
				лТекущийИсточник.Вставить(лПодстрока, Новый Структура);
			КонецЕсли;		
			лТекущийИсточник.Свойство(лПодстрока, лТекущийИсточник);
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

Функция ПроводитсяПо(вхПараметры, вхРегистр) Экспорт
	
	Результат = Истина;
	лРегистрыДвижений = Неопределено;
	
	лРегистр = вхРегистр;
	Если ТипЗнч(лРегистр) = Тип("ОбъектМетаданных") тогда
		лРегистр = лРегистр.Имя;
	КонецЕсли;
	
	Если ПрочитатьЗначение(вхПараметры, "РегистрыДвижений", лРегистрыДвижений) тогда
			
		лСтруктураРегистров = лРегистрыДвижений;
		Если ТипЗнч(лСтруктураРегистров) = Тип("Строка") тогда
			лСтруктураРегистров = Новый Структура(лСтруктураРегистров);
		КонецЕсли;
				
		Результат = лСтруктураРегистров.Свойство(лРегистр); 	
	КонецЕсли;
	
	//[Тарасов А.В.]
	СписокРегистровЗапрещенныхКПроведению = ПараметрыСеанса.СписокРегистровЗапрещенныхКПроведению;
	Если СписокРегистровЗапрещенныхКПроведению.Количество() <> 0 Тогда
		
		Если Метаданные.РегистрыНакопления.Найти(вхРегистр) <> Неопределено Тогда
			Если СписокРегистровЗапрещенныхКПроведению.Найти("РегистрНакопления." + лРегистр) <> Неопределено Тогда
				Результат = Ложь;
			КонецЕсли;	
		КонецЕсли;
		
		Если Метаданные.РегистрыСведений.Найти(вхРегистр) <> Неопределено Тогда
			Если СписокРегистровЗапрещенныхКПроведению.Найти("РегистрСведений." + лРегистр) <> Неопределено Тогда
				Результат = Ложь;
			КонецЕсли;	
		КонецЕсли;		
		
	КонецЕсли;
	//[Тарасов А.В.]
	
	Возврат Результат;
	
КонецФункции

Процедура ЗарегистрироватьОбъектВОбменПартКом77_83(вхИсточник, вхОтказ)
	
	лМетаданныеПланаОбмена = Метаданные.ПланыОбмена.ОбменПартКом77_83;
	лМетаданныеИсточника = Метаданные.НайтиПоТипу(ТипЗнч(вхИсточник));
	
	Если (лМетаданныеИсточника <> Неопределено) тогда
		
		лЭлементСостава = лМетаданныеПланаОбмена.Состав.Найти(лМетаданныеИсточника);
		Если (лЭлементСостава = Неопределено) ИЛИ (лЭлементСостава.АвтоРегистрация = АвтоРегистрацияИзменений.Разрешить) тогда
			Возврат;
		КонецЕсли;
		
		лРезультат = Истина;
		лУзлы = Неопределено;
		лКромеУзлов = Неопределено;
		лРегистрацияИзменений = Неопределено;
		Если ПрочитатьЗначение(вхИсточник.ДополнительныеСвойства, "РегистрацияИзменений", лРегистрацияИзменений) тогда
			лРезультат = Ложь;
			Если (ТипЗнч(лРегистрацияИзменений) = Тип("Структура")) тогда
				лЕстьУзлы = лРегистрацияИзменений.Свойство("Узлы", лУзлы);
				лЕстьКромеУзлов = лРегистрацияИзменений.Свойство("КромеУзлов", лКромеУзлов);
				лРезультат = лЕстьУзлы ИЛИ лЕстьКромеУзлов;
			КонецЕсли;
		КонецЕсли;
		
		Если ПрочитатьЗначение(вхИсточник.ДополнительныеСвойства, "ОтключитьМеханизмРегистрацииОбъектов", Ложь) тогда
			   лРезультат = Ложь;
		КонецЕсли;	   
		
		Если лРезультат тогда
			
			лКромеУзловСкорректированный = Новый Массив;
			Если вхИсточник.ОбменДанными.Загрузка тогда
				// дополнительно исключаем отправителя
				Если ЗначениеЗаполнено(вхИсточник.ОбменДанными.Отправитель) тогда
					лКромеУзловСкорректированный.Добавить(вхИсточник.ОбменДанными.Отправитель);		
				КонецЕсли;			
			КонецЕсли;
			
			Если (лКромеУзлов = Неопределено) тогда
			ИначеЕсли ТипЗнч(лКромеУзлов) = Тип("Массив") тогда
				Для Каждого лЭлементМассива Из лКромеУзлов цикл
					лКромеУзловСкорректированный.Добавить(лЭлементМассива);
				КонецЦикла;
			Иначе
				лКромеУзловСкорректированный.Добавить(лКромеУзлов);
			КонецЕсли;	
			
			ОбменДаннымиКлиентСервер.ЗарегистрироватьОбъектВУзлах(вхИсточник, лМетаданныеПланаОбмена, 
			лУзлы, лКромеУзловСкорректированный);
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

Процедура РегистрацияИзмененийДокументовПередЗаписью(Источник, Отказ, РежимЗаписи, РежимПроведения) Экспорт

	лПредставлениеРазличий = "";
	лНеобходимаРегистрацияИзменений = ОбменДаннымиКлиентСервер.НеобходимаРегистрацияИзменений(
	Метаданные.ПланыОбмена.ОбменПартКом77_83, Источник, лПредставлениеРазличий);
	Если НЕ лНеобходимаРегистрацияИзменений тогда
		ЗаписатьЗначение(Источник.ДополнительныеСвойства, "РегистрацияИзменений.КромеУзлов", 
		ОбменДаннымиКлиентСервер.ПолучитьИсходящийУзелОбмена(Метаданные.ПланыОбмена.ОбменПартКом77_83, 1));
	Иначе
		ЗаписатьЗначение(Источник.ДополнительныеСвойства, "ПредставлениеРазличий", лПредставлениеРазличий);
	КонецЕсли;	
	
КонецПроцедуры

Процедура РегистрацияИзмененийДокументовПриЗаписи(Источник, Отказ) Экспорт
	ЗарегистрироватьОбъектВОбменПартКом77_83(Источник, Отказ);	
КонецПроцедуры

Процедура РегистрацияИзмененийДокументовПередУдалениемПередУдалением(Источник, Отказ) Экспорт
	ЗарегистрироватьОбъектВОбменПартКом77_83(Источник, Отказ);	
КонецПроцедуры

Процедура РегистрацияИзмененийСправочниковПриЗаписи(Источник, Отказ) Экспорт
	ЗарегистрироватьОбъектВОбменПартКом77_83(Источник, Отказ);	
КонецПроцедуры

Процедура РегистрацияИзмененийСправочниковПередУдалением(Источник, Отказ) Экспорт
	ЗарегистрироватьОбъектВОбменПартКом77_83(Источник, Отказ);	
КонецПроцедуры

//Регистрация ОбменПартКом83_77
Процедура ОбменПартКом83_77_РегистрацияИзмененийДокументовПередЗаписью(Источник, Отказ, РежимЗаписи, РежимПроведения) Экспорт

	лПредставлениеРазличий = "";
	лНеобходимаРегистрацияИзменений = ОбменДаннымиКлиентСервер.НеобходимаРегистрацияИзменений(
	Метаданные.ПланыОбмена.ОбменПартКом83_77, Источник, лПредставлениеРазличий);
	
	ОбменПартКом83_77_РегистрацияИзмененийДокументовПередЗаписьюКонтрольРегистрации(Источник, Отказ, РежимЗаписи, РежимПроведения, лНеобходимаРегистрацияИзменений);
	
	Если НЕ лНеобходимаРегистрацияИзменений тогда
		ЗаписатьЗначение(Источник.ДополнительныеСвойства, "РегистрацияИзменений.КромеУзлов", 
		ОбменДаннымиКлиентСервер.ПолучитьИсходящийУзелОбмена(Метаданные.ПланыОбмена.ОбменПартКом83_77, 2));
	Иначе
		//Нужно удалить узел 
		ЗаписатьЗначение(Источник.ДополнительныеСвойства, "ПредставлениеРазличий", лПредставлениеРазличий);
	КонецЕсли;	
	
КонецПроцедуры

Процедура ОбменПартКом83_77_РегистрацияИзмененийДокументовПередЗаписьюКонтрольРегистрации(Источник, Отказ, РежимЗаписи, РежимПроведения, лНеобходимаРегистрацияИзменений)
	
	Если ТипЗнч(Источник) = Тип("ДокументОбъект.СчетФактураВыданный") Тогда
		
		лНеобходимаРегистрацияИзменений = Ложь;
		
		Если Источник.ДокументыОснования.Количество() > 0 Тогда
			
			ДокументОснование = Источник.ДокументыОснования[0].ДокументОснование;
			Если ЗначениеЗаполнено(ДокументОснование) Тогда
				Контрагент = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДокументОснование, "Контрагент");
				Если ЗначениеЗаполнено(Источник.Контрагент) тогда
					лЭтоПитер = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Источник.Контрагент, "ПокупательИзДрБазы");
					Если лЭтоПитер тогда
						лНеобходимаРегистрацияИзменений = Истина;
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
			
		КонецЕсли;
		
		Если ЗначениеЗаполнено(Источник.Контрагент) тогда
			лЭтоПитер = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Источник.Контрагент, "ПокупательИзДрБазы");
			Если лЭтоПитер тогда
				лНеобходимаРегистрацияИзменений = Истина;
			КонецЕсли;
		КонецЕсли;
		
	КонецЕсли;
		
КонецПроцедуры

Процедура ОбменПартКом83_77_РегистрацияИзмененийДокументовПриЗаписи(Источник, Отказ) Экспорт
	ЗарегистрироватьОбъектВОбменПартКом83_77(Источник, Отказ);	
КонецПроцедуры

Процедура ОбменПартКом83_77_РегистрацияИзмененийДокументовПередУдалением(Источник, Отказ) Экспорт
	ЗарегистрироватьОбъектВОбменПартКом83_77(Источник, Отказ);	
КонецПроцедуры

Процедура ЗарегистрироватьОбъектВОбменПартКом83_77(вхИсточник, вхОтказ)
	
	лМетаданныеПланаОбмена = Метаданные.ПланыОбмена.ОбменПартКом83_77;
	лМетаданныеИсточника = Метаданные.НайтиПоТипу(ТипЗнч(вхИсточник));
	
	Если (лМетаданныеИсточника <> Неопределено) тогда
		
		лЭлементСостава = лМетаданныеПланаОбмена.Состав.Найти(лМетаданныеИсточника);
		Если (лЭлементСостава = Неопределено) ИЛИ (лЭлементСостава.АвтоРегистрация = АвтоРегистрацияИзменений.Разрешить) тогда
			Возврат;
		КонецЕсли;
		
		лРезультат = Истина;
		лУзлы = Неопределено;
		лКромеУзлов = Неопределено;
		лРегистрацияИзменений = Неопределено;
		Если ПрочитатьЗначение(вхИсточник.ДополнительныеСвойства, "РегистрацияИзменений", лРегистрацияИзменений) тогда
			лРезультат = Ложь;
			Если (ТипЗнч(лРегистрацияИзменений) = Тип("Структура")) тогда
				лЕстьУзлы = лРегистрацияИзменений.Свойство("Узлы", лУзлы);
				лЕстьКромеУзлов = лРегистрацияИзменений.Свойство("КромеУзлов", лКромеУзлов);
				лРезультат = лЕстьУзлы ИЛИ лЕстьКромеУзлов;
			КонецЕсли;
		КонецЕсли;
		
		Если лРезультат тогда
			
			лКромеУзловСкорректированный = Новый Массив;
			Если вхИсточник.ОбменДанными.Загрузка тогда
				// дополнительно исключаем отправителя
				Если ЗначениеЗаполнено(вхИсточник.ОбменДанными.Отправитель) тогда
					лКромеУзловСкорректированный.Добавить(вхИсточник.ОбменДанными.Отправитель);		
				КонецЕсли;			
			КонецЕсли;
			
			Если (лКромеУзлов = Неопределено) тогда
			ИначеЕсли ТипЗнч(лКромеУзлов) = Тип("Массив") тогда
				Для Каждого лЭлементМассива Из лКромеУзлов цикл
					лКромеУзловСкорректированный.Добавить(лЭлементМассива);
				КонецЦикла;
			Иначе
				лКромеУзловСкорректированный.Добавить(лКромеУзлов);
			КонецЕсли;	
			
			ОбменДаннымиКлиентСервер.ЗарегистрироватьОбъектВУзлах(вхИсточник, лМетаданныеПланаОбмена, 
			лУзлы, лКромеУзловСкорректированный);
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры
//

Процедура РассчитатьСписаниеПоПартиям(ТабТоваров, ТабПартий, Результат)
	
	ЕстьТорговаяТочка = ?(ТабПартий.Колонки.Найти("ТорговаяТочка") = Неопределено, Ложь, Истина);
	
	тхтСообщения = "";
	Если Результат.Колонки.Найти("ИмяРегистра") = Неопределено Тогда
		Результат.Колонки.Добавить("ИмяРегистра", Новый ОписаниеТипов("Строка"));
	КонецЕсли;
	
	ПараметрОтбора = Новый Структура;
	Для Каждого СтрокаТовара Из ТабТоваров Цикл
		
		КолвоСписать = СтрокаТовара.Количество;
		
		Параметротбора.Очистить();
		Если ЗначениеЗаполнено(СтрокаТовара.СтрокаПрихода) Тогда
			ПараметрОтбора.Вставить("СтрокаПрихода", СтрокаТовара.СтрокаПрихода);
		КонецЕсли;
		ПараметрОтбора.Вставить("ЕдиницаИзмерения", СтрокаТовара.ЕдиницаИзмерения);
				
		СтрокиПартий = ТабПартий.НайтиСтроки(ПараметрОтбора);
		
		Если СтрокиПартий.Количество() = 0 Тогда
			тхтСообщения = тхтСообщения + Символ(13) + "для товара " + СтрокаТовара.Наименование 
			+ " не найдено ни одной партии (строка " + СтрокаТовара.НомерСтроки + ").";
		Иначе
			Для Каждого СтрокаПартии Из СтрокиПартий Цикл
				Если СтрокаПартии.КоличествоОстаток <= 0 Тогда
					Продолжить;
				КонецЕсли;
				Если КолвоСписать <= 0 Тогда
					Прервать;
				КонецЕсли;
				ЦенаРубли 	= Окр(СтрокаПартии.СуммаРублиОстаток/СтрокаПартии.КоличествоОстаток, 2);
				ЦенаДоллары = Окр(СтрокаПартии.СуммаДолларыОстаток/СтрокаПартии.КоличествоОстаток, 2);
				ЦенаЕвро 	= Окр(СтрокаПартии.СуммаЕвроОстаток/СтрокаПартии.КоличествоОстаток, 2);
				Если КолвоСписать <= СтрокаПартии.КоличествоОстаток Тогда
					ЗаписьРегистра = Результат.Добавить();
					ЗаписьРегистра.Период = СтрокаТовара.ДатаСписания;
					ЗаписьРегистра.Регистратор = СтрокаТовара.Ссылка;
					ЗаписьРегистра.ИмяРегистра = СтрокаПартии.ИмяРегистра;
					ЗаписьРегистра.ВидДвижения = ВидДвиженияНакопления.Расход;
					ЗаписьРегистра.Склад = СтрокаТовара.Склад;
					ЗаписьРегистра.Номенклатура = СтрокаТовара.Номенклатура;
					ЗаписьРегистра.ЕдиницаИзмерения = СтрокаТовара.ЕдиницаИзмерения;
					ЗаписьРегистра.СтрокаПрихода = СтрокаПартии.СтрокаПрихода;
					ЗаписьРегистра.Количество = КолвоСписать;
					ЗаписьРегистра.СуммаРубли = ЗаписьРегистра.Количество * ЦенаРубли;
					ЗаписьРегистра.СуммаДоллары = ЗаписьРегистра.Количество * ЦенаДоллары;
					ЗаписьРегистра.СуммаЕвро = ЗаписьРегистра.Количество * ЦенаЕвро;
					СтрокаПартии.КоличествоОстаток = СтрокаПартии.КоличествоОстаток - КолвоСписать;
					Если ЕстьТорговаяТочка Тогда
						ЗаписьРегистра.ТорговаяТочка = СтрокаПартии.ТорговаяТочка;
						ЗаписьРегистра.СостояниеПартии = СтрокаТовара.СостояниеПартии;
					КонецЕсли;
					КолвоСписать = 0;
					Прервать;
				Иначе
					ЗаписьРегистра = Результат.Добавить();
					ЗаписьРегистра.Период = СтрокаТовара.ДатаСписания;
					ЗаписьРегистра.Регистратор = СтрокаТовара.Ссылка;
					ЗаписьРегистра.ИмяРегистра = СтрокаПартии.ИмяРегистра;
					ЗаписьРегистра.ВидДвижения = ВидДвиженияНакопления.Расход;
					ЗаписьРегистра.Склад = СтрокаТовара.Склад;
					ЗаписьРегистра.Номенклатура = СтрокаТовара.Номенклатура;
					ЗаписьРегистра.ЕдиницаИзмерения = СтрокаТовара.ЕдиницаИзмерения;
					ЗаписьРегистра.СтрокаПрихода = СтрокаПартии.СтрокаПрихода;
					ЗаписьРегистра.Количество = СтрокаПартии.КоличествоОстаток;
					ЗаписьРегистра.СуммаРубли = ЗаписьРегистра.Количество * ЦенаРубли;
					ЗаписьРегистра.СуммаДоллары = ЗаписьРегистра.Количество * ЦенаДоллары;
					ЗаписьРегистра.СуммаЕвро = ЗаписьРегистра.Количество * ЦенаЕвро;
					КолвоСписать = КолвоСписать - СтрокаПартии.КоличествоОстаток;
					Если ЕстьТорговаяТочка Тогда
						ЗаписьРегистра.ТорговаяТочка = СтрокаПартии.ТорговаяТочка;
						ЗаписьРегистра.СостояниеПартии = СтрокаТовара.СостояниеПартии;
					КонецЕсли;
					СтрокаПартии.КоличествоОстаток = 0;
				КонецЕсли;
			
			КонецЦикла;
			
			Если КолвоСписать > 0 Тогда
				Параметротбора.Очистить();
				ПараметрОтбора.Вставить("ЕдиницаИзмерения", СтрокаТовара.ЕдиницаИзмерения);
				
				СтрокиПартий = ТабПартий.НайтиСтроки(ПараметрОтбора);
		
				Если СтрокиПартий.Количество() = 0 Тогда
					тхтСообщения = тхтСообщения + Символ(13) + "для товара " + СтрокаТовара.Наименование 
					+ " распределено по партиям не все количество (строка " + СтрокаТовара.НомерСтроки + ").";
				Иначе
					Для Каждого СтрокаПартии Из СтрокиПартий Цикл
						Если СтрокаПартии.КоличествоОстаток <= 0 Тогда
							Продолжить;
						КонецЕсли;
						Если КолвоСписать <= СтрокаПартии.КоличествоОстаток Тогда
							ЗаписьРегистра = Результат.Добавить();
							ЗаписьРегистра.Период = СтрокаТовара.ДатаСписания;
							ЗаписьРегистра.Регистратор = СтрокаТовара.Ссылка;
							ЗаписьРегистра.ИмяРегистра = СтрокаПартии.ИмяРегистра;
							ЗаписьРегистра.ВидДвижения = ВидДвиженияНакопления.Расход;
							ЗаписьРегистра.Склад = СтрокаТовара.Склад;
							ЗаписьРегистра.Номенклатура = СтрокаТовара.Номенклатура;
							ЗаписьРегистра.ЕдиницаИзмерения = СтрокаТовара.ЕдиницаИзмерения;
							ЗаписьРегистра.СтрокаПрихода = СтрокаПартии.СтрокаПрихода;
							ЗаписьРегистра.Количество = КолвоСписать;
							СтрокаПартии.КоличествоОстаток = СтрокаПартии.КоличествоОстаток - КолвоСписать;
							Если ЕстьТорговаяТочка Тогда
								ЗаписьРегистра.ТорговаяТочка = СтрокаПартии.ТорговаяТочка;
								ЗаписьРегистра.СостояниеПартии = СтрокаТовара.СостояниеПартии;
							КонецЕсли;
							КолвоСписать = 0;
							Прервать;
						Иначе
							ЗаписьРегистра = Результат.Добавить();
							ЗаписьРегистра.Период = СтрокаТовара.ДатаСписания;
							ЗаписьРегистра.Регистратор = СтрокаТовара.Ссылка;
							ЗаписьРегистра.ИмяРегистра = СтрокаПартии.ИмяРегистра;
							ЗаписьРегистра.ВидДвижения = ВидДвиженияНакопления.Расход;
							ЗаписьРегистра.Склад = СтрокаТовара.Склад;
							ЗаписьРегистра.Номенклатура = СтрокаТовара.Номенклатура;
							ЗаписьРегистра.ЕдиницаИзмерения = СтрокаТовара.ЕдиницаИзмерения;
							ЗаписьРегистра.СтрокаПрихода = СтрокаПартии.СтрокаПрихода;
							ЗаписьРегистра.Количество = СтрокаПартии.КоличествоОстаток;
							Если ЕстьТорговаяТочка Тогда
								ЗаписьРегистра.ТорговаяТочка = СтрокаПартии.ТорговаяТочка;
								ЗаписьРегистра.СостояниеПартии = СтрокаТовара.СостояниеПартии;
							КонецЕсли;
							КолвоСписать = КолвоСписать - СтрокаПартии.КоличествоОстаток;
							СтрокаПартии.КоличествоОстаток = 0;
						КонецЕсли;
			
					КонецЦикла;
					
				КонецЕсли;
				
				Если КолвоСписать > 0 Тогда
					тхтСообщения = тхтСообщения + Символ(13) + "для товара " + СтрокаТовара.Наименование 
					+ " распределено по партиям не все количество (строка " + СтрокаТовара.НомерСтроки + ").";
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	
	//Если НЕ ПустаяСтрока(тхтСообщения) Тогда
	//	тхтСообщения = "Проведение по партиям " + Строка(СтрокаТовара.Ссылка) + тхтСообщения;
	//	СписокАдресатов = Новый СписокЗначений;
	//	СписокАдресатов.Добавить("Astashov-DO@part-kom.ru");
	//	СписокАдресатов.Добавить("Golubev-SV@part-kom.ru");
	//	РассылкаСообщенийОбОшибках.ОтправитьЭлектронноеСообщениеБезСохранения(тхтСообщения, "!!! ошибки проведения", СписокАдресатов);
	//КонецЕсли;
	
КонецПроцедуры

Функция ПогашениеПартийТоваровУпр(вхСсылкаНаДокумент, вхРегистрНакопления = Неопределено, вхПараметры = Неопределено) Экспорт
	
	Структура = ПолучитьТаблицыТоваровПартий(вхСсылкаНаДокумент, вхРегистрНакопления, вхПараметры);
	
	РассчитатьСписаниеПоПартиям(Структура.ТабТоваров, Структура.ТабПартий, Структура.Результат);
	Возврат Структура.Результат;
	
КонецФункции

Функция ПолучитьТаблицыТоваровПартий(вхСсылкаНаДокумент, вхРегистрНакопления = Неопределено, вхПараметры = Неопределено)
	
	Если вхРегистрНакопления <> "ПартииТоваровУпр" Тогда
		Если вхРегистрНакопления <> "ПартииТоваровVMI" Тогда
			ВызватьИсключение "[ПогашениеПартийТоваровУпр]: неправильный параметр номер 2.";
		КонецЕсли;
	КонецЕсли;
	
	Результат = Неопределено;
	Если вхРегистрНакопления = Неопределено Тогда
		ОбщегоНазначения.СоздатьСтруктуруРегистраНакопления("ПартииТоваровУпр", Результат);
	Иначе
		ОбщегоНазначения.СоздатьСтруктуруРегистраНакопления(вхРегистрНакопления, Результат);
	КонецЕсли;
	
	лМетаданныеДокумента = Метаданные.НайтиПоТипу(ТипЗнч(вхСсылкаНаДокумент));
	Если НЕ((лМетаданныеДокумента <> Неопределено) И Метаданные.Документы.Содержит(лМетаданныеДокумента)) тогда
		ВызватьИсключение "[ПогашениеПартийТоваровУпр]: неправильный параметр номер 1.";
	КонецЕсли;
	
	Если лМетаданныеДокумента.Проведение <> Метаданные.СвойстваОбъектов.Проведение.Разрешить тогда
		ВызватьИсключение "[ПогашениеПартийТоваровУпр]: неправильный параметр номер 1.";
	КонецЕсли;
	
	ЕстьРеквизитСклад = ОбщегоНазначения.ЕстьРеквизитДокумента("Склад", лМетаданныеДокумента);
	ЕстьТорговаяТочка = ?(вхРегистрНакопления = "ПартииТоваровVMI", Истина, Ложь);
	
	Запрос = Новый Запрос;
	
	Если вхПараметры <> Неопределено Тогда
		Если вхПараметры.Свойство("Фильтр") = Неопределено Тогда
			вхФильтр = вхПараметры.Фильтр;
			
		Иначе
			вхФильтр = Неопределено;
			
		КонецЕсли;
		
		ПереданФильтр = "";
		Если ТипЗнч(вхФильтр) = Тип("Структура") Тогда
			Для Каждого КлючИЗначение Из вхФильтр цикл
				ПереданФильтр = ПереданФильтр + "
				|	И ДокументТовары." + КлючИЗначение.Ключ + " = &" + КлючИЗначение.Ключ;
				Запрос.УстановитьПараметр(КлючИЗначение.Ключ, КлючИЗначение.Значение);
			КонецЦикла;
		
		КонецЕсли;
		
	КонецЕсли;
			
	Запрос.Текст =
	"ВЫБРАТЬ "
	+ ?(ЕстьРеквизитСклад, "
	|	ДокументТовары.Ссылка.Склад КАК Склад,", "
	|	ДокументТовары.Ссылка.СкладОтправитель КАК Склад,") + "
	|	ДокументТовары.НомерСтроки,
	|	ДокументТовары.Номенклатура.Наименование КАК Наименование,
	|	ДокументТовары.ЕдиницаИзмерения,
	|	ДокументТовары.Номенклатура,
	|	ДокументТовары.Количество,
	|	ДокументТовары.СтрокаПрихода,
	|	&СостояниеПартии КАК СостояниеПартии,
	|	ДокументТовары.Ссылка,
	|	ДокументТовары.Ссылка.Дата КАК ДатаСписания
	|ПОМЕСТИТЬ ТабТоваров
	|ИЗ "
	+ лМетаданныеДокумента.ПолноеИмя() + ".Товары КАК ДокументТовары
	|ГДЕ
	|	ДокументТовары.Ссылка = &Ссылка И Не ДокументТовары.Номенклатура.Услуга"
	+ ПереданФильтр + ";
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ * ИЗ ТабТоваров;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ"
	+ ?(ЕстьТорговаяТочка, " ПартииТоваровОстатки.СтрокаПрихода.ТорговаяТочка КАК ТорговаяТочка,", "") + "
	|	ПартииТоваровОстатки.СтрокаПрихода КАК СтрокаПрихода,
	|	ПартииТоваровОстатки.ЕдиницаИзмерения,
	|	ПартииТоваровОстатки.Номенклатура,
	|	ПартииТоваровОстатки.КоличествоОстаток,
	|	ПартииТоваровОстатки.СуммаРублиОстаток,
	|	ПартииТоваровОстатки.СуммаДолларыОстаток,
	|	ПартииТоваровОстатки.СуммаЕвроОстаток,
	|	ПартииТоваровОстатки.СтрокаПрихода.Дата КАК ПорядокСписания,
	|	ПартииТоваровОстатки.СтрокаПрихода.Приход КАК СтрокаПриходаСсылка,
	|	""" + вхРегистрНакопления + """ КАК ИмяРегистра
	|ИЗ
	|	РегистрНакопления." + вхРегистрНакопления + ".Остатки(
	|			&МоментВремени,
	|			(Склад, ЕдиницаИзмерения"
	+ ?(ЕстьТорговаяТочка, ", СостояниеПартии", "") + ") В
	|					(ВЫБРАТЬ РАЗЛИЧНЫЕ
	|						ТабТоваров.Склад,
	|						ТабТоваров.ЕдиницаИзмерения"
	+ ?(ЕстьТорговаяТочка, ",
	|						ТабТоваров.СостояниеПартии", "") + "
	|					ИЗ
	|						ТабТоваров)) КАК ПартииТоваровОстатки
	|
	|ГДЕ
	|	ПартииТоваровОстатки.КоличествоОстаток > 0
	|
	|УПОРЯДОЧИТЬ ПО
	|	ПорядокСписания,
	|	СтрокаПриходаСсылка
	|";
	Запрос.УстановитьПараметр("Ссылка", вхСсылкаНаДокумент);
	Запрос.УстановитьПараметр("МоментВремени", ПолучитьДатуОстатков(вхСсылкаНаДокумент, вхПараметры));
	Запрос.УстановитьПараметр("Дата", ОбщегоНазначения.ПолучитьЗначениеРеквизита(вхСсылкаНаДокумент, "Дата"));
	
	Если ТипЗнч(вхСсылкаНаДокумент) = Тип("ДокументСсылка.ПоступлениеТоваровУслуг") Тогда
		//закрытие регистра партии товаров VMI
		Запрос.УстановитьПараметр("СостояниеПартии", Перечисления.СостоянияПартииТовараVMI.Реализован);
	Иначе
		Запрос.УстановитьПараметр("СостояниеПартии", Перечисления.СостоянияПартииТовараVMI.Поступил);
	КонецЕсли;
	
	РезультатЗапроса = Запрос.ВыполнитьПакет();
	ТабТоваров = РезультатЗапроса[1].Выгрузить();
	ТабПартий = РезультатЗапроса[2].Выгрузить();
	
	Возврат Новый Структура("ТабТоваров, ТабПартий, Результат", ТабТоваров, ТабПартий, Результат);
	
КонецФункции

Процедура ПогашениеПартийТоваров(вхСсылкаНаДокумент, вхПараметры = Неопределено) Экспорт
	
	Массив = Новый Массив;
	Если ПараметрыСеанса.СтратегияСписанияПартий = Перечисления.СтретегииСписанияПартийТоваровПоСтатусам.СначалаСобственныеПотомПринятые Тогда
		Массив.Добавить("ПартииТоваровУпр");
		Массив.Добавить("ПартииТоваровVMI");
	Иначе
		Массив.Добавить("ПартииТоваровVMI");
		Массив.Добавить("ПартииТоваровУпр");
	КонецЕсли;
	
	//получить общую таблицу партий
	ТабПартий = Неопределено;
	Результат = Неопределено;
	ОбщегоНазначения.СоздатьСтруктуруРегистраНакопления("ПартииТоваровVMI", Результат);
	
	Для Каждого ТекРегистр Из Массив Цикл
		
		Структура = ПолучитьТаблицыТоваровПартий(вхСсылкаНаДокумент, ТекРегистр, вхПараметры);
		
		Если ТабПартий = Неопределено Тогда
			ТабПартий = Структура.ТабПартий;
		Иначе
			
			врТабПартий = Структура.ТабПартий;
			Для Каждого ТекКолонка Из врТабПартий.Колонки Цикл
				
				Если ТабПартий.Колонки.Найти(ТекКолонка.Имя) = Неопределено Тогда
					ТабПартий.Колонки.Добавить(ТекКолонка.Имя, ТекКолонка.ТипЗначения);
				КонецЕсли;
				
			КонецЦикла;
			
			ОбщегоНазначения.ЗагрузитьВТаблицуЗначений(врТабПартий, ТабПартий);
			
		КонецЕсли;
		
	КонецЦикла;
	//рассчитать результат по партиям
	РассчитатьСписаниеПоПартиям(Структура.ТабТоваров, ТабПартий, Результат);
	//отобрать строки из результат по регистрам и вставить в вхПараметры
	ПартииТоваровУпр = Результат.Скопировать(); ПартииТоваровУпр.Очистить();
	ПартииТоваровVMI = Результат.Скопировать(); ПартииТоваровVMI.Очистить();
	
	Для Каждого ТекСтрока Из Результат Цикл
		
		Если ТекСтрока.ИмяРегистра = "ПартииТоваровУпр" Тогда
			НоваяСтрока = ПартииТоваровУпр.Добавить();
		Иначе
			НоваяСтрока = ПартииТоваровVMI.Добавить();
		КонецЕсли;
		ЗаполнитьЗначенияСвойств(НоваяСтрока, ТекСтрока);
		
	КонецЦикла;
	
	Если вхПараметры = Неопределено Тогда
		вхПараметры = Новый Структура;
		вхПараметры.Вставить("ДвиженияПартииТоваровУпр", ПартииТоваровУпр);
		вхПараметры.Вставить("ДвиженияПартииТоваровVMI", ПартииТоваровVMI);
	Иначе
		Если вхПараметры.Свойство("ДвиженияПартииТоваровУпр") Тогда
			вхПараметры.ДвиженияПартииТоваровУпр = ПартииТоваровУпр;
		Иначе
			вхПараметры.Вставить("ДвиженияПартииТоваровУпр", ПартииТоваровУпр);
		КонецЕсли;
		
		Если вхПараметры.Свойство("ДвиженияПартииТоваровVMI") Тогда
			вхПараметры.ДвиженияПартииТоваровVMI = ПартииТоваровVMI;
		Иначе
			вхПараметры.Вставить("ДвиженияПартииТоваровVMI", ПартииТоваровVMI);
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Функция ПолучитьДатуОстатков(вхСсылкаНаДокумент, вхПараметры = Неопределено) Экспорт
	лДатаОстатков = Неопределено;
	Если ТипЗнч(вхПараметры) = Тип("Структура") Тогда
		Если  НЕ ПрочитатьЗначение(вхПараметры, "ДатыПолученияОстатков.ПартииТоваровУпр", Неопределено) Тогда
  			лДатаОстатков = вхСсылкаНаДокумент.МоментВремени();
			
		КонецЕсли;
	КонецЕсли;
	
	Возврат лДатаОстатков;
	
КонецФункции


// Начало [Тарасов А.В.] 

Процедура РегистрацияИзмененийСправочниковTopLogПриЗаписи(Источник, Отказ) Экспорт
	ЗарегистрироватьОбъектВОбменПартКом83_TopLog(Источник, Отказ);
КонецПроцедуры

Процедура РегистрацияИзмененийСправочниковTopLogПередУдалением(Источник, Отказ) Экспорт
	ЗарегистрироватьОбъектВОбменПартКом83_TopLog(Источник, Отказ);	
КонецПроцедуры

Процедура РегистрацияИзмененийДокументовTopLogПриЗаписи(Источник, Отказ, РежимЗаписи, РежимПроведения) Экспорт
	ЗарегистрироватьОбъектВОбменПартКом83_TopLog(Источник, Отказ);	
КонецПроцедуры

Процедура РегистрацияИзмененийРегистровНакопленийTopLogПриЗаписи(Источник, Отказ) Экспорт 
	ЗарегистрироватьОбъектВОбменПартКом83_TopLog(Источник, Отказ);	
КонецПроцедуры
	
Процедура РегистрацияИзмененийДокументовTopLogПередУдалением(Источник, Отказ) Экспорт
	ЗарегистрироватьОбъектВОбменПартКом83_TopLog(Источник, Отказ);	
КонецПроцедуры

Процедура ЗарегистрироватьОбъектВОбменПартКом83_TopLog(вхИсточник, вхОтказ)
	МетаданныеИсточника   = Метаданные.НайтиПоТипу(ТипЗнч(вхИсточник));
	Если (МетаданныеИсточника = Метаданные.Документы.РеализацияТоваровУслуг 
		Или МетаданныеИсточника = Метаданные.Справочники.ТорговыеТочки) И Константы.ОбменСТопЛог_ИспользоватьОтдельныйПотокДляРТУ.Получить() Тогда 
		МетаданныеПланаОбмена = Метаданные.ПланыОбмена.ОбменПартКом83_TopLog_РТУ;
	Иначе
		МетаданныеПланаОбмена = Метаданные.ПланыОбмена.ОбменПартКом83_TopLog;
	КонецЕсли;
	
	Если (МетаданныеИсточника <> Неопределено) Тогда
		
		ЭлементСостава = МетаданныеПланаОбмена.Состав.Найти(МетаданныеИсточника);
		Если (ЭлементСостава = Неопределено) ИЛИ (ЭлементСостава.АвтоРегистрация = АвтоРегистрацияИзменений.Разрешить) Тогда
			Возврат;
		КонецЕсли;
		
		Если ОтменитьРегистрациюОбъектаПоУсловиям(МетаданныеИсточника, вхИсточник) Тогда
			Возврат;
		КонецЕсли;
				
		ОбменДаннымиКлиентСервер.ЗарегистрироватьОбъектВУзлах(вхИсточник, МетаданныеПланаОбмена);
		
	КонецЕсли;
	
КонецПроцедуры

//Здесь описываются специфические условия для конкретного объекта метаданных, 
//при выполнении которых объект не регистрируется на обмен

Функция ОтменитьРегистрациюОбъектаПоУсловиям(МетаданныеИсточника, вхИсточник) Экспорт 
	
	лКлючАлгоритма = "ОбщийМодуль_ПроведениеДокументовКлиентСервер_ОтменитьРегистрациюОбъектаПоУсловиям";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		АлгоритмыЗначениеВозврата = Неопределено;		
		Выполнить(лЗамена);		
		Возврат АлгоритмыЗначениеВозврата;		
	КонецЕсли;	
	///////////////////////////////////////////////////////////////////////////
	
	
	Если ОбщегоНазначения.ЭтоДокумент(МетаданныеИсточника) Тогда 
		Если вхИсточник.Дата <  глЗначениеПеременной("ДатаНачалаРегистрацииОбъектовВТопЛог") Тогда 
			Возврат Истина;
		КонецЕсли;
	Иначе
		Если ТекущаяДата() < глЗначениеПеременной("ДатаНачалаРегистрацииОбъектовВТопЛог") Тогда 
			Возврат Истина;
		КонецЕсли;
	КонецЕсли;
	
	Если вхИсточник.ДополнительныеСвойства.Свойство("ОтключитьМеханизмРегистрацииОбъектов") Тогда 
		Возврат Истина;
	КонецЕсли;
	
	ОтказОтРегистрации = Ложь;
		
	Если ВРЕГ(МетаданныеИсточника.Имя) = ВРЕГ("Номенклатура") Тогда
		Если вхИсточник.ЭтоГруппа Тогда //ИЛИ вхИсточник.Услуга Тогда
			ОтказОтРегистрации = Истина;
		КонецЕсли;	
	ИначеЕсли ВРЕГ(МетаданныеИсточника.Имя) = ВРЕГ("Водители") Тогда 
		ОтказОтРегистрации = Истина;	
	ИначеЕсли ВРЕГ(МетаданныеИсточника.Имя) = ВРЕГ("Изготовители") Тогда
		ОтказОтРегистрации = Не ОбменДаннымиКлиентСервер.НеобходимаРегистрацияИзмененийНовое(Метаданные.ПланыОбмена.ОбменПартКом83_TopLog, вхИсточник); 
	ИначеЕсли ВРЕГ(МетаданныеИсточника.Имя) = ВРЕГ("ПоступлениеТоваровУслуг") Тогда
		
		ОтказОтРегистрации = 
		//Добавлено Валиахметов А.А. 17.03.2018
		Не вхИсточник.Проведен 
		//Конец Добавлено Валиахметов А.А. 17.03.2018
		
		Или вхИсточник.ЭтоМФП Или вхИсточник.ВидОперацииПоступления = Перечисления.ВидыПоступленияТоваров.ЗачетТовараVMI ИЛИ 
		вхИсточник.ВидОперацииПоступления = Перечисления.ВидыПоступленияТоваров.Прочее Или Не (вхИсточник.СтатусДокумента = Справочники.СтатусыДокументов.ПоступлениеТоваровОтгружен ИЛИ
		вхИсточник.СтатусДокумента = Справочники.СтатусыДокументов.ПоступлениеТоваровДоставлен) Или 
		вхИсточник.флНеВыгружатьВТопЛог Или
		ОбщегоНазначения.ЗначениеРеквизитаОбъекта(вхИсточник.Склад, "ОбменСTopLog") <> Истина Или Не ПерваяВыгрузка(вхИсточник);
		
		Если Не ОтказОтРегистрации Тогда 
			Ответ = КорректноеРазмещениеПоЗаявкам(вхИсточник);
			
			Если Не Ответ.Корректно Тогда 
				ОписаниеОшибки = "Номер ПТУ: " + вхИсточник.Номер;
				Расхождения = Ответ.РезультатЗапроса.Выбрать();
				Пока Расхождения.Следующий() Цикл 
					ОписаниеОшибки = ОписаниеОшибки + Символы.ПС + "Номер строки: " + Расхождения.НомерСтроки + ". Количество " + Расхождения.Количество + ". Количество размещено " + Расхождения.КоличествоРазмещено;		
				КонецЦикла;
				Попытка
					РассылкаСообщенийОбОшибках.ОтправитьЭлектронноеСообщениеБезСохранения(Справочники.СобытияДляОтправкиЭлектронныхПисем.ОшибкаРазмещенияПТУПоЗаявкам, ОписаниеОшибки, "Поступление " + вхИсточник.Номер + " не выгружено в ТопЛог из-за неверного размещения");
				Исключение
				КонецПопытки;
			КонецЕсли;
			
			ОтказОтРегистрации = Не Ответ.Корректно;
			
		КонецЕсли;
		
	ИначеЕсли ВРЕГ(МетаданныеИсточника.Имя) = ВРЕГ("РеализацияТоваровУслуг") Тогда
		
		ОтказОтРегистрации = 
		//Добавлено Валиахметов А.А. 17.03.2018
		Не вхИсточник.Проведен 		                                      
		//Конец Добавлено Валиахметов А.А. 17.03.2018
		
		//Добавлено Валиахметов А.А. 09.04.2018
		Или вхИсточник.Товары.Количество() = 0
		//Конец Добавлено Валиахметов А.А. 09.04.2018
		
		Или вхИсточник.ЭтоМФП Или вхИсточник.СтатусДокумента <> Справочники.СтатусыДокументов.РеализацияТоваровУслугСборка Или 
		вхИсточник.флНеВыгружатьВТопЛог Или
		ОбщегоНазначения.ЗначениеРеквизитаОбъекта(вхИсточник.Склад, "ОбменСTopLog") <> Истина Или вхИсточник.ДополнительныеСвойства.Свойство("НеРегистрироватьВОбменСТоплог")
		Или вхИсточник.ТранзитнаяОтгрузка <> Новый УникальныйИдентификатор("00000000-0000-0000-0000-000000000000");
		
	ИначеЕсли ВРЕГ(МетаданныеИсточника.Имя) = ВРЕГ("ПеремещениеТоваров") Тогда
		СкладОтправительОбменСTopLog = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(вхИсточник.СкладОтправитель, "ОбменСTopLog");
		СкладПолучательОбменСTopLog = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(вхИсточник.СкладПолучатель, "ОбменСTopLog");
				
		Если вхИсточник.флНеВыгружатьВТопЛог Или вхИсточник.ДополнительныеСвойства.Свойство("НеРегистрироватьВОбменСТоплог") Тогда 
			ОтказОтРегистрации = Истина;
		ИначеЕсли СкладОтправительОбменСTopLog И Не СкладПолучательОбменСTopLog И вхИсточник.СтатусДокумента = Справочники.СтатусыДокументов.ПеремещениеТоваровПоступил И вхИсточник.Проведен Тогда
			ОтказОтРегистрации = Ложь;
		ИначеЕсли Не СкладОтправительОбменСTopLog И СкладПолучательОбменСTopLog И вхИсточник.РазмещениеСсылкаТопЛог = Новый УникальныйИдентификатор("00000000-0000-0000-0000-000000000000")
			И вхИсточник.Проведен И вхИсточник.СтатусДокумента = Справочники.СтатусыДокументов.ПеремещениеТоваровНовый И Не вхИсточник.ЗагруженИзТопЛог Тогда 
			//ОтказОтРегистрации = Ложь;
			ОтказОтРегистрации = Истина;
		ИначеЕсли вхИсточник.ВидОперации = Перечисления.ВидыОперацийПеремещенияТоваров.ВозвратВПродажу
					И вхИсточник.СтатусДокумента = Справочники.СтатусыДокументов.ПеремещениеТоваровНовый
					И вхИсточник.Проведен 
					И СкладОтправительОбменСTopLog
					И Не вхИсточник.ЗагруженИзТопЛог Тогда
			ОтказОтРегистрации = Ложь;
		Иначе
			ОтказОтРегистрации = Истина;
		КонецЕсли;
		
	ИначеЕсли ВРЕГ(МетаданныеИсточника.Имя) = ВРЕГ("ВозвратТоваровПоставщику") Тогда

		//ОтказОтРегистрации = Не (вхИсточник.Проведен И ОбщегоНазначения.ЗначениеРеквизитаОбъекта(вхИсточник.Склад, "ОбменСTopLog") = Истина);	
		
		ОтказОтРегистрации = Истина;
		
		//ХудинВВ 26022019 XX-1969
		Если ЗначениеЗаполнено(вхИсточник.АктРассмотренияВозврата)
			И (вхИсточник.СтатусДокумента = Справочники.СтатусыДокументов.ВозвратТоваровПоставщикуНовый
			ИЛИ вхИсточник.СтатусДокумента = Справочники.СтатусыДокументов.ВозвратТоваровПоставщикуНовыйНаЭкспертизу)
			И вхИсточник.Проведен
			И вхИсточник.Товары.Количество() > 0
			И НЕ вхИсточник.ВидОперации = Перечисления.ВидыОперацийВозвратПоставщику.МФП
			И ОбщегоНазначения.ЗначениеРеквизитаОбъекта(вхИсточник.Склад, "ОбменСTopLog") = Истина
			И НЕ вхИсточник.ДополнительныеСвойства.Свойство("НеРегистрироватьВОбменСТоплог")
			И НЕ вхИсточник.ОбновленИзТопЛог Тогда
			
			ОтказОтРегистрации = Ложь; 
		КонецЕсли;

			
	ИначеЕсли ВРЕГ(МетаданныеИсточника.Имя) = ВРЕГ("ЗакрытиеЗаявокПокупателя") Тогда
		ОтказОтРегистрации = Не вхИсточник.Проведен;
	ИначеЕсли  ВРЕГ(МетаданныеИсточника.Имя) = ВРЕГ("ВозвратТоваровОтПокупателя") Тогда 
		
		Если ОбщегоНазначения.ЗначениеРеквизитаОбъекта(вхИсточник.Склад, "Возвраты") Тогда
			РабочийСклад = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(вхИсточник.Склад, "ФизическийСклад");
		Иначе
			РабочийСклад = вхИсточник.Склад;
		КонецЕсли;
		СкладОбменСTopLog = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(РабочийСклад, "ОбменСTopLog");
		
		Если Не ЗначениеЗаполнено(вхИсточник.АктРассмотренияВозврата) 
			ИЛИ вхИсточник.ВидОперации = Перечисления.ВидыОперацийВозвратаОтПокупателя.МФП
			ИЛИ вхИсточник.ДополнительныеСвойства.Свойство("НеРегистрироватьВОбменСТоплог")
			ИЛИ НЕ вхИсточник.Проведен
			ИЛИ вхИсточник.Товары.Количество() = 0
			ИЛИ НЕ (вхИсточник.СтатусДокумента = Справочники.СтатусыДокументов.ВозвратТоваровОтПокупателяНовый
			ИЛИ вхИсточник.СтатусДокумента = Справочники.СтатусыДокументов.ВозвратТоваровОтПокупателяОтменен)
			ИЛИ НЕ вхИсточник.СостояниеОтменыВТоплог = Перечисления.СостоянияОтменыЗаказаНаПриемкуВТоплог.ПустаяСсылка()
			//ИЛИ НЕ СкладОбменСTopLog  //Отключаем, тк склад возврата на самом деле неизвестен
			ИЛИ вхИсточник.флНеВыгружатьВТопЛог Тогда 
		
			ОтказОтРегистрации = Истина;
		КонецЕсли;
	ИначеЕсли ВРЕГ(МетаданныеИсточника.Имя) = ВРЕГ("СписаниеТоваров") Тогда
		
		ОтказОтРегистрации = 
		Не вхИсточник.Проведен 		                                      
		Или вхИсточник.Товары.Количество() = 0
		Или вхИсточник.флНеВыгружатьВТопЛог 
		Или ОбщегоНазначения.ЗначениеРеквизитаОбъекта(вхИсточник.Склад, "ОбменСTopLog") <> Истина 
		Или вхИсточник.ДополнительныеСвойства.Свойство("НеРегистрироватьВОбменСТоплог")
		ИЛИ Не ЗначениеЗаполнено(вхИсточник.АктРассмотренияВозврата);
		
		Если ОтказОтРегистрации = Ложь Тогда
			Если вхИсточник.СтатусДокумента = Справочники.СтатусыДокументов.СписаниеТоваровНовый И вхИсточник.ВыгруженВТопЛог Тогда
				ОтказОтРегистрации = Истина;
			ИначеЕсли вхИсточник.СтатусДокумента = Справочники.СтатусыДокументов.СписаниеТоваровСписан 
				И (вхИсточник.ОбновленИзТопЛог ИЛИ вхИсточник.ВыгруженВТопЛогАвтопроведение) Тогда
				ОтказОтРегистрации = Истина;
			КонецЕсли;
		КонецЕсли;		

	ИначеЕсли ВРЕГ(МетаданныеИсточника.Имя) = ВРЕГ("ПерестикеровкаПереоценка") Тогда
		
		ОтказОтРегистрации = 
		Не вхИсточник.Проведен 		                                      
		Или вхИсточник.Товары.Количество() = 0
		Или вхИсточник.СтатусДокумента <> Справочники.СтатусыДокументов.ПерестикеровкаПереоценкаНовый  
		Или вхИсточник.флНеВыгружатьВТопЛог 
		Или ОбщегоНазначения.ЗначениеРеквизитаОбъекта(вхИсточник.Склад, "ОбменСTopLog") <> Истина 
		Или вхИсточник.ДополнительныеСвойства.Свойство("НеРегистрироватьВОбменСТоплог")
		ИЛИ Не ЗначениеЗаполнено(вхИсточник.АктРассмотренияВозврата);
		
	//ХудинВВ XX-1983
	ИначеЕсли  ВРЕГ(МетаданныеИсточника.Имя) = ВРЕГ("Экспертиза") Тогда 
		
		РабочийСклад = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(вхИсточник.Склад, "ФизическийСклад");
		СкладОбменСTopLog = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(РабочийСклад, "ОбменСTopLog");
		
		Если Не ЗначениеЗаполнено(вхИсточник.АктРассмотренияВозврата) 
			ИЛИ вхИсточник.ДополнительныеСвойства.Свойство("НеРегистрироватьВОбменСТоплог")
			ИЛИ НЕ вхИсточник.Проведен
			ИЛИ вхИсточник.Товары.Количество() = 0
			ИЛИ НЕ вхИсточник.СтатусДокумента = Справочники.СтатусыДокументов.ЭкспертизаНовый
			ИЛИ НЕ СкладОбменСTopLog  
			ИЛИ вхИсточник.флНеВыгружатьВТопЛог
			ИЛИ вхИсточник.ОбновленИзТопЛог Тогда 
		
			ОтказОтРегистрации = Истина;
		КонецЕсли;
		
	//ХудинВВ XX-2123
	ИначеЕсли  ВРЕГ(МетаданныеИсточника.Имя) = ВРЕГ("МегаЛогист_МаршрутныйЛист") Тогда 
	
	    ДатаНачалаВыгрузкиМЛВТоплог = Константы.ДатаНачалаВыгрузкиМЛВТоплог.Получить();
	
		ОтказОтРегистрации = 
		Не вхИсточник.Проведен 		                                      
		Или ОбщегоНазначения.ЗначениеРеквизитаОбъекта(вхИсточник.Филиал, "ОсновнойСклад.ОбменСTopLog") <> Истина 
		Или вхИсточник.ДополнительныеСвойства.Свойство("НеРегистрироватьВОбменСТоплог");
		
		Если РегистрыСведений.ИсторияОбменаСТопЛогПоОбъектам.ЕстьСообщениеПоОбъекту(вхИсточник.Ссылка, Истина) Тогда
			ОтказОтРегистрации = Истина;
		КонецЕсли;
		
		Если Не ЗначениеЗаполнено(ДатаНачалаВыгрузкиМЛВТоплог) ИЛИ вхИсточник.Дата < ДатаНачалаВыгрузкиМЛВТоплог Тогда
			ОтказОтРегистрации = Истина;
		КонецЕсли;

	КонецЕсли;
	
	Возврат ОтказОтРегистрации;
	
КонецФункции
// Конец [Тарасов А.В.]  

// Начало Валиахметов А.А.
Процедура ЗарегистрироватьКорректировкуЗаявкиПокупателяВОбменСТопЛог(вхСсылкаНаДокумент) Экспорт 
	
	Если ТипЗнч(вхСсылкаНаДокумент) <> Тип("ДокументСсылка.КорректировкаЗаявкиПокупателя") Тогда 
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	РезервыТоваров.Номенклатура,
	               |	РезервыТоваров.Номенклатура.Наименование,
	               |	РезервыТоваров.Номенклатура.Артикул,
	               |	РезервыТоваров.СтрокаЗаявки.IDSite КАК SSID
	               |ИЗ
	               |	РегистрНакопления.РезервыТоваров КАК РезервыТоваров
	               |ГДЕ
	               |	РезервыТоваров.ВидДвижения = &ВидДвижения
	               |			И РезервыТоваров.Количество > 0
	               |	И РезервыТоваров.СтрокаЗаявки.ТипПоставки = &ТипПоставки
	               |	И РезервыТоваров.Регистратор = &Регистратор
	               |
	               |ОБЪЕДИНИТЬ ВСЕ
	               |
	               |ВЫБРАТЬ
	               |	РезервыТоваров.Номенклатура,
	               |	РезервыТоваров.Номенклатура.Наименование,
	               |	РезервыТоваров.Номенклатура.Артикул,
	               |	РезервыТоваров.СтрокаЗаявки.IDSite
	               |ИЗ
	               |	РегистрНакопления.РезервыТоваров КАК РезервыТоваров
	               |ГДЕ
	               |	РезервыТоваров.ВидДвижения = &ВидДвижения2
	               |			И РезервыТоваров.Количество < 0
	               |	И РезервыТоваров.СтрокаЗаявки.ТипПоставки = &ТипПоставки
	               |	И РезервыТоваров.Регистратор = &Регистратор";
	Запрос.УстановитьПараметр("Регистратор", вхСсылкаНаДокумент);
	Запрос.УстановитьПараметр("ВидДвижения", ВидДвиженияНакопления.Расход);
	Запрос.УстановитьПараметр("ВидДвижения2", ВидДвиженияНакопления.Приход);
	Запрос.УстановитьПараметр("ТипПоставки", Перечисления.ТипПоставки.Кросс);
	Если Не Запрос.Выполнить().Пустой() Тогда 
		Узел = ОбменДаннымиКлиентСервер.ПолучитьИсходящийУзелОбмена(Метаданные.ПланыОбмена.ОбменПартКом83_TopLog, 3);
		ПланыОбмена.ЗарегистрироватьИзменения(Узел, вхСсылкаНаДокумент);	
	КонецЕсли;
	
КонецПроцедуры

// Партии товаров
Функция ПогашениеПартийТоваровНовое(вхСсылкаНаДокумент, вхОтказ, КонтрольНаличияПартий = Истина, вхФильтр = Неопределено, ПараметрыСписания = Неопределено) Экспорт 
	
	лКлючАлгоритма = "ОбщийМодуль_ПроведениеДокументовКлиентСервер_ПогашениеПартийТоваровНовое";
	лЗамена = АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		АлгоритмыЗначениеВозврата = Неопределено;
		Выполнить(лЗамена);
		Возврат АлгоритмыЗначениеВозврата;
	КонецЕсли;
	
	Если ПараметрыСписания = Неопределено Тогда
		 ПараметрыСписания = Новый Структура;   
	КонецЕсли;
		
	ДатаДокумента = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(вхСсылкаНаДокумент, "Дата");

	МетаданныеДокумента = вхСсылкаНаДокумент.Метаданные();
	
	//УчитыватьПоставщика = Ложь;  //Для не возвратов поставщику, поставщика не учитываем

	//Если МетаданныеДокумента = Метаданные.Документы.ВозвратТоваровПоставщику Тогда 
	//	Если ДатаДокумента < глЗначениеПеременной("ДатаВозвратыПоставщиковСоздаютсяВ83") Тогда 
	//		УчитыватьПоставщика = Ложь; //Если возвраты поставщиков не создаются в 8.3, то не учитываем поставщика  
	//	Иначе
	//		Запрос = Новый Запрос;
	//		Запрос.Текст = "ВЫБРАТЬ
	//		|	ВозвратТоваровПоставщику.Контрагент.Организация КАК СобственнаяОрганизация
	//		|ИЗ
	//		|	Документ.ВозвратТоваровПоставщику КАК ВозвратТоваровПоставщику
	//		|ГДЕ
	//		|	ВозвратТоваровПоставщику.Ссылка = &Ссылка";
	//		Запрос.УстановитьПараметр("Ссылка", вхСсылкаНаДокумент);
	//		Выборка = Запрос.Выполнить().Выбрать();
	//		Если Выборка.Следующий() Тогда 
	//			УчитыватьПоставщика = Не ЗначениеЗаполнено(Выборка.СобственнаяОрганизация); //Не учитываем поставщика партии, если поставщик - наша организация
	//		КонецЕсли;
	//	КонецЕсли;
	//КонецЕсли;
		
	
	ТаблицаДвижений = Неопределено;
	ОбщегоНазначения.СоздатьСтруктуруРегистраНакопления("ПартииТоваров", ТаблицаДвижений);
	
	ТаблицаДвижений.Колонки.Добавить("ВидСписания", Новый ОписаниеТипов("Строка"));
	
	ТаблицаДвиженийVMI = Неопределено;
	ОбщегоНазначения.СоздатьСтруктуруРегистраНакопления("ПартииТоваровVMI", ТаблицаДвиженийVMI);
	
	
	Если ДатаДокумента < ПараметрыСеанса.ДатаНачалаРаботыТовары 
		ИЛИ ДатаДокумента < глЗначениеПеременной("ДатаЗапускаПроведенияПоПартиямРезервам")
		Тогда
		СтруктураТаблиц = Новый Структура;
		
		СтруктураТаблиц.Вставить("ПартииТоваров",    ТаблицаДвижений);
		СтруктураТаблиц.Вставить("ПартииТоваровVMI", ТаблицаДвиженийVMI);
		Возврат СтруктураТаблиц;
	КонецЕсли;
		
	Если Не ПараметрыСеанса.ОпределятьСтратегиюПогашенияПартийТоваровПоСкладу Тогда
		ВызватьИсключение "[ПогашениеПартийТоваров]: Реализовано погашение партий только при использовании стратегии погашения партий товаров по складу";
	КонецЕсли;
	
	МенеджерОбъекта = ОбщегоНазначения.МенеджерОбъектаПоМетаданным(МетаданныеДокумента);	
	
	//Если в параметрах задана таблица товаров, то повторно получать её не надо
	Товары = Неопределено;
	ПараметрыСписания.Свойство("Товары", Товары);
	Если Товары = Неопределено Тогда
		Товары = МенеджерОбъекта.ТаблицыДляРасчетаСписанияПоПартиям(вхСсылкаНаДокумент, вхФильтр);
	КонецЕсли;
	
	//Нормализация таблицы значений. Добавляем отсутствующие колонки и заполняем их
	
	НормализацияТаблицыДляРасчетаСписанияПоПартиям(Товары);

	//СписыватьТолькоПоСвоейОрганизации = Истина;
	//Если ТипЗнч(вхСсылкаНаДокумент) = Тип("ДокументСсылка.РеализацияТоваровУслуг") И ДатаДокумента >= глЗначениеПеременной("ДатаЗапускаПроведенияПоПартиямРезервам") Тогда 
	//	СписыватьТолькоПоСвоейОрганизации = Ложь;
	//КонецЕсли;
	
	//Реквизиты, которые переносятся в таблицу движений
	ЗаполняемыеРеквизиты = "ВидСписания,НомерСтрокиВДокументе"; 
	ВозможныеКолонки = Новый Массив;
	ВозможныеКолонки.Добавить("ОприходоватьПоVMI");
	ВозможныеКолонки.Добавить("ВнутреннееПеремещение");
	Для Каждого Колонка Из ВозможныеКолонки Цикл 
		лКолонка = Товары.Колонки.Найти(Колонка);
		Если лКолонка <> Неопределено Тогда 
			Если ТаблицаДвижений.Колонки.Найти(Колонка) = Неопределено Тогда 
				ТаблицаДвижений.Колонки.Добавить(лКолонка.Имя, лКолонка.ТипЗначения);
			КонецЕсли;
			ЗаполняемыеРеквизиты = ЗаполняемыеРеквизиты + "," + лКолонка.Имя;
		КонецЕсли;
	КонецЦикла;
	
	//СписаныПартии = Ложь;
	//Если Не ОперативноеПроведение(ПараметрыСписания) и вхФильтр = Неопределено Тогда 
	//	вхБазовая = ПроведениеДокументовКлиентСервер.ЗначенияДвиженийДокумента(вхСсылкаНаДокумент, Метаданные.РегистрыНакопления.ПартииТоваров, вхФильтр);
	//	СписаныПартии = ПроведениеДокументовКлиентСервер.СписатьПартииБезПерепроведения(вхСсылкаНаДокумент, ПараметрыСписания, вхБазовая, СтруктураТаблиц); 
	//КонецЕсли;
	//
	//Если СписаныПартии Тогда
	//	Возврат СтруктураТаблиц; 
	//КонецЕсли;
	
	Товары.Индексы.Добавить("ИгнорироватьСтатусПартии,ПустаяСтрокаПрихода,УчитыватьПоставщика");		               
	
	СтратегияПогашенияПоОрганизации = СтратегияПогашенияПоОрганизации(вхСсылкаНаДокумент, ДатаДокумента);
	
	//Если в параметрах списания задана политика списания по организации, то используем её
	СписыватьТолькоПоСвоейОрганизацииПараметр = Неопределено;
	ПараметрыСписания.Свойство("СписыватьТолькоПоСвоейОрганизации", СписыватьТолькоПоСвоейОрганизацииПараметр);
	Если СписыватьТолькоПоСвоейОрганизацииПараметр <> Неопределено Тогда
		СтратегияПогашенияПоОрганизации.СписыватьТолькоПоСвоейОрганизации 						 		= СписыватьТолькоПоСвоейОрганизацииПараметр;
		Если ТипЗнч(СтратегияПогашенияПоОрганизации.ПараметрыПолитикиМФП) = Тип("Структура") Тогда
			СтратегияПогашенияПоОрганизации.ПараметрыПолитикиМФП.УчитыватьОрганизациюТаблицыСписания 	= СписыватьТолькоПоСвоейОрганизацииПараметр;
		КонецЕсли;
	КонецЕсли;

	//Если в параметрах списания заданы организации для списания партий, то подставим их в политику списания
	ОрганизацииДляЗакупкиПараметр = Неопределено;
	ПараметрыСписания.Свойство("ОрганизацииДляЗакупки", ОрганизацииДляЗакупкиПараметр);
	Если ОрганизацииДляЗакупкиПараметр <> Неопределено И ТипЗнч(СтратегияПогашенияПоОрганизации.ПараметрыПолитикиМФП) = Тип("Структура") Тогда
		 СтратегияПогашенияПоОрганизации.ПараметрыПолитикиМФП.ОрганизацииДляЗакупки = ОрганизацииДляЗакупкиПараметр;
	КонецЕсли;

	//Валиахметов 05.04.2019 http://jira.part-kom.ru/browse/XX-1966  Оптимизация процесса перемещения
	Если Не ПараметрыСписания.Свойство("Перепровести") И вхФильтр = Неопределено И Не ОперативноеПроведение(ПараметрыСписания) Тогда 
		СписатьПоПриоритетнымПартиям(вхСсылкаНаДокумент, ТаблицаДвижений, Товары, СтратегияПогашенияПоОрганизации, ЗаполняемыеРеквизиты, ДатаДокумента);
	КонецЕсли;
	
	//Вставить код, которые очищает строки, где Количество = 0
	ОбщегоНазначения.ОчиститьТаблицуСНулевымКол(Товары);
	//Конец Валиахметов 05.04.2019 http://jira.part-kom.ru/browse/XX-1966  Оптимизация процесса перемещения

	ТаблицаПоСтрокамПриходаПоПоcтавщику 	= Товары.Скопировать(Товары.НайтиСтроки(Новый Структура("ИгнорироватьСтатусПартии, ПустаяСтрокаПрихода, УчитыватьПоставщика", Ложь,   Ложь, Истина)));	
	ТаблицаПоСтрокамПрихода 				= Товары.Скопировать(Товары.НайтиСтроки(Новый Структура("ИгнорироватьСтатусПартии, ПустаяСтрокаПрихода, УчитыватьПоставщика", Ложь,   Ложь, Ложь)));
	ТаблицаПоFIFOПоПоставщику				= Товары.Скопировать(Товары.НайтиСтроки(Новый Структура("ИгнорироватьСтатусПартии, ПустаяСтрокаПрихода, УчитыватьПоставщика", Ложь,   Истина, Истина)));
	ТаблицаПоFIFO 							= Товары.Скопировать(Товары.НайтиСтроки(Новый Структура("ИгнорироватьСтатусПартии, ПустаяСтрокаПрихода, УчитыватьПоставщика", Ложь,   Истина, Ложь)));
	
	ТаблицаПоСтрокамПриходаБезУчетаСтатусаПоПоставщику  = Товары.Скопировать(Товары.НайтиСтроки(Новый Структура("ИгнорироватьСтатусПартии, ПустаяСтрокаПрихода, УчитыватьПоставщика", Истина, Ложь, Истина)));	
	ТаблицаПоСтрокамПриходаБезУчетаСтатуса  = Товары.Скопировать(Товары.НайтиСтроки(Новый Структура("ИгнорироватьСтатусПартии, ПустаяСтрокаПрихода, УчитыватьПоставщика", Истина, Ложь, Ложь)));	
	ТаблицаПоFIFOБезУчетаСтатусаПоПоставщику= Товары.Скопировать(Товары.НайтиСтроки(Новый Структура("ИгнорироватьСтатусПартии, ПустаяСтрокаПрихода, УчитыватьПоставщика", Истина, Истина, Истина)));
	ТаблицаПоFIFOБезУчетаСтатуса  			= Товары.Скопировать(Товары.НайтиСтроки(Новый Структура("ИгнорироватьСтатусПартии, ПустаяСтрокаПрихода, УчитыватьПоставщика", Истина, Истина, Ложь)));	
	
	
	//Запрос = Новый Запрос;
	//Запрос.Текст =  "ВЫБРАТЬ
	//                |	Товары.Номенклатура,
	//                |	Товары.Склад,
	//                |	Товары.Качество
	//                |ПОМЕСТИТЬ Товары
	//                |ИЗ
	//                |	&Товары КАК Товары
	//                |;
	//                |
	//                |////////////////////////////////////////////////////////////////////////////////
	//                |ВЫБРАТЬ
	//                |	ПартииТоваровОстатки.Номенклатура КАК Номенклатура,
	//                |	ПартииТоваровОстатки.Склад КАК Склад,
	//                |	ПартииТоваровОстатки.Качество КАК Качество,
	//                |	ПартииТоваровОстатки.СтатусПартии КАК СтатусПартии,
	//                |	ПартииТоваровОстатки.СтрокаПрихода КАК СтрокаПрихода,
	//                |	ПартииТоваровОстатки.Организация КАК Организация,
	//                |	ПартииТоваровОстатки.ДокументОснование КАК ДокументОснование,
	//                |	ПартииТоваровОстатки.КоличествоОстаток КАК Количество,
	//                |	ПартииТоваровОстатки.СуммаРублиОстаток КАК СуммаРубли,
	//                |	ПартииТоваровОстатки.СуммаДолларыОстаток КАК СуммаДоллары,
	//                |	ПартииТоваровОстатки.СуммаЕвроОстаток КАК СуммаЕвро,
	//                |	ПартииТоваровОстатки.СуммаБезНДСОстаток КАК СуммаБезНДС,
	//                |	ПартииТоваровОстатки.СтрокаПрихода.ТорговаяТочка.Владелец КАК Поставщик,
	//                |	ПартииТоваровОстатки.Организация.Наименование КАК ОрганизацияНаименование,
	//                |	ПартииТоваровОстатки.СтрокаПрихода.Дата КАК СтрокаПриходаДата
	//                |ИЗ
	//                |	РегистрНакопления.ПартииТоваров.Остатки(
	//                |			&КонПериода,
	//                |			(Номенклатура, Склад, Качество) В
	//                |				(ВЫБРАТЬ
	//                |					Товары.Номенклатура,
	//                |					Товары.Склад,
	//                |					Товары.Качество
	//                |				ИЗ
	//                |					Товары)) КАК ПартииТоваровОстатки";
	//
	//Запрос.УстановитьПараметр("Товары", Товары);
	//Запрос.УстановитьПараметр("КонПериода", ?(ОперативноеПроведение(ПараметрыСписания), Неопределено, вхСсылкаНаДокумент.МоментВремени()));
	//
	//ОстаткиПартий = Запрос.Выполнить().Выгрузить();
		
	Если ТаблицаПоСтрокамПриходаПоПоcтавщику.Количество() > 0 Тогда 
		//СписыватьТолькоПоСвоейОрганизации = ?(СписыватьТолькоПоСвоейОрганизации = Неопределено, Истина, СписыватьТолькоПоСвоейОрганизации);
		СписатьПоСтрокамПриходаПоПоставщику(вхСсылкаНаДокумент, ТаблицаДвижений, ТаблицаПоСтрокамПриходаПоПоcтавщику, ТаблицаПоFIFOПоПоставщику, СтратегияПогашенияПоОрганизации, ЗаполняемыеРеквизиты, КонтрольНаличияПартий, вхОтказ, ПараметрыСписания);
	КонецЕсли;
	
	Если ТаблицаПоСтрокамПрихода.Количество() > 0 Тогда 
		//СписыватьТолькоПоСвоейОрганизации = ?(СписыватьТолькоПоСвоейОрганизации = Неопределено, Истина, СписыватьТолькоПоСвоейОрганизации);
		СписатьПоСтрокамПрихода(вхСсылкаНаДокумент, ТаблицаДвижений, ТаблицаПоСтрокамПрихода, ТаблицаПоFIFO, СтратегияПогашенияПоОрганизации, ЗаполняемыеРеквизиты, КонтрольНаличияПартий, вхОтказ, ПараметрыСписания);
	КонецЕсли;
	
	Если ТаблицаПоFIFOПоПоставщику.Количество() > 0 Тогда 
		//СписыватьТолькоПоСвоейОрганизации = ?(СписыватьТолькоПоСвоейОрганизации = Неопределено, СтратегияПогашенияПоОрганизации(вхСсылкаНаДокумент, ДатаДокумента), СписыватьТолькоПоСвоейОрганизации);
		СписатьПоFIFOПоПоставщику(вхСсылкаНаДокумент, ТаблицаДвижений, ТаблицаПоFIFOПоПоставщику, СтратегияПогашенияПоОрганизации, ЗаполняемыеРеквизиты, КонтрольНаличияПартий, вхОтказ, ПараметрыСписания, ТаблицаПоFIFO);
	КонецЕсли;
	
	Если ТаблицаПоFIFO.Количество() > 0 Тогда 
		//СписыватьТолькоПоСвоейОрганизации = ?(СписыватьТолькоПоСвоейОрганизации = Неопределено, СтратегияПогашенияПоОрганизации(вхСсылкаНаДокумент, ДатаДокумента), СписыватьТолькоПоСвоейОрганизации);
		СписатьПоFIFO(вхСсылкаНаДокумент, ТаблицаДвижений, ТаблицаПоFIFO, СтратегияПогашенияПоОрганизации, ЗаполняемыеРеквизиты, КонтрольНаличияПартий, вхОтказ, ПараметрыСписания);
	КонецЕсли;
	
	Если ТаблицаПоСтрокамПриходаБезУчетаСтатусаПоПоставщику.Количество() > 0 Тогда 
		//СписыватьТолькоПоСвоейОрганизации = ?(СписыватьТолькоПоСвоейОрганизации = Неопределено, Истина, СписыватьТолькоПоСвоейОрганизации);
		СписатьПоСтрокамПриходаБезУчетаСтатусаПоПоставщику(вхСсылкаНаДокумент, ТаблицаДвижений, ТаблицаПоСтрокамПриходаБезУчетаСтатусаПоПоставщику, ТаблицаПоFIFOБезУчетаСтатусаПоПоставщику, СтратегияПогашенияПоОрганизации, ЗаполняемыеРеквизиты, КонтрольНаличияПартий, вхОтказ, ПараметрыСписания)
	КонецЕсли;

	Если ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Количество() > 0 Тогда 
		//СписыватьТолькоПоСвоейОрганизации = ?(СписыватьТолькоПоСвоейОрганизации = Неопределено, Истина, СписыватьТолькоПоСвоейОрганизации);
		СписатьПоСтрокамПриходаБезУчетаСтатуса(вхСсылкаНаДокумент, ТаблицаДвижений, ТаблицаПоСтрокамПриходаБезУчетаСтатуса, ТаблицаПоFIFOБезУчетаСтатуса, СтратегияПогашенияПоОрганизации, ЗаполняемыеРеквизиты, КонтрольНаличияПартий, вхОтказ, ПараметрыСписания)
	КонецЕсли;
	
	Если ТаблицаПоFIFOБезУчетаСтатусаПоПоставщику.Количество() > 0 Тогда 
		//СписыватьТолькоПоСвоейОрганизации = ?(СписыватьТолькоПоСвоейОрганизации = Неопределено, СтратегияПогашенияПоОрганизации(вхСсылкаНаДокумент, ДатаДокумента), СписыватьТолькоПоСвоейОрганизации);
		СписатьПоFIFOБезУчетаСтатусаПоПоставщику(вхСсылкаНаДокумент, ТаблицаДвижений, ТаблицаПоFIFOБезУчетаСтатусаПоПоставщику, СтратегияПогашенияПоОрганизации, ЗаполняемыеРеквизиты, КонтрольНаличияПартий, вхОтказ, ПараметрыСписания)	
	КонецЕсли;
	
	Если ТаблицаПоFIFOБезУчетаСтатуса.Количество() > 0 Тогда 
		//СписыватьТолькоПоСвоейОрганизации = ?(СписыватьТолькоПоСвоейОрганизации = Неопределено, СтратегияПогашенияПоОрганизации(вхСсылкаНаДокумент, ДатаДокумента), СписыватьТолькоПоСвоейОрганизации);
		СписатьПоFIFOБезУчетаСтатуса(вхСсылкаНаДокумент, ТаблицаДвижений, ТаблицаПоFIFOБезУчетаСтатуса, СтратегияПогашенияПоОрганизации, ЗаполняемыеРеквизиты, КонтрольНаличияПартий, вхОтказ, ПараметрыСписания)	
	КонецЕсли;
	
	Если ТаблицаДвижений.Колонки.Найти("ОприходоватьПоVMI") <> Неопределено Тогда 
		СтрокиVMI = ТаблицаДвижений.НайтиСтроки(Новый Структура("СтатусПартии, ВидДвижения, ОприходоватьПоVMI", Перечисления.СтатусыПартии.ПринятыйНаОтветХранение, ВидДвиженияНакопления.Расход, Истина));
		Если СтрокиVMI.Количество() > 0 Тогда 
			Для Каждого Строка Из СтрокиVMI Цикл 
				ЗаполнитьЗначенияСвойств(ТаблицаДвиженийVMI.Добавить(), Строка);
			КонецЦикла;
			
			Запрос = Новый Запрос;
			Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
			               |	ВЫРАЗИТЬ(ТаблицаДвиженийVMI.СтрокаПрихода КАК Справочник.ИдентификаторыСтрокПриходов) КАК СтрокаПрихода
			               |ПОМЕСТИТЬ ТаблицаДвиженийVMI
			               |ИЗ
			               |	&ТаблицаДвиженийVMI КАК ТаблицаДвиженийVMI
			               |;
			               |
			               |////////////////////////////////////////////////////////////////////////////////
			               |ВЫБРАТЬ
			               |	ТаблицаДвиженийVMI.СтрокаПрихода,
			               |	ТаблицаДвиженийVMI.СтрокаПрихода.ДоговорКонтрагента КАК ДоговорКонтрагента
			               |ИЗ
			               |	ТаблицаДвиженийVMI КАК ТаблицаДвиженийVMI";
			Запрос.УстановитьПараметр("ТаблицаДвиженийVMI", ТаблицаДвиженийVMI);
			ДопТаблица = Запрос.Выполнить().Выгрузить();
			Для Каждого СтрокаДвижений Из ТаблицаДвиженийVMI Цикл
				СтрокаДвижений.ВидДвижения = ВидДвиженияНакопления.Приход;
				СтрокаДопТаблицы = ДопТаблица.Найти(СтрокаДвижений.СтрокаПрихода, "СтрокаПрихода");
				СтрокаДвижений.ДоговорКонтрагента = СтрокаДопТаблицы.ДоговорКонтрагента;
				СтрокаДвижений.КредДокумент = вхСсылкаНаДокумент;
				
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;
	
	// 19.02.19 Строганов Роман > XX-1835
	Если ПараметрыСписания <> Неопределено И ПараметрыСписания.Свойство("СобственнаяПартия") И ПараметрыСписания.СобственнаяПартия Тогда
		Для Каждого СтрокаДвижений Из ТаблицаДвижений Цикл
			Если СтрокаДвижений.ВидДвижения = ВидДвиженияНакопления.Приход Тогда
				СтрокаДвижений.СтатусПартии = ПредопределенноеЗначение("Перечисление.СтатусыПартии.Собственный");
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	// 19.02.19 Строганов Роман < XX-1835
	
	СтруктураТаблиц = Новый Структура;
	
	СтруктураТаблиц.Вставить("ПартииТоваров",    ТаблицаДвижений);
	СтруктураТаблиц.Вставить("ПартииТоваровVMI", ТаблицаДвиженийVMI);
	
	Возврат СтруктураТаблиц;
	
КонецФункции

Процедура НормализацияТаблицыДляРасчетаСписанияПоПартиям(Товары)
	
	лКлючАлгоритма = "ОбщийМодуль_ПроведениеДокументовКлиентСервер_НормализацияТаблицыДляРасчетаСписанияПоПартиям";
	лЗамена = АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		Выполнить(лЗамена);
	КонецЕсли;
	
	Если Товары.Колонки.Найти("ПустаяСтрокаПрихода") = Неопределено Тогда  //Если Ложь, то списываем сначала по совпадению строки прихода, затем по FIFO
		//Если Истина, то списываем сразу по FIFO				
		Товары.Колонки.Добавить("ПустаяСтрокаПрихода", Новый ОписаниеТипов("Булево"));
		Для Каждого СтрокаТовары Из Товары Цикл
			СтрокаТовары.ПустаяСтрокаПрихода = Не ЗначениеЗаполнено(СтрокаТовары.СтрокаПрихода); 
		КонецЦикла;
	КонецЕсли;
	
	Если Товары.Колонки.Найти("ВидСписания") = Неопределено Тогда  //Может принимать одно из двух значений: Списание или Перемещение
		//Если Перемещение, то должны быть заполнены колонки строки ТЗ: СкладПеремещения, КачествоПеремещения, СтатусПартииПеремещения 
		Товары.Колонки.Добавить("ВидСписания", Новый ОписаниеТипов("Строка"));
		Товары.ЗаполнитьЗначения("Списание", "ВидСписания");
	КонецЕсли;
	
	Если Товары.Колонки.Найти("ИгнорироватьСтатусПартии") = Неопределено Тогда //Если истина, то можно списывать партию, не учитывая совпадение по статусу партии. 
		Товары.Колонки.Добавить("ИгнорироватьСтатусПартии", Новый ОписаниеТипов("Булево"));
		Товары.ЗаполнитьЗначения(Ложь, "ИгнорироватьСтатусПартии");
	КонецЕсли;
	
	Если Товары.Колонки.Найти("УчитыватьПоставщика") = Неопределено Тогда //Если ложь, то можно списывать партию, не учитывая совпадение по поставщику. 
		Товары.Колонки.Добавить("УчитыватьПоставщика", Новый ОписаниеТипов("Булево"));
		Товары.ЗаполнитьЗначения(Ложь, "УчитыватьПоставщика");
	КонецЕсли;
	Если Товары.Колонки.Найти("ВнутреннееПеремещение") = Неопределено Тогда //Если истина, то перемещение между нашими складами
		Товары.Колонки.Добавить("ВнутреннееПеремещение", Новый ОписаниеТипов("Булево"));
		Товары.ЗаполнитьЗначения(Ложь, "ВнутреннееПеремещение");
	КонецЕсли;
	Если Товары.Колонки.Найти("ДокументОснование") = Неопределено Тогда   //Если неопределено, то списываются только партии у которых ДокументОснование = неопределено, 
																		  //Если заполнено, то списываются с таким же ДокументОснование, либо неопределено
		МассивТипов = Новый Массив;
		МассивТипов.Добавить(Тип("ДокументСсылка.ПеремещениеТоваров"));
		МассивТипов.Добавить(Тип("ДокументСсылка.ПоступлениеТоваровУслуг"));
		Товары.Колонки.Добавить("ДокументОснование", Новый ОписаниеТипов(МассивТипов));
		Товары.ЗаполнитьЗначения(Неопределено, "ДокументОснование");
	КонецЕсли;
	Если Товары.Колонки.Найти("ДокументОснованиеПеремещения") = Неопределено Тогда //При перемещении оприходование этого документа основание
		МассивТипов = Новый Массив;
		МассивТипов.Добавить(Тип("ДокументСсылка.ПеремещениеТоваров"));
		МассивТипов.Добавить(Тип("ДокументСсылка.ПоступлениеТоваровУслуг"));
		Товары.Колонки.Добавить("ДокументОснованиеПеремещения", Новый ОписаниеТипов(МассивТипов));
		Товары.ЗаполнитьЗначения(Неопределено, "ДокументОснование");
	КонецЕсли;
	
	// 18.04.19 Строганов Роман > 
	Если Товары.Колонки.Найти("УпрощенныйКонтрольПроведения") = Неопределено Тогда // Только для документа «ВозвратТоваровПоставщику» с включенным флагом «УпрощенныйКонтрольПроведения» 
		Товары.Колонки.Добавить("УпрощенныйКонтрольПроведения", Новый ОписаниеТипов("Булево"));
		Товары.ЗаполнитьЗначения(Ложь, "УпрощенныйКонтрольПроведения");
	КонецЕсли;
	// 18.04.19 Строганов Роман <

КонецПроцедуры

Функция СтратегияПогашенияПоОрганизации(вхСсылкаНаДокумент, ДатаДокумента) Экспорт
	
	СтратегияПогашенияПоОрганизации = Новый Структура;
	СтратегияПогашенияПоОрганизации.Вставить("ПараметрыПолитикиМФП", Неопределено);
	СтратегияПогашенияПоОрганизации.Вставить("ИспользуютсяМФП", ИспользуютсяМФП(ДатаДокумента));
	
	Организация = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(вхСсылкаНаДокумент, "Организация");
	Если СтратегияПогашенияПоОрганизации.ИспользуютсяМФП Тогда
		ПараметрыПолитикиМФП = Справочники.ПолитикиМФП.ПолучитьПараметрыПолитикиМФПДляОрганизации(Организация, ДатаДокумента);
		СтратегияПогашенияПоОрганизации.ПараметрыПолитикиМФП = ПараметрыПолитикиМФП;
		
		Если НЕ СтратегияПогашенияПоОрганизации.ПараметрыПолитикиМФП = Неопределено Тогда
			
			//Подбирать остатки по организации строки
			СтратегияПогашенияПоОрганизации.ПараметрыПолитикиМФП.Вставить("УчитыватьОрганизациюТаблицыСписания", Истина);
			
			Если ТипЗнч(вхСсылкаНаДокумент) = Тип("ДокументСсылка.РеализацияТоваровУслуг") Тогда
				
				//Для РТУ на питерских контрагентов в качестве закупочной организации оставим только организацию документа
				ДатаНачалаРазделенияРТУ_СПБ = глЗначениеПеременной("ДатаНачалаРазделенияРТУ_СПБ");
				ПокупательИзДрБазы 			= ОбщегоНазначения.ЗначениеРеквизитаОбъекта(вхСсылкаНаДокумент, "Контрагент.ПокупательИзДрБазы");
				
				Если ЗначениеЗаполнено(ДатаНачалаРазделенияРТУ_СПБ) 
					И ДатаДокумента >= ДатаНачалаРазделенияРТУ_СПБ
					И ПокупательИзДрБазы Тогда
					
					СтратегияПогашенияПоОрганизации.ПараметрыПолитикиМФП.ОрганизацииДляЗакупки.Очистить();
					НоваяСтрока 			= СтратегияПогашенияПоОрганизации.ПараметрыПолитикиМФП.ОрганизацииДляЗакупки.Добавить();
					НоваяСтрока.Организация = Организация;
				Иначе
					//Подбирать остатки по всем доступным организациям из "ОрганизацииДляЗакупки"
					СтратегияПогашенияПоОрганизации.ПараметрыПолитикиМФП.Вставить("УчитыватьОрганизациюТаблицыСписания", Ложь);
				КонецЕсли;
				
			ИначеЕсли ТипЗнч(вхСсылкаНаДокумент) = Тип("ДокументСсылка.ПеремещениеТоваров") Тогда
				
				Запрос = Новый Запрос;
				Запрос.Текст = 
				"ВЫБРАТЬ Различные
				|	ПеремещениеТоваровТовары.Организация
				|ИЗ
				|	Документ.ПеремещениеТоваров.Товары КАК ПеремещениеТоваровТовары
				|ГДЕ
				|	ПеремещениеТоваровТовары.Ссылка = &Ссылка
				|	И НЕ ПеремещениеТоваровТовары.Организация = &Организация
				|	И НЕ ПеремещениеТоваровТовары.Организация = ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)";
				Запрос.УстановитьПараметр("Организация", Организация);
				Запрос.УстановитьПараметр("Ссылка", 	 вхСсылкаНаДокумент);
				
				Выборка = Запрос.Выполнить().Выбрать();
				
				СтратегияПогашенияПоОрганизации.ПараметрыПолитикиМФП.ОрганизацииДляЗакупки.Очистить();
				НоваяСтрока 			= СтратегияПогашенияПоОрганизации.ПараметрыПолитикиМФП.ОрганизацииДляЗакупки.Добавить();
				НоваяСтрока.Организация = Организация;
				Пока Выборка.Следующий() Цикл
					НоваяСтрока 			= СтратегияПогашенияПоОрганизации.ПараметрыПолитикиМФП.ОрганизацииДляЗакупки.Добавить();
					НоваяСтрока.Организация = Выборка.Организация;
				КонецЦикла;
				
			// ХудинВВ 21112018	
			ИначеЕсли ТипЗнч(вхСсылкаНаДокумент) = Тип("ДокументСсылка.ВозвратТоваровПоставщику") Тогда

				ОрганизацияДляСписанияПартий = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(вхСсылкаНаДокумент, "ОрганизацияДляСписанияПартий");
				
				СтратегияПогашенияПоОрганизации.ПараметрыПолитикиМФП.ОрганизацииДляЗакупки.Очистить();
				НоваяСтрока 			= СтратегияПогашенияПоОрганизации.ПараметрыПолитикиМФП.ОрганизацииДляЗакупки.Добавить();
				НоваяСтрока.Организация = ?(ЗначениеЗаполнено(ОрганизацияДляСписанияПартий), ОрганизацияДляСписанияПартий, Организация);
				
			Иначе //все остальные типы документов могут списывать только по своей организации
				
				СтратегияПогашенияПоОрганизации.ПараметрыПолитикиМФП.ОрганизацииДляЗакупки.Очистить();
				НоваяСтрока 			= СтратегияПогашенияПоОрганизации.ПараметрыПолитикиМФП.ОрганизацииДляЗакупки.Добавить();
				НоваяСтрока.Организация = Организация;
				
			КонецЕсли;
		КонецЕсли;
		
	КонецЕсли;
	
	Если СтратегияПогашенияПоОрганизации.ИспользуютсяМФП И СтратегияПогашенияПоОрганизации.ПараметрыПолитикиМФП = Неопределено Тогда
		ТекстОшибки = "Не задана политика МФП для организации "+Организация + " на "+ДатаДокумента+"!";
		ВызватьИсключение ТекстОшибки;
	КонецЕсли;
	
	//старый признак, пока сохраняем
	СписыватьТолькоПоСвоейОрганизации = Истина;
	Если ТипЗнч(вхСсылкаНаДокумент) = Тип("ДокументСсылка.РеализацияТоваровУслуг") Тогда 
		СписыватьТолькоПоСвоейОрганизации = СтратегияПогашенияПоОрганизации_РТУ(вхСсылкаНаДокумент, ДатаДокумента);
	КонецЕсли;
	СтратегияПогашенияПоОрганизации.Вставить("СписыватьТолькоПоСвоейОрганизации", СписыватьТолькоПоСвоейОрганизации); 
	
	Возврат СтратегияПогашенияПоОрганизации;
	
КонецФункции

Функция СтратегияПогашенияПоОрганизации_РТУ(вхСсылкаНаДокумент, ДатаДокумента) Экспорт
	
	СписыватьТолькоПоСвоейОрганизации = Ложь;
	
	Если ДатаДокумента < глЗначениеПеременной("ДатаЗапускаПроведенияПоПартиямРезервам") Тогда
		СписыватьТолькоПоСвоейОрганизации = Истина;
	КонецЕсли;	
	
	ДатаНачалаРазделенияРТУ_СПБ = глЗначениеПеременной("ДатаНачалаРазделенияРТУ_СПБ");
	Контрагент 					= ОбщегоНазначения.ЗначениеРеквизитаОбъекта(вхСсылкаНаДокумент, "Контрагент");
	ПокупательИзДрБазы 			= ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Контрагент, "ПокупательИзДрБазы");
	
	Если ЗначениеЗаполнено(ДатаНачалаРазделенияРТУ_СПБ) 
		И ДатаДокумента >= ДатаНачалаРазделенияРТУ_СПБ
		И ПокупательИзДрБазы Тогда
		СписыватьТолькоПоСвоейОрганизации = Истина;
	КонецЕсли;
	
	Возврат СписыватьТолькоПоСвоейОрганизации;
	
КонецФункции

Процедура ПогашениеПартийТоваровНовоеФрагмент(вхСсылкаНаДокумент, 
												ТаблицаДляРаспределения, 
												ПередаваемыеПараметры, 
												ОстаткиПоПартиям, 
												ТаблицаДвижений,
												вхОтказ,	
												ТаблицаПоFIFO = Неопределено, ОтсортированаПоОрганизации = Неопределено, ПараметрыСписания = Неопределено) 
												
	лКлючАлгоритма = "ОбщийМодуль_ПроведениеДокументовКлиентСервер_ПогашениеПартийТоваровНовоеФрагмент";
	лЗамена = АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		Выполнить(лЗамена);
	КонецЕсли;
											
	КолонкиРаспределения 				= ПередаваемыеПараметры.КолонкиРаспределения;
	ЗаполняемыеРеквизиты 				= ПередаваемыеПараметры.ЗаполняемыеРеквизиты;
	КонтрольНаличияПартий 				= ПередаваемыеПараметры.КонтрольНаличияПартий;
	ДатаДокумента						= ПередаваемыеПараметры.ДатаДокумента;	
	СписыватьТолькоПоСвоейОрганизации 	= ПередаваемыеПараметры.СписыватьТолькоПоСвоейОрганизации;
	СтратегияПогашенияПоОрганизации 	= ПередаваемыеПараметры.СтратегияПогашенияПоОрганизации;
	
	// 18.04.19 Строганов Роман > 
	Если ПередаваемыеПараметры.Свойство("ТаблицаПоFIFOБезОтбораПоПоставщику") Тогда 
		ТаблицаПоFIFOБезОтбораПоПоставщику 	= ПередаваемыеПараметры.ТаблицаПоFIFOБезОтбораПоПоставщику;
	КонецЕсли;
	// 18.04.19 Строганов Роман <
	
	ЭтоСписаниеПоFIFO = (ТаблицаПоFIFO = Неопределено); //Условие если списываем по FIFO
	
	Если ПараметрыСписания = Неопределено Тогда
		ПараметрыСписания = Новый Структура;
	КонецЕсли;
	
	ВызыватьИсключение = Неопределено;
	ПараметрыСписания.Свойство("ВызыватьИсключение", ВызыватьИсключение);
	Если ВызыватьИсключение = Неопределено Тогда
		ВызыватьИсключение = Истина;
	КонецЕсли;
	
	Успешно = Истина;
	Сообщение = "";
	
	Для Каждого СтрокаТовары Из ТаблицаДляРаспределения Цикл 
		
		Если ОтсортированаПоОрганизации <> Неопределено Тогда 
			Если ОтсортированаПоОрганизации <> СтрокаТовары.Организация Тогда 
				Для Каждого СтрокаТЧ Из ОстаткиПоПартиям Цикл 
					СтрокаТЧ.ЭтаОрганизация = (СтрокаТЧ.Организация = СтрокаТовары.Организация);
				КонецЦикла;
				Если ЭтоСписаниеПоFIFO Тогда 
					ОстаткиПоПартиям.Сортировать("ЭтаОрганизация Убыв, ОрганизацияНаименование, ПустойДокументОснование, СтрокаПриходаДата")
				Иначе
					ОстаткиПоПартиям.Сортировать("ЭтаОрганизация Убыв, ОрганизацияНаименование");
				КонецЕсли;
				ОтсортированаПоОрганизации = СтрокаТовары.Организация;
			КонецЕсли;
		КонецЕсли;
		
		Отбор = Новый Структура(КолонкиРаспределения);
		ЗаполнитьЗначенияСвойств(Отбор, СтрокаТовары);
		СтрокиОстатков = ОстаткиПоПартиям.НайтиСтроки(Отбор);
		
		КоличествоРаспределить = СтрокаТовары.Количество;
		ИндексСтроки = 0;
		
		КоличествоРаспределить = СписатьПартииПоСтрокеТаблицеСписания(вхСсылкаНаДокумент, ДатаДокумента, ЗаполняемыеРеквизиты, СтрокаТовары, СтрокиОстатков, ТаблицаДвижений);
		//Пока КоличествоРаспределить > 0 И ИндексСтроки < СтрокиОстатков.Количество() Цикл  
		//	СтрокаОст = СтрокиОстатков.Получить(ИндексСтроки);
		//	Если СтрокаОст.Количество > 0 Тогда 
		//		СписываемоеКоличество = Мин(КоличествоРаспределить, СтрокаОст.Количество);
		//		
		//		СтрокаДвижений = ТаблицаДвижений.Добавить();
		//		ЗаполнитьЗначенияСвойств(СтрокаДвижений, СтрокаОст);
		//		
		//		СтрокаДвижений.ВидДвижения = ВидДвиженияНакопления.Расход;
		//		СтрокаДвижений.Количество = СписываемоеКоличество;
		//		СтрокаДвижений.Регистратор = вхСсылкаНаДокумент;
		//		СтрокаДвижений.Период = ДатаДокумента;
		//		ЗаполнитьЗначенияСвойств(СтрокаДвижений, СтрокаТовары, ЗаполняемыеРеквизиты);
		//		Если СтрокаДвижений.Количество <> СтрокаОст.Количество Тогда 
		//			СтрокаДвижений.СуммаРубли   = СтрокаДвижений.Количество * СтрокаДвижений.СуммаРубли/СтрокаОст.Количество;
		//			СтрокаДвижений.СуммаДоллары = СтрокаДвижений.Количество * СтрокаДвижений.СуммаДоллары/СтрокаОст.Количество;
		//			СтрокаДвижений.СуммаЕвро 	= СтрокаДвижений.Количество * СтрокаДвижений.СуммаЕвро/СтрокаОст.Количество;
		//			СтрокаДвижений.СуммаБезНДС 	= СтрокаДвижений.Количество * СтрокаДвижений.СуммаБезНДС/СтрокаОст.Количество;
		//		КонецЕсли;
		//		
		//		СтрокаОст.Количество   = СтрокаОст.Количество - СписываемоеКоличество;	
		//		СтрокаОст.СуммаРубли   = СтрокаОст.СуммаРубли - СтрокаДвижений.СуммаРубли;	
		//		СтрокаОст.СуммаДоллары = СтрокаОст.СуммаДоллары - СтрокаДвижений.СуммаДоллары;
		//		СтрокаОст.СуммаЕвро    = СтрокаОст.СуммаЕвро - СтрокаДвижений.СуммаЕвро;
		//		СтрокаОст.СуммаБезНДС    = СтрокаОст.СуммаБезНДС - СтрокаДвижений.СуммаБезНДС;
		//		
		//		КоличествоРаспределить = КоличествоРаспределить - СписываемоеКоличество;
		//		Если СтрокаТовары.ВидСписания = "Перемещение" Тогда 
		//			СтрокаДвиженийПриход = ТаблицаДвижений.Добавить();
		//			ЗаполнитьЗначенияСвойств(СтрокаДвиженийПриход, СтрокаДвижений);
		//			СтрокаДвиженийПриход.Склад = СтрокаТовары.СкладПеремещения;
		//			СтрокаДвиженийПриход.Качество = СтрокаТовары.КачествоПеремещения;
		//			СтрокаДвиженийПриход.ВидДвижения = ВидДвиженияНакопления.Приход;
		//			СтрокаДвиженийПриход.СтатусПартии = СтрокаТовары.СтатусПартииПеремещения;
		//		    СтрокаДвиженийПриход.ДокументОснование = СтрокаТовары.ДокументОснованиеПеремещения
		//		КонецЕсли;
		//	КонецЕсли;
		//	ИндексСтроки = ИндексСтроки + 1;
		//КонецЦикла;
		Если КоличествоРаспределить > 0 Тогда
			// 18.04.19 Строганов Роман > 
			Если СтрокаТовары.УпрощенныйКонтрольПроведения И ТаблицаПоFIFOБезОтбораПоПоставщику <> Неопределено Тогда
				НоваяСтрока = ТаблицаПоFIFOБезОтбораПоПоставщику.Добавить();
				ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаТовары);
				НоваяСтрока.СтрокаПрихода = Неопределено;
				НоваяСтрока.ПустаяСтрокаПрихода = Истина;
				НоваяСтрока.Количество = КоличествоРаспределить;
			// 18.04.19 Строганов Роман 
			ИначеЕсли Не ЭтоСписаниеПоFIFO Тогда 
				//Нет партий по данной строке прихода, пытаемся списать по FIFO 
				НоваяСтрока = ТаблицаПоFIFO.Добавить();
				ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаТовары);
				НоваяСтрока.СтрокаПрихода = Неопределено;
				НоваяСтрока.ПустаяСтрокаПрихода = Истина;
				НоваяСтрока.Количество = КоличествоРаспределить;
			Иначе
				Успешно = Ложь;
				Сообщение = Сообщение + 
				"[ПогашениеПартийТоваров]: не удалось списать по партиям
				| Номенклатура: " + СтрокаТовары.Номенклатура.Артикул + "/" + СтрокаТовары.Номенклатура + "(" + СтрокаТовары.Номенклатура.Код + ")" + "
				//| Номенклатура: " + СтрокаТовары.Номенклатура + "(" + СтрокаТовары.Номенклатура.Код + ")" + "
				| Склад: " +  СтрокаТовары.Склад + " 
				| Качество: " + СтрокаТовары.Качество + "
				| Количество (недостающее): " + Формат(КоличествоРаспределить, "ЧГ=0") + "
				| Списание по всем орг.: " + Формат(Не СписыватьТолькоПоСвоейОрганизации, "БЛ=Нет; БИ=Да") + "
				| Параметры поиска: " + КолонкиРаспределения + Символы.ПС; 
				
				//Напишем список организаций, по которым пробовали списать
				Если СтратегияПогашенияПоОрганизации.ИспользуютсяМФП Тогда
					
					Если СтратегияПогашенияПоОрганизации.ПараметрыПолитикиМФП.УчитыватьОрганизациюТаблицыСписания Тогда
						
						Сообщение = Сообщение + 
						" Список доступных организаций для списания партий:
						|"+СтрокаТовары.Организация+"
						|";
						
					Иначе
						
						ОрганизацииДляСписания = СтратегияПогашенияПоОрганизации.ПараметрыПолитикиМФП.ОрганизацииДляЗакупки;
						ОрганизацииДляСписанияСтрока = "";
						Для каждого Стр ИЗ ОрганизацииДляСписания Цикл
							ОрганизацииДляСписанияСтрока = ОрганизацииДляСписанияСтрока + ?(ОрганизацииДляСписанияСтрока = "", "", Символы.ПС) + Стр.Организация;
						КонецЦикла;
						Сообщение = Сообщение + 
						" Список доступных организаций для списания партий:
						|"+ОрганизацииДляСписанияСтрока+"
						|";
						
					КонецЕсли;
					
				КонецЕсли;
				
				//13.03.2019 Валиахметов http://jira.part-kom.ru/browse/XX-2059	
				Если ТипЗнч(ПараметрыСписания) = Тип("Структура") И ПараметрыСписания.Свойство("НеХватаетОстатка") Тогда 
					СтрокаНеХватаетОстатка = ПараметрыСписания.НеХватаетОстатка.Найти(СтрокаТовары.НомерСтрокиВДокументе, "НомерСтроки");
					Если СтрокаНеХватаетОстатка = Неопределено Тогда 
						СтрокаНеХватаетОстатка = ПараметрыСписания.НеХватаетОстатка.Добавить();
						СтрокаНеХватаетОстатка.НомерСтроки = СтрокаТовары.НомерСтрокиВДокументе;
					КонецЕсли;
					СтрокаНеХватаетОстатка.Количество = Макс(СтрокаНеХватаетОстатка.Количество, КоличествоРаспределить);
				КонецЕсли;
				//Конец 13.03.2019 Валиахметов http://jira.part-kom.ru/browse/XX-2059	

				//Сообщить("[ПогашениеПартийТоваров]: не удалось списать по партиям номенклатуру " + СтрокаТовары.Номенклатура + "(" + СтрокаТовары.Номенклатура.Код + ")" + " со склада " + СтрокаТовары.Склад +  " с качеством " + СтрокаТовары.Качество + " в количестве " + КоличествоРаспределить);
				Попытка
				Если КонтрольНаличияПартий Тогда 
					вхОтказ = Истина;
				КонецЕсли;
				Исключение
				КонецПопытки;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	Если Не Успешно Тогда 
		#Если Клиент Тогда 
			Сообщить(Сообщение);
		#КонецЕсли
		Если ВызыватьИсключение Тогда
			ВызватьИсключение Сообщение;
		КонецЕсли;
	КонецЕсли;

КонецПроцедуры

//Валиахметов 05.04.2019 http://jira.part-kom.ru/browse/XX-1966  Оптимизация процесса перемещения
//Приоритетные партии
Функция ПриоритетныеПартии(вхСсылкаНаДокумент) Экспорт 
	лКлючАлгоритма = "ОбщийМодуль_ПроведениеДокументовКлиентСервер_ПриоритетныеПартии";
	лЗамена = АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		АлгоритмыЗначениеВозврата = Неопределено;
		Выполнить(лЗамена);
		Возврат АлгоритмыЗначениеВозврата;
	КонецЕсли;
	
	ЭтоИсходящееПеремещение_НовоеПроведение = ИсходящееПеремещениеРазрешеноРазмещениеБезСборки(вхСсылкаНаДокумент);
	//Если ТипЗнч(вхСсылкаНаДокумент) = Тип("ДокументСсылка.ПеремещениеТоваров") Тогда 
	//	РеквизитыДокумента = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(вхСсылкаНаДокумент, "СкладПолучатель.ТоварыВПути, Дата");
	//	Если РеквизитыДокумента.Дата >= Константы.ДатаНовогоПроведенияПоПартиям_Апрель2019.Получить() И РеквизитыДокумента.СкладПолучательТоварыВПути Тогда 
	//		ЭтоИсходящееПеремещение = Ложь;
	//	КонецЕсли;
	//КонецЕсли;
	
	ТаблицаДвижений = ПроведениеДокументовКлиентСервер.ЗначенияДвиженийДокумента(вхСсылкаНаДокумент, Метаданные.РегистрыНакопления.ПартииТоваров);
	Строки = ТаблицаДвижений.НайтиСтроки(Новый Структура("ВидДвижения", ВидДвиженияНакопления.Расход));
		
	ПриоритетныеПартии = ТаблицаДвижений.Скопировать(Строки);
	Если ЭтоИсходящееПеремещение_НовоеПроведение Тогда 
		Запрос = Новый Запрос;
		Запрос.Текст = "ВЫБРАТЬ
		               |	ПриоритетныеПартии.Номенклатура,
		               |	ПриоритетныеПартии.Склад,
		               |	ПриоритетныеПартии.Качество,
		               |	ПриоритетныеПартии.СтатусПартии,
		               |	ПриоритетныеПартии.СтрокаПрихода,
		               |	ПриоритетныеПартии.Организация,
		               |	ПриоритетныеПартии.Количество,
		               |	ПриоритетныеПартии.СуммаРубли,
		               |	ПриоритетныеПартии.СуммаДоллары,
		               |	ПриоритетныеПартии.СуммаЕвро,
		               |	ПриоритетныеПартии.СуммаБезНДС
		               |ПОМЕСТИТЬ ПриоритетныеПартии
		               |ИЗ
		               |	&ПриоритетныеПартии КАК ПриоритетныеПартии
		               |ГДЕ
		               |	ПриоритетныеПартии.Количество > 0
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПриоритетныеПартии.Номенклатура,
		               |	ПриоритетныеПартии.Склад,
		               |	ПриоритетныеПартии.Качество,
		               |	ПриоритетныеПартии.СтатусПартии,
		               |	ПриоритетныеПартии.СтрокаПрихода,
		               |	ПриоритетныеПартии.Организация,
		               |	СУММА(ПриоритетныеПартии.Количество) КАК Количество,
		               |	СУММА(ПриоритетныеПартии.СуммаРубли) КАК СуммаРубли,
		               |	СУММА(ПриоритетныеПартии.СуммаДоллары) КАК СуммаДоллары,
		               |	СУММА(ПриоритетныеПартии.СуммаЕвро) КАК СуммаЕвро,
		               |	СУММА(ПриоритетныеПартии.СуммаБезНДС) КАК СуммаБезНДС
		               |ПОМЕСТИТЬ ПриоритетныеПартииСвернутые
		               |ИЗ
		               |	ПриоритетныеПартии КАК ПриоритетныеПартии
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ПриоритетныеПартии.Номенклатура,
		               |	ПриоритетныеПартии.Склад,
		               |	ПриоритетныеПартии.Качество,
		               |	ПриоритетныеПартии.СтатусПартии,
		               |	ПриоритетныеПартии.СтрокаПрихода,
		               |	ПриоритетныеПартии.Организация
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.КоличествоОстаток КАК Количество
		               |ПОМЕСТИТЬ ПартииСвободные
		               |ИЗ
		               |	РегистрНакопления.ПартииТоваров.Остатки(, ДокументОснование = &ДокументОснование) КАК ПартииТоваровОстатки
		               |ГДЕ
		               |	ПартииТоваровОстатки.КоличествоОстаток > 0
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПриоритетныеПартииСвернутые.Номенклатура,
		               |	ПриоритетныеПартииСвернутые.Склад,
		               |	ПриоритетныеПартииСвернутые.Качество,
		               |	ПриоритетныеПартииСвернутые.СтатусПартии,
		               |	ПриоритетныеПартииСвернутые.СтрокаПрихода,
		               |	ПриоритетныеПартииСвернутые.Организация,
		               |	ПриоритетныеПартииСвернутые.Количество - ЕСТЬNULL(ПартииСвободные.Количество, 0) КАК Количество,
		               |	ПриоритетныеПартииСвернутые.СуммаРубли * (ПриоритетныеПартииСвернутые.Количество - ЕСТЬNULL(ПартииСвободные.Количество, 0)) / ПриоритетныеПартииСвернутые.Количество КАК СуммаРубли,
		               |	ПриоритетныеПартииСвернутые.СуммаДоллары * (ПриоритетныеПартииСвернутые.Количество - ЕСТЬNULL(ПартииСвободные.Количество, 0)) / ПриоритетныеПартииСвернутые.Количество КАК СуммаДоллары,
		               |	ПриоритетныеПартииСвернутые.СуммаЕвро * (ПриоритетныеПартииСвернутые.Количество - ЕСТЬNULL(ПартииСвободные.Количество, 0)) / ПриоритетныеПартииСвернутые.Количество КАК СуммаЕвро,
		               |	ПриоритетныеПартииСвернутые.СуммаБезНДС * (ПриоритетныеПартииСвернутые.Количество - ЕСТЬNULL(ПартииСвободные.Количество, 0)) / ПриоритетныеПартииСвернутые.Количество КАК СуммаБезНДС
		               |ИЗ
		               |	ПриоритетныеПартииСвернутые КАК ПриоритетныеПартииСвернутые
		               |		ЛЕВОЕ СОЕДИНЕНИЕ ПартииСвободные КАК ПартииСвободные
		               |		ПО ПриоритетныеПартииСвернутые.Номенклатура = ПартииСвободные.Номенклатура
		               |			И ПриоритетныеПартииСвернутые.Склад = ПартииСвободные.Склад
		               |			И ПриоритетныеПартииСвернутые.Качество = ПартииСвободные.Качество
		               |			И ПриоритетныеПартииСвернутые.СтатусПартии = ПартииСвободные.СтатусПартии
		               |			И ПриоритетныеПартииСвернутые.СтрокаПрихода = ПартииСвободные.СтрокаПрихода
		               |			И ПриоритетныеПартииСвернутые.Организация = ПартииСвободные.Организация
		               |ГДЕ
		               |	ПриоритетныеПартииСвернутые.Количество - ЕСТЬNULL(ПартииСвободные.Количество, 0) > 0";
		Запрос.УстановитьПараметр("ДокументОснование", вхСсылкаНаДокумент);
	    Запрос.УстановитьПараметр("ПриоритетныеПартии", ПриоритетныеПартии);
		ПриоритетныеПартии = Запрос.Выполнить().Выгрузить();
		ПриоритетныеПартии.Колонки.Добавить("ДокументОснование", Новый ОписаниеТипов("Неопределено"));
		ПриоритетныеПартии.ЗаполнитьЗначения(Неопределено, "ДокументОснование");
	КонецЕсли;
	
	ПриоритетныеПартии.Колонки.Добавить("Поставщик", Новый ОписаниеТипов("СправочникСсылка.Контрагенты"));
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	ВЫРАЗИТЬ(ПриоритетныеПартии.СтрокаПрихода КАК Справочник.ИдентификаторыСтрокПриходов) КАК СтрокаПрихода
	               |ПОМЕСТИТЬ Вт
	               |ИЗ
	               |	&ПриоритетныеПартии КАК ПриоритетныеПартии
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	Вт.СтрокаПрихода,
	               |	Вт.СтрокаПрихода.ТорговаяТочка.Владелец КАК Поставщик
	               |ИЗ
	               |	Вт КАК Вт";
	Запрос.УстановитьПараметр("ПриоритетныеПартии", ПриоритетныеПартии);
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл 
		Строки = ПриоритетныеПартии.НайтиСтроки(Новый Структура("СтрокаПрихода", Выборка.СтрокаПрихода));
		Для Каждого Строка Из Строки Цикл 
			Строка.Поставщик = Выборка.Поставщик;
		КонецЦикла;
	КонецЦикла;
	
	Возврат ПриоритетныеПартии;
	
КонецФункции

Функция СписатьПоПриоритетнымПартиям(вхСсылкаНаДокумент, ТаблицаДвижений, Товары, СтратегияПогашенияПоОрганизации, ЗаполняемыеРеквизиты, ДатаДокумента)
	лКлючАлгоритма = "ОбщийМодуль_ПроведениеДокументовКлиентСервер_СписатьПоПриоритетнымПартиям";
	лЗамена = АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		АлгоритмыЗначениеВозврата = Неопределено;
		Выполнить(лЗамена);
		Возврат АлгоритмыЗначениеВозврата;
	КонецЕсли;
	                                                                     
	ТаблицаОстатков = ПриоритетныеПартии(вхСсылкаНаДокумент);
	
	Для Каждого СтрокаТовары из Товары Цикл 
		Отбор = Новый Структура("Номенклатура,Качество,ДокументОснование");
		
		Если СтратегияПогашенияПоОрганизации.ИспользуютсяМФП И СтратегияПогашенияПоОрганизации.ПараметрыПолитикиМФП.УчитыватьОрганизациюТаблицыСписания 
			Или СтратегияПогашенияПоОрганизации.СписыватьТолькоПоСвоейОрганизации Тогда
			Отбор.Вставить("Организация");
		КонецЕсли;

		Если Не СтрокаТовары.ИгнорироватьСтатусПартии Тогда 
			Отбор.Вставить("СтатусПартии");
		КонецЕсли;
		Если СтрокаТовары.УчитыватьПоставщика Тогда 
			Отбор.Вставить("Поставщик");
		КонецЕсли;
		
		ЗаполнитьЗначенияСвойств(Отбор, СтрокаТовары);
		Строки = ТаблицаОстатков.НайтиСтроки(Отбор);
		
		КоличествоРаспределить = СписатьПартииПоСтрокеТаблицеСписания(вхСсылкаНаДокумент, ДатаДокумента, ЗаполняемыеРеквизиты, СтрокаТовары, Строки, ТаблицаДвижений);
	   
		Если КоличествоРаспределить > 0 И ЗначениеЗаполнено(Отбор.ДокументОснование) Тогда 
			Отбор.Вставить("ДокументОснование", Неопределено);
			Строки = ТаблицаОстатков.НайтиСтроки(Отбор);
			
			КоличествоРаспределить = СписатьПартииПоСтрокеТаблицеСписания(вхСсылкаНаДокумент, ДатаДокумента, ЗаполняемыеРеквизиты, СтрокаТовары, Строки, ТаблицаДвижений);
		КонецЕсли;
	КонецЦикла;
	
КонецФункции

Функция ИсходящееПеремещениеРазрешеноРазмещениеБезСборки(Документ) Экспорт
	
	лКлючАлгоритма = "ОбщийМодуль_ПроведениеДокументовКлиентСервер_ИсходящееПеремещениеРазрешеноРазмещениеБезСборки";
	лЗамена = АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		АлгоритмыЗначениеВозврата = Неопределено;
		Выполнить(лЗамена);
		Возврат АлгоритмыЗначениеВозврата;
	КонецЕсли;
	
	Если ТипЗнч(Документ) = Тип("ДокументСсылка.ПеремещениеТоваров") Тогда 
		Реквизиты = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Документ, "Дата, СкладПолучатель.ТоварыВПути");
		ДатаНовогоПроведенияПоПартиям_Апрель2019 = Константы.ДатаНовогоПроведенияПоПартиям_Апрель2019.Получить();
		Если ЗначениеЗаполнено(ДатаНовогоПроведенияПоПартиям_Апрель2019) И Реквизиты.Дата >= ДатаНовогоПроведенияПоПартиям_Апрель2019 И Реквизиты.СкладПолучательТоварыВПути Тогда 
			Возврат Истина;
		КонецЕсли;
	КонецЕсли;
	
	Возврат Ложь;
КонецФункции

Процедура ПерепровестиДокумент (ДокОбъект) Экспорт 
	
	лКлючАлгоритма = "ОбщийМодуль_ПроведениеДокументовКлиентСервер_ПерепровестиДокумент";
	лЗамена = АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		Выполнить(лЗамена);
	КонецЕсли;

	ДокОбъект.ДополнительныеСвойства.Вставить("Перепровести");
	ДокОбъект.Записать(РежимЗаписиДокумента.Проведение);
	ДокОбъект.ДополнительныеСвойства.Удалить("Перепровести");
КонецПроцедуры

//Конец Валиахметов 05.04.2019 http://jira.part-kom.ru/browse/XX-1966  Оптимизация процесса перемещения

//Начало Процедуры списания по партиям

Процедура СписатьПоСтрокамПриходаПоПоставщику(вхСсылкаНаДокумент, ТаблицаДвижений, ТаблицаПоСтрокамПрихода, ТаблицаПоFIFO, СтратегияПогашенияПоОрганизации, ЗаполняемыеРеквизиты, КонтрольНаличияПартий, вхОтказ, ПараметрыСписания = Неопределено)
												
	лКлючАлгоритма = "ОбщийМодуль_ПроведениеДокументовКлиентСервер_СписатьПоСтрокамПриходаПоПоставщику";
	лЗамена = АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		Выполнить(лЗамена);
	КонецЕсли;
	
	ОтсортированаПоОрганизации = Неопределено; 
	ОперативноеПроведение = Неопределено;
	
	Реквизиты = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(вхСсылкаНаДокумент, "Дата,Организация");
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ТаблицаДвижений", ТаблицаДвижений);			   
	Запрос.УстановитьПараметр("ТаблицаПоСтрокамПрихода", ТаблицаПоСтрокамПрихода);
	
	ПараметрыСписания.Свойство("ОперативноеПроведение", ОперативноеПроведение);
	Если ОперативноеПроведение = Неопределено Тогда 
		ОперативноеПроведение = Ложь;
	КонецЕсли;
	
	Запрос.УстановитьПараметр("КонПериода", ?(ОперативноеПроведение, Неопределено, вхСсылкаНаДокумент.МоментВремени()));
	
	КолонкиРаспределения = "Номенклатура,Склад,Качество,СтрокаПрихода,СтатусПартии,Поставщик"; 
	
	Если СтратегияПогашенияПоОрганизации.ИспользуютсяМФП Тогда
		
		Если СтратегияПогашенияПоОрганизации.ПараметрыПолитикиМФП.УчитыватьОрганизациюТаблицыСписания Тогда
			КолонкиРаспределения = КолонкиРаспределения + ",Организация"; 
		КонецЕсли;
		
		Запрос.УстановитьПараметр("ТаблицаПриоритетаОрганизаций", СтратегияПогашенияПоОрганизации.ПараметрыПолитикиМФП.ОрганизацииДляЗакупки);
		
		Запрос.Текст = "ВЫБРАТЬ
		               |	ТаблицаПриоритетаОрганизаций.Приоритет КАК Приоритет,
		               |	ТаблицаПриоритетаОрганизаций.Организация КАК Организация
		               |ПОМЕСТИТЬ ТаблицаПриоритетаОрганизаций
		               |ИЗ
		               |	&ТаблицаПриоритетаОрганизаций КАК ТаблицаПриоритетаОрганизаций
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ РАЗЛИЧНЫЕ
		               |	ТаблицаПоСтрокамПрихода.Номенклатура КАК Номенклатура,
		               |	ТаблицаПоСтрокамПрихода.Склад КАК Склад,
		               |	ТаблицаПоСтрокамПрихода.Качество КАК Качество,
		               |	ТаблицаПоСтрокамПрихода.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаПоСтрокамПрихода.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаПоСтрокамПрихода.Поставщик КАК Поставщик
		               |ПОМЕСТИТЬ ТаблицаПоСтрокамПрихода
		               |ИЗ
		               |	&ТаблицаПоСтрокамПрихода КАК ТаблицаПоСтрокамПрихода
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
		               |	ТаблицаДвижений.Склад КАК Склад,
		               |	ТаблицаДвижений.Качество КАК Качество,
		               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаДвижений.Организация КАК Организация,
		               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование,
		               |	ТаблицаДвижений.Количество КАК Количество,
		               |	ТаблицаДвижений.СуммаРубли КАК СуммаРубли,
		               |	ТаблицаДвижений.СуммаДоллары КАК СуммаДоллары,
		               |	ТаблицаДвижений.СуммаЕвро КАК СуммаЕвро,
		               |	ТаблицаДвижений.СуммаБезНДС КАК СуммаБезНДС
		               |ПОМЕСТИТЬ ТаблицаДвижений
		               |ИЗ
		               |	&ТаблицаДвижений КАК ТаблицаДвижений
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
		               |	ТаблицаДвижений.Склад КАК Склад,
		               |	ТаблицаДвижений.Качество КАК Качество,
		               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаДвижений.Организация КАК Организация,
		               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование,
		               |	СУММА(ТаблицаДвижений.Количество) КАК Количество,
		               |	СУММА(ТаблицаДвижений.СуммаРубли) КАК СуммаРубли,
		               |	СУММА(ТаблицаДвижений.СуммаДоллары) КАК СуммаДоллары,
		               |	СУММА(ТаблицаДвижений.СуммаЕвро) КАК СуммаЕвро,
		               |	СУММА(ТаблицаДвижений.СуммаБезНДС) КАК СуммаБезНДС
		               |ПОМЕСТИТЬ ТаблицаДвиженийСвернутая
		               |ИЗ
		               |	ТаблицаДвижений КАК ТаблицаДвижений
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ТаблицаДвижений.Номенклатура,
		               |	ТаблицаДвижений.Склад,
		               |	ТаблицаДвижений.Качество,
		               |	ТаблицаДвижений.СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода,
		               |	ТаблицаДвижений.Организация,
		               |	ТаблицаДвижений.ДокументОснование
		               |
		               |ИНДЕКСИРОВАТЬ ПО
		               |	Номенклатура,
		               |	Склад,
		               |	Качество,
		               |	СтатусПартии,
		               |	СтрокаПрихода,
		               |	Организация,
		               |	ДокументОснование
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтрокаПрихода.Дата,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.ДокументОснование,
		               |	ПартииТоваровОстатки.СтрокаПрихода.ТорговаяТочка.Владелец КАК Поставщик,
		               |	СУММА(ПартииТоваровОстатки.КоличествоОстаток) КАК Количество,
		               |	СУММА(ПартииТоваровОстатки.СуммаРублиОстаток) КАК СуммаРубли,
		               |	СУММА(ПартииТоваровОстатки.СуммаДолларыОстаток) КАК СуммаДоллары,
		               |	СУММА(ПартииТоваровОстатки.СуммаЕвроОстаток) КАК СуммаЕвро,
		               |	СУММА(ПартииТоваровОстатки.СуммаБезНДСОстаток) КАК СуммаБезНДС,
		               |	ПартииТоваровОстатки.Организация.Наименование КАК ОрганизацияНаименование
		               |ПОМЕСТИТЬ втПартии
		               |ИЗ
		               |	РегистрНакопления.ПартииТоваров.Остатки(
		               |			&КонПериода,
		               |			(Номенклатура, Склад, Качество, СтатусПартии, СтрокаПрихода) В
		               |				(ВЫБРАТЬ
		               |					ТаблицаПоСтрокамПрихода.Номенклатура,
		               |					ТаблицаПоСтрокамПрихода.Склад,
		               |					ТаблицаПоСтрокамПрихода.Качество,
		               |					ТаблицаПоСтрокамПрихода.СтатусПартии,
		               |					ТаблицаПоСтрокамПрихода.СтрокаПрихода
		               |				ИЗ
		               |					ТаблицаПоСтрокамПрихода)) КАК ПартииТоваровОстатки
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.СтрокаПрихода.ТорговаяТочка.Владелец,
		               |	ПартииТоваровОстатки.Организация.Наименование,
		               |	ПартииТоваровОстатки.СтрокаПрихода.Дата,
		               |	ПартииТоваровОстатки.ДокументОснование
		               |
		               |ДЛЯ ИЗМЕНЕНИЯ
		               |	РегистрНакопления.ПартииТоваров.Остатки
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	втПартии.Номенклатура,
		               |	втПартии.Склад,
		               |	втПартии.Качество,
		               |	втПартии.Организация,
		               |	втПартии.СтрокаПрихода,
		               |	втПартии.СтрокаПриходаДата,
		               |	втПартии.СтатусПартии,
		               |	втПартии.Поставщик,
		               |	втПартии.ДокументОснование,
		               |	втПартии.Количество,
		               |	втПартии.СуммаРубли,
		               |	втПартии.СуммаДоллары,
		               |	втПартии.СуммаЕвро,
		               |	втПартии.СуммаБезНДС,
		               |	втПартии.ОрганизацияНаименование
		               |ПОМЕСТИТЬ втПартииСвернутые
		               |ИЗ
		               |	втПартии КАК втПартии
		               |ГДЕ
		               |	(втПартии.Номенклатура, втПартии.Склад, втПартии.Качество, втПартии.СтатусПартии, втПартии.СтрокаПрихода, втПартии.Поставщик) В
		               |			(ВЫБРАТЬ
		               |				ТаблицаПоСтрокамПрихода.Номенклатура,
		               |				ТаблицаПоСтрокамПрихода.Склад,
		               |				ТаблицаПоСтрокамПрихода.Качество,
		               |				ТаблицаПоСтрокамПрихода.СтатусПартии,
		               |				ТаблицаПоСтрокамПрихода.СтрокаПрихода,
		               |				ТаблицаПоСтрокамПрихода.Поставщик
		               |			ИЗ
		               |				ТаблицаПоСтрокамПрихода)
		               |	И втПартии.Организация В
		               |			(ВЫБРАТЬ
		               |				ТаблицаПриоритетаОрганизаций.Организация
		               |			ИЗ
		               |				ТаблицаПриоритетаОрганизаций)
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.ДокументОснование,
		               |	ПартииТоваровОстатки.Поставщик КАК Поставщик,
		               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) КАК Количество,
		               |	ПартииТоваровОстатки.СуммаРубли - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаРубли, 0) КАК СуммаРубли,
		               |	ПартииТоваровОстатки.СуммаДоллары - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаДоллары, 0) КАК СуммаДоллары,
		               |	ПартииТоваровОстатки.СуммаЕвро - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаЕвро, 0) КАК СуммаЕвро,
		               |	ПартииТоваровОстатки.СуммаБезНДС - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаБезНДС, 0) КАК СуммаБезНДС,
		               |	ПартииТоваровОстатки.ОрганизацияНаименование КАК ОрганизацияНаименование
		               |ИЗ
		               |	втПартииСвернутые КАК ПартииТоваровОстатки
		               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаПриоритетаОрганизаций КАК ТаблицаПриоритетаОрганизаций
		               |		ПО (ТаблицаПриоритетаОрганизаций.Организация = ПартииТоваровОстатки.Организация)
		               |		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаДвиженийСвернутая КАК ТаблицаДвиженийСвернутая
		               |		ПО ПартииТоваровОстатки.Номенклатура = ТаблицаДвиженийСвернутая.Номенклатура
		               |			И ПартииТоваровОстатки.Склад = ТаблицаДвиженийСвернутая.Склад
		               |			И ПартииТоваровОстатки.Качество = ТаблицаДвиженийСвернутая.Качество
		               |			И ПартииТоваровОстатки.СтатусПартии = ТаблицаДвиженийСвернутая.СтатусПартии
		               |			И ПартииТоваровОстатки.СтрокаПрихода = ТаблицаДвиженийСвернутая.СтрокаПрихода
		               |			И ПартииТоваровОстатки.Организация = ТаблицаДвиженийСвернутая.Организация
		               |			И ПартииТоваровОстатки.ДокументОснование = ТаблицаДвиженийСвернутая.ДокументОснование
		               |ГДЕ
		               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) > 0
		               |
		               |УПОРЯДОЧИТЬ ПО
		               |	ТаблицаПриоритетаОрганизаций.Приоритет,
		               |	ПартииТоваровОстатки.СтрокаПриходаДата,
		               |	ПартииТоваровОстатки.ОрганизацияНаименование";

		
	ИначеЕсли СтратегияПогашенияПоОрганизации.СписыватьТолькоПоСвоейОрганизации Тогда 
		КолонкиРаспределения = КолонкиРаспределения + ",Организация"; 
		
		Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
		               |	ТаблицаПоСтрокамПрихода.Номенклатура КАК Номенклатура,
		               |	ТаблицаПоСтрокамПрихода.Склад КАК Склад,
		               |	ТаблицаПоСтрокамПрихода.Качество КАК Качество,
		               |	ТаблицаПоСтрокамПрихода.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаПоСтрокамПрихода.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаПоСтрокамПрихода.Организация КАК Организация,
		               |	ТаблицаПоСтрокамПрихода.Поставщик КАК Поставщик
		               |ПОМЕСТИТЬ ТаблицаПоСтрокамПрихода
		               |ИЗ
		               |	&ТаблицаПоСтрокамПрихода КАК ТаблицаПоСтрокамПрихода
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
		               |	ТаблицаДвижений.Склад КАК Склад,
		               |	ТаблицаДвижений.Качество КАК Качество,
		               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаДвижений.Организация КАК Организация,
		               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование,
		               |	ТаблицаДвижений.Количество КАК Количество,
		               |	ТаблицаДвижений.СуммаРубли КАК СуммаРубли,
		               |	ТаблицаДвижений.СуммаДоллары КАК СуммаДоллары,
		               |	ТаблицаДвижений.СуммаЕвро КАК СуммаЕвро,
		               |	ТаблицаДвижений.СуммаБезНДС КАК СуммаБезНДС
		               |ПОМЕСТИТЬ ТаблицаДвижений
		               |ИЗ
		               |	&ТаблицаДвижений КАК ТаблицаДвижений
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
		               |	ТаблицаДвижений.Склад КАК Склад,
		               |	ТаблицаДвижений.Качество КАК Качество,
		               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаДвижений.Организация КАК Организация,
		               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование,
		               |	СУММА(ТаблицаДвижений.Количество) КАК Количество,
		               |	СУММА(ТаблицаДвижений.СуммаРубли) КАК СуммаРубли,
		               |	СУММА(ТаблицаДвижений.СуммаДоллары) КАК СуммаДоллары,
		               |	СУММА(ТаблицаДвижений.СуммаЕвро) КАК СуммаЕвро,
		               |	СУММА(ТаблицаДвижений.СуммаБезНДС) КАК СуммаБезНДС
		               |ПОМЕСТИТЬ ТаблицаДвиженийСвернутая
		               |ИЗ
		               |	ТаблицаДвижений КАК ТаблицаДвижений
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ТаблицаДвижений.Номенклатура,
		               |	ТаблицаДвижений.Склад,
		               |	ТаблицаДвижений.Качество,
		               |	ТаблицаДвижений.СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода,
		               |	ТаблицаДвижений.Организация,
		               |	ТаблицаДвижений.ДокументОснование
		               |
		               |ИНДЕКСИРОВАТЬ ПО
		               |	Номенклатура,
		               |	Склад,
		               |	Качество,
		               |	СтатусПартии,
		               |	СтрокаПрихода,
		               |	Организация,
		               |	ДокументОснование
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.СтрокаПрихода.ТорговаяТочка.Владелец КАК Поставщик,
		               |	ПартииТоваровОстатки.ДокументОснование,
		               |	СУММА(ПартииТоваровОстатки.КоличествоОстаток) КАК Количество,
		               |	СУММА(ПартииТоваровОстатки.СуммаРублиОстаток) КАК СуммаРубли,
		               |	СУММА(ПартииТоваровОстатки.СуммаДолларыОстаток) КАК СуммаДоллары,
		               |	СУММА(ПартииТоваровОстатки.СуммаЕвроОстаток) КАК СуммаЕвро,
		               |	СУММА(ПартииТоваровОстатки.СуммаБезНДСОстаток) КАК СуммаБезНДС
		               |ПОМЕСТИТЬ втПартии
		               |ИЗ
		               |	РегистрНакопления.ПартииТоваров.Остатки(
		               |			&КонПериода,
		               |			(Номенклатура, Склад, Качество, СтатусПартии, СтрокаПрихода) В
		               |				(ВЫБРАТЬ
		               |					ТаблицаПоСтрокамПрихода.Номенклатура,
		               |					ТаблицаПоСтрокамПрихода.Склад,
		               |					ТаблицаПоСтрокамПрихода.Качество,
		               |					ТаблицаПоСтрокамПрихода.СтатусПартии,
		               |					ТаблицаПоСтрокамПрихода.СтрокаПрихода
		               |				ИЗ
		               |					ТаблицаПоСтрокамПрихода)) КАК ПартииТоваровОстатки
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.СтрокаПрихода.ТорговаяТочка.Владелец,
		               |	ПартииТоваровОстатки.ДокументОснование
		               |
		               |ДЛЯ ИЗМЕНЕНИЯ
		               |	РегистрНакопления.ПартииТоваров.Остатки
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	втПартии.Номенклатура,
		               |	втПартии.Склад,
		               |	втПартии.Качество,
		               |	втПартии.Организация,
		               |	втПартии.СтрокаПрихода,
		               |	втПартии.СтатусПартии,
		               |	втПартии.Поставщик,
		               |	втПартии.ДокументОснование,
		               |	втПартии.Количество,
		               |	втПартии.СуммаРубли,
		               |	втПартии.СуммаДоллары,
		               |	втПартии.СуммаЕвро,
		               |	втПартии.СуммаБезНДС
		               |ПОМЕСТИТЬ втПартииСвернутые
		               |ИЗ
		               |	втПартии КАК втПартии
		               |ГДЕ
		               |	(втПартии.Номенклатура, втПартии.Склад, втПартии.Качество, втПартии.СтатусПартии, втПартии.СтрокаПрихода, втПартии.Поставщик, втПартии.Организация) В
		               |			(ВЫБРАТЬ
		               |				ТаблицаПоСтрокамПрихода.Номенклатура,
		               |				ТаблицаПоСтрокамПрихода.Склад,
		               |				ТаблицаПоСтрокамПрихода.Качество,
		               |				ТаблицаПоСтрокамПрихода.СтатусПартии,
		               |				ТаблицаПоСтрокамПрихода.СтрокаПрихода,
		               |				ТаблицаПоСтрокамПрихода.Поставщик,
		               |				ТаблицаПоСтрокамПрихода.Организация
		               |			ИЗ
		               |				ТаблицаПоСтрокамПрихода)
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.ДокументОснование,
		               |	ПартииТоваровОстатки.Поставщик КАК Поставщик,
		               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) КАК Количество,
		               |	ПартииТоваровОстатки.СуммаРубли - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаРубли, 0) КАК СуммаРубли,
		               |	ПартииТоваровОстатки.СуммаДоллары - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаДоллары, 0) КАК СуммаДоллары,
		               |	ПартииТоваровОстатки.СуммаЕвро - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаЕвро, 0) КАК СуммаЕвро,
		               |	ПартииТоваровОстатки.СуммаБезНДС - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаБезНДС, 0) КАК СуммаБезНДС
		               |ИЗ
		               |	втПартииСвернутые КАК ПартииТоваровОстатки
		               |		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаДвиженийСвернутая КАК ТаблицаДвиженийСвернутая
		               |		ПО ПартииТоваровОстатки.Номенклатура = ТаблицаДвиженийСвернутая.Номенклатура
		               |			И ПартииТоваровОстатки.Склад = ТаблицаДвиженийСвернутая.Склад
		               |			И ПартииТоваровОстатки.Качество = ТаблицаДвиженийСвернутая.Качество
		               |			И ПартииТоваровОстатки.СтатусПартии = ТаблицаДвиженийСвернутая.СтатусПартии
		               |			И ПартииТоваровОстатки.СтрокаПрихода = ТаблицаДвиженийСвернутая.СтрокаПрихода
		               |			И ПартииТоваровОстатки.Организация = ТаблицаДвиженийСвернутая.Организация
		               |			И ПартииТоваровОстатки.ДокументОснование = ТаблицаДвиженийСвернутая.ДокументОснование
		               |ГДЕ
		               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) > 0";					   

		
 Иначе
					   
		Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
		               |	ТаблицаПоСтрокамПрихода.Номенклатура КАК Номенклатура,
		               |	ТаблицаПоСтрокамПрихода.Склад КАК Склад,
		               |	ТаблицаПоСтрокамПрихода.Качество КАК Качество,
		               |	ТаблицаПоСтрокамПрихода.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаПоСтрокамПрихода.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаПоСтрокамПрихода.Поставщик КАК Поставщик
		               |ПОМЕСТИТЬ ТаблицаПоСтрокамПрихода
		               |ИЗ
		               |	&ТаблицаПоСтрокамПрихода КАК ТаблицаПоСтрокамПрихода
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
		               |	ТаблицаДвижений.Склад КАК Склад,
		               |	ТаблицаДвижений.Качество КАК Качество,
		               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаДвижений.Организация КАК Организация,
		               |	ТаблицаДвижений.ДокументОснование,
		               |	ТаблицаДвижений.Количество КАК Количество,
		               |	ТаблицаДвижений.СуммаРубли КАК СуммаРубли,
		               |	ТаблицаДвижений.СуммаДоллары КАК СуммаДоллары,
		               |	ТаблицаДвижений.СуммаЕвро КАК СуммаЕвро,
		               |	ТаблицаДвижений.СуммаБезНДС КАК СуммаБезНДС
		               |ПОМЕСТИТЬ ТаблицаДвижений
		               |ИЗ
		               |	&ТаблицаДвижений КАК ТаблицаДвижений
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
		               |	ТаблицаДвижений.Склад КАК Склад,
		               |	ТаблицаДвижений.Качество КАК Качество,
		               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаДвижений.Организация КАК Организация,
		               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование,
		               |	СУММА(ТаблицаДвижений.Количество) КАК Количество,
		               |	СУММА(ТаблицаДвижений.СуммаРубли) КАК СуммаРубли,
		               |	СУММА(ТаблицаДвижений.СуммаДоллары) КАК СуммаДоллары,
		               |	СУММА(ТаблицаДвижений.СуммаЕвро) КАК СуммаЕвро,
		               |	СУММА(ТаблицаДвижений.СуммаБезНДС) КАК СуммаБезНДС
		               |ПОМЕСТИТЬ ТаблицаДвиженийСвернутая
		               |ИЗ
		               |	ТаблицаДвижений КАК ТаблицаДвижений
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ТаблицаДвижений.Номенклатура,
		               |	ТаблицаДвижений.Склад,
		               |	ТаблицаДвижений.Качество,
		               |	ТаблицаДвижений.СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода,
		               |	ТаблицаДвижений.Организация,
		               |	ТаблицаДвижений.ДокументОснование
		               |
		               |ИНДЕКСИРОВАТЬ ПО
		               |	Номенклатура,
		               |	Склад,
		               |	Качество,
		               |	СтатусПартии,
		               |	СтрокаПрихода,
		               |	Организация,
		               |	ДокументОснование
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.ДокументОснование,
		               |	ПартииТоваровОстатки.СтрокаПрихода.ТорговаяТочка.Владелец КАК Поставщик,
		               |	ПартииТоваровОстатки.Организация = &Организация КАК ЭтаОрганизация,
		               |	СУММА(ПартииТоваровОстатки.КоличествоОстаток) КАК Количество,
		               |	СУММА(ПартииТоваровОстатки.СуммаРублиОстаток) КАК СуммаРубли,
		               |	СУММА(ПартииТоваровОстатки.СуммаДолларыОстаток) КАК СуммаДоллары,
		               |	СУММА(ПартииТоваровОстатки.СуммаЕвроОстаток) КАК СуммаЕвро,
		               |	СУММА(ПартииТоваровОстатки.СуммаБезНДСОстаток) КАК СуммаБезНДС,
		               |	ПартииТоваровОстатки.Организация.Наименование КАК ОрганизацияНаименование
		               |ПОМЕСТИТЬ втПартии
		               |ИЗ
		               |	РегистрНакопления.ПартииТоваров.Остатки(
		               |			&КонПериода,
		               |			(Номенклатура, Склад, Качество, СтрокаПрихода, СтатусПартии) В
		               |				(ВЫБРАТЬ
		               |					ТаблицаПоСтрокамПрихода.Номенклатура,
		               |					ТаблицаПоСтрокамПрихода.Склад,
		               |					ТаблицаПоСтрокамПрихода.Качество,
		               |					ТаблицаПоСтрокамПрихода.СтрокаПрихода,
		               |					ТаблицаПоСтрокамПрихода.СтатусПартии
		               |				ИЗ
		               |					ТаблицаПоСтрокамПрихода)) КАК ПартииТоваровОстатки
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.СтрокаПрихода.ТорговаяТочка.Владелец,
		               |	ПартииТоваровОстатки.Организация.Наименование,
		               |	ПартииТоваровОстатки.ДокументОснование,
		               |	ПартииТоваровОстатки.Организация = &Организация
		               |
		               |ДЛЯ ИЗМЕНЕНИЯ
		               |	РегистрНакопления.ПартииТоваров.Остатки
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	втПартии.Номенклатура,
		               |	втПартии.Склад,
		               |	втПартии.Качество,
		               |	втПартии.Организация,
		               |	втПартии.СтрокаПрихода,
		               |	втПартии.СтатусПартии,
		               |	втПартии.ДокументОснование,
		               |	втПартии.Поставщик,
		               |	втПартии.ЭтаОрганизация,
		               |	втПартии.Количество,
		               |	втПартии.СуммаРубли,
		               |	втПартии.СуммаДоллары,
		               |	втПартии.СуммаЕвро,
		               |	втПартии.СуммаБезНДС,
		               |	втПартии.ОрганизацияНаименование
		               |ПОМЕСТИТЬ втПартииСвернутые
		               |ИЗ
		               |	втПартии КАК втПартии
		               |ГДЕ
		               |	(втПартии.Номенклатура, втПартии.Склад, втПартии.Качество, втПартии.СтрокаПрихода, втПартии.СтатусПартии, втПартии.Поставщик) В
		               |			(ВЫБРАТЬ
		               |				ТаблицаПоСтрокамПрихода.Номенклатура,
		               |				ТаблицаПоСтрокамПрихода.Склад,
		               |				ТаблицаПоСтрокамПрихода.Качество,
		               |				ТаблицаПоСтрокамПрихода.СтрокаПрихода,
		               |				ТаблицаПоСтрокамПрихода.СтатусПартии,
		               |				ТаблицаПоСтрокамПрихода.Поставщик
		               |			ИЗ
		               |				ТаблицаПоСтрокамПрихода)
		               |	И НЕ втПартии.Организация В (&ЗапрещенныеОрганизации)
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.ДокументОснование,
		               |	ПартииТоваровОстатки.Поставщик КАК Поставщик,
		               |	ПартииТоваровОстатки.Организация = &Организация КАК ЭтаОрганизация,
		               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) КАК Количество,
		               |	ПартииТоваровОстатки.СуммаРубли - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаРубли, 0) КАК СуммаРубли,
		               |	ПартииТоваровОстатки.СуммаДоллары - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаДоллары, 0) КАК СуммаДоллары,
		               |	ПартииТоваровОстатки.СуммаЕвро - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаЕвро, 0) КАК СуммаЕвро,
		               |	ПартииТоваровОстатки.СуммаБезНДС - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаБезНДС, 0) КАК СуммаБезНДС,
		               |	ПартииТоваровОстатки.ОрганизацияНаименование КАК ОрганизацияНаименование
		               |ИЗ
		               |	втПартииСвернутые КАК ПартииТоваровОстатки
		               |		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаДвиженийСвернутая КАК ТаблицаДвиженийСвернутая
		               |		ПО ПартииТоваровОстатки.Номенклатура = ТаблицаДвиженийСвернутая.Номенклатура
		               |			И ПартииТоваровОстатки.Склад = ТаблицаДвиженийСвернутая.Склад
		               |			И ПартииТоваровОстатки.Качество = ТаблицаДвиженийСвернутая.Качество
		               |			И ПартииТоваровОстатки.СтатусПартии = ТаблицаДвиженийСвернутая.СтатусПартии
		               |			И ПартииТоваровОстатки.СтрокаПрихода = ТаблицаДвиженийСвернутая.СтрокаПрихода
		               |			И ПартииТоваровОстатки.Организация = ТаблицаДвиженийСвернутая.Организация
		               |			И ПартииТоваровОстатки.ДокументОснование = ТаблицаДвиженийСвернутая.ДокументОснование
		               |ГДЕ
		               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) > 0
		               |
		               |УПОРЯДОЧИТЬ ПО
		               |	ЭтаОрганизация УБЫВ,
		               |	ОрганизацияНаименование";
		Организация = ТаблицаПоСтрокамПрихода.Получить(0).Организация;			   
		Запрос.УстановитьПараметр("Организация", Организация);
		Запрос.УстановитьПараметр("ЗапрещенныеОрганизации", ЗапрещенныеОрганизацииПродавцы(Организация, Реквизиты.Дата));
		ОтсортированаПоОрганизации = Организация;
	КонецЕсли;
	
	ОстаткиПоПартиям = Запрос.Выполнить().Выгрузить();	
	ОстаткиПоПартиям.Индексы.Добавить(КолонкиРаспределения);
	
	ПередаваемыеПараметры = Новый Структура;
	ПередаваемыеПараметры.Вставить("КолонкиРаспределения", КолонкиРаспределения);
	ПередаваемыеПараметры.Вставить("ЗаполняемыеРеквизиты", ЗаполняемыеРеквизиты);
	ПередаваемыеПараметры.Вставить("КонтрольНаличияПартий", КонтрольНаличияПартий);
	ПередаваемыеПараметры.Вставить("ДатаДокумента", Реквизиты.Дата);	
	ПередаваемыеПараметры.Вставить("СписыватьТолькоПоСвоейОрганизации", СтратегияПогашенияПоОрганизации.СписыватьТолькоПоСвоейОрганизации);
	ПередаваемыеПараметры.Вставить("СтратегияПогашенияПоОрганизации", СтратегияПогашенияПоОрганизации);
	
	ПогашениеПартийТоваровНовоеФрагмент(вхСсылкаНаДокумент, ТаблицаПоСтрокамПрихода, ПередаваемыеПараметры, ОстаткиПоПартиям, ТаблицаДвижений, вхОтказ, ТаблицаПоFIFO, ОтсортированаПоОрганизации, ПараметрыСписания);
	
КонецПроцедуры

Процедура СписатьПоСтрокамПрихода(вхСсылкаНаДокумент, ТаблицаДвижений, ТаблицаПоСтрокамПрихода, ТаблицаПоFIFO, СтратегияПогашенияПоОрганизации, ЗаполняемыеРеквизиты, КонтрольНаличияПартий, вхОтказ, ПараметрыСписания = Неопределено)
	
	лКлючАлгоритма = "ОбщийМодуль_ПроведениеДокументовКлиентСервер_СписатьПоСтрокамПрихода";
	лЗамена = АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		Выполнить(лЗамена);
	КонецЕсли;
	
	ОтсортированаПоОрганизации = Неопределено; 
	ОперативноеПроведение = Неопределено;
	
	Реквизиты = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(вхСсылкаНаДокумент, "Дата,Организация");
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ТаблицаДвижений", ТаблицаДвижений);			   
	Запрос.УстановитьПараметр("ТаблицаПоСтрокамПрихода", ТаблицаПоСтрокамПрихода);
	
	ПараметрыСписания.Свойство("ОперативноеПроведение", ОперативноеПроведение);
	Если ОперативноеПроведение = Неопределено Тогда 
		ОперативноеПроведение = Ложь;
	КонецЕсли;
	
	Запрос.УстановитьПараметр("КонПериода", ?(ОперативноеПроведение, Неопределено, вхСсылкаНаДокумент.МоментВремени()));
	
	КолонкиРаспределения = "Номенклатура,Склад,Качество,СтрокаПрихода,СтатусПартии"; 
	
	Если СтратегияПогашенияПоОрганизации.ИспользуютсяМФП Тогда
		
		Если СтратегияПогашенияПоОрганизации.ПараметрыПолитикиМФП.УчитыватьОрганизациюТаблицыСписания Тогда
			КолонкиРаспределения = КолонкиРаспределения + ",Организация"; 
		КонецЕсли;
		
		Запрос.УстановитьПараметр("ТаблицаПриоритетаОрганизаций", СтратегияПогашенияПоОрганизации.ПараметрыПолитикиМФП.ОрганизацииДляЗакупки);
		
				Запрос.Текст = "ВЫБРАТЬ
				               |	ТаблицаПриоритетаОрганизаций.Приоритет КАК Приоритет,
				               |	ТаблицаПриоритетаОрганизаций.Организация КАК Организация
				               |ПОМЕСТИТЬ ТаблицаПриоритетаОрганизаций
				               |ИЗ
				               |	&ТаблицаПриоритетаОрганизаций КАК ТаблицаПриоритетаОрганизаций
				               |;
				               |
				               |////////////////////////////////////////////////////////////////////////////////
				               |ВЫБРАТЬ РАЗЛИЧНЫЕ
				               |	ТаблицаПоСтрокамПрихода.Номенклатура КАК Номенклатура,
				               |	ТаблицаПоСтрокамПрихода.Склад КАК Склад,
				               |	ТаблицаПоСтрокамПрихода.Качество КАК Качество,
				               |	ТаблицаПоСтрокамПрихода.СтатусПартии КАК СтатусПартии,
				               |	ТаблицаПоСтрокамПрихода.СтрокаПрихода КАК СтрокаПрихода
				               |ПОМЕСТИТЬ ТаблицаПоСтрокамПрихода
				               |ИЗ
				               |	&ТаблицаПоСтрокамПрихода КАК ТаблицаПоСтрокамПрихода
				               |;
				               |
				               |////////////////////////////////////////////////////////////////////////////////
				               |ВЫБРАТЬ
				               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
				               |	ТаблицаДвижений.Склад КАК Склад,
				               |	ТаблицаДвижений.Качество КАК Качество,
				               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
				               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
				               |	ТаблицаДвижений.Организация КАК Организация,
				               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование,
				               |	ТаблицаДвижений.Количество КАК Количество,
				               |	ТаблицаДвижений.СуммаРубли КАК СуммаРубли,
				               |	ТаблицаДвижений.СуммаДоллары КАК СуммаДоллары,
				               |	ТаблицаДвижений.СуммаЕвро КАК СуммаЕвро,
				               |	ТаблицаДвижений.СуммаБезНДС КАК СуммаБезНДС
				               |ПОМЕСТИТЬ ТаблицаДвижений
				               |ИЗ
				               |	&ТаблицаДвижений КАК ТаблицаДвижений
				               |;
				               |
				               |////////////////////////////////////////////////////////////////////////////////
				               |ВЫБРАТЬ
				               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
				               |	ТаблицаДвижений.Склад КАК Склад,
				               |	ТаблицаДвижений.Качество КАК Качество,
				               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
				               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
				               |	ТаблицаДвижений.Организация КАК Организация,
				               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование,
				               |	СУММА(ТаблицаДвижений.Количество) КАК Количество,
				               |	СУММА(ТаблицаДвижений.СуммаРубли) КАК СуммаРубли,
				               |	СУММА(ТаблицаДвижений.СуммаДоллары) КАК СуммаДоллары,
				               |	СУММА(ТаблицаДвижений.СуммаЕвро) КАК СуммаЕвро,
				               |	СУММА(ТаблицаДвижений.СуммаБезНДС) КАК СуммаБезНДС
				               |ПОМЕСТИТЬ ТаблицаДвиженийСвернутая
				               |ИЗ
				               |	ТаблицаДвижений КАК ТаблицаДвижений
				               |
				               |СГРУППИРОВАТЬ ПО
				               |	ТаблицаДвижений.Номенклатура,
				               |	ТаблицаДвижений.Склад,
				               |	ТаблицаДвижений.Качество,
				               |	ТаблицаДвижений.СтатусПартии,
				               |	ТаблицаДвижений.СтрокаПрихода,
				               |	ТаблицаДвижений.Организация,
				               |	ТаблицаДвижений.ДокументОснование
				               |
				               |ИНДЕКСИРОВАТЬ ПО
				               |	Номенклатура,
				               |	Склад,
				               |	Качество,
				               |	СтатусПартии,
				               |	СтрокаПрихода,
				               |	Организация,
				               |	ДокументОснование
				               |;
				               |
				               |////////////////////////////////////////////////////////////////////////////////
				               |ВЫБРАТЬ
				               |	ПартииТоваровОстатки.Номенклатура,
				               |	ПартииТоваровОстатки.Склад,
				               |	ПартииТоваровОстатки.Качество,
				               |	ПартииТоваровОстатки.Организация,
				               |	ПартииТоваровОстатки.СтрокаПрихода,
				               |	ПартииТоваровОстатки.СтатусПартии,
				               |	ПартииТоваровОстатки.ДокументОснование,
				               |	ПартииТоваровОстатки.СтрокаПрихода.Дата,
				               |	СУММА(ПартииТоваровОстатки.КоличествоОстаток) КАК Количество,
				               |	СУММА(ПартииТоваровОстатки.СуммаРублиОстаток) КАК СуммаРубли,
				               |	СУММА(ПартииТоваровОстатки.СуммаДолларыОстаток) КАК СуммаДоллары,
				               |	СУММА(ПартииТоваровОстатки.СуммаЕвроОстаток) КАК СуммаЕвро,
				               |	СУММА(ПартииТоваровОстатки.СуммаБезНДСОстаток) КАК СуммаБезНДС,
				               |	ПартииТоваровОстатки.Организация.Наименование КАК ОрганизацияНаименование
				               |ПОМЕСТИТЬ втПартииСвернутые
				               |ИЗ
				               |	РегистрНакопления.ПартииТоваров.Остатки(
				               |			&КонПериода,
				               |			(Номенклатура, Склад, Качество, СтрокаПрихода, СтатусПартии) В
				               |					(ВЫБРАТЬ
				               |						ТаблицаПоСтрокамПрихода.Номенклатура,
				               |						ТаблицаПоСтрокамПрихода.Склад,
				               |						ТаблицаПоСтрокамПрихода.Качество,
				               |						ТаблицаПоСтрокамПрихода.СтрокаПрихода,
				               |						ТаблицаПоСтрокамПрихода.СтатусПартии
				               |					ИЗ
				               |						ТаблицаПоСтрокамПрихода)
				               |				И Организация В
				               |					(ВЫБРАТЬ
				               |						ТаблицаПриоритетаОрганизаций.Организация
				               |					ИЗ
				               |						ТаблицаПриоритетаОрганизаций)) КАК ПартииТоваровОстатки
				               |
				               |СГРУППИРОВАТЬ ПО
				               |	ПартииТоваровОстатки.Номенклатура,
				               |	ПартииТоваровОстатки.Склад,
				               |	ПартииТоваровОстатки.Качество,
				               |	ПартииТоваровОстатки.Организация,
				               |	ПартииТоваровОстатки.СтрокаПрихода,
				               |	ПартииТоваровОстатки.СтатусПартии,
				               |	ПартииТоваровОстатки.Организация.Наименование,
				               |	ПартииТоваровОстатки.СтрокаПрихода.Дата,
				               |	ПартииТоваровОстатки.ДокументОснование
				               |
				               |ДЛЯ ИЗМЕНЕНИЯ
				               |	РегистрНакопления.ПартииТоваров.Остатки
				               |;
				               |
				               |////////////////////////////////////////////////////////////////////////////////
				               |ВЫБРАТЬ
				               |	ПартииТоваровОстатки.Номенклатура,
				               |	ПартииТоваровОстатки.Склад,
				               |	ПартииТоваровОстатки.Качество,
				               |	ПартииТоваровОстатки.Организация,
				               |	ПартииТоваровОстатки.СтрокаПрихода,
				               |	ПартииТоваровОстатки.СтатусПартии,
				               |	ПартииТоваровОстатки.ДокументОснование,
				               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) КАК Количество,
				               |	ПартииТоваровОстатки.СуммаРубли - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаРубли, 0) КАК СуммаРубли,
				               |	ПартииТоваровОстатки.СуммаДоллары - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаДоллары, 0) КАК СуммаДоллары,
				               |	ПартииТоваровОстатки.СуммаЕвро - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаЕвро, 0) КАК СуммаЕвро,
				               |	ПартииТоваровОстатки.СуммаБезНДС - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаБезНДС, 0) КАК СуммаБезНДС,
				               |	ПартииТоваровОстатки.ОрганизацияНаименование КАК ОрганизацияНаименование
				               |ИЗ
				               |	втПартииСвернутые КАК ПартииТоваровОстатки
				               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаПриоритетаОрганизаций КАК ТаблицаПриоритетаОрганизаций
				               |		ПО (ТаблицаПриоритетаОрганизаций.Организация = ПартииТоваровОстатки.Организация)
				               |		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаДвиженийСвернутая КАК ТаблицаДвиженийСвернутая
				               |		ПО ПартииТоваровОстатки.Номенклатура = ТаблицаДвиженийСвернутая.Номенклатура
				               |			И ПартииТоваровОстатки.Склад = ТаблицаДвиженийСвернутая.Склад
				               |			И ПартииТоваровОстатки.Качество = ТаблицаДвиженийСвернутая.Качество
				               |			И ПартииТоваровОстатки.СтатусПартии = ТаблицаДвиженийСвернутая.СтатусПартии
				               |			И ПартииТоваровОстатки.СтрокаПрихода = ТаблицаДвиженийСвернутая.СтрокаПрихода
				               |			И ПартииТоваровОстатки.Организация = ТаблицаДвиженийСвернутая.Организация
				               |			И ПартииТоваровОстатки.ДокументОснование = ТаблицаДвиженийСвернутая.ДокументОснование
				               |ГДЕ
				               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) > 0
				               |
				               |УПОРЯДОЧИТЬ ПО
				               |	ТаблицаПриоритетаОрганизаций.Приоритет,
				               |	ПартииТоваровОстатки.СтрокаПриходаДата,
				               |	ПартииТоваровОстатки.ОрганизацияНаименование";
							   
		ИначеЕсли СтратегияПогашенияПоОрганизации.СписыватьТолькоПоСвоейОрганизации Тогда 
		КолонкиРаспределения = КолонкиРаспределения + ",Организация"; 
		
		Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
		               |	ТаблицаПоСтрокамПрихода.Номенклатура КАК Номенклатура,
		               |	ТаблицаПоСтрокамПрихода.Склад КАК Склад,
		               |	ТаблицаПоСтрокамПрихода.Качество КАК Качество,
		               |	ТаблицаПоСтрокамПрихода.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаПоСтрокамПрихода.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаПоСтрокамПрихода.Организация КАК Организация
		               |ПОМЕСТИТЬ ТаблицаПоСтрокамПрихода
		               |ИЗ
		               |	&ТаблицаПоСтрокамПрихода КАК ТаблицаПоСтрокамПрихода
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
		               |	ТаблицаДвижений.Склад КАК Склад,
		               |	ТаблицаДвижений.Качество КАК Качество,
		               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаДвижений.Организация КАК Организация,
		               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование,
		               |	ТаблицаДвижений.Количество КАК Количество,
		               |	ТаблицаДвижений.СуммаРубли КАК СуммаРубли,
		               |	ТаблицаДвижений.СуммаДоллары КАК СуммаДоллары,
		               |	ТаблицаДвижений.СуммаЕвро КАК СуммаЕвро,
		               |	ТаблицаДвижений.СуммаБезНДС КАК СуммаБезНДС
		               |ПОМЕСТИТЬ ТаблицаДвижений
		               |ИЗ
		               |	&ТаблицаДвижений КАК ТаблицаДвижений
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
		               |	ТаблицаДвижений.Склад КАК Склад,
		               |	ТаблицаДвижений.Качество КАК Качество,
		               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаДвижений.Организация КАК Организация,
		               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование,
		               |	СУММА(ТаблицаДвижений.Количество) КАК Количество,
		               |	СУММА(ТаблицаДвижений.СуммаРубли) КАК СуммаРубли,
		               |	СУММА(ТаблицаДвижений.СуммаДоллары) КАК СуммаДоллары,
		               |	СУММА(ТаблицаДвижений.СуммаЕвро) КАК СуммаЕвро,
		               |	СУММА(ТаблицаДвижений.СуммаБезНДС) КАК СуммаБезНДС
		               |ПОМЕСТИТЬ ТаблицаДвиженийСвернутая
		               |ИЗ
		               |	ТаблицаДвижений КАК ТаблицаДвижений
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ТаблицаДвижений.Номенклатура,
		               |	ТаблицаДвижений.Склад,
		               |	ТаблицаДвижений.Качество,
		               |	ТаблицаДвижений.СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода,
		               |	ТаблицаДвижений.Организация,
		               |	ТаблицаДвижений.ДокументОснование
		               |
		               |ИНДЕКСИРОВАТЬ ПО
		               |	Номенклатура,
		               |	Склад,
		               |	Качество,
		               |	СтатусПартии,
		               |	СтрокаПрихода,
		               |	Организация,
		               |	ДокументОснование
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.ДокументОснование,
		               |	ПартииТоваровОстатки.КоличествоОстаток КАК Количество,
		               |	ПартииТоваровОстатки.СуммаРублиОстаток КАК СуммаРубли,
		               |	ПартииТоваровОстатки.СуммаДолларыОстаток КАК СуммаДоллары,
		               |	ПартииТоваровОстатки.СуммаЕвроОстаток КАК СуммаЕвро,
		               |	ПартииТоваровОстатки.СуммаБезНДСОстаток КАК СуммаБезНДС
		               |ПОМЕСТИТЬ втПартииСвернутые
		               |ИЗ
		               |	РегистрНакопления.ПартииТоваров.Остатки(
		               |			&КонПериода,
		               |			(Номенклатура, Склад, Качество, СтрокаПрихода, СтатусПартии, Организация) В
		               |				(ВЫБРАТЬ
		               |					ТаблицаПоСтрокамПрихода.Номенклатура,
		               |					ТаблицаПоСтрокамПрихода.Склад,
		               |					ТаблицаПоСтрокамПрихода.Качество,
		               |					ТаблицаПоСтрокамПрихода.СтрокаПрихода,
		               |					ТаблицаПоСтрокамПрихода.СтатусПартии,
		               |					ТаблицаПоСтрокамПрихода.Организация
		               |				ИЗ
		               |					ТаблицаПоСтрокамПрихода)) КАК ПартииТоваровОстатки
		               |
		               |ДЛЯ ИЗМЕНЕНИЯ
		               |	РегистрНакопления.ПартииТоваров.Остатки
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.ДокументОснование,
		               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) КАК Количество,
		               |	ПартииТоваровОстатки.СуммаРубли - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаРубли, 0) КАК СуммаРубли,
		               |	ПартииТоваровОстатки.СуммаДоллары - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаДоллары, 0) КАК СуммаДоллары,
		               |	ПартииТоваровОстатки.СуммаЕвро - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаЕвро, 0) КАК СуммаЕвро,
		               |	ПартииТоваровОстатки.СуммаБезНДС - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаБезНДС, 0) КАК СуммаБезНДС
		               |ИЗ
		               |	втПартииСвернутые КАК ПартииТоваровОстатки
		               |		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаДвиженийСвернутая КАК ТаблицаДвиженийСвернутая
		               |		ПО ПартииТоваровОстатки.Номенклатура = ТаблицаДвиженийСвернутая.Номенклатура
		               |			И ПартииТоваровОстатки.Склад = ТаблицаДвиженийСвернутая.Склад
		               |			И ПартииТоваровОстатки.Качество = ТаблицаДвиженийСвернутая.Качество
		               |			И ПартииТоваровОстатки.СтатусПартии = ТаблицаДвиженийСвернутая.СтатусПартии
		               |			И ПартииТоваровОстатки.СтрокаПрихода = ТаблицаДвиженийСвернутая.СтрокаПрихода
		               |			И ПартииТоваровОстатки.Организация = ТаблицаДвиженийСвернутая.Организация
		               |			И ПартииТоваровОстатки.ДокументОснование = ТаблицаДвиженийСвернутая.ДокументОснование
		               |ГДЕ
		               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) > 0";
 Иначе
					   
		Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
		               |	ТаблицаПоСтрокамПрихода.Номенклатура КАК Номенклатура,
		               |	ТаблицаПоСтрокамПрихода.Склад КАК Склад,
		               |	ТаблицаПоСтрокамПрихода.Качество КАК Качество,
		               |	ТаблицаПоСтрокамПрихода.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаПоСтрокамПрихода.СтрокаПрихода КАК СтрокаПрихода
		               |ПОМЕСТИТЬ ТаблицаПоСтрокамПрихода
		               |ИЗ
		               |	&ТаблицаПоСтрокамПрихода КАК ТаблицаПоСтрокамПрихода
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
		               |	ТаблицаДвижений.Склад КАК Склад,
		               |	ТаблицаДвижений.Качество КАК Качество,
		               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаДвижений.Организация КАК Организация,
		               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование,
		               |	ТаблицаДвижений.Количество КАК Количество,
		               |	ТаблицаДвижений.СуммаРубли КАК СуммаРубли,
		               |	ТаблицаДвижений.СуммаДоллары КАК СуммаДоллары,
		               |	ТаблицаДвижений.СуммаЕвро КАК СуммаЕвро,
		               |	ТаблицаДвижений.СуммаБезНДС КАК СуммаБезНДС
		               |ПОМЕСТИТЬ ТаблицаДвижений
		               |ИЗ
		               |	&ТаблицаДвижений КАК ТаблицаДвижений
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
		               |	ТаблицаДвижений.Склад КАК Склад,
		               |	ТаблицаДвижений.Качество КАК Качество,
		               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаДвижений.Организация КАК Организация,
		               |	СУММА(ТаблицаДвижений.Количество) КАК Количество,
		               |	СУММА(ТаблицаДвижений.СуммаРубли) КАК СуммаРубли,
		               |	СУММА(ТаблицаДвижений.СуммаДоллары) КАК СуммаДоллары,
		               |	СУММА(ТаблицаДвижений.СуммаЕвро) КАК СуммаЕвро,
		               |	СУММА(ТаблицаДвижений.СуммаБезНДС) КАК СуммаБезНДС,
		               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование
		               |ПОМЕСТИТЬ ТаблицаДвиженийСвернутая
		               |ИЗ
		               |	ТаблицаДвижений КАК ТаблицаДвижений
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ТаблицаДвижений.Номенклатура,
		               |	ТаблицаДвижений.Склад,
		               |	ТаблицаДвижений.Качество,
		               |	ТаблицаДвижений.СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода,
		               |	ТаблицаДвижений.Организация,
		               |	ТаблицаДвижений.ДокументОснование
		               |
		               |ИНДЕКСИРОВАТЬ ПО
		               |	Номенклатура,
		               |	Склад,
		               |	Качество,
		               |	СтатусПартии,
		               |	СтрокаПрихода,
		               |	Организация,
		               |	ДокументОснование
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.ДокументОснование,
		               |	ПартииТоваровОстатки.Организация = &Организация КАК ЭтаОрганизация,
		               |	СУММА(ПартииТоваровОстатки.КоличествоОстаток) КАК Количество,
		               |	СУММА(ПартииТоваровОстатки.СуммаРублиОстаток) КАК СуммаРубли,
		               |	СУММА(ПартииТоваровОстатки.СуммаДолларыОстаток) КАК СуммаДоллары,
		               |	СУММА(ПартииТоваровОстатки.СуммаЕвроОстаток) КАК СуммаЕвро,
		               |	СУММА(ПартииТоваровОстатки.СуммаБезНДСОстаток) КАК СуммаБезНДС,
		               |	ПартииТоваровОстатки.Организация.Наименование КАК ОрганизацияНаименование
		               |ПОМЕСТИТЬ втПартииСвернутые
		               |ИЗ
		               |	РегистрНакопления.ПартииТоваров.Остатки(
		               |			&КонПериода,
		               |			(Номенклатура, Склад, Качество, СтрокаПрихода, СтатусПартии) В
		               |					(ВЫБРАТЬ
		               |						ТаблицаПоСтрокамПрихода.Номенклатура,
		               |						ТаблицаПоСтрокамПрихода.Склад,
		               |						ТаблицаПоСтрокамПрихода.Качество,
		               |						ТаблицаПоСтрокамПрихода.СтрокаПрихода,
		               |						ТаблицаПоСтрокамПрихода.СтатусПартии
		               |					ИЗ
		               |						ТаблицаПоСтрокамПрихода)
		               |				И НЕ Организация В (&ЗапрещенныеОрганизации)) КАК ПартииТоваровОстатки
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.Организация.Наименование,
		               |	ПартииТоваровОстатки.Организация = &Организация,
		               |	ПартииТоваровОстатки.ДокументОснование
		               |
		               |ДЛЯ ИЗМЕНЕНИЯ
		               |	РегистрНакопления.ПартииТоваров.Остатки
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.ДокументОснование,
		               |	ПартииТоваровОстатки.ЭтаОрганизация КАК ЭтаОрганизация,
		               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) КАК Количество,
		               |	ПартииТоваровОстатки.СуммаРубли - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаРубли, 0) КАК СуммаРубли,
		               |	ПартииТоваровОстатки.СуммаДоллары - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаДоллары, 0) КАК СуммаДоллары,
		               |	ПартииТоваровОстатки.СуммаЕвро - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаЕвро, 0) КАК СуммаЕвро,
		               |	ПартииТоваровОстатки.СуммаБезНДС - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаБезНДС, 0) КАК СуммаБезНДС,
		               |	ПартииТоваровОстатки.ОрганизацияНаименование КАК ОрганизацияНаименование
		               |ИЗ
		               |	втПартииСвернутые КАК ПартииТоваровОстатки
		               |		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаДвиженийСвернутая КАК ТаблицаДвиженийСвернутая
		               |		ПО ПартииТоваровОстатки.Номенклатура = ТаблицаДвиженийСвернутая.Номенклатура
		               |			И ПартииТоваровОстатки.Склад = ТаблицаДвиженийСвернутая.Склад
		               |			И ПартииТоваровОстатки.Качество = ТаблицаДвиженийСвернутая.Качество
		               |			И ПартииТоваровОстатки.СтатусПартии = ТаблицаДвиженийСвернутая.СтатусПартии
		               |			И ПартииТоваровОстатки.СтрокаПрихода = ТаблицаДвиженийСвернутая.СтрокаПрихода
		               |			И ПартииТоваровОстатки.Организация = ТаблицаДвиженийСвернутая.Организация
		               |			И ПартииТоваровОстатки.ДокументОснование = ТаблицаДвиженийСвернутая.ДокументОснование
		               |ГДЕ
		               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) > 0
		               |
		               |УПОРЯДОЧИТЬ ПО
		               |	ЭтаОрганизация УБЫВ,
		               |	ОрганизацияНаименование";
		Организация = ТаблицаПоСтрокамПрихода.Получить(0).Организация;			   
		Запрос.УстановитьПараметр("Организация", Организация);
		Запрос.УстановитьПараметр("ЗапрещенныеОрганизации", ЗапрещенныеОрганизацииПродавцы(Организация, Реквизиты.Дата));
		ОтсортированаПоОрганизации = Организация;
	КонецЕсли;
	
	ОстаткиПоПартиям = Запрос.Выполнить().Выгрузить();	
	ОстаткиПоПартиям.Индексы.Добавить(КолонкиРаспределения);
	
	ПередаваемыеПараметры = Новый Структура;
	ПередаваемыеПараметры.Вставить("КолонкиРаспределения", КолонкиРаспределения);
	ПередаваемыеПараметры.Вставить("ЗаполняемыеРеквизиты", ЗаполняемыеРеквизиты);
	ПередаваемыеПараметры.Вставить("КонтрольНаличияПартий", КонтрольНаличияПартий);
	ПередаваемыеПараметры.Вставить("ДатаДокумента", Реквизиты.Дата);	
	ПередаваемыеПараметры.Вставить("СписыватьТолькоПоСвоейОрганизации", СтратегияПогашенияПоОрганизации.СписыватьТолькоПоСвоейОрганизации);
	ПередаваемыеПараметры.Вставить("СтратегияПогашенияПоОрганизации", СтратегияПогашенияПоОрганизации);
	
	ПогашениеПартийТоваровНовоеФрагмент(вхСсылкаНаДокумент, ТаблицаПоСтрокамПрихода, ПередаваемыеПараметры, ОстаткиПоПартиям, ТаблицаДвижений, вхОтказ, ТаблицаПоFIFO, ОтсортированаПоОрганизации, ПараметрыСписания);
	
КонецПроцедуры

Процедура СписатьПоFIFOПоПоставщику(вхСсылкаНаДокумент, ТаблицаДвижений, ТаблицаПоFIFO, СтратегияПогашенияПоОрганизации, ЗаполняемыеРеквизиты, КонтрольНаличияПартий, вхОтказ, ПараметрыСписания = Неопределено, ТаблицаПоFIFOБезОтбораПоПоставщику = Неопределено)
	
	лКлючАлгоритма = "ОбщийМодуль_ПроведениеДокументовКлиентСервер_СписатьПоFIFOПоПоставщику";
	лЗамена = АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		Выполнить(лЗамена);
	КонецЕсли;
	
	ОтсортированаПоОрганизации = Неопределено; 
	ОперативноеПроведение = Неопределено;
	
	Реквизиты = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(вхСсылкаНаДокумент, "Дата,Организация");
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ТаблицаПоFIFO", ТаблицаПоFIFO);
	Запрос.УстановитьПараметр("ТаблицаДвижений", ТаблицаДвижений);
	
	ПараметрыСписания.Свойство("ОперативноеПроведение", ОперативноеПроведение);
	Если ОперативноеПроведение = Неопределено Тогда 
		ОперативноеПроведение = Ложь;
	КонецЕсли;
	
	Запрос.УстановитьПараметр("КонПериода", ?(ОперативноеПроведение, Неопределено, вхСсылкаНаДокумент.МоментВремени()));
	
	КолонкиРаспределения = "Номенклатура,Склад,Качество,СтатусПартии,Поставщик";
	
	Если СтратегияПогашенияПоОрганизации.ИспользуютсяМФП Тогда
		
		Если СтратегияПогашенияПоОрганизации.ПараметрыПолитикиМФП.УчитыватьОрганизациюТаблицыСписания Тогда
			КолонкиРаспределения = КолонкиРаспределения + ",Организация"; 
		КонецЕсли;
		
		Запрос.УстановитьПараметр("ТаблицаПриоритетаОрганизаций", СтратегияПогашенияПоОрганизации.ПараметрыПолитикиМФП.ОрганизацииДляЗакупки);
		
		Запрос.Текст = "ВЫБРАТЬ
		               |	ТаблицаПриоритетаОрганизаций.Приоритет КАК Приоритет,
		               |	ТаблицаПриоритетаОрганизаций.Организация КАК Организация
		               |ПОМЕСТИТЬ ТаблицаПриоритетаОрганизаций
		               |ИЗ
		               |	&ТаблицаПриоритетаОрганизаций КАК ТаблицаПриоритетаОрганизаций
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ РАЗЛИЧНЫЕ
		               |	ТаблицаПоFIFO.Номенклатура КАК Номенклатура,
		               |	ТаблицаПоFIFO.Склад КАК Склад,
		               |	ТаблицаПоFIFO.Качество КАК Качество,
		               |	ТаблицаПоFIFO.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаПоFIFO.Поставщик КАК Поставщик,
		               |	ТаблицаПоFIFO.ДокументОснование
		               |ПОМЕСТИТЬ ТаблицаПоFIFO
		               |ИЗ
		               |	&ТаблицаПоFIFO КАК ТаблицаПоFIFO
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
		               |	ТаблицаДвижений.Склад КАК Склад,
		               |	ТаблицаДвижений.Качество КАК Качество,
		               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаДвижений.Организация КАК Организация,
		               |	ТаблицаДвижений.Количество КАК Количество,
		               |	ТаблицаДвижений.СуммаРубли КАК СуммаРубли,
		               |	ТаблицаДвижений.СуммаДоллары КАК СуммаДоллары,
		               |	ТаблицаДвижений.СуммаЕвро КАК СуммаЕвро,
		               |	ТаблицаДвижений.СуммаБезНДС КАК СуммаБезНДС,
		               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование
		               |ПОМЕСТИТЬ ТаблицаДвижений
		               |ИЗ
		               |	&ТаблицаДвижений КАК ТаблицаДвижений
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
		               |	ТаблицаДвижений.Склад КАК Склад,
		               |	ТаблицаДвижений.Качество КАК Качество,
		               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаДвижений.Организация КАК Организация,
		               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование,
		               |	СУММА(ТаблицаДвижений.Количество) КАК Количество,
		               |	СУММА(ТаблицаДвижений.СуммаРубли) КАК СуммаРубли,
		               |	СУММА(ТаблицаДвижений.СуммаДоллары) КАК СуммаДоллары,
		               |	СУММА(ТаблицаДвижений.СуммаЕвро) КАК СуммаЕвро,
		               |	СУММА(ТаблицаДвижений.СуммаБезНДС) КАК СуммаБезНДС
		               |ПОМЕСТИТЬ ТаблицаДвиженийСвернутая
		               |ИЗ
		               |	ТаблицаДвижений КАК ТаблицаДвижений
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ТаблицаДвижений.Номенклатура,
		               |	ТаблицаДвижений.Склад,
		               |	ТаблицаДвижений.Качество,
		               |	ТаблицаДвижений.СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода,
		               |	ТаблицаДвижений.Организация,
		               |	ТаблицаДвижений.ДокументОснование
		               |
		               |ИНДЕКСИРОВАТЬ ПО
		               |	Номенклатура,
		               |	Склад,
		               |	Качество,
		               |	СтатусПартии,
		               |	СтрокаПрихода,
		               |	Организация,
		               |	ДокументОснование
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.ДокументОснование КАК ДокументОснование,
		               |	ПартииТоваровОстатки.СтрокаПрихода.ТорговаяТочка.Владелец КАК Поставщик,
		               |	СУММА(ПартииТоваровОстатки.КоличествоОстаток) КАК Количество,
		               |	СУММА(ПартииТоваровОстатки.СуммаРублиОстаток) КАК СуммаРубли,
		               |	СУММА(ПартииТоваровОстатки.СуммаДолларыОстаток) КАК СуммаДоллары,
		               |	СУММА(ПартииТоваровОстатки.СуммаЕвроОстаток) КАК СуммаЕвро,
		               |	СУММА(ПартииТоваровОстатки.СуммаБезНДСОстаток) КАК СуммаБезНДС,
		               |	ПартииТоваровОстатки.СтрокаПрихода.Дата КАК СтрокаПриходаДата,
		               |	ПартииТоваровОстатки.Организация.Наименование КАК ОрганизацияНаименование
		               |ПОМЕСТИТЬ втПартии
		               |ИЗ
		               |	РегистрНакопления.ПартииТоваров.Остатки(
		               |			&КонПериода,
		               |			(Номенклатура, Склад, Качество, СтатусПартии) В
		               |				(ВЫБРАТЬ
		               |					ТаблицаПоFIFO.Номенклатура,
		               |					ТаблицаПоFIFO.Склад,
		               |					ТаблицаПоFIFO.Качество,
		               |					ТаблицаПоFIFO.СтатусПартии
		               |				ИЗ
		               |					ТаблицаПоFIFO)) КАК ПартииТоваровОстатки
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.СтрокаПрихода.ТорговаяТочка.Владелец,
		               |	ПартииТоваровОстатки.СтрокаПрихода.Дата,
		               |	ПартииТоваровОстатки.Организация.Наименование,
		               |	ПартииТоваровОстатки.ДокументОснование
		               |
		               |ДЛЯ ИЗМЕНЕНИЯ
		               |	РегистрНакопления.ПартииТоваров.Остатки
		               |;
						//	25.02.2019 Валиахметов XX-1920
						//Изменение алгоритма проведения перемещения
					   |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	втПартии.Номенклатура,
		               |	втПартии.Склад,
		               |	втПартии.Качество,
		               |	втПартии.Организация,
		               |	втПартии.СтрокаПрихода,
		               |	втПартии.СтатусПартии,
		               |	втПартии.Поставщик,
		               |	втПартии.Количество,
		               |	втПартии.СуммаРубли,
		               |	втПартии.СуммаДоллары,
		               |	втПартии.СуммаЕвро,
		               |	втПартии.СуммаБезНДС,
		               |	втПартии.СтрокаПриходаДата,
		               |	втПартии.ОрганизацияНаименование,
		               |	втПартии.ДокументОснование,
		               |	ЛОЖЬ КАК ПустойДокументОснование
		               |ПОМЕСТИТЬ втПартииСвернутые
		               |ИЗ
		               |	втПартии КАК втПартии
		               |ГДЕ
		               |	втПартии.Организация В
		               |			(ВЫБРАТЬ
		               |				ТаблицаПриоритетаОрганизаций.Организация
		               |			ИЗ
		               |				ТаблицаПриоритетаОрганизаций)
		               |	И (втПартии.Номенклатура, втПартии.Склад, втПартии.Качество, втПартии.СтатусПартии, втПартии.Поставщик, втПартии.ДокументОснование) В
		               |			(ВЫБРАТЬ
		               |				ТаблицаПоFIFO.Номенклатура,
		               |				ТаблицаПоFIFO.Склад,
		               |				ТаблицаПоFIFO.Качество,
		               |				ТаблицаПоFIFO.СтатусПартии,
		               |				ТаблицаПоFIFO.Поставщик,
		               |				ТаблицаПоFIFO.ДокументОснование
		               |			ИЗ
		               |				ТаблицаПоFIFO
		               |			ГДЕ
		               |				ТаблицаПоFIFO.ДокументОснование <> НЕОПРЕДЕЛЕНО)
		               |
		               |ОБЪЕДИНИТЬ ВСЕ
		               |
		               |ВЫБРАТЬ
		               |	втПартии.Номенклатура,
		               |	втПартии.Склад,
		               |	втПартии.Качество,
		               |	втПартии.Организация,
		               |	втПартии.СтрокаПрихода,
		               |	втПартии.СтатусПартии,
		               |	втПартии.Поставщик,
		               |	втПартии.Количество,
		               |	втПартии.СуммаРубли,
		               |	втПартии.СуммаДоллары,
		               |	втПартии.СуммаЕвро,
		               |	втПартии.СуммаБезНДС,
		               |	втПартии.СтрокаПриходаДата,
		               |	втПартии.ОрганизацияНаименование,
		               |	втПартии.ДокументОснование,
		               |	ИСТИНА
		               |ИЗ
		               |	втПартии КАК втПартии
		               |ГДЕ
		               |	втПартии.Организация В
		               |			(ВЫБРАТЬ
		               |				ТаблицаПриоритетаОрганизаций.Организация
		               |			ИЗ
		               |				ТаблицаПриоритетаОрганизаций)
		               |	И (втПартии.Номенклатура, втПартии.Склад, втПартии.Качество, втПартии.СтатусПартии, втПартии.Поставщик) В
		               |			(ВЫБРАТЬ
		               |				ТаблицаПоFIFO.Номенклатура,
		               |				ТаблицаПоFIFO.Склад,
		               |				ТаблицаПоFIFO.Качество,
		               |				ТаблицаПоFIFO.СтатусПартии,
		               |				ТаблицаПоFIFO.Поставщик
		               |			ИЗ
		               |				ТаблицаПоFIFO)
		               |	И втПартии.ДокументОснование = НЕОПРЕДЕЛЕНО
		               |;
					   //Конец	25.02.2019 Валиахметов XX-1920
					   //Изменение алгоритма проведения перемещения
					   |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.Поставщик КАК Поставщик,
		               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) КАК Количество,
		               |	ПартииТоваровОстатки.СуммаРубли - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаРубли, 0) КАК СуммаРубли,
		               |	ПартииТоваровОстатки.СуммаДоллары - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаДоллары, 0) КАК СуммаДоллары,
		               |	ПартииТоваровОстатки.СуммаЕвро - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаЕвро, 0) КАК СуммаЕвро,
		               |	ПартииТоваровОстатки.СуммаБезНДС - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаБезНДС, 0) КАК СуммаБезНДС,
		               |	ПартииТоваровОстатки.СтрокаПриходаДата КАК СтрокаПриходаДата,
		               |	ПартииТоваровОстатки.ОрганизацияНаименование КАК ОрганизацияНаименование,
		               |	ПартииТоваровОстатки.ДокументОснование,
		               |	ПартииТоваровОстатки.ПустойДокументОснование КАК ПустойДокументОснование
		               |ИЗ
		               |	втПартииСвернутые КАК ПартииТоваровОстатки
		               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаПриоритетаОрганизаций КАК ТаблицаПриоритетаОрганизаций
		               |		ПО (ТаблицаПриоритетаОрганизаций.Организация = ПартииТоваровОстатки.Организация)
		               |		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаДвиженийСвернутая КАК ТаблицаДвиженийСвернутая
		               |		ПО ПартииТоваровОстатки.Номенклатура = ТаблицаДвиженийСвернутая.Номенклатура
		               |			И ПартииТоваровОстатки.Склад = ТаблицаДвиженийСвернутая.Склад
		               |			И ПартииТоваровОстатки.Качество = ТаблицаДвиженийСвернутая.Качество
		               |			И ПартииТоваровОстатки.СтатусПартии = ТаблицаДвиженийСвернутая.СтатусПартии
		               |			И ПартииТоваровОстатки.СтрокаПрихода = ТаблицаДвиженийСвернутая.СтрокаПрихода
		               |			И ПартииТоваровОстатки.Организация = ТаблицаДвиженийСвернутая.Организация
		               |			И ПартииТоваровОстатки.ДокументОснование = ТаблицаДвиженийСвернутая.ДокументОснование
		               |ГДЕ
		               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) > 0
		               |
		               |УПОРЯДОЧИТЬ ПО
		               |	ПустойДокументОснование,
		               |	ТаблицаПриоритетаОрганизаций.Приоритет,
		               |	ПартииТоваровОстатки.СтрокаПриходаДата,
		               |	ПартииТоваровОстатки.ОрганизацияНаименование";
		
	ИначеЕсли СтратегияПогашенияПоОрганизации.СписыватьТолькоПоСвоейОрганизации Тогда 
		КолонкиРаспределения = КолонкиРаспределения + ",Организация"; 
		
		Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
		               |	ТаблицаПоFIFO.Номенклатура КАК Номенклатура,
		               |	ТаблицаПоFIFO.Склад КАК Склад,
		               |	ТаблицаПоFIFO.Качество КАК Качество,
		               |	ТаблицаПоFIFO.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаПоFIFO.Организация КАК Организация,
		               |	ТаблицаПоFIFO.Поставщик КАК Поставщик,
		               |	ТаблицаПоFIFO.ДокументОснование
		               |ПОМЕСТИТЬ ТаблицаПоFIFO
		               |ИЗ
		               |	&ТаблицаПоFIFO КАК ТаблицаПоFIFO
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
		               |	ТаблицаДвижений.Склад КАК Склад,
		               |	ТаблицаДвижений.Качество КАК Качество,
		               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаДвижений.Организация КАК Организация,
		               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование,
		               |	ТаблицаДвижений.Количество КАК Количество,
		               |	ТаблицаДвижений.СуммаРубли КАК СуммаРубли,
		               |	ТаблицаДвижений.СуммаДоллары КАК СуммаДоллары,
		               |	ТаблицаДвижений.СуммаЕвро КАК СуммаЕвро,
		               |	ТаблицаДвижений.СуммаБезНДС КАК СуммаБезНДС
		               |ПОМЕСТИТЬ ТаблицаДвижений
		               |ИЗ
		               |	&ТаблицаДвижений КАК ТаблицаДвижений
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
		               |	ТаблицаДвижений.Склад КАК Склад,
		               |	ТаблицаДвижений.Качество КАК Качество,
		               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаДвижений.Организация КАК Организация,
		               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование,
		               |	СУММА(ТаблицаДвижений.Количество) КАК Количество,
		               |	СУММА(ТаблицаДвижений.СуммаРубли) КАК СуммаРубли,
		               |	СУММА(ТаблицаДвижений.СуммаДоллары) КАК СуммаДоллары,
		               |	СУММА(ТаблицаДвижений.СуммаЕвро) КАК СуммаЕвро,
		               |	СУММА(ТаблицаДвижений.СуммаБезНДС) КАК СуммаБезНДС
		               |ПОМЕСТИТЬ ТаблицаДвиженийСвернутая
		               |ИЗ
		               |	ТаблицаДвижений КАК ТаблицаДвижений
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ТаблицаДвижений.Номенклатура,
		               |	ТаблицаДвижений.Склад,
		               |	ТаблицаДвижений.Качество,
		               |	ТаблицаДвижений.СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода,
		               |	ТаблицаДвижений.Организация,
		               |	ТаблицаДвижений.ДокументОснование
		               |
		               |ИНДЕКСИРОВАТЬ ПО
		               |	Номенклатура,
		               |	Склад,
		               |	Качество,
		               |	СтатусПартии,
		               |	СтрокаПрихода,
		               |	Организация,
		               |	ДокументОснование
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.СтрокаПрихода.ТорговаяТочка.Владелец КАК Поставщик,
		               |	ПартииТоваровОстатки.ДокументОснование,
		               |	СУММА(ПартииТоваровОстатки.КоличествоОстаток) КАК Количество,
		               |	СУММА(ПартииТоваровОстатки.СуммаРублиОстаток) КАК СуммаРубли,
		               |	СУММА(ПартииТоваровОстатки.СуммаДолларыОстаток) КАК СуммаДоллары,
		               |	СУММА(ПартииТоваровОстатки.СуммаЕвроОстаток) КАК СуммаЕвро,
		               |	СУММА(ПартииТоваровОстатки.СуммаБезНДСОстаток) КАК СуммаБезНДС,
		               |	ПартииТоваровОстатки.СтрокаПрихода.Дата КАК СтрокаПриходаДата
		               |ПОМЕСТИТЬ втПартии
		               |ИЗ
		               |	РегистрНакопления.ПартииТоваров.Остатки(
		               |			&КонПериода,
		               |			(Номенклатура, Склад, Качество, СтатусПартии) В
		               |				(ВЫБРАТЬ
		               |					ТаблицаПоFIFO.Номенклатура,
		               |					ТаблицаПоFIFO.Склад,
		               |					ТаблицаПоFIFO.Качество,
		               |					ТаблицаПоFIFO.СтатусПартии
		               |				ИЗ
		               |					ТаблицаПоFIFO)) КАК ПартииТоваровОстатки
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.СтрокаПрихода.ТорговаяТочка.Владелец,
		               |	ПартииТоваровОстатки.СтрокаПрихода.Дата,
		               |	ПартииТоваровОстатки.ДокументОснование
		               |
		               |ДЛЯ ИЗМЕНЕНИЯ
		               |	РегистрНакопления.ПартииТоваров.Остатки
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	втПартии.Номенклатура,
		               |	втПартии.Склад,
		               |	втПартии.Качество,
		               |	втПартии.Организация,
		               |	втПартии.СтрокаПрихода,
		               |	втПартии.СтатусПартии,
		               |	втПартии.Поставщик,
		               |	втПартии.Количество,
		               |	втПартии.СуммаРубли,
		               |	втПартии.СуммаДоллары,
		               |	втПартии.СуммаЕвро,
		               |	втПартии.СуммаБезНДС,
		               |	втПартии.СтрокаПриходаДата,
		               |	втПартии.ДокументОснование,
		               |	ЛОЖЬ КАК ПустойДокументОснование
		               |ПОМЕСТИТЬ втПартииСвернутые
		               |ИЗ
		               |	втПартии КАК втПартии
		               |ГДЕ
		               |	(втПартии.Номенклатура, втПартии.Склад, втПартии.Качество, втПартии.СтатусПартии, втПартии.Организация, втПартии.Поставщик, втПартии.ДокументОснование) В
		               |			(ВЫБРАТЬ
		               |				ТаблицаПоFIFO.Номенклатура,
		               |				ТаблицаПоFIFO.Склад,
		               |				ТаблицаПоFIFO.Качество,
		               |				ТаблицаПоFIFO.СтатусПартии,
		               |				ТаблицаПоFIFO.Организация,
		               |				ТаблицаПоFIFO.Поставщик,
		               |				ТаблицаПоFIFO.ДокументОснование
		               |			ИЗ
		               |				ТаблицаПоFIFO
		               |			ГДЕ
		               |				ТаблицаПоFIFO.ДокументОснование <> НЕОПРЕДЕЛЕНО)
		               |
		               |ОБЪЕДИНИТЬ ВСЕ
		               |
		               |ВЫБРАТЬ
		               |	втПартии.Номенклатура,
		               |	втПартии.Склад,
		               |	втПартии.Качество,
		               |	втПартии.Организация,
		               |	втПартии.СтрокаПрихода,
		               |	втПартии.СтатусПартии,
		               |	втПартии.Поставщик,
		               |	втПартии.Количество,
		               |	втПартии.СуммаРубли,
		               |	втПартии.СуммаДоллары,
		               |	втПартии.СуммаЕвро,
		               |	втПартии.СуммаБезНДС,
		               |	втПартии.СтрокаПриходаДата,
		               |	втПартии.ДокументОснование,
		               |	ИСТИНА
		               |ИЗ
		               |	втПартии КАК втПартии
		               |ГДЕ
		               |	(втПартии.Номенклатура, втПартии.Склад, втПартии.Качество, втПартии.СтатусПартии, втПартии.Организация, втПартии.Поставщик) В
		               |			(ВЫБРАТЬ
		               |				ТаблицаПоFIFO.Номенклатура,
		               |				ТаблицаПоFIFO.Склад,
		               |				ТаблицаПоFIFO.Качество,
		               |				ТаблицаПоFIFO.СтатусПартии,
		               |				ТаблицаПоFIFO.Организация,
		               |				ТаблицаПоFIFO.Поставщик
		               |			ИЗ
		               |				ТаблицаПоFIFO)
		               |	И втПартии.ДокументОснование = НЕОПРЕДЕЛЕНО
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.Поставщик КАК Поставщик,
		               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) КАК Количество,
		               |	ПартииТоваровОстатки.СуммаРубли - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаРубли, 0) КАК СуммаРубли,
		               |	ПартииТоваровОстатки.СуммаДоллары - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаДоллары, 0) КАК СуммаДоллары,
		               |	ПартииТоваровОстатки.СуммаЕвро - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаЕвро, 0) КАК СуммаЕвро,
		               |	ПартииТоваровОстатки.СуммаБезНДС - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаБезНДС, 0) КАК СуммаБезНДС,
		               |	ПартииТоваровОстатки.СтрокаПриходаДата КАК СтрокаПриходаДата,
		               |	ПартииТоваровОстатки.ДокументОснование,
		               |	ПартииТоваровОстатки.ПустойДокументОснование КАК ПустойДокументОснование
		               |ИЗ
		               |	втПартииСвернутые КАК ПартииТоваровОстатки
		               |		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаДвиженийСвернутая КАК ТаблицаДвиженийСвернутая
		               |		ПО ПартииТоваровОстатки.Номенклатура = ТаблицаДвиженийСвернутая.Номенклатура
		               |			И ПартииТоваровОстатки.Склад = ТаблицаДвиженийСвернутая.Склад
		               |			И ПартииТоваровОстатки.Качество = ТаблицаДвиженийСвернутая.Качество
		               |			И ПартииТоваровОстатки.СтатусПартии = ТаблицаДвиженийСвернутая.СтатусПартии
		               |			И ПартииТоваровОстатки.СтрокаПрихода = ТаблицаДвиженийСвернутая.СтрокаПрихода
		               |			И ПартииТоваровОстатки.Организация = ТаблицаДвиженийСвернутая.Организация
		               |			И ПартииТоваровОстатки.ДокументОснование = ТаблицаДвиженийСвернутая.ДокументОснование
		               |ГДЕ
		               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) > 0
		               |
		               |УПОРЯДОЧИТЬ ПО
		               |	ПустойДокументОснование,
		               |	СтрокаПриходаДата";
	Иначе
		
		Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
		               |	ТаблицаПоFIFO.Номенклатура КАК Номенклатура,
		               |	ТаблицаПоFIFO.Склад КАК Склад,
		               |	ТаблицаПоFIFO.Качество КАК Качество,
		               |	ТаблицаПоFIFO.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаПоFIFO.Поставщик КАК Поставщик,
		               |	ТаблицаПоFIFO.ДокументОснование КАК ДокументОснование
		               |ПОМЕСТИТЬ ТаблицаПоFIFO
		               |ИЗ
		               |	&ТаблицаПоFIFO КАК ТаблицаПоFIFO
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
		               |	ТаблицаДвижений.Склад КАК Склад,
		               |	ТаблицаДвижений.Качество КАК Качество,
		               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаДвижений.Организация КАК Организация,
		               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование,
		               |	ТаблицаДвижений.Количество КАК Количество,
		               |	ТаблицаДвижений.СуммаРубли КАК СуммаРубли,
		               |	ТаблицаДвижений.СуммаДоллары КАК СуммаДоллары,
		               |	ТаблицаДвижений.СуммаЕвро КАК СуммаЕвро,
		               |	ТаблицаДвижений.СуммаБезНДС КАК СуммаБезНДС
		               |ПОМЕСТИТЬ ТаблицаДвижений
		               |ИЗ
		               |	&ТаблицаДвижений КАК ТаблицаДвижений
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
		               |	ТаблицаДвижений.Склад КАК Склад,
		               |	ТаблицаДвижений.Качество КАК Качество,
		               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаДвижений.Организация КАК Организация,
		               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование,
		               |	СУММА(ТаблицаДвижений.Количество) КАК Количество,
		               |	СУММА(ТаблицаДвижений.СуммаРубли) КАК СуммаРубли,
		               |	СУММА(ТаблицаДвижений.СуммаДоллары) КАК СуммаДоллары,
		               |	СУММА(ТаблицаДвижений.СуммаЕвро) КАК СуммаЕвро,
		               |	СУММА(ТаблицаДвижений.СуммаБезНДС) КАК СуммаБезНДС
		               |ПОМЕСТИТЬ ТаблицаДвиженийСвернутая
		               |ИЗ
		               |	ТаблицаДвижений КАК ТаблицаДвижений
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ТаблицаДвижений.Номенклатура,
		               |	ТаблицаДвижений.Склад,
		               |	ТаблицаДвижений.Качество,
		               |	ТаблицаДвижений.СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода,
		               |	ТаблицаДвижений.Организация,
		               |	ТаблицаДвижений.ДокументОснование
		               |
		               |ИНДЕКСИРОВАТЬ ПО
		               |	Номенклатура,
		               |	Склад,
		               |	Качество,
		               |	СтатусПартии,
		               |	СтрокаПрихода,
		               |	Организация,
		               |	ДокументОснование
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.СтрокаПрихода.ТорговаяТочка.Владелец КАК Поставщик,
		               |	СУММА(ПартииТоваровОстатки.КоличествоОстаток) КАК Количество,
		               |	СУММА(ПартииТоваровОстатки.СуммаРублиОстаток) КАК СуммаРубли,
		               |	СУММА(ПартииТоваровОстатки.СуммаДолларыОстаток) КАК СуммаДоллары,
		               |	СУММА(ПартииТоваровОстатки.СуммаЕвроОстаток) КАК СуммаЕвро,
		               |	СУММА(ПартииТоваровОстатки.СуммаБезНДСОстаток) КАК СуммаБезНДС,
		               |	ПартииТоваровОстатки.Организация = &Организация КАК ЭтаОрганизация,
		               |	ПартииТоваровОстатки.СтрокаПрихода.Дата КАК СтрокаПриходаДата,
		               |	ПартииТоваровОстатки.Организация.Наименование КАК ОрганизацияНаименование,
		               |	ПартииТоваровОстатки.ДокументОснование
		               |ПОМЕСТИТЬ втПартии
		               |ИЗ
		               |	РегистрНакопления.ПартииТоваров.Остатки(
		               |			&КонПериода,
		               |			(Номенклатура, Склад, Качество, СтатусПартии) В
		               |				(ВЫБРАТЬ
		               |					ТаблицаПоFIFO.Номенклатура,
		               |					ТаблицаПоFIFO.Склад,
		               |					ТаблицаПоFIFO.Качество,
		               |					ТаблицаПоFIFO.СтатусПартии
		               |				ИЗ
		               |					ТаблицаПоFIFO)) КАК ПартииТоваровОстатки
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.СтрокаПрихода.ТорговаяТочка.Владелец,
		               |	ПартииТоваровОстатки.СтрокаПрихода.Дата,
		               |	ПартииТоваровОстатки.Организация.Наименование,
		               |	ПартииТоваровОстатки.ДокументОснование,
		               |	ПартииТоваровОстатки.Организация = &Организация
		               |
		               |ДЛЯ ИЗМЕНЕНИЯ
		               |	РегистрНакопления.ПартииТоваров.Остатки
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	втПартии.Номенклатура,
		               |	втПартии.Склад,
		               |	втПартии.Качество,
		               |	втПартии.Организация,
		               |	втПартии.СтрокаПрихода,
		               |	втПартии.СтатусПартии,
		               |	втПартии.Поставщик,
		               |	втПартии.Количество,
		               |	втПартии.СуммаРубли,
		               |	втПартии.СуммаДоллары,
		               |	втПартии.СуммаЕвро,
		               |	втПартии.СуммаБезНДС,
		               |	втПартии.ЭтаОрганизация,
		               |	втПартии.СтрокаПриходаДата,
		               |	втПартии.ОрганизацияНаименование,
		               |	втПартии.ДокументОснование КАК ДокументОснование,
		               |	ЛОЖЬ КАК ПустойДокументОснование
		               |ПОМЕСТИТЬ втПартииСвернутые
		               |ИЗ
		               |	втПартии КАК втПартии
		               |ГДЕ
		               |	НЕ втПартии.Организация В (&ЗапрещенныеОрганизации)
		               |	И (втПартии.Номенклатура, втПартии.Склад, втПартии.Качество, втПартии.СтатусПартии, втПартии.Поставщик, втПартии.ДокументОснование) В
		               |			(ВЫБРАТЬ
		               |				ТаблицаПоFIFO.Номенклатура,
		               |				ТаблицаПоFIFO.Склад,
		               |				ТаблицаПоFIFO.Качество,
		               |				ТаблицаПоFIFO.СтатусПартии,
		               |				ТаблицаПоFIFO.Поставщик,
		               |				ТаблицаПоFIFO.ДокументОснование
		               |			ИЗ
		               |				ТаблицаПоFIFO
		               |			ГДЕ
		               |				ТаблицаПоFIFO.ДокументОснование <> НЕОПРЕДЕЛЕНО)
		               |
		               |ОБЪЕДИНИТЬ ВСЕ
		               |
		               |ВЫБРАТЬ
		               |	втПартии.Номенклатура,
		               |	втПартии.Склад,
		               |	втПартии.Качество,
		               |	втПартии.Организация,
		               |	втПартии.СтрокаПрихода,
		               |	втПартии.СтатусПартии,
		               |	втПартии.Поставщик,
		               |	втПартии.Количество,
		               |	втПартии.СуммаРубли,
		               |	втПартии.СуммаДоллары,
		               |	втПартии.СуммаЕвро,
		               |	втПартии.СуммаБезНДС,
		               |	втПартии.ЭтаОрганизация,
		               |	втПартии.СтрокаПриходаДата,
		               |	втПартии.ОрганизацияНаименование,
		               |	втПартии.ДокументОснование,
		               |	ИСТИНА
		               |ИЗ
		               |	втПартии КАК втПартии
		               |ГДЕ
		               |	НЕ втПартии.Организация В (&ЗапрещенныеОрганизации)
		               |	И (втПартии.Номенклатура, втПартии.Склад, втПартии.Качество, втПартии.СтатусПартии, втПартии.Поставщик) В
		               |			(ВЫБРАТЬ
		               |				ТаблицаПоFIFO.Номенклатура,
		               |				ТаблицаПоFIFO.Склад,
		               |				ТаблицаПоFIFO.Качество,
		               |				ТаблицаПоFIFO.СтатусПартии,
		               |				ТаблицаПоFIFO.Поставщик
		               |			ИЗ
		               |				ТаблицаПоFIFO)
		               |	И втПартии.ДокументОснование = НЕОПРЕДЕЛЕНО
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.Поставщик КАК Поставщик,
		               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) КАК Количество,
		               |	ПартииТоваровОстатки.СуммаРубли - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаРубли, 0) КАК СуммаРубли,
		               |	ПартииТоваровОстатки.СуммаДоллары - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаДоллары, 0) КАК СуммаДоллары,
		               |	ПартииТоваровОстатки.СуммаЕвро - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаЕвро, 0) КАК СуммаЕвро,
		               |	ПартииТоваровОстатки.СуммаБезНДС - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаБезНДС, 0) КАК СуммаБезНДС,
		               |	ПартииТоваровОстатки.ЭтаОрганизация КАК ЭтаОрганизация,
		               |	ПартииТоваровОстатки.СтрокаПриходаДата КАК СтрокаПриходаДата,
		               |	ПартииТоваровОстатки.ОрганизацияНаименование КАК ОрганизацияНаименование,
		               |	ПартииТоваровОстатки.ДокументОснование,
		               |	ПартииТоваровОстатки.ПустойДокументОснование КАК ПустойДокументОснование
		               |ИЗ
		               |	втПартииСвернутые КАК ПартииТоваровОстатки
		               |		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаДвиженийСвернутая КАК ТаблицаДвиженийСвернутая
		               |		ПО ПартииТоваровОстатки.Номенклатура = ТаблицаДвиженийСвернутая.Номенклатура
		               |			И ПартииТоваровОстатки.Склад = ТаблицаДвиженийСвернутая.Склад
		               |			И ПартииТоваровОстатки.Качество = ТаблицаДвиженийСвернутая.Качество
		               |			И ПартииТоваровОстатки.СтатусПартии = ТаблицаДвиженийСвернутая.СтатусПартии
		               |			И ПартииТоваровОстатки.СтрокаПрихода = ТаблицаДвиженийСвернутая.СтрокаПрихода
		               |			И ПартииТоваровОстатки.Организация = ТаблицаДвиженийСвернутая.Организация
		               |			И ПартииТоваровОстатки.ДокументОснование = ТаблицаДвиженийСвернутая.ДокументОснование
		               |ГДЕ
		               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) > 0
		               |
		               |УПОРЯДОЧИТЬ ПО
		               |	ЭтаОрганизация УБЫВ,
		               |	ОрганизацияНаименование,
		               |	ПустойДокументОснование,
		               |	СтрокаПриходаДата";
		Организация = ТаблицаПоFIFO.Получить(0).Организация;			   
		Запрос.УстановитьПараметр("Организация", Организация);
		Запрос.УстановитьПараметр("ЗапрещенныеОрганизации", ЗапрещенныеОрганизацииПродавцы(Организация, Реквизиты.Дата));
		ОтсортированаПоОрганизации = Организация;
	КонецЕсли;					   
		
	//Если УчитыватьПоставщика Тогда 
	//	Запрос.Текст = СтрЗаменить(Запрос.Текст, "%ОтборПоПоставщику%", "И СтрокаПрихода.ТорговаяТочка.Владелец = &Поставщик");
	//	Запрос.УстановитьПараметр("Поставщик", ОбщегоНазначения.ЗначениеРеквизитаОбъекта(вхСсылкаНаДокумент, "Контрагент"));
	//Иначе
	//	Запрос.Текст = СтрЗаменить(Запрос.Текст, "%ОтборПоПоставщику%", "");
	//КонецЕсли;
	
	ОстаткиПоПартиям = Запрос.Выполнить().Выгрузить();
	ОстаткиПоПартиям.Индексы.Добавить(КолонкиРаспределения);
	
	ПередаваемыеПараметры = Новый Структура;
	ПередаваемыеПараметры.Вставить("КолонкиРаспределения", КолонкиРаспределения);
	ПередаваемыеПараметры.Вставить("ЗаполняемыеРеквизиты", ЗаполняемыеРеквизиты);
	ПередаваемыеПараметры.Вставить("КонтрольНаличияПартий", КонтрольНаличияПартий);
	ПередаваемыеПараметры.Вставить("ДатаДокумента", Реквизиты.Дата);	
	ПередаваемыеПараметры.Вставить("СписыватьТолькоПоСвоейОрганизации", СтратегияПогашенияПоОрганизации.СписыватьТолькоПоСвоейОрганизации);
	ПередаваемыеПараметры.Вставить("СтратегияПогашенияПоОрганизации", СтратегияПогашенияПоОрганизации);
	
	// 18.04.19 Строганов Роман > 
	ПередаваемыеПараметры.Вставить("ТаблицаПоFIFOБезОтбораПоПоставщику", ТаблицаПоFIFOБезОтбораПоПоставщику);
	// 18.04.19 Строганов Роман <

	ПогашениеПартийТоваровНовоеФрагмент(вхСсылкаНаДокумент, ТаблицаПоFIFO, ПередаваемыеПараметры, ОстаткиПоПартиям, ТаблицаДвижений, вхОтказ,,ОтсортированаПоОрганизации, ПараметрыСписания);
	
КонецПроцедуры
	
Процедура СписатьПоFIFO(вхСсылкаНаДокумент, ТаблицаДвижений, ТаблицаПоFIFO, СтратегияПогашенияПоОрганизации, ЗаполняемыеРеквизиты, КонтрольНаличияПартий, вхОтказ, ПараметрыСписания = Неопределено)
	
	лКлючАлгоритма = "ОбщийМодуль_ПроведениеДокументовКлиентСервер_СписатьПоFIFO";
	лЗамена = АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		Выполнить(лЗамена);
	КонецЕсли;
	
	ОтсортированаПоОрганизации = Неопределено; 
	ОперативноеПроведение = Неопределено;
	
	Реквизиты = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(вхСсылкаНаДокумент, "Дата,Организация");
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ТаблицаПоFIFO", ТаблицаПоFIFO);
	Запрос.УстановитьПараметр("ТаблицаДвижений", ТаблицаДвижений);
	ПараметрыСписания.Свойство("ОперативноеПроведение", ОперативноеПроведение);
	Если ОперативноеПроведение = Неопределено Тогда 
		ОперативноеПроведение = Ложь;
	КонецЕсли;
	
	Запрос.УстановитьПараметр("КонПериода", ?(ОперативноеПроведение, Неопределено, вхСсылкаНаДокумент.МоментВремени()));
	
	КолонкиРаспределения = "Номенклатура,Склад,Качество,СтатусПартии";
	
	Если СтратегияПогашенияПоОрганизации.ИспользуютсяМФП Тогда
		
		Если СтратегияПогашенияПоОрганизации.ПараметрыПолитикиМФП.УчитыватьОрганизациюТаблицыСписания Тогда
			КолонкиРаспределения = КолонкиРаспределения + ",Организация"; 
		КонецЕсли;
		
		Запрос.УстановитьПараметр("ТаблицаПриоритетаОрганизаций", СтратегияПогашенияПоОрганизации.ПараметрыПолитикиМФП.ОрганизацииДляЗакупки);
		Запрос.Текст = "ВЫБРАТЬ
		               |	ТаблицаПриоритетаОрганизаций.Приоритет КАК Приоритет,
		               |	ТаблицаПриоритетаОрганизаций.Организация КАК Организация
		               |ПОМЕСТИТЬ ТаблицаПриоритетаОрганизаций
		               |ИЗ
		               |	&ТаблицаПриоритетаОрганизаций КАК ТаблицаПриоритетаОрганизаций
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ РАЗЛИЧНЫЕ
		               |	ТаблицаПоFIFO.Номенклатура КАК Номенклатура,
		               |	ТаблицаПоFIFO.Склад КАК Склад,
		               |	ТаблицаПоFIFO.Качество КАК Качество,
		               |	ТаблицаПоFIFO.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаПоFIFO.ДокументОснование КАК ДокументОснование
		               |ПОМЕСТИТЬ ТаблицаПоFIFO
		               |ИЗ
		               |	&ТаблицаПоFIFO КАК ТаблицаПоFIFO
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
		               |	ТаблицаДвижений.Склад КАК Склад,
		               |	ТаблицаДвижений.Качество КАК Качество,
		               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаДвижений.Организация КАК Организация,
		               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование,
		               |	ТаблицаДвижений.Количество КАК Количество,
		               |	ТаблицаДвижений.СуммаРубли КАК СуммаРубли,
		               |	ТаблицаДвижений.СуммаДоллары КАК СуммаДоллары,
		               |	ТаблицаДвижений.СуммаЕвро КАК СуммаЕвро,
		               |	ТаблицаДвижений.СуммаБезНДС КАК СуммаБезНДС
		               |ПОМЕСТИТЬ ТаблицаДвижений
		               |ИЗ
		               |	&ТаблицаДвижений КАК ТаблицаДвижений
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
		               |	ТаблицаДвижений.Склад КАК Склад,
		               |	ТаблицаДвижений.Качество КАК Качество,
		               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаДвижений.Организация КАК Организация,
		               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование,
		               |	СУММА(ТаблицаДвижений.Количество) КАК Количество,
		               |	СУММА(ТаблицаДвижений.СуммаРубли) КАК СуммаРубли,
		               |	СУММА(ТаблицаДвижений.СуммаДоллары) КАК СуммаДоллары,
		               |	СУММА(ТаблицаДвижений.СуммаЕвро) КАК СуммаЕвро,
		               |	СУММА(ТаблицаДвижений.СуммаБезНДС) КАК СуммаБезНДС
		               |ПОМЕСТИТЬ ТаблицаДвиженийСвернутая
		               |ИЗ
		               |	ТаблицаДвижений КАК ТаблицаДвижений
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ТаблицаДвижений.Номенклатура,
		               |	ТаблицаДвижений.Склад,
		               |	ТаблицаДвижений.Качество,
		               |	ТаблицаДвижений.СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода,
		               |	ТаблицаДвижений.Организация,
		               |	ТаблицаДвижений.ДокументОснование
		               |
		               |ИНДЕКСИРОВАТЬ ПО
		               |	Номенклатура,
		               |	Склад,
		               |	Качество,
		               |	СтатусПартии,
		               |	СтрокаПрихода,
		               |	Организация,
		               |	ДокументОснование
		               |;
					   //	25.02.2019 Валиахметов XX-1920
					   //Изменение алгоритма проведения перемещения
					   |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	СУММА(ПартииТоваровОстатки.КоличествоОстаток) КАК Количество,
		               |	СУММА(ПартииТоваровОстатки.СуммаРублиОстаток) КАК СуммаРубли,
		               |	СУММА(ПартииТоваровОстатки.СуммаДолларыОстаток) КАК СуммаДоллары,
		               |	СУММА(ПартииТоваровОстатки.СуммаЕвроОстаток) КАК СуммаЕвро,
		               |	СУММА(ПартииТоваровОстатки.СуммаБезНДСОстаток) КАК СуммаБезНДС,
		               |	ПартииТоваровОстатки.СтрокаПрихода.Дата КАК СтрокаПриходаДата,
		               |	ПартииТоваровОстатки.Организация.Наименование КАК ОрганизацияНаименование,
		               |	ПартииТоваровОстатки.ДокументОснование КАК ДокументОснование,
		               |	ЛОЖЬ КАК ПустойДокументОснование
		               |ПОМЕСТИТЬ втПартииСвернутые
		               |ИЗ
		               |	РегистрНакопления.ПартииТоваров.Остатки(
		               |			&КонПериода,
		               |			(Номенклатура, Склад, Качество, СтатусПартии, ДокументОснование) В
		               |					(ВЫБРАТЬ
		               |						ТаблицаПоFIFO.Номенклатура,
		               |						ТаблицаПоFIFO.Склад,
		               |						ТаблицаПоFIFO.Качество,
		               |						ТаблицаПоFIFO.СтатусПартии,
		               |						ТаблицаПоFIFO.ДокументОснование
		               |					ИЗ
		               |						ТаблицаПоFIFO
		               |					ГДЕ
		               |						ТаблицаПоFIFO.ДокументОснование <> НЕОПРЕДЕЛЕНО)
		               |				И Организация В
		               |					(ВЫБРАТЬ
		               |						ТаблицаПриоритетаОрганизаций.Организация
		               |					ИЗ
		               |						ТаблицаПриоритетаОрганизаций)) КАК ПартииТоваровОстатки
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.СтрокаПрихода.Дата,
		               |	ПартииТоваровОстатки.Организация.Наименование,
		               |	ПартииТоваровОстатки.ДокументОснование
		               |
		               |ДЛЯ ИЗМЕНЕНИЯ
		               |	РегистрНакопления.ПартииТоваров.Остатки
		               |
		               |ОБЪЕДИНИТЬ ВСЕ
		               |
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	СУММА(ПартииТоваровОстатки.КоличествоОстаток),
		               |	СУММА(ПартииТоваровОстатки.СуммаРублиОстаток),
		               |	СУММА(ПартииТоваровОстатки.СуммаДолларыОстаток),
		               |	СУММА(ПартииТоваровОстатки.СуммаЕвроОстаток),
		               |	СУММА(ПартииТоваровОстатки.СуммаБезНДСОстаток),
		               |	ПартииТоваровОстатки.СтрокаПрихода.Дата,
		               |	ПартииТоваровОстатки.Организация.Наименование,
		               |	ПартииТоваровОстатки.ДокументОснование,
		               |	ИСТИНА
		               |ИЗ
		               |	РегистрНакопления.ПартииТоваров.Остатки(
		               |			&КонПериода,
		               |			(Номенклатура, Склад, Качество, СтатусПартии) В
		               |					(ВЫБРАТЬ
		               |						ТаблицаПоFIFO.Номенклатура,
		               |						ТаблицаПоFIFO.Склад,
		               |						ТаблицаПоFIFO.Качество,
		               |						ТаблицаПоFIFO.СтатусПартии
		               |					ИЗ
		               |						ТаблицаПоFIFO)
		               |				И Организация В
		               |					(ВЫБРАТЬ
		               |						ТаблицаПриоритетаОрганизаций.Организация
		               |					ИЗ
		               |						ТаблицаПриоритетаОрганизаций)
		               |				И ДокументОснование = НЕОПРЕДЕЛЕНО) КАК ПартииТоваровОстатки
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.СтрокаПрихода.Дата,
		               |	ПартииТоваровОстатки.Организация.Наименование,
		               |	ПартииТоваровОстатки.ДокументОснование
		               |
		               |ДЛЯ ИЗМЕНЕНИЯ
		               |	РегистрНакопления.ПартииТоваров.Остатки
		               |;
					   //Конец	25.02.2019 Валиахметов XX-1920
					   //Изменение алгоритма проведения перемещения
					   |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) КАК Количество,
		               |	ПартииТоваровОстатки.СуммаРубли - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаРубли, 0) КАК СуммаРубли,
		               |	ПартииТоваровОстатки.СуммаДоллары - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаДоллары, 0) КАК СуммаДоллары,
		               |	ПартииТоваровОстатки.СуммаЕвро - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаЕвро, 0) КАК СуммаЕвро,
		               |	ПартииТоваровОстатки.СуммаБезНДС - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаБезНДС, 0) КАК СуммаБезНДС,
		               |	ПартииТоваровОстатки.СтрокаПриходаДата КАК СтрокаПриходаДата,
		               |	ПартииТоваровОстатки.ДокументОснование,
		               |	ПартииТоваровОстатки.ПустойДокументОснование КАК ПустойДокументОснование
		               |ИЗ
		               |	втПартииСвернутые КАК ПартииТоваровОстатки
		               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаПриоритетаОрганизаций КАК ТаблицаПриоритетаОрганизаций
		               |		ПО (ТаблицаПриоритетаОрганизаций.Организация = ПартииТоваровОстатки.Организация)
		               |		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаДвиженийСвернутая КАК ТаблицаДвиженийСвернутая
		               |		ПО ПартииТоваровОстатки.Номенклатура = ТаблицаДвиженийСвернутая.Номенклатура
		               |			И ПартииТоваровОстатки.Склад = ТаблицаДвиженийСвернутая.Склад
		               |			И ПартииТоваровОстатки.Качество = ТаблицаДвиженийСвернутая.Качество
		               |			И ПартииТоваровОстатки.СтатусПартии = ТаблицаДвиженийСвернутая.СтатусПартии
		               |			И ПартииТоваровОстатки.СтрокаПрихода = ТаблицаДвиженийСвернутая.СтрокаПрихода
		               |			И ПартииТоваровОстатки.Организация = ТаблицаДвиженийСвернутая.Организация
		               |			И ПартииТоваровОстатки.ДокументОснование = ТаблицаДвиженийСвернутая.ДокументОснование
		               |ГДЕ
		               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) > 0
		               |
		               |УПОРЯДОЧИТЬ ПО
		               |	ПустойДокументОснование,
		               |	ТаблицаПриоритетаОрганизаций.Приоритет,
		               |	ПартииТоваровОстатки.СтрокаПриходаДата,
		               |	ПартииТоваровОстатки.ОрганизацияНаименование";
					   
		ИначеЕсли СтратегияПогашенияПоОрганизации.СписыватьТолькоПоСвоейОрганизации Тогда 
		КолонкиРаспределения = КолонкиРаспределения + ",Организация"; 
		
		Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
		               |	ТаблицаПоFIFO.Номенклатура КАК Номенклатура,
		               |	ТаблицаПоFIFO.Склад КАК Склад,
		               |	ТаблицаПоFIFO.Качество КАК Качество,
		               |	ТаблицаПоFIFO.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаПоFIFO.Организация КАК Организация,
		               |	ТаблицаПоFIFO.ДокументОснование КАК ДокументОснование
		               |ПОМЕСТИТЬ ТаблицаПоFIFO
		               |ИЗ
		               |	&ТаблицаПоFIFO КАК ТаблицаПоFIFO
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
		               |	ТаблицаДвижений.Склад КАК Склад,
		               |	ТаблицаДвижений.Качество КАК Качество,
		               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаДвижений.Организация КАК Организация,
		               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование,
		               |	ТаблицаДвижений.Количество КАК Количество,
		               |	ТаблицаДвижений.СуммаРубли КАК СуммаРубли,
		               |	ТаблицаДвижений.СуммаДоллары КАК СуммаДоллары,
		               |	ТаблицаДвижений.СуммаЕвро КАК СуммаЕвро,
		               |	ТаблицаДвижений.СуммаБезНДС КАК СуммаБезНДС
		               |ПОМЕСТИТЬ ТаблицаДвижений
		               |ИЗ
		               |	&ТаблицаДвижений КАК ТаблицаДвижений
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
		               |	ТаблицаДвижений.Склад КАК Склад,
		               |	ТаблицаДвижений.Качество КАК Качество,
		               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаДвижений.Организация КАК Организация,
		               |	СУММА(ТаблицаДвижений.Количество) КАК Количество,
		               |	СУММА(ТаблицаДвижений.СуммаРубли) КАК СуммаРубли,
		               |	СУММА(ТаблицаДвижений.СуммаДоллары) КАК СуммаДоллары,
		               |	СУММА(ТаблицаДвижений.СуммаЕвро) КАК СуммаЕвро,
		               |	СУММА(ТаблицаДвижений.СуммаБезНДС) КАК СуммаБезНДС,
		               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование
		               |ПОМЕСТИТЬ ТаблицаДвиженийСвернутая
		               |ИЗ
		               |	ТаблицаДвижений КАК ТаблицаДвижений
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ТаблицаДвижений.Номенклатура,
		               |	ТаблицаДвижений.Склад,
		               |	ТаблицаДвижений.Качество,
		               |	ТаблицаДвижений.СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода,
		               |	ТаблицаДвижений.Организация,
		               |	ТаблицаДвижений.ДокументОснование
		               |
		               |ИНДЕКСИРОВАТЬ ПО
		               |	Номенклатура,
		               |	Склад,
		               |	Качество,
		               |	СтатусПартии,
		               |	СтрокаПрихода,
		               |	Организация,
		               |	ДокументОснование
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	СУММА(ПартииТоваровОстатки.КоличествоОстаток) КАК Количество,
		               |	СУММА(ПартииТоваровОстатки.СуммаРублиОстаток) КАК СуммаРубли,
		               |	СУММА(ПартииТоваровОстатки.СуммаДолларыОстаток) КАК СуммаДоллары,
		               |	СУММА(ПартииТоваровОстатки.СуммаЕвроОстаток) КАК СуммаЕвро,
		               |	СУММА(ПартииТоваровОстатки.СуммаБезНДСОстаток) КАК СуммаБезНДС,
		               |	ПартииТоваровОстатки.СтрокаПрихода.Дата КАК СтрокаПриходаДата,
		               |	ПартииТоваровОстатки.ДокументОснование,
		               |	ЛОЖЬ КАК ПустойДокументОснование
		               |ПОМЕСТИТЬ втПартииСвернутые
		               |ИЗ
		               |	РегистрНакопления.ПартииТоваров.Остатки(
		               |			&КонПериода,
		               |			(Номенклатура, Склад, Качество, СтатусПартии, Организация, ДокументОснование) В
		               |				(ВЫБРАТЬ
		               |					ТаблицаПоFIFO.Номенклатура,
		               |					ТаблицаПоFIFO.Склад,
		               |					ТаблицаПоFIFO.Качество,
		               |					ТаблицаПоFIFO.СтатусПартии,
		               |					ТаблицаПоFIFO.Организация,
		               |					ТаблицаПоFIFO.ДокументОснование
		               |				ИЗ
		               |					ТаблицаПоFIFO
		               |				ГДЕ
		               |					ТаблицаПоFIFO.ДокументОснование <> НЕОПРЕДЕЛЕНО)) КАК ПартииТоваровОстатки
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.СтрокаПрихода.Дата,
		               |	ПартииТоваровОстатки.ДокументОснование
		               |
		               |ДЛЯ ИЗМЕНЕНИЯ
		               |	РегистрНакопления.ПартииТоваров.Остатки
		               |
		               |ОБЪЕДИНИТЬ ВСЕ
		               |
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	СУММА(ПартииТоваровОстатки.КоличествоОстаток),
		               |	СУММА(ПартииТоваровОстатки.СуммаРублиОстаток),
		               |	СУММА(ПартииТоваровОстатки.СуммаДолларыОстаток),
		               |	СУММА(ПартииТоваровОстатки.СуммаЕвроОстаток),
		               |	СУММА(ПартииТоваровОстатки.СуммаБезНДСОстаток),
		               |	ПартииТоваровОстатки.СтрокаПрихода.Дата,
		               |	ПартииТоваровОстатки.ДокументОснование,
		               |	ИСТИНА
		               |ИЗ
		               |	РегистрНакопления.ПартииТоваров.Остатки(
		               |			&КонПериода,
		               |			(Номенклатура, Склад, Качество, СтатусПартии, Организация) В
		               |					(ВЫБРАТЬ
		               |						ТаблицаПоFIFO.Номенклатура,
		               |						ТаблицаПоFIFO.Склад,
		               |						ТаблицаПоFIFO.Качество,
		               |						ТаблицаПоFIFO.СтатусПартии,
		               |						ТаблицаПоFIFO.Организация
		               |					ИЗ
		               |						ТаблицаПоFIFO)
		               |				И ДокументОснование = НЕОПРЕДЕЛЕНО) КАК ПартииТоваровОстатки
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.СтрокаПрихода.Дата,
		               |	ПартииТоваровОстатки.ДокументОснование
		               |
		               |ДЛЯ ИЗМЕНЕНИЯ
		               |	РегистрНакопления.ПартииТоваров.Остатки
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) КАК Количество,
		               |	ПартииТоваровОстатки.СуммаРубли - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаРубли, 0) КАК СуммаРубли,
		               |	ПартииТоваровОстатки.СуммаДоллары - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаДоллары, 0) КАК СуммаДоллары,
		               |	ПартииТоваровОстатки.СуммаЕвро - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаЕвро, 0) КАК СуммаЕвро,
		               |	ПартииТоваровОстатки.СуммаБезНДС - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаБезНДС, 0) КАК СуммаБезНДС,
		               |	ПартииТоваровОстатки.СтрокаПриходаДата КАК СтрокаПриходаДата,
		               |	ПартииТоваровОстатки.ДокументОснование,
		               |	ПартииТоваровОстатки.ПустойДокументОснование КАК ПустойДокументОснование
		               |ИЗ
		               |	втПартииСвернутые КАК ПартииТоваровОстатки
		               |		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаДвиженийСвернутая КАК ТаблицаДвиженийСвернутая
		               |		ПО ПартииТоваровОстатки.Номенклатура = ТаблицаДвиженийСвернутая.Номенклатура
		               |			И ПартииТоваровОстатки.Склад = ТаблицаДвиженийСвернутая.Склад
		               |			И ПартииТоваровОстатки.Качество = ТаблицаДвиженийСвернутая.Качество
		               |			И ПартииТоваровОстатки.СтатусПартии = ТаблицаДвиженийСвернутая.СтатусПартии
		               |			И ПартииТоваровОстатки.СтрокаПрихода = ТаблицаДвиженийСвернутая.СтрокаПрихода
		               |			И ПартииТоваровОстатки.Организация = ТаблицаДвиженийСвернутая.Организация
		               |			И ПартииТоваровОстатки.ДокументОснование = ТаблицаДвиженийСвернутая.ДокументОснование
		               |ГДЕ
		               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) > 0
		               |
		               |УПОРЯДОЧИТЬ ПО
		               |	ПустойДокументОснование,
		               |	СтрокаПриходаДата";
	Иначе
		
		Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
		               |	ТаблицаПоFIFO.Номенклатура КАК Номенклатура,
		               |	ТаблицаПоFIFO.Склад КАК Склад,
		               |	ТаблицаПоFIFO.Качество КАК Качество,
		               |	ТаблицаПоFIFO.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаПоFIFO.ДокументОснование КАК ДокументОснование
		               |ПОМЕСТИТЬ ТаблицаПоFIFO
		               |ИЗ
		               |	&ТаблицаПоFIFO КАК ТаблицаПоFIFO
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
		               |	ТаблицаДвижений.Склад КАК Склад,
		               |	ТаблицаДвижений.Качество КАК Качество,
		               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаДвижений.Организация КАК Организация,
		               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование,
		               |	ТаблицаДвижений.Количество КАК Количество,
		               |	ТаблицаДвижений.СуммаРубли КАК СуммаРубли,
		               |	ТаблицаДвижений.СуммаДоллары КАК СуммаДоллары,
		               |	ТаблицаДвижений.СуммаЕвро КАК СуммаЕвро,
		               |	ТаблицаДвижений.СуммаБезНДС КАК СуммаБезНДС
		               |ПОМЕСТИТЬ ТаблицаДвижений
		               |ИЗ
		               |	&ТаблицаДвижений КАК ТаблицаДвижений
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
		               |	ТаблицаДвижений.Склад КАК Склад,
		               |	ТаблицаДвижений.Качество КАК Качество,
		               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаДвижений.Организация КАК Организация,
		               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование,
		               |	СУММА(ТаблицаДвижений.Количество) КАК Количество,
		               |	СУММА(ТаблицаДвижений.СуммаРубли) КАК СуммаРубли,
		               |	СУММА(ТаблицаДвижений.СуммаДоллары) КАК СуммаДоллары,
		               |	СУММА(ТаблицаДвижений.СуммаЕвро) КАК СуммаЕвро,
		               |	СУММА(ТаблицаДвижений.СуммаБезНДС) КАК СуммаБезНДС
		               |ПОМЕСТИТЬ ТаблицаДвиженийСвернутая
		               |ИЗ
		               |	ТаблицаДвижений КАК ТаблицаДвижений
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ТаблицаДвижений.Номенклатура,
		               |	ТаблицаДвижений.Склад,
		               |	ТаблицаДвижений.Качество,
		               |	ТаблицаДвижений.СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода,
		               |	ТаблицаДвижений.Организация,
		               |	ТаблицаДвижений.ДокументОснование
		               |
		               |ИНДЕКСИРОВАТЬ ПО
		               |	Номенклатура,
		               |	Склад,
		               |	Качество,
		               |	СтатусПартии,
		               |	СтрокаПрихода,
		               |	Организация,
		               |	ДокументОснование
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	СУММА(ПартииТоваровОстатки.КоличествоОстаток) КАК Количество,
		               |	СУММА(ПартииТоваровОстатки.СуммаРублиОстаток) КАК СуммаРубли,
		               |	СУММА(ПартииТоваровОстатки.СуммаДолларыОстаток) КАК СуммаДоллары,
		               |	СУММА(ПартииТоваровОстатки.СуммаЕвроОстаток) КАК СуммаЕвро,
		               |	СУММА(ПартииТоваровОстатки.СуммаБезНДСОстаток) КАК СуммаБезНДС,
		               |	ПартииТоваровОстатки.Организация = &Организация КАК ЭтаОрганизация,
		               |	ПартииТоваровОстатки.СтрокаПрихода.Дата КАК СтрокаПриходаДата,
		               |	ПартииТоваровОстатки.Организация.Наименование КАК ОрганизацияНаименование,
		               |	ПартииТоваровОстатки.ДокументОснование,
		               |	ЛОЖЬ КАК ПустойДокументОснование
		               |ПОМЕСТИТЬ втПартииСвернутые
		               |ИЗ
		               |	РегистрНакопления.ПартииТоваров.Остатки(
		               |			&КонПериода,
		               |			(Номенклатура, Склад, Качество, СтатусПартии, ДокументОснование) В
		               |					(ВЫБРАТЬ
		               |						ТаблицаПоFIFO.Номенклатура,
		               |						ТаблицаПоFIFO.Склад,
		               |						ТаблицаПоFIFO.Качество,
		               |						ТаблицаПоFIFO.СтатусПартии,
		               |						ТаблицаПоFIFO.ДокументОснование
		               |					ИЗ
		               |						ТаблицаПоFIFO
		               |					ГДЕ
		               |						ТаблицаПоFIFO.ДокументОснование <> НЕОПРЕДЕЛЕНО)
		               |				И НЕ Организация В (&ЗапрещенныеОрганизации)) КАК ПартииТоваровОстатки
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.СтрокаПрихода.Дата,
		               |	ПартииТоваровОстатки.Организация.Наименование,
		               |	ПартииТоваровОстатки.ДокументОснование,
		               |	ПартииТоваровОстатки.Организация = &Организация
		               |
		               |ДЛЯ ИЗМЕНЕНИЯ
		               |	РегистрНакопления.ПартииТоваров.Остатки
		               |
		               |ОБЪЕДИНИТЬ ВСЕ
		               |
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	СУММА(ПартииТоваровОстатки.КоличествоОстаток),
		               |	СУММА(ПартииТоваровОстатки.СуммаРублиОстаток),
		               |	СУММА(ПартииТоваровОстатки.СуммаДолларыОстаток),
		               |	СУММА(ПартииТоваровОстатки.СуммаЕвроОстаток),
		               |	СУММА(ПартииТоваровОстатки.СуммаБезНДСОстаток),
		               |	ПартииТоваровОстатки.Организация = &Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода.Дата,
		               |	ПартииТоваровОстатки.Организация.Наименование,
		               |	ПартииТоваровОстатки.ДокументОснование,
		               |	ИСТИНА
		               |ИЗ
		               |	РегистрНакопления.ПартииТоваров.Остатки(
		               |			&КонПериода,
		               |			(Номенклатура, Склад, Качество, СтатусПартии) В
		               |					(ВЫБРАТЬ
		               |						ТаблицаПоFIFO.Номенклатура,
		               |						ТаблицаПоFIFO.Склад,
		               |						ТаблицаПоFIFO.Качество,
		               |						ТаблицаПоFIFO.СтатусПартии
		               |					ИЗ
		               |						ТаблицаПоFIFO)
		               |				И НЕ Организация В (&ЗапрещенныеОрганизации)
		               |				И ДокументОснование = НЕОПРЕДЕЛЕНО) КАК ПартииТоваровОстатки
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.СтрокаПрихода.Дата,
		               |	ПартииТоваровОстатки.Организация.Наименование,
		               |	ПартииТоваровОстатки.ДокументОснование,
		               |	ПартииТоваровОстатки.Организация = &Организация
		               |
		               |ДЛЯ ИЗМЕНЕНИЯ
		               |	РегистрНакопления.ПартииТоваров.Остатки
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) КАК Количество,
		               |	ПартииТоваровОстатки.СуммаРубли - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаРубли, 0) КАК СуммаРубли,
		               |	ПартииТоваровОстатки.СуммаДоллары - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаДоллары, 0) КАК СуммаДоллары,
		               |	ПартииТоваровОстатки.СуммаЕвро - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаЕвро, 0) КАК СуммаЕвро,
		               |	ПартииТоваровОстатки.СуммаБезНДС - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаБезНДС, 0) КАК СуммаБезНДС,
		               |	ПартииТоваровОстатки.ЭтаОрганизация КАК ЭтаОрганизация,
		               |	ПартииТоваровОстатки.СтрокаПриходаДата КАК СтрокаПриходаДата,
		               |	ПартииТоваровОстатки.ОрганизацияНаименование КАК ОрганизацияНаименование,
		               |	ПартииТоваровОстатки.ДокументОснование,
		               |	ПартииТоваровОстатки.ПустойДокументОснование КАК ПустойДокументОснование
		               |ИЗ
		               |	втПартииСвернутые КАК ПартииТоваровОстатки
		               |		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаДвиженийСвернутая КАК ТаблицаДвиженийСвернутая
		               |		ПО ПартииТоваровОстатки.Номенклатура = ТаблицаДвиженийСвернутая.Номенклатура
		               |			И ПартииТоваровОстатки.Склад = ТаблицаДвиженийСвернутая.Склад
		               |			И ПартииТоваровОстатки.Качество = ТаблицаДвиженийСвернутая.Качество
		               |			И ПартииТоваровОстатки.СтатусПартии = ТаблицаДвиженийСвернутая.СтатусПартии
		               |			И ПартииТоваровОстатки.СтрокаПрихода = ТаблицаДвиженийСвернутая.СтрокаПрихода
		               |			И ПартииТоваровОстатки.Организация = ТаблицаДвиженийСвернутая.Организация
		               |			И ПартииТоваровОстатки.ДокументОснование = ТаблицаДвиженийСвернутая.ДокументОснование
		               |ГДЕ
		               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) > 0
		               |
		               |УПОРЯДОЧИТЬ ПО
		               |	ЭтаОрганизация УБЫВ,
		               |	ОрганизацияНаименование,
		               |	ПустойДокументОснование,
		               |	СтрокаПриходаДата";
		Организация = ТаблицаПоFIFO.Получить(0).Организация;			   
		Запрос.УстановитьПараметр("Организация", Организация);
		Запрос.УстановитьПараметр("ЗапрещенныеОрганизации", ЗапрещенныеОрганизацииПродавцы(Организация, Реквизиты.Дата));
		ОтсортированаПоОрганизации = Организация;
	КонецЕсли;					   
		
	//Если УчитыватьПоставщика Тогда 
	//	Запрос.Текст = СтрЗаменить(Запрос.Текст, "%ОтборПоПоставщику%", "И СтрокаПрихода.ТорговаяТочка.Владелец = &Поставщик");
	//	Запрос.УстановитьПараметр("Поставщик", ОбщегоНазначения.ЗначениеРеквизитаОбъекта(вхСсылкаНаДокумент, "Контрагент"));
	//Иначе
	//	Запрос.Текст = СтрЗаменить(Запрос.Текст, "%ОтборПоПоставщику%", "");
	//КонецЕсли;
	
	ОстаткиПоПартиям = Запрос.Выполнить().Выгрузить();
	ОстаткиПоПартиям.Индексы.Добавить(КолонкиРаспределения);
	
	ПередаваемыеПараметры = Новый Структура;
	ПередаваемыеПараметры.Вставить("КолонкиРаспределения", КолонкиРаспределения);
	ПередаваемыеПараметры.Вставить("ЗаполняемыеРеквизиты", ЗаполняемыеРеквизиты);
	ПередаваемыеПараметры.Вставить("КонтрольНаличияПартий", КонтрольНаличияПартий);
	ПередаваемыеПараметры.Вставить("ДатаДокумента", Реквизиты.Дата);	
	ПередаваемыеПараметры.Вставить("СписыватьТолькоПоСвоейОрганизации", СтратегияПогашенияПоОрганизации.СписыватьТолькоПоСвоейОрганизации);
	ПередаваемыеПараметры.Вставить("СтратегияПогашенияПоОрганизации", СтратегияПогашенияПоОрганизации);
	
	ПогашениеПартийТоваровНовоеФрагмент(вхСсылкаНаДокумент, ТаблицаПоFIFO, ПередаваемыеПараметры, ОстаткиПоПартиям, ТаблицаДвижений, вхОтказ,,ОтсортированаПоОрганизации, ПараметрыСписания);
	
КонецПроцедуры

Процедура СписатьПоСтрокамПриходаБезУчетаСтатусаПоПоставщику(вхСсылкаНаДокумент, ТаблицаДвижений, ТаблицаПоСтрокамПриходаБезУчетаСтатуса, ТаблицаПоFIFOБезУчетаСтатуса, СтратегияПогашенияПоОрганизации, ЗаполняемыеРеквизиты, КонтрольНаличияПартий, вхОтказ, ПараметрыСписания = Неопределено)
	
	лКлючАлгоритма = "ОбщийМодуль_ПроведениеДокументовКлиентСервер_СписатьПоСтрокамПриходаБезУчетаСтатусаПоПоставщику";
	лЗамена = АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		Выполнить(лЗамена);
	КонецЕсли;
	
	ОтсортированаПоОрганизации = Неопределено; 
	ОперативноеПроведение = Неопределено;
	
	Реквизиты = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(вхСсылкаНаДокумент, "Дата,Организация");
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ТаблицаПоСтрокамПриходаБезУчетаСтатуса", ТаблицаПоСтрокамПриходаБезУчетаСтатуса);
	Запрос.УстановитьПараметр("ТаблицаДвижений", ТаблицаДвижений);
	
	ПараметрыСписания.Свойство("ОперативноеПроведение", ОперативноеПроведение);
	Если ОперативноеПроведение = Неопределено Тогда 
		ОперативноеПроведение = Ложь;
	КонецЕсли;
	
	Запрос.УстановитьПараметр("КонПериода", ?(ОперативноеПроведение, Неопределено, вхСсылкаНаДокумент.МоментВремени()));
	
	КолонкиРаспределения = "Номенклатура,Склад,Качество,СтрокаПрихода,Поставщик";
	
	Если СтратегияПогашенияПоОрганизации.ИспользуютсяМФП Тогда
		
		Если СтратегияПогашенияПоОрганизации.ПараметрыПолитикиМФП.УчитыватьОрганизациюТаблицыСписания Тогда
			КолонкиРаспределения = КолонкиРаспределения + ",Организация"; 
		КонецЕсли;
		
		Запрос.УстановитьПараметр("ТаблицаПриоритетаОрганизаций", СтратегияПогашенияПоОрганизации.ПараметрыПолитикиМФП.ОрганизацииДляЗакупки);
		
		Запрос.Текст = "ВЫБРАТЬ
		               |	ТаблицаПриоритетаОрганизаций.Приоритет КАК Приоритет,
		               |	ТаблицаПриоритетаОрганизаций.Организация КАК Организация
		               |ПОМЕСТИТЬ ТаблицаПриоритетаОрганизаций
		               |ИЗ
		               |	&ТаблицаПриоритетаОрганизаций КАК ТаблицаПриоритетаОрганизаций
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ РАЗЛИЧНЫЕ
		               |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Номенклатура КАК Номенклатура,
		               |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Склад КАК Склад,
		               |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Качество КАК Качество,
		               |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Поставщик КАК Поставщик
		               |ПОМЕСТИТЬ ТаблицаПоСтрокамПриходаБезУчетаСтатуса
		               |ИЗ
		               |	&ТаблицаПоСтрокамПриходаБезУчетаСтатуса КАК ТаблицаПоСтрокамПриходаБезУчетаСтатуса
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
		               |	ТаблицаДвижений.Склад КАК Склад,
		               |	ТаблицаДвижений.Качество КАК Качество,
		               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаДвижений.Организация КАК Организация,
		               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование,
		               |	ТаблицаДвижений.Количество КАК Количество,
		               |	ТаблицаДвижений.СуммаРубли КАК СуммаРубли,
		               |	ТаблицаДвижений.СуммаДоллары КАК СуммаДоллары,
		               |	ТаблицаДвижений.СуммаЕвро КАК СуммаЕвро,
		               |	ТаблицаДвижений.СуммаБезНДС КАК СуммаБезНДС
		               |ПОМЕСТИТЬ ТаблицаДвижений
		               |ИЗ
		               |	&ТаблицаДвижений КАК ТаблицаДвижений
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
		               |	ТаблицаДвижений.Склад КАК Склад,
		               |	ТаблицаДвижений.Качество КАК Качество,
		               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаДвижений.Организация КАК Организация,
		               |	СУММА(ТаблицаДвижений.Количество) КАК Количество,
		               |	СУММА(ТаблицаДвижений.СуммаРубли) КАК СуммаРубли,
		               |	СУММА(ТаблицаДвижений.СуммаДоллары) КАК СуммаДоллары,
		               |	СУММА(ТаблицаДвижений.СуммаЕвро) КАК СуммаЕвро,
		               |	СУММА(ТаблицаДвижений.СуммаБезНДС) КАК СуммаБезНДС,
		               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование
		               |ПОМЕСТИТЬ ТаблицаДвиженийСвернутая
		               |ИЗ
		               |	ТаблицаДвижений КАК ТаблицаДвижений
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ТаблицаДвижений.Номенклатура,
		               |	ТаблицаДвижений.Склад,
		               |	ТаблицаДвижений.Качество,
		               |	ТаблицаДвижений.СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода,
		               |	ТаблицаДвижений.Организация,
		               |	ТаблицаДвижений.ДокументОснование
		               |
		               |ИНДЕКСИРОВАТЬ ПО
		               |	Номенклатура,
		               |	Склад,
		               |	Качество,
		               |	СтатусПартии,
		               |	СтрокаПрихода,
		               |	Организация,
		               |	ДокументОснование
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.СтрокаПрихода.ТорговаяТочка.Владелец КАК Поставщик,
		               |	ПартииТоваровОстатки.СтрокаПрихода.Дата,
		               |	СУММА(ПартииТоваровОстатки.КоличествоОстаток) КАК Количество,
		               |	СУММА(ПартииТоваровОстатки.СуммаРублиОстаток) КАК СуммаРубли,
		               |	СУММА(ПартииТоваровОстатки.СуммаДолларыОстаток) КАК СуммаДоллары,
		               |	СУММА(ПартииТоваровОстатки.СуммаЕвроОстаток) КАК СуммаЕвро,
		               |	СУММА(ПартииТоваровОстатки.СуммаБезНДСОстаток) КАК СуммаБезНДС,
		               |	ПартииТоваровОстатки.Организация.Наименование КАК ОрганизацияНаименование,
		               |	ПартииТоваровОстатки.ДокументОснование
		               |ПОМЕСТИТЬ втПартии
		               |ИЗ
		               |	РегистрНакопления.ПартииТоваров.Остатки(
		               |			&КонПериода,
		               |			(Номенклатура, Склад, Качество) В
		               |				(ВЫБРАТЬ
		               |					ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Номенклатура,
		               |					ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Склад,
		               |					ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Качество
		               |				ИЗ
		               |					ТаблицаПоСтрокамПриходаБезУчетаСтатуса)) КАК ПартииТоваровОстатки
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.СтрокаПрихода.ТорговаяТочка.Владелец,
		               |	ПартииТоваровОстатки.Организация.Наименование,
		               |	ПартииТоваровОстатки.СтрокаПрихода.Дата,
		               |	ПартииТоваровОстатки.ДокументОснование
		               |
		               |ДЛЯ ИЗМЕНЕНИЯ
		               |	РегистрНакопления.ПартииТоваров.Остатки
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	втПартии.Номенклатура,
		               |	втПартии.Склад,
		               |	втПартии.Качество,
		               |	втПартии.Организация,
		               |	втПартии.СтрокаПрихода,
		               |	втПартии.СтатусПартии,
		               |	втПартии.Поставщик,
		               |	втПартии.СтрокаПриходаДата,
		               |	втПартии.Количество,
		               |	втПартии.СуммаРубли,
		               |	втПартии.СуммаДоллары,
		               |	втПартии.СуммаЕвро,
		               |	втПартии.СуммаБезНДС,
		               |	втПартии.ОрганизацияНаименование,
		               |	втПартии.ДокументОснование
		               |ПОМЕСТИТЬ втПартииСвернутые
		               |ИЗ
		               |	втПартии КАК втПартии
		               |ГДЕ
		               |	(втПартии.Номенклатура, втПартии.Склад, втПартии.Качество, втПартии.СтрокаПрихода, втПартии.Поставщик) В
		               |			(ВЫБРАТЬ
		               |				ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Номенклатура,
		               |				ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Склад,
		               |				ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Качество,
		               |				ТаблицаПоСтрокамПриходаБезУчетаСтатуса.СтрокаПрихода,
		               |				ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Поставщик
		               |			ИЗ
		               |				ТаблицаПоСтрокамПриходаБезУчетаСтатуса)
		               |	И втПартии.Организация В
		               |			(ВЫБРАТЬ
		               |				ТаблицаПриоритетаОрганизаций.Организация
		               |			ИЗ
		               |				ТаблицаПриоритетаОрганизаций)
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.Поставщик КАК Поставщик,
		               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) КАК Количество,
		               |	ПартииТоваровОстатки.СуммаРубли - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаРубли, 0) КАК СуммаРубли,
		               |	ПартииТоваровОстатки.СуммаДоллары - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаДоллары, 0) КАК СуммаДоллары,
		               |	ПартииТоваровОстатки.СуммаЕвро - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаЕвро, 0) КАК СуммаЕвро,
		               |	ПартииТоваровОстатки.СуммаБезНДС - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаБезНДС, 0) КАК СуммаБезНДС,
		               |	ПартииТоваровОстатки.ОрганизацияНаименование КАК ОрганизацияНаименование,
		               |	ПартииТоваровОстатки.ДокументОснование
		               |ИЗ
		               |	втПартииСвернутые КАК ПартииТоваровОстатки
		               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаПриоритетаОрганизаций КАК ТаблицаПриоритетаОрганизаций
		               |		ПО (ТаблицаПриоритетаОрганизаций.Организация = ПартииТоваровОстатки.Организация)
		               |		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаДвиженийСвернутая КАК ТаблицаДвиженийСвернутая
		               |		ПО ПартииТоваровОстатки.Номенклатура = ТаблицаДвиженийСвернутая.Номенклатура
		               |			И ПартииТоваровОстатки.Склад = ТаблицаДвиженийСвернутая.Склад
		               |			И ПартииТоваровОстатки.Качество = ТаблицаДвиженийСвернутая.Качество
		               |			И ПартииТоваровОстатки.СтатусПартии = ТаблицаДвиженийСвернутая.СтатусПартии
		               |			И ПартииТоваровОстатки.СтрокаПрихода = ТаблицаДвиженийСвернутая.СтрокаПрихода
		               |			И ПартииТоваровОстатки.Организация = ТаблицаДвиженийСвернутая.Организация
		               |			И ПартииТоваровОстатки.ДокументОснование = ТаблицаДвиженийСвернутая.ДокументОснование
		               |ГДЕ
		               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) > 0
		               |
		               |УПОРЯДОЧИТЬ ПО
		               |	ТаблицаПриоритетаОрганизаций.Приоритет,
		               |	ПартииТоваровОстатки.СтрокаПриходаДата,
		               |	ПартииТоваровОстатки.ОрганизацияНаименование";

		
	ИначеЕсли СтратегияПогашенияПоОрганизации.СписыватьТолькоПоСвоейОрганизации Тогда 
		КолонкиРаспределения = КолонкиРаспределения + ",Организация"; 
		
		Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
		               |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Номенклатура КАК Номенклатура,
		               |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Склад КАК Склад,
		               |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Качество КАК Качество,
		               |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Организация КАК Организация,
		               |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Поставщик КАК Поставщик
		               |ПОМЕСТИТЬ ТаблицаПоСтрокамПриходаБезУчетаСтатуса
		               |ИЗ
		               |	&ТаблицаПоСтрокамПриходаБезУчетаСтатуса КАК ТаблицаПоСтрокамПриходаБезУчетаСтатуса
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
		               |	ТаблицаДвижений.Склад КАК Склад,
		               |	ТаблицаДвижений.Качество КАК Качество,
		               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаДвижений.Организация КАК Организация,
		               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование,
		               |	ТаблицаДвижений.Количество КАК Количество,
		               |	ТаблицаДвижений.СуммаРубли КАК СуммаРубли,
		               |	ТаблицаДвижений.СуммаДоллары КАК СуммаДоллары,
		               |	ТаблицаДвижений.СуммаЕвро КАК СуммаЕвро,
		               |	ТаблицаДвижений.СуммаБезНДС КАК СуммаБезНДС
		               |ПОМЕСТИТЬ ТаблицаДвижений
		               |ИЗ
		               |	&ТаблицаДвижений КАК ТаблицаДвижений
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
		               |	ТаблицаДвижений.Склад КАК Склад,
		               |	ТаблицаДвижений.Качество КАК Качество,
		               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаДвижений.Организация КАК Организация,
		               |	СУММА(ТаблицаДвижений.Количество) КАК Количество,
		               |	СУММА(ТаблицаДвижений.СуммаРубли) КАК СуммаРубли,
		               |	СУММА(ТаблицаДвижений.СуммаДоллары) КАК СуммаДоллары,
		               |	СУММА(ТаблицаДвижений.СуммаЕвро) КАК СуммаЕвро,
		               |	СУММА(ТаблицаДвижений.СуммаБезНДС) КАК СуммаБезНДС,
		               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование
		               |ПОМЕСТИТЬ ТаблицаДвиженийСвернутая
		               |ИЗ
		               |	ТаблицаДвижений КАК ТаблицаДвижений
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ТаблицаДвижений.Номенклатура,
		               |	ТаблицаДвижений.Склад,
		               |	ТаблицаДвижений.Качество,
		               |	ТаблицаДвижений.СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода,
		               |	ТаблицаДвижений.Организация,
		               |	ТаблицаДвижений.ДокументОснование
		               |
		               |ИНДЕКСИРОВАТЬ ПО
		               |	Номенклатура,
		               |	Склад,
		               |	Качество,
		               |	СтатусПартии,
		               |	СтрокаПрихода,
		               |	Организация,
		               |	ДокументОснование
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.СтрокаПрихода.ТорговаяТочка.Владелец КАК Поставщик,
		               |	СУММА(ПартииТоваровОстатки.КоличествоОстаток) КАК Количество,
		               |	СУММА(ПартииТоваровОстатки.СуммаРублиОстаток) КАК СуммаРубли,
		               |	СУММА(ПартииТоваровОстатки.СуммаДолларыОстаток) КАК СуммаДоллары,
		               |	СУММА(ПартииТоваровОстатки.СуммаЕвроОстаток) КАК СуммаЕвро,
		               |	СУММА(ПартииТоваровОстатки.СуммаБезНДСОстаток) КАК СуммаБезНДС,
		               |	ПартииТоваровОстатки.ДокументОснование
		               |ПОМЕСТИТЬ втПартии
		               |ИЗ
		               |	РегистрНакопления.ПартииТоваров.Остатки(
		               |			&КонПериода,
		               |			(Номенклатура, Склад, Качество) В
		               |				(ВЫБРАТЬ
		               |					ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Номенклатура,
		               |					ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Склад,
		               |					ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Качество
		               |				ИЗ
		               |					ТаблицаПоСтрокамПриходаБезУчетаСтатуса)) КАК ПартииТоваровОстатки
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.СтрокаПрихода.ТорговаяТочка.Владелец,
		               |	ПартииТоваровОстатки.ДокументОснование
		               |
		               |ДЛЯ ИЗМЕНЕНИЯ
		               |	РегистрНакопления.ПартииТоваров.Остатки
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	втПартии.Номенклатура,
		               |	втПартии.Склад,
		               |	втПартии.Качество,
		               |	втПартии.Организация,
		               |	втПартии.СтрокаПрихода,
		               |	втПартии.СтатусПартии,
		               |	втПартии.Поставщик,
		               |	втПартии.Количество,
		               |	втПартии.СуммаРубли,
		               |	втПартии.СуммаДоллары,
		               |	втПартии.СуммаЕвро,
		               |	втПартии.СуммаБезНДС,
		               |	втПартии.ДокументОснование
		               |ПОМЕСТИТЬ втПартииСвернутые
		               |ИЗ
		               |	втПартии КАК втПартии
		               |ГДЕ
		               |	(втПартии.Номенклатура, втПартии.Склад, втПартии.Качество, втПартии.СтрокаПрихода, втПартии.Организация, втПартии.Поставщик) В
		               |			(ВЫБРАТЬ
		               |				ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Номенклатура,
		               |				ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Склад,
		               |				ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Качество,
		               |				ТаблицаПоСтрокамПриходаБезУчетаСтатуса.СтрокаПрихода,
		               |				ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Организация,
		               |				ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Поставщик
		               |			ИЗ
		               |				ТаблицаПоСтрокамПриходаБезУчетаСтатуса)
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.Поставщик КАК Поставщик,
		               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) КАК Количество,
		               |	ПартииТоваровОстатки.СуммаРубли - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаРубли, 0) КАК СуммаРубли,
		               |	ПартииТоваровОстатки.СуммаДоллары - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаДоллары, 0) КАК СуммаДоллары,
		               |	ПартииТоваровОстатки.СуммаЕвро - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаЕвро, 0) КАК СуммаЕвро,
		               |	ПартииТоваровОстатки.СуммаБезНДС - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаБезНДС, 0) КАК СуммаБезНДС,
		               |	ПартииТоваровОстатки.ДокументОснование
		               |ИЗ
		               |	втПартииСвернутые КАК ПартииТоваровОстатки
		               |		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаДвиженийСвернутая КАК ТаблицаДвиженийСвернутая
		               |		ПО ПартииТоваровОстатки.Номенклатура = ТаблицаДвиженийСвернутая.Номенклатура
		               |			И ПартииТоваровОстатки.Склад = ТаблицаДвиженийСвернутая.Склад
		               |			И ПартииТоваровОстатки.Качество = ТаблицаДвиженийСвернутая.Качество
		               |			И ПартииТоваровОстатки.СтатусПартии = ТаблицаДвиженийСвернутая.СтатусПартии
		               |			И ПартииТоваровОстатки.СтрокаПрихода = ТаблицаДвиженийСвернутая.СтрокаПрихода
		               |			И ПартииТоваровОстатки.Организация = ТаблицаДвиженийСвернутая.Организация
		               |			И ПартииТоваровОстатки.ДокументОснование = ТаблицаДвиженийСвернутая.ДокументОснование
		               |ГДЕ
		               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) > 0";
		Иначе
		
		Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
		               |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Номенклатура КАК Номенклатура,
		               |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Склад КАК Склад,
		               |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Качество КАК Качество,
		               |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Поставщик КАК Поставщик
		               |ПОМЕСТИТЬ ТаблицаПоСтрокамПриходаБезУчетаСтатуса
		               |ИЗ
		               |	&ТаблицаПоСтрокамПриходаБезУчетаСтатуса КАК ТаблицаПоСтрокамПриходаБезУчетаСтатуса
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
		               |	ТаблицаДвижений.Склад КАК Склад,
		               |	ТаблицаДвижений.Качество КАК Качество,
		               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаДвижений.Организация КАК Организация,
		               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование,
		               |	ТаблицаДвижений.Количество КАК Количество,
		               |	ТаблицаДвижений.СуммаРубли КАК СуммаРубли,
		               |	ТаблицаДвижений.СуммаДоллары КАК СуммаДоллары,
		               |	ТаблицаДвижений.СуммаЕвро КАК СуммаЕвро,
		               |	ТаблицаДвижений.СуммаБезНДС КАК СуммаБезНДС
		               |ПОМЕСТИТЬ ТаблицаДвижений
		               |ИЗ
		               |	&ТаблицаДвижений КАК ТаблицаДвижений
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
		               |	ТаблицаДвижений.Склад КАК Склад,
		               |	ТаблицаДвижений.Качество КАК Качество,
		               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаДвижений.Организация КАК Организация,
		               |	СУММА(ТаблицаДвижений.Количество) КАК Количество,
		               |	СУММА(ТаблицаДвижений.СуммаРубли) КАК СуммаРубли,
		               |	СУММА(ТаблицаДвижений.СуммаДоллары) КАК СуммаДоллары,
		               |	СУММА(ТаблицаДвижений.СуммаЕвро) КАК СуммаЕвро,
		               |	СУММА(ТаблицаДвижений.СуммаБезНДС) КАК СуммаБезНДС,
		               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование
		               |ПОМЕСТИТЬ ТаблицаДвиженийСвернутая
		               |ИЗ
		               |	ТаблицаДвижений КАК ТаблицаДвижений
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ТаблицаДвижений.Номенклатура,
		               |	ТаблицаДвижений.Склад,
		               |	ТаблицаДвижений.Качество,
		               |	ТаблицаДвижений.СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода,
		               |	ТаблицаДвижений.Организация,
		               |	ТаблицаДвижений.ДокументОснование
		               |
		               |ИНДЕКСИРОВАТЬ ПО
		               |	Номенклатура,
		               |	Склад,
		               |	Качество,
		               |	СтатусПартии,
		               |	СтрокаПрихода,
		               |	Организация,
		               |	ДокументОснование
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.СтрокаПрихода.ТорговаяТочка.Владелец КАК Поставщик,
		               |	ПартииТоваровОстатки.Организация = &Организация КАК ЭтаОрганизация,
		               |	СУММА(ПартииТоваровОстатки.КоличествоОстаток) КАК Количество,
		               |	СУММА(ПартииТоваровОстатки.СуммаРублиОстаток) КАК СуммаРубли,
		               |	СУММА(ПартииТоваровОстатки.СуммаДолларыОстаток) КАК СуммаДоллары,
		               |	СУММА(ПартииТоваровОстатки.СуммаЕвроОстаток) КАК СуммаЕвро,
		               |	СУММА(ПартииТоваровОстатки.СуммаБезНДСОстаток) КАК СуммаБезНДС,
		               |	ПартииТоваровОстатки.Организация.Наименование КАК ОрганизацияНаименование,
		               |	ПартииТоваровОстатки.ДокументОснование
		               |ПОМЕСТИТЬ втПартии
		               |ИЗ
		               |	РегистрНакопления.ПартииТоваров.Остатки(
		               |			&КонПериода,
		               |			(Номенклатура, Склад, Качество) В
		               |				(ВЫБРАТЬ
		               |					ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Номенклатура,
		               |					ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Склад,
		               |					ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Качество
		               |				ИЗ
		               |					ТаблицаПоСтрокамПриходаБезУчетаСтатуса)) КАК ПартииТоваровОстатки
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.СтрокаПрихода.ТорговаяТочка.Владелец,
		               |	ПартииТоваровОстатки.Организация.Наименование,
		               |	ПартииТоваровОстатки.Организация = &Организация,
		               |	ПартииТоваровОстатки.ДокументОснование
		               |
		               |ДЛЯ ИЗМЕНЕНИЯ
		               |	РегистрНакопления.ПартииТоваров.Остатки
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	втПартии.Номенклатура,
		               |	втПартии.Склад,
		               |	втПартии.Качество,
		               |	втПартии.Организация,
		               |	втПартии.СтрокаПрихода,
		               |	втПартии.СтатусПартии,
		               |	втПартии.Поставщик,
		               |	втПартии.ЭтаОрганизация,
		               |	втПартии.Количество,
		               |	втПартии.СуммаРубли,
		               |	втПартии.СуммаДоллары,
		               |	втПартии.СуммаЕвро,
		               |	втПартии.СуммаБезНДС,
		               |	втПартии.ОрганизацияНаименование,
		               |	втПартии.ДокументОснование
		               |ПОМЕСТИТЬ втПартииСвернутые
		               |ИЗ
		               |	втПартии КАК втПартии
		               |ГДЕ
		               |	(втПартии.Номенклатура, втПартии.Склад, втПартии.Качество, втПартии.СтрокаПрихода, втПартии.Поставщик) В
		               |			(ВЫБРАТЬ
		               |				ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Номенклатура,
		               |				ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Склад,
		               |				ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Качество,
		               |				ТаблицаПоСтрокамПриходаБезУчетаСтатуса.СтрокаПрихода,
		               |				ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Поставщик
		               |			ИЗ
		               |				ТаблицаПоСтрокамПриходаБезУчетаСтатуса)
		               |	И НЕ втПартии.Организация В (&ЗапрещенныеОрганизации)
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.Поставщик КАК Поставщик,
		               |	ПартииТоваровОстатки.ЭтаОрганизация КАК ЭтаОрганизация,
		               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) КАК Количество,
		               |	ПартииТоваровОстатки.СуммаРубли - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаРубли, 0) КАК СуммаРубли,
		               |	ПартииТоваровОстатки.СуммаДоллары - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаДоллары, 0) КАК СуммаДоллары,
		               |	ПартииТоваровОстатки.СуммаЕвро - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаЕвро, 0) КАК СуммаЕвро,
		               |	ПартииТоваровОстатки.СуммаБезНДС - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаБезНДС, 0) КАК СуммаБезНДС,
		               |	ПартииТоваровОстатки.ОрганизацияНаименование КАК ОрганизацияНаименование,
		               |	ПартииТоваровОстатки.ДокументОснование
		               |ИЗ
		               |	втПартииСвернутые КАК ПартииТоваровОстатки
		               |		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаДвиженийСвернутая КАК ТаблицаДвиженийСвернутая
		               |		ПО ПартииТоваровОстатки.Номенклатура = ТаблицаДвиженийСвернутая.Номенклатура
		               |			И ПартииТоваровОстатки.Склад = ТаблицаДвиженийСвернутая.Склад
		               |			И ПартииТоваровОстатки.Качество = ТаблицаДвиженийСвернутая.Качество
		               |			И ПартииТоваровОстатки.СтатусПартии = ТаблицаДвиженийСвернутая.СтатусПартии
		               |			И ПартииТоваровОстатки.СтрокаПрихода = ТаблицаДвиженийСвернутая.СтрокаПрихода
		               |			И ПартииТоваровОстатки.Организация = ТаблицаДвиженийСвернутая.Организация
		               |			И ПартииТоваровОстатки.ДокументОснование = ТаблицаДвиженийСвернутая.ДокументОснование
		               |ГДЕ
		               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) > 0
		               |
		               |УПОРЯДОЧИТЬ ПО
		               |	ЭтаОрганизация УБЫВ,
		               |	ОрганизацияНаименование";
		
		Организация = ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Получить(0).Организация;			   
		Запрос.УстановитьПараметр("Организация", Организация);
		Запрос.УстановитьПараметр("ЗапрещенныеОрганизации", ЗапрещенныеОрганизацииПродавцы(Организация, Реквизиты.Дата));
		ОтсортированаПоОрганизации = Организация;
	КонецЕсли;
	
	ОстаткиПоПартиям = Запрос.Выполнить().Выгрузить();	
	ОстаткиПоПартиям.Индексы.Добавить(КолонкиРаспределения);
	
	ПередаваемыеПараметры = Новый Структура;
	ПередаваемыеПараметры.Вставить("КолонкиРаспределения", КолонкиРаспределения);
	ПередаваемыеПараметры.Вставить("ЗаполняемыеРеквизиты", ЗаполняемыеРеквизиты);
	ПередаваемыеПараметры.Вставить("КонтрольНаличияПартий", КонтрольНаличияПартий);
	ПередаваемыеПараметры.Вставить("ДатаДокумента", Реквизиты.Дата);	
	ПередаваемыеПараметры.Вставить("СписыватьТолькоПоСвоейОрганизации", СтратегияПогашенияПоОрганизации.СписыватьТолькоПоСвоейОрганизации);
	ПередаваемыеПараметры.Вставить("СтратегияПогашенияПоОрганизации", СтратегияПогашенияПоОрганизации);
	
	ПогашениеПартийТоваровНовоеФрагмент(вхСсылкаНаДокумент, ТаблицаПоСтрокамПриходаБезУчетаСтатуса, ПередаваемыеПараметры, ОстаткиПоПартиям, ТаблицаДвижений, вхОтказ, ТаблицаПоFIFOБезУчетаСтатуса,ОтсортированаПоОрганизации, ПараметрыСписания);

КонецПроцедуры

Процедура СписатьПоСтрокамПриходаБезУчетаСтатуса(вхСсылкаНаДокумент, ТаблицаДвижений, ТаблицаПоСтрокамПриходаБезУчетаСтатуса, ТаблицаПоFIFOБезУчетаСтатуса, СтратегияПогашенияПоОрганизации, ЗаполняемыеРеквизиты, КонтрольНаличияПартий, вхОтказ, ПараметрыСписания = Неопределено)
	
	лКлючАлгоритма = "ОбщийМодуль_ПроведениеДокументовКлиентСервер_СписатьПоСтрокамПриходаБезУчетаСтатуса";
	лЗамена = АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		Выполнить(лЗамена);
	КонецЕсли;
	
	ОтсортированаПоОрганизации = Неопределено; 
	ОперативноеПроведение = Неопределено;
	
	Реквизиты = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(вхСсылкаНаДокумент, "Дата,Организация");
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ТаблицаПоСтрокамПриходаБезУчетаСтатуса", ТаблицаПоСтрокамПриходаБезУчетаСтатуса);
	Запрос.УстановитьПараметр("ТаблицаДвижений", ТаблицаДвижений);

	ПараметрыСписания.Свойство("ОперативноеПроведение", ОперативноеПроведение);
	Если ОперативноеПроведение = Неопределено Тогда 
		ОперативноеПроведение = Ложь;
	КонецЕсли;
	
	Запрос.УстановитьПараметр("КонПериода", ?(ОперативноеПроведение, Неопределено, вхСсылкаНаДокумент.МоментВремени()));

	КолонкиРаспределения = "Номенклатура,Склад,Качество,СтрокаПрихода,ВидДоговора";
	
	Если СтратегияПогашенияПоОрганизации.ИспользуютсяМФП Тогда
		
		Если СтратегияПогашенияПоОрганизации.ПараметрыПолитикиМФП.УчитыватьОрганизациюТаблицыСписания Тогда
			КолонкиРаспределения = КолонкиРаспределения + ",Организация"; 
		КонецЕсли;
		
		Запрос.УстановитьПараметр("ТаблицаПриоритетаОрганизаций", СтратегияПогашенияПоОрганизации.ПараметрыПолитикиМФП.ОрганизацииДляЗакупки);
		
				Запрос.Текст = "ВЫБРАТЬ
				               |	ТаблицаПриоритетаОрганизаций.Приоритет КАК Приоритет,
				               |	ТаблицаПриоритетаОрганизаций.Организация КАК Организация
				               |ПОМЕСТИТЬ ТаблицаПриоритетаОрганизаций
				               |ИЗ
				               |	&ТаблицаПриоритетаОрганизаций КАК ТаблицаПриоритетаОрганизаций
				               |;
				               |
				               |////////////////////////////////////////////////////////////////////////////////
				               |ВЫБРАТЬ РАЗЛИЧНЫЕ
				               |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Номенклатура КАК Номенклатура,
				               |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Склад КАК Склад,
				               |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Качество КАК Качество,
				               |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса.СтрокаПрихода КАК СтрокаПрихода,
				               |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса.ВидДоговора КАК ВидДоговора
				               |ПОМЕСТИТЬ ТаблицаПоСтрокамПриходаБезУчетаСтатуса
				               |ИЗ
				               |	&ТаблицаПоСтрокамПриходаБезУчетаСтатуса КАК ТаблицаПоСтрокамПриходаБезУчетаСтатуса
				               |;
				               |
				               |////////////////////////////////////////////////////////////////////////////////
				               |ВЫБРАТЬ
				               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
				               |	ТаблицаДвижений.Склад КАК Склад,
				               |	ТаблицаДвижений.Качество КАК Качество,
				               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
				               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
				               |	ТаблицаДвижений.Организация КАК Организация,
				               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование,
				               |	ТаблицаДвижений.Количество КАК Количество,
				               |	ТаблицаДвижений.СуммаРубли КАК СуммаРубли,
				               |	ТаблицаДвижений.СуммаДоллары КАК СуммаДоллары,
				               |	ТаблицаДвижений.СуммаЕвро КАК СуммаЕвро,
				               |	ТаблицаДвижений.СуммаБезНДС КАК СуммаБезНДС
				               |ПОМЕСТИТЬ ТаблицаДвижений
				               |ИЗ
				               |	&ТаблицаДвижений КАК ТаблицаДвижений
				               |;
				               |
				               |////////////////////////////////////////////////////////////////////////////////
				               |ВЫБРАТЬ
				               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
				               |	ТаблицаДвижений.Склад КАК Склад,
				               |	ТаблицаДвижений.Качество КАК Качество,
				               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
				               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
				               |	ТаблицаДвижений.Организация КАК Организация,
				               |	СУММА(ТаблицаДвижений.Количество) КАК Количество,
				               |	СУММА(ТаблицаДвижений.СуммаРубли) КАК СуммаРубли,
				               |	СУММА(ТаблицаДвижений.СуммаДоллары) КАК СуммаДоллары,
				               |	СУММА(ТаблицаДвижений.СуммаЕвро) КАК СуммаЕвро,
				               |	СУММА(ТаблицаДвижений.СуммаБезНДС) КАК СуммаБезНДС,
				               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование
				               |ПОМЕСТИТЬ ТаблицаДвиженийСвернутая
				               |ИЗ
				               |	ТаблицаДвижений КАК ТаблицаДвижений
				               |
				               |СГРУППИРОВАТЬ ПО
				               |	ТаблицаДвижений.Номенклатура,
				               |	ТаблицаДвижений.Склад,
				               |	ТаблицаДвижений.Качество,
				               |	ТаблицаДвижений.СтатусПартии,
				               |	ТаблицаДвижений.СтрокаПрихода,
				               |	ТаблицаДвижений.Организация,
				               |	ТаблицаДвижений.ДокументОснование
				               |
				               |ИНДЕКСИРОВАТЬ ПО
				               |	Номенклатура,
				               |	Склад,
				               |	Качество,
				               |	СтатусПартии,
				               |	СтрокаПрихода,
				               |	Организация,
				               |	ДокументОснование
				               |;
				               |
				               |////////////////////////////////////////////////////////////////////////////////
				               |ВЫБРАТЬ
				               |	ПартииТоваровОстатки.Номенклатура,
				               |	ПартииТоваровОстатки.Склад,
				               |	ПартииТоваровОстатки.Качество,
				               |	ПартииТоваровОстатки.Организация,
				               |	ПартииТоваровОстатки.СтрокаПрихода,
				               |	ПартииТоваровОстатки.СтрокаПрихода.Дата,
				               |	ВЫБОР
				               |		КОГДА ПартииТоваровОстатки.СтрокаПрихода.ДоговорКонтрагента.ВидДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
				               |			ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
				               |		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ПустаяСсылка)
				               |	КОНЕЦ КАК ВидДоговора,
				               |	ПартииТоваровОстатки.СтатусПартии,
				               |	СУММА(ПартииТоваровОстатки.КоличествоОстаток) КАК Количество,
				               |	СУММА(ПартииТоваровОстатки.СуммаРублиОстаток) КАК СуммаРубли,
				               |	СУММА(ПартииТоваровОстатки.СуммаДолларыОстаток) КАК СуммаДоллары,
				               |	СУММА(ПартииТоваровОстатки.СуммаЕвроОстаток) КАК СуммаЕвро,
				               |	СУММА(ПартииТоваровОстатки.СуммаБезНДСОстаток) КАК СуммаБезНДС,
				               |	ПартииТоваровОстатки.Организация.Наименование КАК ОрганизацияНаименование,
				               |	ПартииТоваровОстатки.ДокументОснование
				               |ПОМЕСТИТЬ втПартии
				               |ИЗ
				               |	РегистрНакопления.ПартииТоваров.Остатки(
				               |			&КонПериода,
				               |			(Номенклатура, Склад, Качество, СтрокаПрихода) В
				               |				(ВЫБРАТЬ
				               |					ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Номенклатура,
				               |					ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Склад,
				               |					ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Качество,
				               |					ТаблицаПоСтрокамПриходаБезУчетаСтатуса.СтрокаПрихода
				               |				ИЗ
				               |					ТаблицаПоСтрокамПриходаБезУчетаСтатуса)) КАК ПартииТоваровОстатки
				               |
				               |СГРУППИРОВАТЬ ПО
				               |	ПартииТоваровОстатки.Номенклатура,
				               |	ПартииТоваровОстатки.Склад,
				               |	ПартииТоваровОстатки.Качество,
				               |	ПартииТоваровОстатки.Организация,
				               |	ПартииТоваровОстатки.СтрокаПрихода,
				               |	ПартииТоваровОстатки.СтатусПартии,
				               |	ПартииТоваровОстатки.Организация.Наименование,
				               |	ВЫБОР
				               |		КОГДА ПартииТоваровОстатки.СтрокаПрихода.ДоговорКонтрагента.ВидДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
				               |			ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
				               |		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ПустаяСсылка)
				               |	КОНЕЦ,
				               |	ПартииТоваровОстатки.СтрокаПрихода.Дата,
				               |	ПартииТоваровОстатки.ДокументОснование
				               |
				               |ДЛЯ ИЗМЕНЕНИЯ
				               |	РегистрНакопления.ПартииТоваров.Остатки
				               |;
				               |
				               |////////////////////////////////////////////////////////////////////////////////
				               |ВЫБРАТЬ
				               |	втПартии.Номенклатура,
				               |	втПартии.Склад,
				               |	втПартии.Качество,
				               |	втПартии.Организация,
				               |	втПартии.СтрокаПрихода,
				               |	втПартии.СтрокаПриходаДата,
				               |	втПартии.ВидДоговора,
				               |	втПартии.СтатусПартии,
				               |	втПартии.Количество,
				               |	втПартии.СуммаРубли,
				               |	втПартии.СуммаДоллары,
				               |	втПартии.СуммаЕвро,
				               |	втПартии.СуммаБезНДС,
				               |	втПартии.ОрганизацияНаименование,
				               |	втПартии.ДокументОснование
				               |ПОМЕСТИТЬ втПартииСвернутые
				               |ИЗ
				               |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса КАК ТаблицаПоСтрокамПриходаБезУчетаСтатуса
				               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ втПартии КАК втПартии
				               |		ПО ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Номенклатура = втПартии.Номенклатура
				               |			И ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Склад = втПартии.Склад
				               |			И ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Качество = втПартии.Качество
				               |			И ТаблицаПоСтрокамПриходаБезУчетаСтатуса.СтрокаПрихода = втПартии.СтрокаПрихода
				               |			И ТаблицаПоСтрокамПриходаБезУчетаСтатуса.ВидДоговора = втПартии.ВидДоговора
				               |ГДЕ
				               |	втПартии.Организация В
				               |			(ВЫБРАТЬ
				               |				ТаблицаПриоритетаОрганизаций.Организация
				               |			ИЗ
				               |				ТаблицаПриоритетаОрганизаций)
				               |;
				               |
				               |////////////////////////////////////////////////////////////////////////////////
				               |ВЫБРАТЬ
				               |	ПартииТоваровОстатки.Номенклатура,
				               |	ПартииТоваровОстатки.Склад,
				               |	ПартииТоваровОстатки.Качество,
				               |	ПартииТоваровОстатки.Организация,
				               |	ПартииТоваровОстатки.СтрокаПрихода,
				               |	ПартииТоваровОстатки.ВидДоговора КАК ВидДоговора,
				               |	ПартииТоваровОстатки.СтатусПартии,
				               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) КАК Количество,
				               |	ПартииТоваровОстатки.СуммаРубли - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаРубли, 0) КАК СуммаРубли,
				               |	ПартииТоваровОстатки.СуммаДоллары - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаДоллары, 0) КАК СуммаДоллары,
				               |	ПартииТоваровОстатки.СуммаЕвро - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаЕвро, 0) КАК СуммаЕвро,
				               |	ПартииТоваровОстатки.СуммаБезНДС - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаБезНДС, 0) КАК СуммаБезНДС,
				               |	ПартииТоваровОстатки.ОрганизацияНаименование КАК ОрганизацияНаименование,
				               |	ПартииТоваровОстатки.ДокументОснование
				               |ИЗ
				               |	втПартииСвернутые КАК ПартииТоваровОстатки
				               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаПриоритетаОрганизаций КАК ТаблицаПриоритетаОрганизаций
				               |		ПО (ТаблицаПриоритетаОрганизаций.Организация = ПартииТоваровОстатки.Организация)
				               |		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаДвиженийСвернутая КАК ТаблицаДвиженийСвернутая
				               |		ПО ПартииТоваровОстатки.Номенклатура = ТаблицаДвиженийСвернутая.Номенклатура
				               |			И ПартииТоваровОстатки.Склад = ТаблицаДвиженийСвернутая.Склад
				               |			И ПартииТоваровОстатки.Качество = ТаблицаДвиженийСвернутая.Качество
				               |			И ПартииТоваровОстатки.СтатусПартии = ТаблицаДвиженийСвернутая.СтатусПартии
				               |			И ПартииТоваровОстатки.СтрокаПрихода = ТаблицаДвиженийСвернутая.СтрокаПрихода
				               |			И ПартииТоваровОстатки.Организация = ТаблицаДвиженийСвернутая.Организация
				               |			И ПартииТоваровОстатки.ДокументОснование = ТаблицаДвиженийСвернутая.ДокументОснование
				               |ГДЕ
				               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) > 0
				               |
				               |УПОРЯДОЧИТЬ ПО
				               |	ТаблицаПриоритетаОрганизаций.Приоритет,
				               |	ПартииТоваровОстатки.СтрокаПриходаДата,
				               |	ПартииТоваровОстатки.ОрганизацияНаименование";
		
	ИначеЕсли СтратегияПогашенияПоОрганизации.СписыватьТолькоПоСвоейОрганизации Тогда 
		КолонкиРаспределения = КолонкиРаспределения + ",Организация"; 
		Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
		               |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Номенклатура КАК Номенклатура,
		               |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Склад КАК Склад,
		               |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Качество КАК Качество,
		               |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса.ВидДоговора КАК ВидДоговора,
		               |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Организация КАК Организация
		               |ПОМЕСТИТЬ ТаблицаПоСтрокамПриходаБезУчетаСтатуса
		               |ИЗ
		               |	&ТаблицаПоСтрокамПриходаБезУчетаСтатуса КАК ТаблицаПоСтрокамПриходаБезУчетаСтатуса
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
		               |	ТаблицаДвижений.Склад КАК Склад,
		               |	ТаблицаДвижений.Качество КАК Качество,
		               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаДвижений.Организация КАК Организация,
		               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование,
		               |	ТаблицаДвижений.Количество КАК Количество,
		               |	ТаблицаДвижений.СуммаРубли КАК СуммаРубли,
		               |	ТаблицаДвижений.СуммаДоллары КАК СуммаДоллары,
		               |	ТаблицаДвижений.СуммаЕвро КАК СуммаЕвро,
		               |	ТаблицаДвижений.СуммаБезНДС КАК СуммаБезНДС
		               |ПОМЕСТИТЬ ТаблицаДвижений
		               |ИЗ
		               |	&ТаблицаДвижений КАК ТаблицаДвижений
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
		               |	ТаблицаДвижений.Склад КАК Склад,
		               |	ТаблицаДвижений.Качество КАК Качество,
		               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаДвижений.Организация КАК Организация,
		               |	СУММА(ТаблицаДвижений.Количество) КАК Количество,
		               |	СУММА(ТаблицаДвижений.СуммаРубли) КАК СуммаРубли,
		               |	СУММА(ТаблицаДвижений.СуммаДоллары) КАК СуммаДоллары,
		               |	СУММА(ТаблицаДвижений.СуммаЕвро) КАК СуммаЕвро,
		               |	СУММА(ТаблицаДвижений.СуммаБезНДС) КАК СуммаБезНДС,
		               |	ТаблицаДвижений.ДокументОснование
		               |ПОМЕСТИТЬ ТаблицаДвиженийСвернутая
		               |ИЗ
		               |	ТаблицаДвижений КАК ТаблицаДвижений
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ТаблицаДвижений.Номенклатура,
		               |	ТаблицаДвижений.Склад,
		               |	ТаблицаДвижений.Качество,
		               |	ТаблицаДвижений.СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода,
		               |	ТаблицаДвижений.Организация,
		               |	ТаблицаДвижений.ДокументОснование
		               |
		               |ИНДЕКСИРОВАТЬ ПО
		               |	Номенклатура,
		               |	Склад,
		               |	Качество,
		               |	СтатусПартии,
		               |	СтрокаПрихода,
		               |	Организация
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ВЫБОР
		               |		КОГДА ПартииТоваровОстатки.СтрокаПрихода.ДоговорКонтрагента.ВидДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
		               |			ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
		               |		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ПустаяСсылка)
		               |	КОНЕЦ КАК ВидДоговора,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	СУММА(ПартииТоваровОстатки.КоличествоОстаток) КАК Количество,
		               |	СУММА(ПартииТоваровОстатки.СуммаРублиОстаток) КАК СуммаРубли,
		               |	СУММА(ПартииТоваровОстатки.СуммаДолларыОстаток) КАК СуммаДоллары,
		               |	СУММА(ПартииТоваровОстатки.СуммаЕвроОстаток) КАК СуммаЕвро,
		               |	СУММА(ПартииТоваровОстатки.СуммаБезНДСОстаток) КАК СуммаБезНДС,
		               |	ПартииТоваровОстатки.Организация.Наименование КАК ОрганизацияНаименование,
		               |	ПартииТоваровОстатки.ДокументОснование
		               |ПОМЕСТИТЬ втПартии
		               |ИЗ
		               |	РегистрНакопления.ПартииТоваров.Остатки(
		               |			&КонПериода,
		               |			(Номенклатура, Склад, Качество, СтрокаПрихода) В
		               |				(ВЫБРАТЬ
		               |					ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Номенклатура,
		               |					ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Склад,
		               |					ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Качество,
		               |					ТаблицаПоСтрокамПриходаБезУчетаСтатуса.СтрокаПрихода
		               |				ИЗ
		               |					ТаблицаПоСтрокамПриходаБезУчетаСтатуса)) КАК ПартииТоваровОстатки
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ВЫБОР
		               |		КОГДА ПартииТоваровОстатки.СтрокаПрихода.ДоговорКонтрагента.ВидДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
		               |			ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
		               |		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ПустаяСсылка)
		               |	КОНЕЦ,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.Организация.Наименование,
		               |	ПартииТоваровОстатки.ДокументОснование
		               |
		               |ДЛЯ ИЗМЕНЕНИЯ
		               |	РегистрНакопления.ПартииТоваров.Остатки
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	втПартии.Номенклатура,
		               |	втПартии.Склад,
		               |	втПартии.Качество,
		               |	втПартии.Организация,
		               |	втПартии.СтрокаПрихода,
		               |	втПартии.ВидДоговора,
		               |	втПартии.СтатусПартии,
		               |	втПартии.Количество,
		               |	втПартии.СуммаРубли,
		               |	втПартии.СуммаДоллары,
		               |	втПартии.СуммаЕвро,
		               |	втПартии.СуммаБезНДС,
		               |	втПартии.ОрганизацияНаименование,
		               |	втПартии.ДокументОснование
		               |ПОМЕСТИТЬ втПартииСвернутые
		               |ИЗ
		               |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса КАК ТаблицаПоСтрокамПриходаБезУчетаСтатуса
		               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ втПартии КАК втПартии
		               |		ПО ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Номенклатура = втПартии.Номенклатура
		               |			И ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Склад = втПартии.Склад
		               |			И ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Качество = втПартии.Качество
		               |			И ТаблицаПоСтрокамПриходаБезУчетаСтатуса.СтрокаПрихода = втПартии.СтрокаПрихода
		               |			И ТаблицаПоСтрокамПриходаБезУчетаСтатуса.ВидДоговора = втПартии.ВидДоговора
		               |			И ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Организация = втПартии.Организация
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.ВидДоговора КАК ВидДоговора,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) КАК Количество,
		               |	ПартииТоваровОстатки.СуммаРубли - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаРубли, 0) КАК СуммаРубли,
		               |	ПартииТоваровОстатки.СуммаДоллары - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаДоллары, 0) КАК СуммаДоллары,
		               |	ПартииТоваровОстатки.СуммаЕвро - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаЕвро, 0) КАК СуммаЕвро,
		               |	ПартииТоваровОстатки.СуммаБезНДС - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаБезНДС, 0) КАК СуммаБезНДС,
		               |	ПартииТоваровОстатки.ОрганизацияНаименование КАК ОрганизацияНаименование,
		               |	ПартииТоваровОстатки.ДокументОснование
		               |ИЗ
		               |	втПартииСвернутые КАК ПартииТоваровОстатки
		               |		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаДвиженийСвернутая КАК ТаблицаДвиженийСвернутая
		               |		ПО ПартииТоваровОстатки.Номенклатура = ТаблицаДвиженийСвернутая.Номенклатура
		               |			И ПартииТоваровОстатки.Склад = ТаблицаДвиженийСвернутая.Склад
		               |			И ПартииТоваровОстатки.Качество = ТаблицаДвиженийСвернутая.Качество
		               |			И ПартииТоваровОстатки.СтатусПартии = ТаблицаДвиженийСвернутая.СтатусПартии
		               |			И ПартииТоваровОстатки.СтрокаПрихода = ТаблицаДвиженийСвернутая.СтрокаПрихода
		               |			И ПартииТоваровОстатки.Организация = ТаблицаДвиженийСвернутая.Организация
		               |			И ПартииТоваровОстатки.ДокументОснование = ТаблицаДвиженийСвернутая.ДокументОснование
		               |ГДЕ
		               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) > 0";
		
		
		//Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
		//               |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Номенклатура КАК Номенклатура,
		//               |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Склад КАК Склад,
		//               |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Качество КАК Качество,
		//               |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса.СтрокаПрихода КАК СтрокаПрихода,
		//               |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса.ВидДоговора КАК ВидДоговора,
		//               |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Организация КАК Организация
		//               |ПОМЕСТИТЬ ТаблицаПоСтрокамПриходаБезУчетаСтатуса
		//               |ИЗ
		//               |	&ТаблицаПоСтрокамПриходаБезУчетаСтатуса КАК ТаблицаПоСтрокамПриходаБезУчетаСтатуса
		//               |;
		//               |
		//               |////////////////////////////////////////////////////////////////////////////////
		//               |ВЫБРАТЬ
		//               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
		//               |	ТаблицаДвижений.Склад КАК Склад,
		//               |	ТаблицаДвижений.Качество КАК Качество,
		//               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
		//               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
		//               |	ТаблицаДвижений.Организация КАК Организация,
		//               |	ТаблицаДвижений.Количество КАК Количество,
		//               |	ТаблицаДвижений.СуммаРубли КАК СуммаРубли,
		//               |	ТаблицаДвижений.СуммаДоллары КАК СуммаДоллары,
		//               |	ТаблицаДвижений.СуммаЕвро КАК СуммаЕвро,
		//               |	ТаблицаДвижений.СуммаБезНДС КАК СуммаБезНДС
		//               |ПОМЕСТИТЬ ТаблицаДвижений
		//               |ИЗ
		//               |	&ТаблицаДвижений КАК ТаблицаДвижений
		//               |;
		//               |
		//               |////////////////////////////////////////////////////////////////////////////////
		//               |ВЫБРАТЬ
		//               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
		//               |	ТаблицаДвижений.Склад КАК Склад,
		//               |	ТаблицаДвижений.Качество КАК Качество,
		//               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
		//               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
		//               |	ТаблицаДвижений.Организация КАК Организация,
		//               |	СУММА(ТаблицаДвижений.Количество) КАК Количество,
		//               |	СУММА(ТаблицаДвижений.СуммаРубли) КАК СуммаРубли,
		//               |	СУММА(ТаблицаДвижений.СуммаДоллары) КАК СуммаДоллары,
		//               |	СУММА(ТаблицаДвижений.СуммаЕвро) КАК СуммаЕвро,
		//               |	СУММА(ТаблицаДвижений.СуммаБезНДС) КАК СуммаБезНДС
		//               |ПОМЕСТИТЬ ТаблицаДвиженийСвернутая
		//               |ИЗ
		//               |	ТаблицаДвижений КАК ТаблицаДвижений
		//               |
		//               |СГРУППИРОВАТЬ ПО
		//               |	ТаблицаДвижений.Номенклатура,
		//               |	ТаблицаДвижений.Склад,
		//               |	ТаблицаДвижений.Качество,
		//               |	ТаблицаДвижений.СтатусПартии,
		//               |	ТаблицаДвижений.СтрокаПрихода,
		//               |	ТаблицаДвижений.Организация
		//               |
		//               |ИНДЕКСИРОВАТЬ ПО
		//               |	Номенклатура,
		//               |	Склад,
		//               |	Качество,
		//               |	СтатусПартии,
		//               |	СтрокаПрихода,
		//               |	Организация
		//               |;
		//               |
		//               |////////////////////////////////////////////////////////////////////////////////
		//               |ВЫБРАТЬ
		//               |	ПартииТоваровОстатки.Номенклатура,
		//               |	ПартииТоваровОстатки.Склад,
		//               |	ПартииТоваровОстатки.Качество,
		//               |	ПартииТоваровОстатки.Организация,
		//               |	ПартииТоваровОстатки.СтрокаПрихода,
		//               |	ВЫБОР
		//               |		КОГДА ПартииТоваровОстатки.СтрокаПрихода.ДоговорКонтрагента.ВидДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
		//               |			ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
		//               |		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ПустаяСсылка)
		//               |	КОНЕЦ КАК ВидДоговора,
		//               |	ПартииТоваровОстатки.СтатусПартии,
		//               |	СУММА(ПартииТоваровОстатки.КоличествоОстаток) КАК Количество,
		//               |	СУММА(ПартииТоваровОстатки.СуммаРублиОстаток) КАК СуммаРубли,
		//               |	СУММА(ПартииТоваровОстатки.СуммаДолларыОстаток) КАК СуммаДоллары,
		//               |	СУММА(ПартииТоваровОстатки.СуммаЕвроОстаток) КАК СуммаЕвро,
		//               |	СУММА(ПартииТоваровОстатки.СуммаБезНДСОстаток) КАК СуммаБезНДС,
		//               |	ПартииТоваровОстатки.Организация.Наименование КАК ОрганизацияНаименование
		//               |ПОМЕСТИТЬ втПартииСвернутые
		//               |ИЗ
		//               |	РегистрНакопления.ПартииТоваров.Остатки(
		//               |			&КонПериода,
		//               |			(Номенклатура, Склад, Качество, СтрокаПрихода, ВЫБОР
		//               |				КОГДА СтрокаПрихода.ДоговорКонтрагента.ВидДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
		//               |					ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
		//               |				ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ПустаяСсылка)
		//               |			КОНЕЦ, Организация) В
		//               |				(ВЫБРАТЬ
		//               |					ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Номенклатура,
		//               |					ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Склад,
		//               |					ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Качество,
		//               |					ТаблицаПоСтрокамПриходаБезУчетаСтатуса.СтрокаПрихода,
		//               |					ТаблицаПоСтрокамПриходаБезУчетаСтатуса.ВидДоговора,
		//               |					ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Организация
		//               |				ИЗ
		//               |					ТаблицаПоСтрокамПриходаБезУчетаСтатуса)) КАК ПартииТоваровОстатки
		//               |
		//               |СГРУППИРОВАТЬ ПО
		//               |	ПартииТоваровОстатки.Номенклатура,
		//               |	ПартииТоваровОстатки.Склад,
		//               |	ПартииТоваровОстатки.Качество,
		//               |	ПартииТоваровОстатки.Организация,
		//               |	ПартииТоваровОстатки.СтрокаПрихода,
		//               |	ВЫБОР
		//               |		КОГДА ПартииТоваровОстатки.СтрокаПрихода.ДоговорКонтрагента.ВидДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
		//               |			ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
		//               |		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ПустаяСсылка)
		//               |	КОНЕЦ,
		//               |	ПартииТоваровОстатки.СтатусПартии,
		//               |	ПартииТоваровОстатки.Организация.Наименование
		//               |
		//               |ДЛЯ ИЗМЕНЕНИЯ
		//               |	РегистрНакопления.ПартииТоваров.Остатки
		//               |;
		//               |
		//               |////////////////////////////////////////////////////////////////////////////////
		//               |ВЫБРАТЬ
		//               |	ПартииТоваровОстатки.Номенклатура,
		//               |	ПартииТоваровОстатки.Склад,
		//               |	ПартииТоваровОстатки.Качество,
		//               |	ПартииТоваровОстатки.Организация,
		//               |	ПартииТоваровОстатки.СтрокаПрихода,
		//               |	ПартииТоваровОстатки.ВидДоговора КАК ВидДоговора,
		//               |	ПартииТоваровОстатки.СтатусПартии,
		//               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) КАК Количество,
		//               |	ПартииТоваровОстатки.СуммаРубли - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаРубли, 0) КАК СуммаРубли,
		//               |	ПартииТоваровОстатки.СуммаДоллары - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаДоллары, 0) КАК СуммаДоллары,
		//               |	ПартииТоваровОстатки.СуммаЕвро - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаЕвро, 0) КАК СуммаЕвро,
		//               |	ПартииТоваровОстатки.СуммаБезНДС - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаБезНДС, 0) КАК СуммаБезНДС,
		//               |	ПартииТоваровОстатки.ОрганизацияНаименование КАК ОрганизацияНаименование
		//               |ИЗ
		//               |	втПартииСвернутые КАК ПартииТоваровОстатки
		//               |		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаДвиженийСвернутая КАК ТаблицаДвиженийСвернутая
		//               |		ПО ПартииТоваровОстатки.Номенклатура = ТаблицаДвиженийСвернутая.Номенклатура
		//               |			И ПартииТоваровОстатки.Склад = ТаблицаДвиженийСвернутая.Склад
		//               |			И ПартииТоваровОстатки.Качество = ТаблицаДвиженийСвернутая.Качество
		//               |			И ПартииТоваровОстатки.СтатусПартии = ТаблицаДвиженийСвернутая.СтатусПартии
		//               |			И ПартииТоваровОстатки.СтрокаПрихода = ТаблицаДвиженийСвернутая.СтрокаПрихода
		//               |			И ПартииТоваровОстатки.Организация = ТаблицаДвиженийСвернутая.Организация
		//               |ГДЕ
		//               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) > 0";					   
		
		Иначе
		Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
		               |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Номенклатура КАК Номенклатура,
		               |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Склад КАК Склад,
		               |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Качество КАК Качество,
		               |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса.ВидДоговора КАК ВидДоговора
		               |ПОМЕСТИТЬ ТаблицаПоСтрокамПриходаБезУчетаСтатуса
		               |ИЗ
		               |	&ТаблицаПоСтрокамПриходаБезУчетаСтатуса КАК ТаблицаПоСтрокамПриходаБезУчетаСтатуса
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
		               |	ТаблицаДвижений.Склад КАК Склад,
		               |	ТаблицаДвижений.Качество КАК Качество,
		               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаДвижений.Организация КАК Организация,
		               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование,
		               |	ТаблицаДвижений.Количество КАК Количество,
		               |	ТаблицаДвижений.СуммаРубли КАК СуммаРубли,
		               |	ТаблицаДвижений.СуммаДоллары КАК СуммаДоллары,
		               |	ТаблицаДвижений.СуммаЕвро КАК СуммаЕвро,
		               |	ТаблицаДвижений.СуммаБезНДС КАК СуммаБезНДС
		               |ПОМЕСТИТЬ ТаблицаДвижений
		               |ИЗ
		               |	&ТаблицаДвижений КАК ТаблицаДвижений
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
		               |	ТаблицаДвижений.Склад КАК Склад,
		               |	ТаблицаДвижений.Качество КАК Качество,
		               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаДвижений.Организация КАК Организация,
		               |	СУММА(ТаблицаДвижений.Количество) КАК Количество,
		               |	СУММА(ТаблицаДвижений.СуммаРубли) КАК СуммаРубли,
		               |	СУММА(ТаблицаДвижений.СуммаДоллары) КАК СуммаДоллары,
		               |	СУММА(ТаблицаДвижений.СуммаЕвро) КАК СуммаЕвро,
		               |	СУММА(ТаблицаДвижений.СуммаБезНДС) КАК СуммаБезНДС,
		               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование
		               |ПОМЕСТИТЬ ТаблицаДвиженийСвернутая
		               |ИЗ
		               |	ТаблицаДвижений КАК ТаблицаДвижений
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ТаблицаДвижений.Номенклатура,
		               |	ТаблицаДвижений.Склад,
		               |	ТаблицаДвижений.Качество,
		               |	ТаблицаДвижений.СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода,
		               |	ТаблицаДвижений.Организация,
		               |	ТаблицаДвижений.ДокументОснование
		               |
		               |ИНДЕКСИРОВАТЬ ПО
		               |	Номенклатура,
		               |	Склад,
		               |	Качество,
		               |	СтатусПартии,
		               |	СтрокаПрихода,
		               |	Организация,
		               |	ДокументОснование
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ВЫБОР
		               |		КОГДА ПартииТоваровОстатки.СтрокаПрихода.ДоговорКонтрагента.ВидДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
		               |			ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
		               |		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ПустаяСсылка)
		               |	КОНЕЦ КАК ВидДоговора,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.Организация = &Организация КАК ЭтаОрганизация,
		               |	СУММА(ПартииТоваровОстатки.КоличествоОстаток) КАК Количество,
		               |	СУММА(ПартииТоваровОстатки.СуммаРублиОстаток) КАК СуммаРубли,
		               |	СУММА(ПартииТоваровОстатки.СуммаДолларыОстаток) КАК СуммаДоллары,
		               |	СУММА(ПартииТоваровОстатки.СуммаЕвроОстаток) КАК СуммаЕвро,
		               |	СУММА(ПартииТоваровОстатки.СуммаБезНДСОстаток) КАК СуммаБезНДС,
		               |	ПартииТоваровОстатки.Организация.Наименование КАК ОрганизацияНаименование,
		               |	ПартииТоваровОстатки.ДокументОснование
		               |ПОМЕСТИТЬ втПартии
		               |ИЗ
		               |	РегистрНакопления.ПартииТоваров.Остатки(
		               |			&КонПериода,
		               |			(Номенклатура, Склад, Качество, СтрокаПрихода) В
		               |				(ВЫБРАТЬ
		               |					ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Номенклатура,
		               |					ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Склад,
		               |					ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Качество,
		               |					ТаблицаПоСтрокамПриходаБезУчетаСтатуса.СтрокаПрихода
		               |				ИЗ
		               |					ТаблицаПоСтрокамПриходаБезУчетаСтатуса)) КАК ПартииТоваровОстатки
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.Организация.Наименование,
		               |	ВЫБОР
		               |		КОГДА ПартииТоваровОстатки.СтрокаПрихода.ДоговорКонтрагента.ВидДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
		               |			ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
		               |		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ПустаяСсылка)
		               |	КОНЕЦ,
		               |	ПартииТоваровОстатки.Организация = &Организация,
		               |	ПартииТоваровОстатки.ДокументОснование
		               |
		               |ДЛЯ ИЗМЕНЕНИЯ
		               |	РегистрНакопления.ПартииТоваров.Остатки
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	втПартии.Номенклатура,
		               |	втПартии.Склад,
		               |	втПартии.Качество,
		               |	втПартии.Организация,
		               |	втПартии.СтрокаПрихода,
		               |	втПартии.ВидДоговора,
		               |	втПартии.СтатусПартии,
		               |	втПартии.ЭтаОрганизация,
		               |	втПартии.Количество,
		               |	втПартии.СуммаРубли,
		               |	втПартии.СуммаДоллары,
		               |	втПартии.СуммаЕвро,
		               |	втПартии.СуммаБезНДС,
		               |	втПартии.ОрганизацияНаименование,
		               |	втПартии.ДокументОснование
		               |ПОМЕСТИТЬ втПартииСвернутые
		               |ИЗ
		               |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса КАК ТаблицаПоСтрокамПриходаБезУчетаСтатуса
		               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ втПартии КАК втПартии
		               |		ПО ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Номенклатура = втПартии.Номенклатура
		               |			И ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Склад = втПартии.Склад
		               |			И ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Качество = втПартии.Качество
		               |			И ТаблицаПоСтрокамПриходаБезУчетаСтатуса.СтрокаПрихода = втПартии.СтрокаПрихода
		               |			И ТаблицаПоСтрокамПриходаБезУчетаСтатуса.ВидДоговора = втПартии.ВидДоговора
		               |ГДЕ
		               |	НЕ втПартии.Организация В (&ЗапрещенныеОрганизации)
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.ВидДоговора КАК ВидДоговора,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.ЭтаОрганизация КАК ЭтаОрганизация,
		               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) КАК Количество,
		               |	ПартииТоваровОстатки.СуммаРубли - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаРубли, 0) КАК СуммаРубли,
		               |	ПартииТоваровОстатки.СуммаДоллары - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаДоллары, 0) КАК СуммаДоллары,
		               |	ПартииТоваровОстатки.СуммаЕвро - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаЕвро, 0) КАК СуммаЕвро,
		               |	ПартииТоваровОстатки.СуммаБезНДС - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаБезНДС, 0) КАК СуммаБезНДС,
		               |	ПартииТоваровОстатки.ОрганизацияНаименование КАК ОрганизацияНаименование,
		               |	ПартииТоваровОстатки.ДокументОснование
		               |ИЗ
		               |	втПартииСвернутые КАК ПартииТоваровОстатки
		               |		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаДвиженийСвернутая КАК ТаблицаДвиженийСвернутая
		               |		ПО ПартииТоваровОстатки.Номенклатура = ТаблицаДвиженийСвернутая.Номенклатура
		               |			И ПартииТоваровОстатки.Склад = ТаблицаДвиженийСвернутая.Склад
		               |			И ПартииТоваровОстатки.Качество = ТаблицаДвиженийСвернутая.Качество
		               |			И ПартииТоваровОстатки.СтатусПартии = ТаблицаДвиженийСвернутая.СтатусПартии
		               |			И ПартииТоваровОстатки.СтрокаПрихода = ТаблицаДвиженийСвернутая.СтрокаПрихода
		               |			И ПартииТоваровОстатки.Организация = ТаблицаДвиженийСвернутая.Организация
		               |			И ПартииТоваровОстатки.ДокументОснование = ТаблицаДвиженийСвернутая.ДокументОснование
		               |ГДЕ
		               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) > 0
		               |
		               |УПОРЯДОЧИТЬ ПО
		               |	ЭтаОрганизация УБЫВ,
		               |	ОрганизацияНаименование";
				//Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
				//       |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Номенклатура КАК Номенклатура,
				//       |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Склад КАК Склад,
				//       |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Качество КАК Качество,
				//       |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса.СтрокаПрихода КАК СтрокаПрихода,
				//       |	ТаблицаПоСтрокамПриходаБезУчетаСтатуса.ВидДоговора КАК ВидДоговора
				//       |ПОМЕСТИТЬ ТаблицаПоСтрокамПриходаБезУчетаСтатуса
				//       |ИЗ
				//       |	&ТаблицаПоСтрокамПриходаБезУчетаСтатуса КАК ТаблицаПоСтрокамПриходаБезУчетаСтатуса
				//       |;
				//       |
				//       |////////////////////////////////////////////////////////////////////////////////
				//       |ВЫБРАТЬ
				//       |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
				//       |	ТаблицаДвижений.Склад КАК Склад,
				//       |	ТаблицаДвижений.Качество КАК Качество,
				//       |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
				//       |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
				//       |	ТаблицаДвижений.Организация КАК Организация,
				//       |	ТаблицаДвижений.Количество КАК Количество,
				//       |	ТаблицаДвижений.СуммаРубли КАК СуммаРубли,
				//       |	ТаблицаДвижений.СуммаДоллары КАК СуммаДоллары,
				//       |	ТаблицаДвижений.СуммаЕвро КАК СуммаЕвро,
				//       |	ТаблицаДвижений.СуммаБезНДС КАК СуммаБезНДС
				//       |ПОМЕСТИТЬ ТаблицаДвижений
				//       |ИЗ
				//       |	&ТаблицаДвижений КАК ТаблицаДвижений
				//       |;
				//       |
				//       |////////////////////////////////////////////////////////////////////////////////
				//       |ВЫБРАТЬ
				//       |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
				//       |	ТаблицаДвижений.Склад КАК Склад,
				//       |	ТаблицаДвижений.Качество КАК Качество,
				//       |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
				//       |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
				//       |	ТаблицаДвижений.Организация КАК Организация,
				//       |	СУММА(ТаблицаДвижений.Количество) КАК Количество,
				//       |	СУММА(ТаблицаДвижений.СуммаРубли) КАК СуммаРубли,
				//       |	СУММА(ТаблицаДвижений.СуммаДоллары) КАК СуммаДоллары,
				//       |	СУММА(ТаблицаДвижений.СуммаЕвро) КАК СуммаЕвро,
				//       |	СУММА(ТаблицаДвижений.СуммаБезНДС) КАК СуммаБезНДС
				//       |ПОМЕСТИТЬ ТаблицаДвиженийСвернутая
				//       |ИЗ
				//       |	ТаблицаДвижений КАК ТаблицаДвижений
				//       |
				//       |СГРУППИРОВАТЬ ПО
				//       |	ТаблицаДвижений.Номенклатура,
				//       |	ТаблицаДвижений.Склад,
				//       |	ТаблицаДвижений.Качество,
				//       |	ТаблицаДвижений.СтатусПартии,
				//       |	ТаблицаДвижений.СтрокаПрихода,
				//       |	ТаблицаДвижений.Организация
				//       |
				//       |ИНДЕКСИРОВАТЬ ПО
				//       |	Номенклатура,
				//       |	Склад,
				//       |	Качество,
				//       |	СтатусПартии,
				//       |	СтрокаПрихода,
				//       |	Организация
				//       |;
				//       |
				//       |////////////////////////////////////////////////////////////////////////////////
				//       |ВЫБРАТЬ
				//       |	ПартииТоваровОстатки.Номенклатура,
				//       |	ПартииТоваровОстатки.Склад,
				//       |	ПартииТоваровОстатки.Качество,
				//       |	ПартииТоваровОстатки.Организация,
				//       |	ПартииТоваровОстатки.СтрокаПрихода,
				//       |	ВЫБОР
				//       |		КОГДА ПартииТоваровОстатки.СтрокаПрихода.ДоговорКонтрагента.ВидДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
				//       |			ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
				//       |		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ПустаяСсылка)
				//       |	КОНЕЦ КАК ВидДоговора,
				//       |	ПартииТоваровОстатки.СтатусПартии,
				//       |	ПартииТоваровОстатки.Организация = &Организация КАК ЭтаОрганизация,
				//       |	СУММА(ПартииТоваровОстатки.КоличествоОстаток) КАК Количество,
				//       |	СУММА(ПартииТоваровОстатки.СуммаРублиОстаток) КАК СуммаРубли,
				//       |	СУММА(ПартииТоваровОстатки.СуммаДолларыОстаток) КАК СуммаДоллары,
				//       |	СУММА(ПартииТоваровОстатки.СуммаЕвроОстаток) КАК СуммаЕвро,
				//       |	СУММА(ПартииТоваровОстатки.СуммаБезНДСОстаток) КАК СуммаБезНДС,
				//       |	ПартииТоваровОстатки.Организация.Наименование КАК ОрганизацияНаименование
				//       |ПОМЕСТИТЬ втПартииСвернутые
				//       |ИЗ
				//       |	РегистрНакопления.ПартииТоваров.Остатки(
				//       |			&КонПериода,
				//       |			(Номенклатура, Склад, Качество, СтрокаПрихода, ВЫБОР
				//       |					КОГДА СтрокаПрихода.ДоговорКонтрагента.ВидДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
				//       |						ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
				//       |					ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ПустаяСсылка)
				//       |				КОНЕЦ) В
				//       |					(ВЫБРАТЬ
				//       |						ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Номенклатура,
				//       |						ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Склад,
				//       |						ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Качество,
				//       |						ТаблицаПоСтрокамПриходаБезУчетаСтатуса.СтрокаПрихода,
				//       |						ТаблицаПоСтрокамПриходаБезУчетаСтатуса.ВидДоговора
				//       |					ИЗ
				//       |						ТаблицаПоСтрокамПриходаБезУчетаСтатуса)
				//       |				И НЕ Организация В (&ЗапрещенныеОрганизации)) КАК ПартииТоваровОстатки
				//       |
				//       |СГРУППИРОВАТЬ ПО
				//       |	ПартииТоваровОстатки.Номенклатура,
				//       |	ПартииТоваровОстатки.Склад,
				//       |	ПартииТоваровОстатки.Качество,
				//       |	ПартииТоваровОстатки.Организация,
				//       |	ПартииТоваровОстатки.СтрокаПрихода,
				//       |	ПартииТоваровОстатки.СтатусПартии,
				//       |	ПартииТоваровОстатки.Организация.Наименование,
				//       |	ВЫБОР
				//       |		КОГДА ПартииТоваровОстатки.СтрокаПрихода.ДоговорКонтрагента.ВидДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
				//       |			ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
				//       |		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ПустаяСсылка)
				//       |	КОНЕЦ
				//       |
				//       |ДЛЯ ИЗМЕНЕНИЯ
				//       |	РегистрНакопления.ПартииТоваров.Остатки
				//       |;
				//       |
				//       |////////////////////////////////////////////////////////////////////////////////
				//       |ВЫБРАТЬ
				//       |	ПартииТоваровОстатки.Номенклатура,
				//       |	ПартииТоваровОстатки.Склад,
				//       |	ПартииТоваровОстатки.Качество,
				//       |	ПартииТоваровОстатки.Организация,
				//       |	ПартииТоваровОстатки.СтрокаПрихода,
				//       |	ПартииТоваровОстатки.ВидДоговора КАК ВидДоговора,
				//       |	ПартииТоваровОстатки.СтатусПартии,
				//       |	ПартииТоваровОстатки.ЭтаОрганизация КАК ЭтаОрганизация,
				//       |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) КАК Количество,
				//       |	ПартииТоваровОстатки.СуммаРубли - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаРубли, 0) КАК СуммаРубли,
				//       |	ПартииТоваровОстатки.СуммаДоллары - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаДоллары, 0) КАК СуммаДоллары,
				//       |	ПартииТоваровОстатки.СуммаЕвро - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаЕвро, 0) КАК СуммаЕвро,
				//       |	ПартииТоваровОстатки.СуммаБезНДС - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаБезНДС, 0) КАК СуммаБезНДС,
				//       |	ПартииТоваровОстатки.ОрганизацияНаименование КАК ОрганизацияНаименование
				//       |ИЗ
				//       |	втПартииСвернутые КАК ПартииТоваровОстатки
				//       |		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаДвиженийСвернутая КАК ТаблицаДвиженийСвернутая
				//       |		ПО ПартииТоваровОстатки.Номенклатура = ТаблицаДвиженийСвернутая.Номенклатура
				//       |			И ПартииТоваровОстатки.Склад = ТаблицаДвиженийСвернутая.Склад
				//       |			И ПартииТоваровОстатки.Качество = ТаблицаДвиженийСвернутая.Качество
				//       |			И ПартииТоваровОстатки.СтатусПартии = ТаблицаДвиженийСвернутая.СтатусПартии
				//       |			И ПартииТоваровОстатки.СтрокаПрихода = ТаблицаДвиженийСвернутая.СтрокаПрихода
				//       |			И ПартииТоваровОстатки.Организация = ТаблицаДвиженийСвернутая.Организация
				//       |ГДЕ
				//       |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) > 0
				//       |
				//       |УПОРЯДОЧИТЬ ПО
				//       |	ЭтаОрганизация УБЫВ,
				//       |	ОрганизацияНаименование";

		
		
		Организация = ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Получить(0).Организация;			   
		Запрос.УстановитьПараметр("Организация", Организация);
		Запрос.УстановитьПараметр("ЗапрещенныеОрганизации", ЗапрещенныеОрганизацииПродавцы(Организация, Реквизиты.Дата));
		ОтсортированаПоОрганизации = Организация;
	КонецЕсли;
	
	ОстаткиПоПартиям = Запрос.Выполнить().Выгрузить();	
	ОстаткиПоПартиям.Индексы.Добавить(КолонкиРаспределения);
	
	ПередаваемыеПараметры = Новый Структура;
	ПередаваемыеПараметры.Вставить("КолонкиРаспределения", КолонкиРаспределения);
	ПередаваемыеПараметры.Вставить("ЗаполняемыеРеквизиты", ЗаполняемыеРеквизиты);
	ПередаваемыеПараметры.Вставить("КонтрольНаличияПартий", КонтрольНаличияПартий);
	ПередаваемыеПараметры.Вставить("ДатаДокумента", Реквизиты.Дата);	
	ПередаваемыеПараметры.Вставить("СписыватьТолькоПоСвоейОрганизации", СтратегияПогашенияПоОрганизации.СписыватьТолькоПоСвоейОрганизации);
	ПередаваемыеПараметры.Вставить("СтратегияПогашенияПоОрганизации", СтратегияПогашенияПоОрганизации);
	
	ПогашениеПартийТоваровНовоеФрагмент(вхСсылкаНаДокумент, ТаблицаПоСтрокамПриходаБезУчетаСтатуса, ПередаваемыеПараметры, ОстаткиПоПартиям, ТаблицаДвижений, вхОтказ, ТаблицаПоFIFOБезУчетаСтатуса,ОтсортированаПоОрганизации, ПараметрыСписания);

КонецПроцедуры

Процедура СписатьПоFIFOБезУчетаСтатусаПоПоставщику(вхСсылкаНаДокумент, ТаблицаДвижений, ТаблицаПоFIFOБезУчетаСтатуса, СтратегияПогашенияПоОрганизации, ЗаполняемыеРеквизиты, КонтрольНаличияПартий, вхОтказ, ПараметрыСписания = Неопределено)
	
	лКлючАлгоритма = "ОбщийМодуль_ПроведениеДокументовКлиентСервер_СписатьПоFIFOБезУчетаСтатусаПоПоставщику";
	лЗамена = АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		Выполнить(лЗамена);
	КонецЕсли;
	
	ОтсортированаПоОрганизации = Неопределено; 
	ОперативноеПроведение = Неопределено;
	
	Реквизиты = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(вхСсылкаНаДокумент, "Дата,Организация");
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ТаблицаПоFIFOБезУчетаСтатуса", ТаблицаПоFIFOБезУчетаСтатуса);
	Запрос.УстановитьПараметр("ТаблицаДвижений", ТаблицаДвижений);
	
	ПараметрыСписания.Свойство("ОперативноеПроведение", ОперативноеПроведение);
	Если ОперативноеПроведение = Неопределено Тогда 
		ОперативноеПроведение = Ложь;
	КонецЕсли;
	
	Запрос.УстановитьПараметр("КонПериода", ?(ОперативноеПроведение, Неопределено, вхСсылкаНаДокумент.МоментВремени()));
	
	КолонкиРаспределения = "Номенклатура,Склад,Качество,Поставщик";
	
	Если СтратегияПогашенияПоОрганизации.ИспользуютсяМФП Тогда
		
		Если СтратегияПогашенияПоОрганизации.ПараметрыПолитикиМФП.УчитыватьОрганизациюТаблицыСписания Тогда
			КолонкиРаспределения = КолонкиРаспределения + ",Организация"; 
		КонецЕсли;
		
		Запрос.УстановитьПараметр("ТаблицаПриоритетаОрганизаций", СтратегияПогашенияПоОрганизации.ПараметрыПолитикиМФП.ОрганизацииДляЗакупки);
		
				Запрос.Текст = "ВЫБРАТЬ
				               |	ТаблицаПриоритетаОрганизаций.Приоритет КАК Приоритет,
				               |	ТаблицаПриоритетаОрганизаций.Организация КАК Организация
				               |ПОМЕСТИТЬ ТаблицаПриоритетаОрганизаций
				               |ИЗ
				               |	&ТаблицаПриоритетаОрганизаций КАК ТаблицаПриоритетаОрганизаций
				               |;
				               |
				               |////////////////////////////////////////////////////////////////////////////////
				               |ВЫБРАТЬ РАЗЛИЧНЫЕ
				               |	ТаблицаПоFIFOБезУчетаСтатуса.Номенклатура КАК Номенклатура,
				               |	ТаблицаПоFIFOБезУчетаСтатуса.Склад КАК Склад,
				               |	ТаблицаПоFIFOБезУчетаСтатуса.Качество КАК Качество,
				               |	ТаблицаПоFIFOБезУчетаСтатуса.Поставщик КАК Поставщик,
				               |	ТаблицаПоFIFOБезУчетаСтатуса.ДокументОснование КАК ДокументОснование
				               |ПОМЕСТИТЬ ТаблицаПоFIFOБезУчетаСтатуса
				               |ИЗ
				               |	&ТаблицаПоFIFOБезУчетаСтатуса КАК ТаблицаПоFIFOБезУчетаСтатуса
				               |;
				               |
				               |////////////////////////////////////////////////////////////////////////////////
				               |ВЫБРАТЬ
				               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
				               |	ТаблицаДвижений.Склад КАК Склад,
				               |	ТаблицаДвижений.Качество КАК Качество,
				               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
				               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
				               |	ТаблицаДвижений.Организация КАК Организация,
				               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование,
				               |	ТаблицаДвижений.Количество КАК Количество,
				               |	ТаблицаДвижений.СуммаРубли КАК СуммаРубли,
				               |	ТаблицаДвижений.СуммаДоллары КАК СуммаДоллары,
				               |	ТаблицаДвижений.СуммаЕвро КАК СуммаЕвро,
				               |	ТаблицаДвижений.СуммаБезНДС КАК СуммаБезНДС
				               |ПОМЕСТИТЬ ТаблицаДвижений
				               |ИЗ
				               |	&ТаблицаДвижений КАК ТаблицаДвижений
				               |;
				               |
				               |////////////////////////////////////////////////////////////////////////////////
				               |ВЫБРАТЬ
				               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
				               |	ТаблицаДвижений.Склад КАК Склад,
				               |	ТаблицаДвижений.Качество КАК Качество,
				               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
				               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
				               |	ТаблицаДвижений.Организация КАК Организация,
				               |	СУММА(ТаблицаДвижений.Количество) КАК Количество,
				               |	СУММА(ТаблицаДвижений.СуммаРубли) КАК СуммаРубли,
				               |	СУММА(ТаблицаДвижений.СуммаДоллары) КАК СуммаДоллары,
				               |	СУММА(ТаблицаДвижений.СуммаЕвро) КАК СуммаЕвро,
				               |	СУММА(ТаблицаДвижений.СуммаБезНДС) КАК СуммаБезНДС,
				               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование
				               |ПОМЕСТИТЬ ТаблицаДвиженийСвернутая
				               |ИЗ
				               |	ТаблицаДвижений КАК ТаблицаДвижений
				               |
				               |СГРУППИРОВАТЬ ПО
				               |	ТаблицаДвижений.Номенклатура,
				               |	ТаблицаДвижений.Склад,
				               |	ТаблицаДвижений.Качество,
				               |	ТаблицаДвижений.СтатусПартии,
				               |	ТаблицаДвижений.СтрокаПрихода,
				               |	ТаблицаДвижений.Организация,
				               |	ТаблицаДвижений.ДокументОснование
				               |
				               |ИНДЕКСИРОВАТЬ ПО
				               |	Номенклатура,
				               |	Склад,
				               |	Качество,
				               |	СтатусПартии,
				               |	СтрокаПрихода,
				               |	Организация,
				               |	ДокументОснование
				               |;
				               |
				               |////////////////////////////////////////////////////////////////////////////////
				               |ВЫБРАТЬ
				               |	ПартииТоваровОстатки.Номенклатура,
				               |	ПартииТоваровОстатки.Склад,
				               |	ПартииТоваровОстатки.Качество,
				               |	ПартииТоваровОстатки.Организация,
				               |	ПартииТоваровОстатки.СтрокаПрихода,
				               |	ПартииТоваровОстатки.СтатусПартии,
				               |	ПартииТоваровОстатки.СтрокаПрихода.ТорговаяТочка.Владелец КАК Поставщик,
				               |	СУММА(ПартииТоваровОстатки.КоличествоОстаток) КАК Количество,
				               |	СУММА(ПартииТоваровОстатки.СуммаРублиОстаток) КАК СуммаРубли,
				               |	СУММА(ПартииТоваровОстатки.СуммаДолларыОстаток) КАК СуммаДоллары,
				               |	СУММА(ПартииТоваровОстатки.СуммаЕвроОстаток) КАК СуммаЕвро,
				               |	СУММА(ПартииТоваровОстатки.СуммаБезНДСОстаток) КАК СуммаБезНДС,
				               |	ПартииТоваровОстатки.СтрокаПрихода.Дата КАК СтрокаПриходаДата,
				               |	ПартииТоваровОстатки.Организация.Наименование КАК ОрганизацияНаименование,
				               |	ПартииТоваровОстатки.ДокументОснование
				               |ПОМЕСТИТЬ втПартии
				               |ИЗ
				               |	РегистрНакопления.ПартииТоваров.Остатки(
				               |			&КонПериода,
				               |			(Номенклатура, Склад, Качество) В
				               |				(ВЫБРАТЬ
				               |					ТаблицаПоFIFOБезУчетаСтатуса.Номенклатура,
				               |					ТаблицаПоFIFOБезУчетаСтатуса.Склад,
				               |					ТаблицаПоFIFOБезУчетаСтатуса.Качество
				               |				ИЗ
				               |					ТаблицаПоFIFOБезУчетаСтатуса)) КАК ПартииТоваровОстатки
				               |
				               |СГРУППИРОВАТЬ ПО
				               |	ПартииТоваровОстатки.СтрокаПрихода,
				               |	ПартииТоваровОстатки.СтатусПартии,
				               |	ПартииТоваровОстатки.Номенклатура,
				               |	ПартииТоваровОстатки.Качество,
				               |	ПартииТоваровОстатки.ДокументОснование,
				               |	ПартииТоваровОстатки.Склад,
				               |	ПартииТоваровОстатки.Организация,
				               |	ПартииТоваровОстатки.СтрокаПрихода.ТорговаяТочка.Владелец,
				               |	ПартииТоваровОстатки.СтрокаПрихода.Дата,
				               |	ПартииТоваровОстатки.Организация.Наименование
				               |
				               |ДЛЯ ИЗМЕНЕНИЯ
				               |	РегистрНакопления.ПартииТоваров.Остатки
				               |;
							   //	25.02.2019 Валиахметов XX-1920
							   //Изменение алгоритма проведения перемещения
							   |
				               |////////////////////////////////////////////////////////////////////////////////
				               |ВЫБРАТЬ
				               |	втПартии.Номенклатура,
				               |	втПартии.Склад,
				               |	втПартии.Качество,
				               |	втПартии.Организация,
				               |	втПартии.СтрокаПрихода,
				               |	втПартии.СтатусПартии,
				               |	втПартии.Поставщик,
				               |	втПартии.Количество,
				               |	втПартии.СуммаРубли,
				               |	втПартии.СуммаДоллары,
				               |	втПартии.СуммаЕвро,
				               |	втПартии.СуммаБезНДС,
				               |	втПартии.СтрокаПриходаДата,
				               |	втПартии.ОрганизацияНаименование,
				               |	втПартии.ДокументОснование КАК ДокументОснование,
				               |	ЛОЖЬ КАК ПустойДокументОснование
				               |ПОМЕСТИТЬ втПартииСвернутые
				               |ИЗ
				               |	втПартии КАК втПартии
				               |ГДЕ
				               |	(втПартии.Номенклатура, втПартии.Склад, втПартии.Качество, втПартии.Поставщик, втПартии.ДокументОснование) В
				               |			(ВЫБРАТЬ
				               |				ТаблицаПоFIFOБезУчетаСтатуса.Номенклатура,
				               |				ТаблицаПоFIFOБезУчетаСтатуса.Склад,
				               |				ТаблицаПоFIFOБезУчетаСтатуса.Качество,
				               |				ТаблицаПоFIFOБезУчетаСтатуса.Поставщик,
				               |				ТаблицаПоFIFOБезУчетаСтатуса.ДокументОснование
				               |			ИЗ
				               |				ТаблицаПоFIFOБезУчетаСтатуса
				               |			ГДЕ
				               |				ТаблицаПоFIFOБезУчетаСтатуса.ДокументОснование <> НЕОПРЕДЕЛЕНО)
				               |	И втПартии.Организация В
				               |			(ВЫБРАТЬ
				               |				ТаблицаПриоритетаОрганизаций.Организация
				               |			ИЗ
				               |				ТаблицаПриоритетаОрганизаций)
				               |
				               |ОБЪЕДИНИТЬ ВСЕ
				               |
				               |ВЫБРАТЬ
				               |	втПартии.Номенклатура,
				               |	втПартии.Склад,
				               |	втПартии.Качество,
				               |	втПартии.Организация,
				               |	втПартии.СтрокаПрихода,
				               |	втПартии.СтатусПартии,
				               |	втПартии.Поставщик,
				               |	втПартии.Количество,
				               |	втПартии.СуммаРубли,
				               |	втПартии.СуммаДоллары,
				               |	втПартии.СуммаЕвро,
				               |	втПартии.СуммаБезНДС,
				               |	втПартии.СтрокаПриходаДата,
				               |	втПартии.ОрганизацияНаименование,
				               |	втПартии.ДокументОснование,
				               |	ИСТИНА
				               |ИЗ
				               |	втПартии КАК втПартии
				               |ГДЕ
				               |	(втПартии.Номенклатура, втПартии.Склад, втПартии.Качество, втПартии.Поставщик) В
				               |			(ВЫБРАТЬ
				               |				ТаблицаПоFIFOБезУчетаСтатуса.Номенклатура,
				               |				ТаблицаПоFIFOБезУчетаСтатуса.Склад,
				               |				ТаблицаПоFIFOБезУчетаСтатуса.Качество,
				               |				ТаблицаПоFIFOБезУчетаСтатуса.Поставщик
				               |			ИЗ
				               |				ТаблицаПоFIFOБезУчетаСтатуса)
				               |	И втПартии.ДокументОснование = НЕОПРЕДЕЛЕНО
				               |	И втПартии.Организация В
				               |			(ВЫБРАТЬ
				               |				ТаблицаПриоритетаОрганизаций.Организация
				               |			ИЗ
				               |				ТаблицаПриоритетаОрганизаций)
				               |;
							   //	25.02.2019 Валиахметов XX-1920
							   //Изменение алгоритма проведения перемещения
							   |
				               |////////////////////////////////////////////////////////////////////////////////
				               |ВЫБРАТЬ
				               |	ПартииТоваровОстатки.Номенклатура,
				               |	ПартииТоваровОстатки.Склад,
				               |	ПартииТоваровОстатки.Качество,
				               |	ПартииТоваровОстатки.Организация,
				               |	ПартииТоваровОстатки.СтрокаПрихода,
				               |	ПартииТоваровОстатки.СтатусПартии,
				               |	ПартииТоваровОстатки.Поставщик КАК Поставщик,
				               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) КАК Количество,
				               |	ПартииТоваровОстатки.СуммаРубли - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаРубли, 0) КАК СуммаРубли,
				               |	ПартииТоваровОстатки.СуммаДоллары - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаДоллары, 0) КАК СуммаДоллары,
				               |	ПартииТоваровОстатки.СуммаЕвро - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаЕвро, 0) КАК СуммаЕвро,
				               |	ПартииТоваровОстатки.СуммаБезНДС - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаБезНДС, 0) КАК СуммаБезНДС,
				               |	ПартииТоваровОстатки.СтрокаПриходаДата,
				               |	ПартииТоваровОстатки.ОрганизацияНаименование КАК ОрганизацияНаименование,
				               |	ПартииТоваровОстатки.ДокументОснование,
				               |	ПартииТоваровОстатки.ПустойДокументОснование КАК ПустойДокументОснование
				               |ИЗ
				               |	втПартииСвернутые КАК ПартииТоваровОстатки
				               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаПриоритетаОрганизаций КАК ТаблицаПриоритетаОрганизаций
				               |		ПО (ТаблицаПриоритетаОрганизаций.Организация = ПартииТоваровОстатки.Организация)
				               |		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаДвиженийСвернутая КАК ТаблицаДвиженийСвернутая
				               |		ПО ПартииТоваровОстатки.Номенклатура = ТаблицаДвиженийСвернутая.Номенклатура
				               |			И ПартииТоваровОстатки.Склад = ТаблицаДвиженийСвернутая.Склад
				               |			И ПартииТоваровОстатки.Качество = ТаблицаДвиженийСвернутая.Качество
				               |			И ПартииТоваровОстатки.СтатусПартии = ТаблицаДвиженийСвернутая.СтатусПартии
				               |			И ПартииТоваровОстатки.СтрокаПрихода = ТаблицаДвиженийСвернутая.СтрокаПрихода
				               |			И ПартииТоваровОстатки.Организация = ТаблицаДвиженийСвернутая.Организация
				               |			И ПартииТоваровОстатки.ДокументОснование = ТаблицаДвиженийСвернутая.ДокументОснование
				               |ГДЕ
				               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) > 0
				               |
				               |УПОРЯДОЧИТЬ ПО
				               |	ПустойДокументОснование,
				               |	ТаблицаПриоритетаОрганизаций.Приоритет,
				               |	ПартииТоваровОстатки.СтрокаПриходаДата,
				               |	ПартииТоваровОстатки.ОрганизацияНаименование";
		
	ИначеЕсли СтратегияПогашенияПоОрганизации.СписыватьТолькоПоСвоейОрганизации Тогда 
		КолонкиРаспределения = КолонкиРаспределения + ",Организация"; 
		
		Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
		               |	ТаблицаПоFIFOБезУчетаСтатуса.Номенклатура КАК Номенклатура,
		               |	ТаблицаПоFIFOБезУчетаСтатуса.Склад КАК Склад,
		               |	ТаблицаПоFIFOБезУчетаСтатуса.Качество КАК Качество,
		               |	ТаблицаПоFIFOБезУчетаСтатуса.Организация КАК Организация,
		               |	ТаблицаПоFIFOБезУчетаСтатуса.Поставщик КАК Поставщик,
		               |	ТаблицаПоFIFOБезУчетаСтатуса.ДокументОснование КАК ДокументОснование
		               |ПОМЕСТИТЬ ТаблицаПоFIFOБезУчетаСтатуса
		               |ИЗ
		               |	&ТаблицаПоFIFOБезУчетаСтатуса КАК ТаблицаПоFIFOБезУчетаСтатуса
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
		               |	ТаблицаДвижений.Склад КАК Склад,
		               |	ТаблицаДвижений.Качество КАК Качество,
		               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаДвижений.Организация КАК Организация,
		               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование,
		               |	ТаблицаДвижений.Количество КАК Количество,
		               |	ТаблицаДвижений.СуммаРубли КАК СуммаРубли,
		               |	ТаблицаДвижений.СуммаДоллары КАК СуммаДоллары,
		               |	ТаблицаДвижений.СуммаЕвро КАК СуммаЕвро,
		               |	ТаблицаДвижений.СуммаБезНДС КАК СуммаБезНДС
		               |ПОМЕСТИТЬ ТаблицаДвижений
		               |ИЗ
		               |	&ТаблицаДвижений КАК ТаблицаДвижений
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
		               |	ТаблицаДвижений.Склад КАК Склад,
		               |	ТаблицаДвижений.Качество КАК Качество,
		               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаДвижений.Организация КАК Организация,
		               |	СУММА(ТаблицаДвижений.Количество) КАК Количество,
		               |	СУММА(ТаблицаДвижений.СуммаРубли) КАК СуммаРубли,
		               |	СУММА(ТаблицаДвижений.СуммаДоллары) КАК СуммаДоллары,
		               |	СУММА(ТаблицаДвижений.СуммаЕвро) КАК СуммаЕвро,
		               |	СУММА(ТаблицаДвижений.СуммаБезНДС) КАК СуммаБезНДС,
		               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование
		               |ПОМЕСТИТЬ ТаблицаДвиженийСвернутая
		               |ИЗ
		               |	ТаблицаДвижений КАК ТаблицаДвижений
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ТаблицаДвижений.Номенклатура,
		               |	ТаблицаДвижений.Склад,
		               |	ТаблицаДвижений.Качество,
		               |	ТаблицаДвижений.СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода,
		               |	ТаблицаДвижений.Организация,
		               |	ТаблицаДвижений.ДокументОснование
		               |
		               |ИНДЕКСИРОВАТЬ ПО
		               |	Номенклатура,
		               |	Склад,
		               |	Качество,
		               |	СтатусПартии,
		               |	СтрокаПрихода,
		               |	Организация,
		               |	ДокументОснование
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.СтрокаПрихода.ТорговаяТочка.Владелец КАК Поставщик,
		               |	СУММА(ПартииТоваровОстатки.КоличествоОстаток) КАК Количество,
		               |	СУММА(ПартииТоваровОстатки.СуммаРублиОстаток) КАК СуммаРубли,
		               |	СУММА(ПартииТоваровОстатки.СуммаДолларыОстаток) КАК СуммаДоллары,
		               |	СУММА(ПартииТоваровОстатки.СуммаЕвроОстаток) КАК СуммаЕвро,
		               |	СУММА(ПартииТоваровОстатки.СуммаБезНДСОстаток) КАК СуммаБезНДС,
		               |	ПартииТоваровОстатки.СтрокаПрихода.Дата КАК СтрокаПриходаДата,
		               |	ПартииТоваровОстатки.ДокументОснование
		               |ПОМЕСТИТЬ втПартии
		               |ИЗ
		               |	РегистрНакопления.ПартииТоваров.Остатки(
		               |			&КонПериода,
		               |			(Номенклатура, Склад, Качество) В
		               |				(ВЫБРАТЬ
		               |					ТаблицаПоFIFOБезУчетаСтатуса.Номенклатура,
		               |					ТаблицаПоFIFOБезУчетаСтатуса.Склад,
		               |					ТаблицаПоFIFOБезУчетаСтатуса.Качество
		               |				ИЗ
		               |					ТаблицаПоFIFOБезУчетаСтатуса)) КАК ПартииТоваровОстатки
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.СтрокаПрихода.ТорговаяТочка.Владелец,
		               |	ПартииТоваровОстатки.СтрокаПрихода.Дата,
		               |	ПартииТоваровОстатки.ДокументОснование
		               |
		               |ДЛЯ ИЗМЕНЕНИЯ
		               |	РегистрНакопления.ПартииТоваров.Остатки
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	втПартии.Номенклатура,
		               |	втПартии.Склад,
		               |	втПартии.Качество,
		               |	втПартии.Организация,
		               |	втПартии.СтрокаПрихода,
		               |	втПартии.СтатусПартии,
		               |	втПартии.Поставщик,
		               |	втПартии.Количество,
		               |	втПартии.СуммаРубли,
		               |	втПартии.СуммаДоллары,
		               |	втПартии.СуммаЕвро,
		               |	втПартии.СуммаБезНДС,
		               |	втПартии.СтрокаПриходаДата,
		               |	втПартии.ДокументОснование,
		               |	ЛОЖЬ КАК ПустойДокументОснование
		               |ПОМЕСТИТЬ втПартииСвернутые
		               |ИЗ
		               |	втПартии КАК втПартии
		               |ГДЕ
		               |	(втПартии.Номенклатура, втПартии.Склад, втПартии.Качество, втПартии.Организация, втПартии.Поставщик, втПартии.ДокументОснование) В
		               |			(ВЫБРАТЬ
		               |				ТаблицаПоFIFOБезУчетаСтатуса.Номенклатура,
		               |				ТаблицаПоFIFOБезУчетаСтатуса.Склад,
		               |				ТаблицаПоFIFOБезУчетаСтатуса.Качество,
		               |				ТаблицаПоFIFOБезУчетаСтатуса.Организация,
		               |				ТаблицаПоFIFOБезУчетаСтатуса.Поставщик,
		               |				ТаблицаПоFIFOБезУчетаСтатуса.ДокументОснование
		               |			ИЗ
		               |				ТаблицаПоFIFOБезУчетаСтатуса
		               |			ГДЕ
		               |				ТаблицаПоFIFOБезУчетаСтатуса.ДокументОснование <> НЕОПРЕДЕЛЕНО)
		               |
		               |ОБЪЕДИНИТЬ ВСЕ
		               |
		               |ВЫБРАТЬ
		               |	втПартии.Номенклатура,
		               |	втПартии.Склад,
		               |	втПартии.Качество,
		               |	втПартии.Организация,
		               |	втПартии.СтрокаПрихода,
		               |	втПартии.СтатусПартии,
		               |	втПартии.Поставщик,
		               |	втПартии.Количество,
		               |	втПартии.СуммаРубли,
		               |	втПартии.СуммаДоллары,
		               |	втПартии.СуммаЕвро,
		               |	втПартии.СуммаБезНДС,
		               |	втПартии.СтрокаПриходаДата,
		               |	втПартии.ДокументОснование,
		               |	ИСТИНА
		               |ИЗ
		               |	втПартии КАК втПартии
		               |ГДЕ
		               |	(втПартии.Номенклатура, втПартии.Склад, втПартии.Качество, втПартии.Организация, втПартии.Поставщик) В
		               |			(ВЫБРАТЬ
		               |				ТаблицаПоFIFOБезУчетаСтатуса.Номенклатура,
		               |				ТаблицаПоFIFOБезУчетаСтатуса.Склад,
		               |				ТаблицаПоFIFOБезУчетаСтатуса.Качество,
		               |				ТаблицаПоFIFOБезУчетаСтатуса.Организация,
		               |				ТаблицаПоFIFOБезУчетаСтатуса.Поставщик
		               |			ИЗ
		               |				ТаблицаПоFIFOБезУчетаСтатуса)
		               |	И втПартии.ДокументОснование = НЕОПРЕДЕЛЕНО
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.Поставщик КАК Поставщик,
		               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) КАК Количество,
		               |	ПартииТоваровОстатки.СуммаРубли - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаРубли, 0) КАК СуммаРубли,
		               |	ПартииТоваровОстатки.СуммаДоллары - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаДоллары, 0) КАК СуммаДоллары,
		               |	ПартииТоваровОстатки.СуммаЕвро - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаЕвро, 0) КАК СуммаЕвро,
		               |	ПартииТоваровОстатки.СуммаБезНДС - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаБезНДС, 0) КАК СуммаБезНДС,
		               |	ПартииТоваровОстатки.СтрокаПриходаДата КАК СтрокаПриходаДата,
		               |	ПартииТоваровОстатки.ДокументОснование,
		               |	ПартииТоваровОстатки.ПустойДокументОснование КАК ПустойДокументОснование
		               |ИЗ
		               |	втПартииСвернутые КАК ПартииТоваровОстатки
		               |		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаДвиженийСвернутая КАК ТаблицаДвиженийСвернутая
		               |		ПО ПартииТоваровОстатки.Номенклатура = ТаблицаДвиженийСвернутая.Номенклатура
		               |			И ПартииТоваровОстатки.Склад = ТаблицаДвиженийСвернутая.Склад
		               |			И ПартииТоваровОстатки.Качество = ТаблицаДвиженийСвернутая.Качество
		               |			И ПартииТоваровОстатки.СтатусПартии = ТаблицаДвиженийСвернутая.СтатусПартии
		               |			И ПартииТоваровОстатки.СтрокаПрихода = ТаблицаДвиженийСвернутая.СтрокаПрихода
		               |			И ПартииТоваровОстатки.Организация = ТаблицаДвиженийСвернутая.Организация
		               |			И ПартииТоваровОстатки.ДокументОснование = ТаблицаДвиженийСвернутая.ДокументОснование
		               |ГДЕ
		               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) > 0
		               |
		               |УПОРЯДОЧИТЬ ПО
		               |	ПустойДокументОснование,
		               |	СтрокаПриходаДата";
	Иначе
		Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
		               |	ТаблицаПоFIFOБезУчетаСтатуса.Номенклатура КАК Номенклатура,
		               |	ТаблицаПоFIFOБезУчетаСтатуса.Склад КАК Склад,
		               |	ТаблицаПоFIFOБезУчетаСтатуса.Качество КАК Качество,
		               |	ТаблицаПоFIFOБезУчетаСтатуса.Поставщик КАК Поставщик,
		               |	ТаблицаПоFIFOБезУчетаСтатуса.ДокументОснование КАК ДокументОснование
		               |ПОМЕСТИТЬ ТаблицаПоFIFOБезУчетаСтатуса
		               |ИЗ
		               |	&ТаблицаПоFIFOБезУчетаСтатуса КАК ТаблицаПоFIFOБезУчетаСтатуса
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
		               |	ТаблицаДвижений.Склад КАК Склад,
		               |	ТаблицаДвижений.Качество КАК Качество,
		               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаДвижений.Организация КАК Организация,
		               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование,
		               |	ТаблицаДвижений.Количество КАК Количество,
		               |	ТаблицаДвижений.СуммаРубли КАК СуммаРубли,
		               |	ТаблицаДвижений.СуммаДоллары КАК СуммаДоллары,
		               |	ТаблицаДвижений.СуммаЕвро КАК СуммаЕвро,
		               |	ТаблицаДвижений.СуммаБезНДС КАК СуммаБезНДС
		               |ПОМЕСТИТЬ ТаблицаДвижений
		               |ИЗ
		               |	&ТаблицаДвижений КАК ТаблицаДвижений
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
		               |	ТаблицаДвижений.Склад КАК Склад,
		               |	ТаблицаДвижений.Качество КАК Качество,
		               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаДвижений.Организация КАК Организация,
		               |	СУММА(ТаблицаДвижений.Количество) КАК Количество,
		               |	СУММА(ТаблицаДвижений.СуммаРубли) КАК СуммаРубли,
		               |	СУММА(ТаблицаДвижений.СуммаДоллары) КАК СуммаДоллары,
		               |	СУММА(ТаблицаДвижений.СуммаЕвро) КАК СуммаЕвро,
		               |	СУММА(ТаблицаДвижений.СуммаБезНДС) КАК СуммаБезНДС,
		               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование
		               |ПОМЕСТИТЬ ТаблицаДвиженийСвернутая
		               |ИЗ
		               |	ТаблицаДвижений КАК ТаблицаДвижений
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ТаблицаДвижений.Номенклатура,
		               |	ТаблицаДвижений.Склад,
		               |	ТаблицаДвижений.Качество,
		               |	ТаблицаДвижений.СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода,
		               |	ТаблицаДвижений.Организация,
		               |	ТаблицаДвижений.ДокументОснование
		               |
		               |ИНДЕКСИРОВАТЬ ПО
		               |	Номенклатура,
		               |	Склад,
		               |	Качество,
		               |	СтатусПартии,
		               |	СтрокаПрихода,
		               |	Организация,
		               |	ДокументОснование
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.СтрокаПрихода.ТорговаяТочка.Владелец КАК Поставщик,
		               |	СУММА(ПартииТоваровОстатки.КоличествоОстаток) КАК Количество,
		               |	СУММА(ПартииТоваровОстатки.СуммаРублиОстаток) КАК СуммаРубли,
		               |	СУММА(ПартииТоваровОстатки.СуммаДолларыОстаток) КАК СуммаДоллары,
		               |	СУММА(ПартииТоваровОстатки.СуммаЕвроОстаток) КАК СуммаЕвро,
		               |	СУММА(ПартииТоваровОстатки.СуммаБезНДСОстаток) КАК СуммаБезНДС,
		               |	ПартииТоваровОстатки.Организация = &Организация КАК ЭтаОрганизация,
		               |	ПартииТоваровОстатки.СтрокаПрихода.Дата КАК СтрокаПриходаДата,
		               |	ПартииТоваровОстатки.Организация.Наименование КАК ОрганизацияНаименование,
		               |	ПартииТоваровОстатки.ДокументОснование
		               |ПОМЕСТИТЬ втПартии
		               |ИЗ
		               |	РегистрНакопления.ПартииТоваров.Остатки(
		               |			&КонПериода,
		               |			(Номенклатура, Склад, Качество) В
		               |				(ВЫБРАТЬ
		               |					ТаблицаПоFIFOБезУчетаСтатуса.Номенклатура,
		               |					ТаблицаПоFIFOБезУчетаСтатуса.Склад,
		               |					ТаблицаПоFIFOБезУчетаСтатуса.Качество
		               |				ИЗ
		               |					ТаблицаПоFIFOБезУчетаСтатуса)) КАК ПартииТоваровОстатки
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.СтрокаПрихода.ТорговаяТочка.Владелец,
		               |	ПартииТоваровОстатки.СтрокаПрихода.Дата,
		               |	ПартииТоваровОстатки.Организация.Наименование,
		               |	ПартииТоваровОстатки.Организация = &Организация,
		               |	ПартииТоваровОстатки.ДокументОснование
		               |
		               |ДЛЯ ИЗМЕНЕНИЯ
		               |	РегистрНакопления.ПартииТоваров.Остатки
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	втПартии.Номенклатура,
		               |	втПартии.Склад,
		               |	втПартии.Качество,
		               |	втПартии.Организация,
		               |	втПартии.СтрокаПрихода,
		               |	втПартии.СтатусПартии,
		               |	втПартии.Поставщик,
		               |	втПартии.Количество,
		               |	втПартии.СуммаРубли,
		               |	втПартии.СуммаДоллары,
		               |	втПартии.СуммаЕвро,
		               |	втПартии.СуммаБезНДС,
		               |	втПартии.ЭтаОрганизация,
		               |	втПартии.СтрокаПриходаДата,
		               |	втПартии.ОрганизацияНаименование,
		               |	втПартии.ДокументОснование,
		               |	ЛОЖЬ КАК ПустойДокументОснование
		               |ПОМЕСТИТЬ втПартииСвернутые
		               |ИЗ
		               |	втПартии КАК втПартии
		               |ГДЕ
		               |	(втПартии.Номенклатура, втПартии.Склад, втПартии.Качество, втПартии.Поставщик, втПартии.ДокументОснование) В
		               |			(ВЫБРАТЬ
		               |				ТаблицаПоFIFOБезУчетаСтатуса.Номенклатура,
		               |				ТаблицаПоFIFOБезУчетаСтатуса.Склад,
		               |				ТаблицаПоFIFOБезУчетаСтатуса.Качество,
		               |				ТаблицаПоFIFOБезУчетаСтатуса.Поставщик,
		               |				ТаблицаПоFIFOБезУчетаСтатуса.ДокументОснование
		               |			ИЗ
		               |				ТаблицаПоFIFOБезУчетаСтатуса
		               |			ГДЕ
		               |				ТаблицаПоFIFOБезУчетаСтатуса.ДокументОснование <> НЕОПРЕДЕЛЕНО)
		               |	И НЕ втПартии.Организация В (&ЗапрещенныеОрганизации)
		               |
		               |ОБЪЕДИНИТЬ ВСЕ
		               |
		               |ВЫБРАТЬ
		               |	втПартии.Номенклатура,
		               |	втПартии.Склад,
		               |	втПартии.Качество,
		               |	втПартии.Организация,
		               |	втПартии.СтрокаПрихода,
		               |	втПартии.СтатусПартии,
		               |	втПартии.Поставщик,
		               |	втПартии.Количество,
		               |	втПартии.СуммаРубли,
		               |	втПартии.СуммаДоллары,
		               |	втПартии.СуммаЕвро,
		               |	втПартии.СуммаБезНДС,
		               |	втПартии.ЭтаОрганизация,
		               |	втПартии.СтрокаПриходаДата,
		               |	втПартии.ОрганизацияНаименование,
		               |	втПартии.ДокументОснование,
		               |	ИСТИНА
		               |ИЗ
		               |	втПартии КАК втПартии
		               |ГДЕ
		               |	(втПартии.Номенклатура, втПартии.Склад, втПартии.Качество, втПартии.Поставщик) В
		               |			(ВЫБРАТЬ
		               |				ТаблицаПоFIFOБезУчетаСтатуса.Номенклатура,
		               |				ТаблицаПоFIFOБезУчетаСтатуса.Склад,
		               |				ТаблицаПоFIFOБезУчетаСтатуса.Качество,
		               |				ТаблицаПоFIFOБезУчетаСтатуса.Поставщик
		               |			ИЗ
		               |				ТаблицаПоFIFOБезУчетаСтатуса)
		               |	И втПартии.ДокументОснование = НЕОПРЕДЕЛЕНО
		               |	И НЕ втПартии.Организация В (&ЗапрещенныеОрганизации)
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.Поставщик КАК Поставщик,
		               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) КАК Количество,
		               |	ПартииТоваровОстатки.СуммаРубли - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаРубли, 0) КАК СуммаРубли,
		               |	ПартииТоваровОстатки.СуммаДоллары - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаДоллары, 0) КАК СуммаДоллары,
		               |	ПартииТоваровОстатки.СуммаЕвро - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаЕвро, 0) КАК СуммаЕвро,
		               |	ПартииТоваровОстатки.СуммаБезНДС - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаБезНДС, 0) КАК СуммаБезНДС,
		               |	ПартииТоваровОстатки.ЭтаОрганизация КАК ЭтаОрганизация,
		               |	ПартииТоваровОстатки.СтрокаПрихода.Дата КАК СтрокаПриходаДата,
		               |	ПартииТоваровОстатки.ОрганизацияНаименование КАК ОрганизацияНаименование,
		               |	ПартииТоваровОстатки.ДокументОснование,
		               |	ПартииТоваровОстатки.ПустойДокументОснование КАК ПустойДокументОснование
		               |ИЗ
		               |	втПартииСвернутые КАК ПартииТоваровОстатки
		               |		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаДвиженийСвернутая КАК ТаблицаДвиженийСвернутая
		               |		ПО ПартииТоваровОстатки.Номенклатура = ТаблицаДвиженийСвернутая.Номенклатура
		               |			И ПартииТоваровОстатки.Склад = ТаблицаДвиженийСвернутая.Склад
		               |			И ПартииТоваровОстатки.Качество = ТаблицаДвиженийСвернутая.Качество
		               |			И ПартииТоваровОстатки.СтатусПартии = ТаблицаДвиженийСвернутая.СтатусПартии
		               |			И ПартииТоваровОстатки.СтрокаПрихода = ТаблицаДвиженийСвернутая.СтрокаПрихода
		               |			И ПартииТоваровОстатки.Организация = ТаблицаДвиженийСвернутая.Организация
		               |			И ПартииТоваровОстатки.ДокументОснование = ТаблицаДвиженийСвернутая.ДокументОснование
		               |ГДЕ
		               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) > 0
		               |
		               |УПОРЯДОЧИТЬ ПО
		               |	ЭтаОрганизация УБЫВ,
		               |	ОрганизацияНаименование,
		               |	ПустойДокументОснование,
		               |	СтрокаПриходаДата";
						   
		Организация = ТаблицаПоFIFOБезУчетаСтатуса.Получить(0).Организация;			   
		Запрос.УстановитьПараметр("Организация", Организация);
		Запрос.УстановитьПараметр("ЗапрещенныеОрганизации", ЗапрещенныеОрганизацииПродавцы(Организация, Реквизиты.Дата));
		ОтсортированаПоОрганизации = Организация;
	КонецЕсли;	
	
	//Если УчитыватьПоставщика Тогда 
	//	Запрос.Текст = СтрЗаменить(Запрос.Текст, "%ОтборПоПоставщику%", "И СтрокаПрихода.ТорговаяТочка.Владелец = &Поставщик");
	//	Запрос.УстановитьПараметр("Поставщик", ОбщегоНазначения.ЗначениеРеквизитаОбъекта(вхСсылкаНаДокумент, "Контрагент"));
	//Иначе
	//	Запрос.Текст = СтрЗаменить(Запрос.Текст, "%ОтборПоПоставщику%", "");
	//КонецЕсли;
	
	ОстаткиПоПартиям = Запрос.Выполнить().Выгрузить();
	ОстаткиПоПартиям.Индексы.Добавить(КолонкиРаспределения);
	
	ПередаваемыеПараметры = Новый Структура;
	ПередаваемыеПараметры.Вставить("КолонкиРаспределения", КолонкиРаспределения);
	ПередаваемыеПараметры.Вставить("ЗаполняемыеРеквизиты", ЗаполняемыеРеквизиты);
	ПередаваемыеПараметры.Вставить("КонтрольНаличияПартий", КонтрольНаличияПартий);
	ПередаваемыеПараметры.Вставить("ДатаДокумента", Реквизиты.Дата);	
	ПередаваемыеПараметры.Вставить("СписыватьТолькоПоСвоейОрганизации", СтратегияПогашенияПоОрганизации.СписыватьТолькоПоСвоейОрганизации);
	ПередаваемыеПараметры.Вставить("СтратегияПогашенияПоОрганизации", СтратегияПогашенияПоОрганизации);
	
	ПогашениеПартийТоваровНовоеФрагмент(вхСсылкаНаДокумент, ТаблицаПоFIFOБезУчетаСтатуса, ПередаваемыеПараметры, ОстаткиПоПартиям, ТаблицаДвижений, вхОтказ,,ОтсортированаПоОрганизации, ПараметрыСписания);
КонецПроцедуры

Процедура СписатьПоFIFOБезУчетаСтатуса(вхСсылкаНаДокумент, ТаблицаДвижений, ТаблицаПоFIFOБезУчетаСтатуса, СтратегияПогашенияПоОрганизации, ЗаполняемыеРеквизиты, КонтрольНаличияПартий, вхОтказ, ПараметрыСписания = Неопределено)
	
	лКлючАлгоритма = "ОбщийМодуль_ПроведениеДокументовКлиентСервер_СписатьПоFIFOБезУчетаСтатуса";
	лЗамена = АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		Выполнить(лЗамена);
	КонецЕсли;
	
	ОтсортированаПоОрганизации = Неопределено; 
	ОперативноеПроведение = Неопределено;
	
	Реквизиты = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(вхСсылкаНаДокумент, "Дата,Организация");
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ТаблицаПоFIFOБезУчетаСтатуса", ТаблицаПоFIFOБезУчетаСтатуса);
	Запрос.УстановитьПараметр("ТаблицаДвижений", ТаблицаДвижений);
	
	ПараметрыСписания.Свойство("ОперативноеПроведение", ОперативноеПроведение);
	Если ОперативноеПроведение = Неопределено Тогда 
		ОперативноеПроведение = Ложь;
	КонецЕсли;
	
	Запрос.УстановитьПараметр("КонПериода", ?(ОперативноеПроведение, Неопределено, вхСсылкаНаДокумент.МоментВремени()));
	
	КолонкиРаспределения = "Номенклатура,Склад,Качество,ВидДоговора";
	
	Если СтратегияПогашенияПоОрганизации.ИспользуютсяМФП Тогда
		
		Если СтратегияПогашенияПоОрганизации.ПараметрыПолитикиМФП.УчитыватьОрганизациюТаблицыСписания Тогда
			КолонкиРаспределения = КолонкиРаспределения + ",Организация"; 
		КонецЕсли;
		
		Запрос.УстановитьПараметр("ТаблицаПриоритетаОрганизаций", СтратегияПогашенияПоОрганизации.ПараметрыПолитикиМФП.ОрганизацииДляЗакупки);
		
		Запрос.Текст = "ВЫБРАТЬ
		               |	ТаблицаПриоритетаОрганизаций.Приоритет КАК Приоритет,
		               |	ТаблицаПриоритетаОрганизаций.Организация КАК Организация
		               |ПОМЕСТИТЬ ТаблицаПриоритетаОрганизаций
		               |ИЗ
		               |	&ТаблицаПриоритетаОрганизаций КАК ТаблицаПриоритетаОрганизаций
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ РАЗЛИЧНЫЕ
		               |	ТаблицаПоFIFOБезУчетаСтатуса.Номенклатура КАК Номенклатура,
		               |	ТаблицаПоFIFOБезУчетаСтатуса.Склад КАК Склад,
		               |	ТаблицаПоFIFOБезУчетаСтатуса.Качество КАК Качество,
		               |	ТаблицаПоFIFOБезУчетаСтатуса.ВидДоговора КАК ВидДоговора,
		               |	ТаблицаПоFIFOБезУчетаСтатуса.ДокументОснование КАК ДокументОснование
		               |ПОМЕСТИТЬ ТаблицаПоFIFOБезУчетаСтатуса
		               |ИЗ
		               |	&ТаблицаПоFIFOБезУчетаСтатуса КАК ТаблицаПоFIFOБезУчетаСтатуса
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
		               |	ТаблицаДвижений.Склад КАК Склад,
		               |	ТаблицаДвижений.Качество КАК Качество,
		               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаДвижений.Организация КАК Организация,
		               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование,
		               |	ТаблицаДвижений.Количество КАК Количество,
		               |	ТаблицаДвижений.СуммаРубли КАК СуммаРубли,
		               |	ТаблицаДвижений.СуммаДоллары КАК СуммаДоллары,
		               |	ТаблицаДвижений.СуммаЕвро КАК СуммаЕвро,
		               |	ТаблицаДвижений.СуммаБезНДС КАК СуммаБезНДС
		               |ПОМЕСТИТЬ ТаблицаДвижений
		               |ИЗ
		               |	&ТаблицаДвижений КАК ТаблицаДвижений
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
		               |	ТаблицаДвижений.Склад КАК Склад,
		               |	ТаблицаДвижений.Качество КАК Качество,
		               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаДвижений.Организация КАК Организация,
		               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование,
		               |	СУММА(ТаблицаДвижений.Количество) КАК Количество,
		               |	СУММА(ТаблицаДвижений.СуммаРубли) КАК СуммаРубли,
		               |	СУММА(ТаблицаДвижений.СуммаДоллары) КАК СуммаДоллары,
		               |	СУММА(ТаблицаДвижений.СуммаЕвро) КАК СуммаЕвро,
		               |	СУММА(ТаблицаДвижений.СуммаБезНДС) КАК СуммаБезНДС
		               |ПОМЕСТИТЬ ТаблицаДвиженийСвернутая
		               |ИЗ
		               |	ТаблицаДвижений КАК ТаблицаДвижений
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ТаблицаДвижений.Номенклатура,
		               |	ТаблицаДвижений.Склад,
		               |	ТаблицаДвижений.Качество,
		               |	ТаблицаДвижений.СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода,
		               |	ТаблицаДвижений.Организация,
		               |	ТаблицаДвижений.ДокументОснование
		               |
		               |ИНДЕКСИРОВАТЬ ПО
		               |	Номенклатура,
		               |	Склад,
		               |	Качество,
		               |	СтатусПартии,
		               |	СтрокаПрихода,
		               |	Организация,
		               |	ДокументОснование
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ВЫБОР
		               |		КОГДА ПартииТоваровОстатки.СтрокаПрихода.ДоговорКонтрагента.ВидДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
		               |			ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
		               |		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ПустаяСсылка)
		               |	КОНЕЦ КАК ВидДоговора,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.ДокументОснование КАК ДокументОснование,
		               |	СУММА(ПартииТоваровОстатки.КоличествоОстаток) КАК Количество,
		               |	СУММА(ПартииТоваровОстатки.СуммаРублиОстаток) КАК СуммаРубли,
		               |	СУММА(ПартииТоваровОстатки.СуммаДолларыОстаток) КАК СуммаДоллары,
		               |	СУММА(ПартииТоваровОстатки.СуммаЕвроОстаток) КАК СуммаЕвро,
		               |	СУММА(ПартииТоваровОстатки.СуммаБезНДСОстаток) КАК СуммаБезНДС,
		               |	ПартииТоваровОстатки.СтрокаПрихода.Дата КАК СтрокаПриходаДата,
		               |	ПартииТоваровОстатки.Организация.Наименование КАК ОрганизацияНаименование
		               |ПОМЕСТИТЬ втПартии
		               |ИЗ
		               |	РегистрНакопления.ПартииТоваров.Остатки(
		               |			&КонПериода,
		               |			(Номенклатура, Склад, Качество) В
		               |					(ВЫБРАТЬ
		               |						ТаблицаПоFIFOБезУчетаСтатуса.Номенклатура,
		               |						ТаблицаПоFIFOБезУчетаСтатуса.Склад,
		               |						ТаблицаПоFIFOБезУчетаСтатуса.Качество
		               |					ИЗ
		               |						ТаблицаПоFIFOБезУчетаСтатуса)
		               |				И Организация В
		               |					(ВЫБРАТЬ
		               |						ТаблицаПриоритетаОрганизаций.Организация
		               |					ИЗ
		               |						ТаблицаПриоритетаОрганизаций)) КАК ПартииТоваровОстатки
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ВЫБОР
		               |		КОГДА ПартииТоваровОстатки.СтрокаПрихода.ДоговорКонтрагента.ВидДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
		               |			ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
		               |		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ПустаяСсылка)
		               |	КОНЕЦ,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.СтрокаПрихода.Дата,
		               |	ПартииТоваровОстатки.Организация.Наименование,
		               |	ПартииТоваровОстатки.ДокументОснование
		               |
		               |ДЛЯ ИЗМЕНЕНИЯ
		               |	РегистрНакопления.ПартииТоваров.Остатки
		               |;
					   //	25.02.2019 Валиахметов XX-1920
					   //Изменение алгоритма проведения перемещения
					   |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	втПартии.Номенклатура,
		               |	втПартии.Склад,
		               |	втПартии.Качество,
		               |	втПартии.Организация,
		               |	втПартии.СтрокаПрихода,
		               |	втПартии.ВидДоговора,
		               |	втПартии.СтатусПартии,
		               |	втПартии.Количество,
		               |	втПартии.СуммаРубли,
		               |	втПартии.СуммаДоллары,
		               |	втПартии.СуммаЕвро,
		               |	втПартии.СуммаБезНДС,
		               |	втПартии.СтрокаПриходаДата,
		               |	втПартии.ОрганизацияНаименование,
		               |	втПартии.ДокументОснование,
		               |	ЛОЖЬ КАК ПустойДокументОснование
		               |ПОМЕСТИТЬ втПартииСвернутые
		               |ИЗ
		               |	ТаблицаПоFIFOБезУчетаСтатуса КАК ТаблицаПоFIFOБезУчетаСтатуса
		               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ втПартии КАК втПартии
		               |		ПО ТаблицаПоFIFOБезУчетаСтатуса.Номенклатура = втПартии.Номенклатура
		               |			И ТаблицаПоFIFOБезУчетаСтатуса.Склад = втПартии.Склад
		               |			И ТаблицаПоFIFOБезУчетаСтатуса.Качество = втПартии.Качество
		               |			И ТаблицаПоFIFOБезУчетаСтатуса.ВидДоговора = втПартии.ВидДоговора
		               |			И ТаблицаПоFIFOБезУчетаСтатуса.ДокументОснование = втПартии.ДокументОснование
		               |ГДЕ
		               |	ТаблицаПоFIFOБезУчетаСтатуса.ДокументОснование <> НЕОПРЕДЕЛЕНО
		               |
		               |ОБЪЕДИНИТЬ ВСЕ
		               |
		               |ВЫБРАТЬ
		               |	втПартии.Номенклатура,
		               |	втПартии.Склад,
		               |	втПартии.Качество,
		               |	втПартии.Организация,
		               |	втПартии.СтрокаПрихода,
		               |	втПартии.ВидДоговора,
		               |	втПартии.СтатусПартии,
		               |	втПартии.Количество,
		               |	втПартии.СуммаРубли,
		               |	втПартии.СуммаДоллары,
		               |	втПартии.СуммаЕвро,
		               |	втПартии.СуммаБезНДС,
		               |	втПартии.СтрокаПриходаДата,
		               |	втПартии.ОрганизацияНаименование,
		               |	втПартии.ДокументОснование,
		               |	ИСТИНА
		               |ИЗ
		               |	ТаблицаПоFIFOБезУчетаСтатуса КАК ТаблицаПоFIFOБезУчетаСтатуса
		               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ втПартии КАК втПартии
		               |		ПО ТаблицаПоFIFOБезУчетаСтатуса.Номенклатура = втПартии.Номенклатура
		               |			И ТаблицаПоFIFOБезУчетаСтатуса.Склад = втПартии.Склад
		               |			И ТаблицаПоFIFOБезУчетаСтатуса.Качество = втПартии.Качество
		               |			И ТаблицаПоFIFOБезУчетаСтатуса.ВидДоговора = втПартии.ВидДоговора
		               |ГДЕ
		               |	втПартии.ДокументОснование = НЕОПРЕДЕЛЕНО
		               |;
					   //Конец	25.02.2019 Валиахметов XX-1920
					   //Изменение алгоритма проведения перемещения
					   |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.ВидДоговора КАК ВидДоговора,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) КАК Количество,
		               |	ПартииТоваровОстатки.СуммаРубли - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаРубли, 0) КАК СуммаРубли,
		               |	ПартииТоваровОстатки.СуммаДоллары - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаДоллары, 0) КАК СуммаДоллары,
		               |	ПартииТоваровОстатки.СуммаЕвро - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаЕвро, 0) КАК СуммаЕвро,
		               |	ПартииТоваровОстатки.СуммаБезНДС - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаБезНДС, 0) КАК СуммаБезНДС,
		               |	ПартииТоваровОстатки.СтрокаПриходаДата КАК СтрокаПриходаДата,
		               |	ПартииТоваровОстатки.ОрганизацияНаименование КАК ОрганизацияНаименование,
		               |	ПартииТоваровОстатки.ДокументОснование,
		               |	ПартииТоваровОстатки.ПустойДокументОснование КАК ПустойДокументОснование
		               |ИЗ
		               |	втПартииСвернутые КАК ПартииТоваровОстатки
		               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаПриоритетаОрганизаций КАК ТаблицаПриоритетаОрганизаций
		               |		ПО (ТаблицаПриоритетаОрганизаций.Организация = ПартииТоваровОстатки.Организация)
		               |		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаДвиженийСвернутая КАК ТаблицаДвиженийСвернутая
		               |		ПО ПартииТоваровОстатки.Номенклатура = ТаблицаДвиженийСвернутая.Номенклатура
		               |			И ПартииТоваровОстатки.Склад = ТаблицаДвиженийСвернутая.Склад
		               |			И ПартииТоваровОстатки.Качество = ТаблицаДвиженийСвернутая.Качество
		               |			И ПартииТоваровОстатки.СтатусПартии = ТаблицаДвиженийСвернутая.СтатусПартии
		               |			И ПартииТоваровОстатки.СтрокаПрихода = ТаблицаДвиженийСвернутая.СтрокаПрихода
		               |			И ПартииТоваровОстатки.Организация = ТаблицаДвиженийСвернутая.Организация
		               |			И ПартииТоваровОстатки.ДокументОснование = ТаблицаДвиженийСвернутая.ДокументОснование
		               |ГДЕ
		               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) > 0
		               |
		               |УПОРЯДОЧИТЬ ПО
		               |	ПустойДокументОснование,
		               |	ТаблицаПриоритетаОрганизаций.Приоритет,
		               |	ПартииТоваровОстатки.СтрокаПриходаДата,
		               |	ПартииТоваровОстатки.ОрганизацияНаименование";

		
	ИначеЕсли СтратегияПогашенияПоОрганизации.СписыватьТолькоПоСвоейОрганизации Тогда 
		КолонкиРаспределения = КолонкиРаспределения + ",Организация"; 
		
		Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
		               |	ТаблицаПоFIFOБезУчетаСтатуса.Номенклатура КАК Номенклатура,
		               |	ТаблицаПоFIFOБезУчетаСтатуса.Склад КАК Склад,
		               |	ТаблицаПоFIFOБезУчетаСтатуса.Качество КАК Качество,
		               |	ТаблицаПоFIFOБезУчетаСтатуса.ВидДоговора КАК ВидДоговора,
		               |	ТаблицаПоFIFOБезУчетаСтатуса.Организация КАК Организация,
		               |	ТаблицаПоFIFOБезУчетаСтатуса.ДокументОснование КАК ДокументОснование
		               |ПОМЕСТИТЬ ТаблицаПоFIFOБезУчетаСтатуса
		               |ИЗ
		               |	&ТаблицаПоFIFOБезУчетаСтатуса КАК ТаблицаПоFIFOБезУчетаСтатуса
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
		               |	ТаблицаДвижений.Склад КАК Склад,
		               |	ТаблицаДвижений.Качество КАК Качество,
		               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаДвижений.Организация КАК Организация,
		               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование,
		               |	ТаблицаДвижений.Количество КАК Количество,
		               |	ТаблицаДвижений.СуммаРубли КАК СуммаРубли,
		               |	ТаблицаДвижений.СуммаДоллары КАК СуммаДоллары,
		               |	ТаблицаДвижений.СуммаЕвро КАК СуммаЕвро,
		               |	ТаблицаДвижений.СуммаБезНДС КАК СуммаБезНДС
		               |ПОМЕСТИТЬ ТаблицаДвижений
		               |ИЗ
		               |	&ТаблицаДвижений КАК ТаблицаДвижений
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
		               |	ТаблицаДвижений.Склад КАК Склад,
		               |	ТаблицаДвижений.Качество КАК Качество,
		               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаДвижений.Организация КАК Организация,
		               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование,
		               |	СУММА(ТаблицаДвижений.Количество) КАК Количество,
		               |	СУММА(ТаблицаДвижений.СуммаРубли) КАК СуммаРубли,
		               |	СУММА(ТаблицаДвижений.СуммаДоллары) КАК СуммаДоллары,
		               |	СУММА(ТаблицаДвижений.СуммаЕвро) КАК СуммаЕвро,
		               |	СУММА(ТаблицаДвижений.СуммаБезНДС) КАК СуммаБезНДС
		               |ПОМЕСТИТЬ ТаблицаДвиженийСвернутая
		               |ИЗ
		               |	ТаблицаДвижений КАК ТаблицаДвижений
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ТаблицаДвижений.Номенклатура,
		               |	ТаблицаДвижений.Склад,
		               |	ТаблицаДвижений.Качество,
		               |	ТаблицаДвижений.СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода,
		               |	ТаблицаДвижений.Организация,
		               |	ТаблицаДвижений.ДокументОснование
		               |
		               |ИНДЕКСИРОВАТЬ ПО
		               |	Номенклатура,
		               |	Склад,
		               |	Качество,
		               |	СтатусПартии,
		               |	СтрокаПрихода,
		               |	Организация,
		               |	ДокументОснование
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ВЫБОР
		               |		КОГДА ПартииТоваровОстатки.СтрокаПрихода.ДоговорКонтрагента.ВидДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
		               |			ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
		               |		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ПустаяСсылка)
		               |	КОНЕЦ КАК ВидДоговора,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	СУММА(ПартииТоваровОстатки.КоличествоОстаток) КАК Количество,
		               |	СУММА(ПартииТоваровОстатки.СуммаРублиОстаток) КАК СуммаРубли,
		               |	СУММА(ПартииТоваровОстатки.СуммаДолларыОстаток) КАК СуммаДоллары,
		               |	СУММА(ПартииТоваровОстатки.СуммаЕвроОстаток) КАК СуммаЕвро,
		               |	СУММА(ПартииТоваровОстатки.СуммаБезНДСОстаток) КАК СуммаБезНДС,
		               |	ПартииТоваровОстатки.СтрокаПрихода.Дата КАК СтрокаПриходаДата,
		               |	ПартииТоваровОстатки.ДокументОснование
		               |ПОМЕСТИТЬ втПартии
		               |ИЗ
		               |	РегистрНакопления.ПартииТоваров.Остатки(
		               |			&КонПериода,
		               |			(Номенклатура, Склад, Качество) В
		               |				(ВЫБРАТЬ
		               |					ТаблицаПоFIFOБезУчетаСтатуса.Номенклатура,
		               |					ТаблицаПоFIFOБезУчетаСтатуса.Склад,
		               |					ТаблицаПоFIFOБезУчетаСтатуса.Качество
		               |				ИЗ
		               |					ТаблицаПоFIFOБезУчетаСтатуса)) КАК ПартииТоваровОстатки
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ВЫБОР
		               |		КОГДА ПартииТоваровОстатки.СтрокаПрихода.ДоговорКонтрагента.ВидДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
		               |			ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
		               |		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ПустаяСсылка)
		               |	КОНЕЦ,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.СтрокаПрихода.Дата,
		               |	ПартииТоваровОстатки.ДокументОснование
		               |
		               |ДЛЯ ИЗМЕНЕНИЯ
		               |	РегистрНакопления.ПартииТоваров.Остатки
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	втПартии.Номенклатура,
		               |	втПартии.Склад,
		               |	втПартии.Качество,
		               |	втПартии.Организация,
		               |	втПартии.СтрокаПрихода,
		               |	втПартии.ВидДоговора,
		               |	втПартии.СтатусПартии,
		               |	втПартии.Количество,
		               |	втПартии.СуммаРубли,
		               |	втПартии.СуммаДоллары,
		               |	втПартии.СуммаЕвро,
		               |	втПартии.СуммаБезНДС,
		               |	втПартии.СтрокаПриходаДата,
		               |	втПартии.ДокументОснование,
		               |	ЛОЖЬ КАК ПустойДокументОснование
		               |ПОМЕСТИТЬ втПартииСвернутые
		               |ИЗ
		               |	ТаблицаПоFIFOБезУчетаСтатуса КАК ТаблицаПоFIFOБезУчетаСтатуса
		               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ втПартии КАК втПартии
		               |		ПО ТаблицаПоFIFOБезУчетаСтатуса.Номенклатура = втПартии.Номенклатура
		               |			И ТаблицаПоFIFOБезУчетаСтатуса.Склад = втПартии.Склад
		               |			И ТаблицаПоFIFOБезУчетаСтатуса.Качество = втПартии.Качество
		               |			И ТаблицаПоFIFOБезУчетаСтатуса.ВидДоговора = втПартии.ВидДоговора
		               |			И ТаблицаПоFIFOБезУчетаСтатуса.Организация = втПартии.Организация
		               |			И ТаблицаПоFIFOБезУчетаСтатуса.ДокументОснование = втПартии.ДокументОснование
		               |ГДЕ
		               |	ТаблицаПоFIFOБезУчетаСтатуса.ДокументОснование <> НЕОПРЕДЕЛЕНО
		               |
		               |ОБЪЕДИНИТЬ ВСЕ
		               |
		               |ВЫБРАТЬ
		               |	втПартии.Номенклатура,
		               |	втПартии.Склад,
		               |	втПартии.Качество,
		               |	втПартии.Организация,
		               |	втПартии.СтрокаПрихода,
		               |	втПартии.ВидДоговора,
		               |	втПартии.СтатусПартии,
		               |	втПартии.Количество,
		               |	втПартии.СуммаРубли,
		               |	втПартии.СуммаДоллары,
		               |	втПартии.СуммаЕвро,
		               |	втПартии.СуммаБезНДС,
		               |	втПартии.СтрокаПриходаДата,
		               |	втПартии.ДокументОснование,
		               |	Истина
		               |ИЗ
		               |	ТаблицаПоFIFOБезУчетаСтатуса КАК ТаблицаПоFIFOБезУчетаСтатуса
		               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ втПартии КАК втПартии
		               |		ПО ТаблицаПоFIFOБезУчетаСтатуса.Номенклатура = втПартии.Номенклатура
		               |			И ТаблицаПоFIFOБезУчетаСтатуса.Склад = втПартии.Склад
		               |			И ТаблицаПоFIFOБезУчетаСтатуса.Качество = втПартии.Качество
		               |			И ТаблицаПоFIFOБезУчетаСтатуса.ВидДоговора = втПартии.ВидДоговора
		               |			И ТаблицаПоFIFOБезУчетаСтатуса.Организация = втПартии.Организация
		               |ГДЕ
		               |	втПартии.ДокументОснование = НЕОПРЕДЕЛЕНО
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.ВидДоговора КАК ВидДоговора,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) КАК Количество,
		               |	ПартииТоваровОстатки.СуммаРубли - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаРубли, 0) КАК СуммаРубли,
		               |	ПартииТоваровОстатки.СуммаДоллары - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаДоллары, 0) КАК СуммаДоллары,
		               |	ПартииТоваровОстатки.СуммаЕвро - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаЕвро, 0) КАК СуммаЕвро,
		               |	ПартииТоваровОстатки.СуммаБезНДС - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаБезНДС, 0) КАК СуммаБезНДС,
		               |	ПартииТоваровОстатки.СтрокаПриходаДата КАК СтрокаПриходаДата,
		               |	ПартииТоваровОстатки.ДокументОснование,
		               |	ПартииТоваровОстатки.ПустойДокументОснование КАК ПустойДокументОснование
		               |ИЗ
		               |	втПартииСвернутые КАК ПартииТоваровОстатки
		               |		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаДвиженийСвернутая КАК ТаблицаДвиженийСвернутая
		               |		ПО ПартииТоваровОстатки.Номенклатура = ТаблицаДвиженийСвернутая.Номенклатура
		               |			И ПартииТоваровОстатки.Склад = ТаблицаДвиженийСвернутая.Склад
		               |			И ПартииТоваровОстатки.Качество = ТаблицаДвиженийСвернутая.Качество
		               |			И ПартииТоваровОстатки.СтатусПартии = ТаблицаДвиженийСвернутая.СтатусПартии
		               |			И ПартииТоваровОстатки.СтрокаПрихода = ТаблицаДвиженийСвернутая.СтрокаПрихода
		               |			И ПартииТоваровОстатки.Организация = ТаблицаДвиженийСвернутая.Организация
		               |			И ПартииТоваровОстатки.ДокументОснование = ТаблицаДвиженийСвернутая.ДокументОснование
		               |ГДЕ
		               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) > 0
		               |
		               |УПОРЯДОЧИТЬ ПО
		               |	ПустойДокументОснование,
		               |	СтрокаПриходаДата";
		
				//Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
				//       |	ТаблицаПоFIFOБезУчетаСтатуса.Номенклатура КАК Номенклатура,
				//       |	ТаблицаПоFIFOБезУчетаСтатуса.Склад КАК Склад,
				//       |	ТаблицаПоFIFOБезУчетаСтатуса.Качество КАК Качество,
				//       |	ТаблицаПоFIFOБезУчетаСтатуса.ВидДоговора КАК ВидДоговора,
				//       |	ТаблицаПоFIFOБезУчетаСтатуса.Организация КАК Организация
				//       |ПОМЕСТИТЬ ТаблицаПоFIFOБезУчетаСтатуса
				//       |ИЗ
				//       |	&ТаблицаПоFIFOБезУчетаСтатуса КАК ТаблицаПоFIFOБезУчетаСтатуса
				//       |;
				//       |
				//       |////////////////////////////////////////////////////////////////////////////////
				//       |ВЫБРАТЬ
				//       |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
				//       |	ТаблицаДвижений.Склад КАК Склад,
				//       |	ТаблицаДвижений.Качество КАК Качество,
				//       |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
				//       |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
				//       |	ТаблицаДвижений.Организация КАК Организация,
				//       |	ТаблицаДвижений.Количество КАК Количество,
				//       |	ТаблицаДвижений.СуммаРубли КАК СуммаРубли,
				//       |	ТаблицаДвижений.СуммаДоллары КАК СуммаДоллары,
				//       |	ТаблицаДвижений.СуммаЕвро КАК СуммаЕвро,
				//       |	ТаблицаДвижений.СуммаБезНДС КАК СуммаБезНДС
				//       |ПОМЕСТИТЬ ТаблицаДвижений
				//       |ИЗ
				//       |	&ТаблицаДвижений КАК ТаблицаДвижений
				//       |;
				//       |
				//       |////////////////////////////////////////////////////////////////////////////////
				//       |ВЫБРАТЬ
				//       |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
				//       |	ТаблицаДвижений.Склад КАК Склад,
				//       |	ТаблицаДвижений.Качество КАК Качество,
				//       |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
				//       |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
				//       |	ТаблицаДвижений.Организация КАК Организация,
				//       |	СУММА(ТаблицаДвижений.Количество) КАК Количество,
				//       |	СУММА(ТаблицаДвижений.СуммаРубли) КАК СуммаРубли,
				//       |	СУММА(ТаблицаДвижений.СуммаДоллары) КАК СуммаДоллары,
				//       |	СУММА(ТаблицаДвижений.СуммаЕвро) КАК СуммаЕвро,
				//       |	СУММА(ТаблицаДвижений.СуммаБезНДС) КАК СуммаБезНДС
				//       |ПОМЕСТИТЬ ТаблицаДвиженийСвернутая
				//       |ИЗ
				//       |	ТаблицаДвижений КАК ТаблицаДвижений
				//       |
				//       |СГРУППИРОВАТЬ ПО
				//       |	ТаблицаДвижений.Номенклатура,
				//       |	ТаблицаДвижений.Склад,
				//       |	ТаблицаДвижений.Качество,
				//       |	ТаблицаДвижений.СтатусПартии,
				//       |	ТаблицаДвижений.СтрокаПрихода,
				//       |	ТаблицаДвижений.Организация
				//       |
				//       |ИНДЕКСИРОВАТЬ ПО
				//       |	Номенклатура,
				//       |	Склад,
				//       |	Качество,
				//       |	СтатусПартии,
				//       |	СтрокаПрихода,
				//       |	Организация
				//       |;
				//       |
				//       |////////////////////////////////////////////////////////////////////////////////
				//       |ВЫБРАТЬ
				//       |	ПартииТоваровОстатки.Номенклатура,
				//       |	ПартииТоваровОстатки.Склад,
				//       |	ПартииТоваровОстатки.Качество,
				//       |	ПартииТоваровОстатки.Организация,
				//       |	ПартииТоваровОстатки.СтрокаПрихода,
				//       |	ВЫБОР
				//       |		КОГДА ПартииТоваровОстатки.СтрокаПрихода.ДоговорКонтрагента.ВидДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
				//       |			ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
				//       |		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ПустаяСсылка)
				//       |	КОНЕЦ КАК ВидДоговора,
				//       |	ПартииТоваровОстатки.СтатусПартии,
				//       |	СУММА(ПартииТоваровОстатки.КоличествоОстаток) КАК Количество,
				//       |	СУММА(ПартииТоваровОстатки.СуммаРублиОстаток) КАК СуммаРубли,
				//       |	СУММА(ПартииТоваровОстатки.СуммаДолларыОстаток) КАК СуммаДоллары,
				//       |	СУММА(ПартииТоваровОстатки.СуммаЕвроОстаток) КАК СуммаЕвро,
				//       |	СУММА(ПартииТоваровОстатки.СуммаБезНДСОстаток) КАК СуммаБезНДС,
				//       |	ПартииТоваровОстатки.СтрокаПрихода.Дата КАК СтрокаПриходаДата
				//       |ПОМЕСТИТЬ втПартииСвернутые
				//       |ИЗ
				//       |	РегистрНакопления.ПартииТоваров.Остатки(
				//       |			&КонПериода,
				//       |			(Номенклатура, Склад, Качество, ВЫБОР
				//       |				КОГДА СтрокаПрихода.ДоговорКонтрагента.ВидДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
				//       |					ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
				//       |				ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ПустаяСсылка)
				//       |			КОНЕЦ, Организация) В
				//       |				(ВЫБРАТЬ
				//       |					ТаблицаПоFIFOБезУчетаСтатуса.Номенклатура,
				//       |					ТаблицаПоFIFOБезУчетаСтатуса.Склад,
				//       |					ТаблицаПоFIFOБезУчетаСтатуса.Качество,
				//       |					ТаблицаПоFIFOБезУчетаСтатуса.ВидДоговора,
				//       |					ТаблицаПоFIFOБезУчетаСтатуса.Организация
				//       |				ИЗ
				//       |					ТаблицаПоFIFOБезУчетаСтатуса)) КАК ПартииТоваровОстатки
				//       |
				//       |СГРУППИРОВАТЬ ПО
				//       |	ПартииТоваровОстатки.Номенклатура,
				//       |	ПартииТоваровОстатки.Склад,
				//       |	ПартииТоваровОстатки.Качество,
				//       |	ПартииТоваровОстатки.Организация,
				//       |	ПартииТоваровОстатки.СтрокаПрихода,
				//       |	ВЫБОР
				//       |		КОГДА ПартииТоваровОстатки.СтрокаПрихода.ДоговорКонтрагента.ВидДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
				//       |			ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
				//       |		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ПустаяСсылка)
				//       |	КОНЕЦ,
				//       |	ПартииТоваровОстатки.СтатусПартии,
				//       |	ПартииТоваровОстатки.СтрокаПрихода.Дата
				//       |
				//       |ДЛЯ ИЗМЕНЕНИЯ
				//       |	РегистрНакопления.ПартииТоваров.Остатки
				//       |;
				//       |
				//       |////////////////////////////////////////////////////////////////////////////////
				//       |ВЫБРАТЬ
				//       |	ПартииТоваровОстатки.Номенклатура,
				//       |	ПартииТоваровОстатки.Склад,
				//       |	ПартииТоваровОстатки.Качество,
				//       |	ПартииТоваровОстатки.Организация,
				//       |	ПартииТоваровОстатки.СтрокаПрихода,
				//       |	ПартииТоваровОстатки.ВидДоговора КАК ВидДоговора,
				//       |	ПартииТоваровОстатки.СтатусПартии,
				//       |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) КАК Количество,
				//       |	ПартииТоваровОстатки.СуммаРубли - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаРубли, 0) КАК СуммаРубли,
				//       |	ПартииТоваровОстатки.СуммаДоллары - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаДоллары, 0) КАК СуммаДоллары,
				//       |	ПартииТоваровОстатки.СуммаЕвро - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаЕвро, 0) КАК СуммаЕвро,
				//       |	ПартииТоваровОстатки.СуммаБезНДС - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаБезНДС, 0) КАК СуммаБезНДС,
				//       |	ПартииТоваровОстатки.СтрокаПриходаДата КАК СтрокаПриходаДата
				//       |ИЗ
				//       |	втПартииСвернутые КАК ПартииТоваровОстатки
				//       |		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаДвиженийСвернутая КАК ТаблицаДвиженийСвернутая
				//       |		ПО ПартииТоваровОстатки.Номенклатура = ТаблицаДвиженийСвернутая.Номенклатура
				//       |			И ПартииТоваровОстатки.Склад = ТаблицаДвиженийСвернутая.Склад
				//       |			И ПартииТоваровОстатки.Качество = ТаблицаДвиженийСвернутая.Качество
				//       |			И ПартииТоваровОстатки.СтатусПартии = ТаблицаДвиженийСвернутая.СтатусПартии
				//       |			И ПартииТоваровОстатки.СтрокаПрихода = ТаблицаДвиженийСвернутая.СтрокаПрихода
				//       |			И ПартииТоваровОстатки.Организация = ТаблицаДвиженийСвернутая.Организация
				//       |ГДЕ
				//       |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) > 0
				//       |
				//       |УПОРЯДОЧИТЬ ПО
				//       |	СтрокаПриходаДата";
	
	Иначе
		Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
		               |	ТаблицаПоFIFOБезУчетаСтатуса.Номенклатура КАК Номенклатура,
		               |	ТаблицаПоFIFOБезУчетаСтатуса.Склад КАК Склад,
		               |	ТаблицаПоFIFOБезУчетаСтатуса.Качество КАК Качество,
		               |	ТаблицаПоFIFOБезУчетаСтатуса.ВидДоговора КАК ВидДоговора,
		               |	ТаблицаПоFIFOБезУчетаСтатуса.ДокументОснование КАК ДокументОснование
		               |ПОМЕСТИТЬ ТаблицаПоFIFOБезУчетаСтатуса
		               |ИЗ
		               |	&ТаблицаПоFIFOБезУчетаСтатуса КАК ТаблицаПоFIFOБезУчетаСтатуса
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
		               |	ТаблицаДвижений.Склад КАК Склад,
		               |	ТаблицаДвижений.Качество КАК Качество,
		               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаДвижений.Организация КАК Организация,
		               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование,
		               |	ТаблицаДвижений.Количество КАК Количество,
		               |	ТаблицаДвижений.СуммаРубли КАК СуммаРубли,
		               |	ТаблицаДвижений.СуммаДоллары КАК СуммаДоллары,
		               |	ТаблицаДвижений.СуммаЕвро КАК СуммаЕвро,
		               |	ТаблицаДвижений.СуммаБезНДС КАК СуммаБезНДС
		               |ПОМЕСТИТЬ ТаблицаДвижений
		               |ИЗ
		               |	&ТаблицаДвижений КАК ТаблицаДвижений
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
		               |	ТаблицаДвижений.Склад КАК Склад,
		               |	ТаблицаДвижений.Качество КАК Качество,
		               |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
		               |	ТаблицаДвижений.Организация КАК Организация,
		               |	СУММА(ТаблицаДвижений.Количество) КАК Количество,
		               |	СУММА(ТаблицаДвижений.СуммаРубли) КАК СуммаРубли,
		               |	СУММА(ТаблицаДвижений.СуммаДоллары) КАК СуммаДоллары,
		               |	СУММА(ТаблицаДвижений.СуммаЕвро) КАК СуммаЕвро,
		               |	СУММА(ТаблицаДвижений.СуммаБезНДС) КАК СуммаБезНДС,
		               |	ТаблицаДвижений.ДокументОснование КАК ДокументОснование
		               |ПОМЕСТИТЬ ТаблицаДвиженийСвернутая
		               |ИЗ
		               |	ТаблицаДвижений КАК ТаблицаДвижений
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ТаблицаДвижений.Номенклатура,
		               |	ТаблицаДвижений.Склад,
		               |	ТаблицаДвижений.Качество,
		               |	ТаблицаДвижений.СтатусПартии,
		               |	ТаблицаДвижений.СтрокаПрихода,
		               |	ТаблицаДвижений.Организация,
		               |	ТаблицаДвижений.ДокументОснование
		               |
		               |ИНДЕКСИРОВАТЬ ПО
		               |	Номенклатура,
		               |	Склад,
		               |	Качество,
		               |	СтатусПартии,
		               |	СтрокаПрихода,
		               |	Организация,
		               |	ДокументОснование
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ВЫБОР
		               |		КОГДА ПартииТоваровОстатки.СтрокаПрихода.ДоговорКонтрагента.ВидДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
		               |			ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
		               |		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ПустаяСсылка)
		               |	КОНЕЦ КАК ВидДоговора,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	СУММА(ПартииТоваровОстатки.КоличествоОстаток) КАК Количество,
		               |	СУММА(ПартииТоваровОстатки.СуммаРублиОстаток) КАК СуммаРубли,
		               |	СУММА(ПартииТоваровОстатки.СуммаДолларыОстаток) КАК СуммаДоллары,
		               |	СУММА(ПартииТоваровОстатки.СуммаЕвроОстаток) КАК СуммаЕвро,
		               |	СУММА(ПартииТоваровОстатки.СуммаБезНДСОстаток) КАК СуммаБезНДС,
		               |	ПартииТоваровОстатки.Организация = &Организация КАК ЭтаОрганизация,
		               |	ПартииТоваровОстатки.СтрокаПрихода.Дата КАК СтрокаПриходаДата,
		               |	ПартииТоваровОстатки.Организация.Наименование КАК ОрганизацияНаименование,
		               |	ПартииТоваровОстатки.ДокументОснование
		               |ПОМЕСТИТЬ втПартии
		               |ИЗ
		               |	РегистрНакопления.ПартииТоваров.Остатки(
		               |			&КонПериода,
		               |			(Номенклатура, Склад, Качество) В
		               |				(ВЫБРАТЬ
		               |					ТаблицаПоFIFOБезУчетаСтатуса.Номенклатура,
		               |					ТаблицаПоFIFOБезУчетаСтатуса.Склад,
		               |					ТаблицаПоFIFOБезУчетаСтатуса.Качество
		               |				ИЗ
		               |					ТаблицаПоFIFOБезУчетаСтатуса)) КАК ПартииТоваровОстатки
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ВЫБОР
		               |		КОГДА ПартииТоваровОстатки.СтрокаПрихода.ДоговорКонтрагента.ВидДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
		               |			ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
		               |		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ПустаяСсылка)
		               |	КОНЕЦ,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.СтрокаПрихода.Дата,
		               |	ПартииТоваровОстатки.Организация.Наименование,
		               |	ПартииТоваровОстатки.Организация = &Организация,
		               |	ПартииТоваровОстатки.ДокументОснование
		               |
		               |ДЛЯ ИЗМЕНЕНИЯ
		               |	РегистрНакопления.ПартииТоваров.Остатки
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	втПартии.Номенклатура,
		               |	втПартии.Склад,
		               |	втПартии.Качество,
		               |	втПартии.Организация,
		               |	втПартии.СтрокаПрихода,
		               |	втПартии.ВидДоговора,
		               |	втПартии.СтатусПартии,
		               |	втПартии.Количество,
		               |	втПартии.СуммаРубли,
		               |	втПартии.СуммаДоллары,
		               |	втПартии.СуммаЕвро,
		               |	втПартии.СуммаБезНДС,
		               |	втПартии.ЭтаОрганизация,
		               |	втПартии.СтрокаПриходаДата,
		               |	втПартии.ОрганизацияНаименование,
		               |	втПартии.ДокументОснование,
		               |	ЛОЖЬ КАК ПустойДокументОснование
		               |ПОМЕСТИТЬ втПартииСвернутые
		               |ИЗ
		               |	ТаблицаПоFIFOБезУчетаСтатуса КАК ТаблицаПоFIFOБезУчетаСтатуса
		               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ втПартии КАК втПартии
		               |		ПО ТаблицаПоFIFOБезУчетаСтатуса.Номенклатура = втПартии.Номенклатура
		               |			И ТаблицаПоFIFOБезУчетаСтатуса.Склад = втПартии.Склад
		               |			И ТаблицаПоFIFOБезУчетаСтатуса.Качество = втПартии.Качество
		               |			И ТаблицаПоFIFOБезУчетаСтатуса.ВидДоговора = втПартии.ВидДоговора
		               |			И ТаблицаПоFIFOБезУчетаСтатуса.ДокументОснование = втПартии.ДокументОснование
		               |ГДЕ
		               |	НЕ втПартии.Организация В (&ЗапрещенныеОрганизации)
		               |	И ТаблицаПоFIFOБезУчетаСтатуса.ДокументОснование <> НЕОПРЕДЕЛЕНО
		               |
		               |ОБЪЕДИНИТЬ ВСЕ
		               |
		               |ВЫБРАТЬ
		               |	втПартии.Номенклатура,
		               |	втПартии.Склад,
		               |	втПартии.Качество,
		               |	втПартии.Организация,
		               |	втПартии.СтрокаПрихода,
		               |	втПартии.ВидДоговора,
		               |	втПартии.СтатусПартии,
		               |	втПартии.Количество,
		               |	втПартии.СуммаРубли,
		               |	втПартии.СуммаДоллары,
		               |	втПартии.СуммаЕвро,
		               |	втПартии.СуммаБезНДС,
		               |	втПартии.ЭтаОрганизация,
		               |	втПартии.СтрокаПриходаДата,
		               |	втПартии.ОрганизацияНаименование,
		               |	втПартии.ДокументОснование,
		               |	ИСТИНА
		               |ИЗ
		               |	ТаблицаПоFIFOБезУчетаСтатуса КАК ТаблицаПоFIFOБезУчетаСтатуса
		               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ втПартии КАК втПартии
		               |		ПО ТаблицаПоFIFOБезУчетаСтатуса.Номенклатура = втПартии.Номенклатура
		               |			И ТаблицаПоFIFOБезУчетаСтатуса.Склад = втПартии.Склад
		               |			И ТаблицаПоFIFOБезУчетаСтатуса.Качество = втПартии.Качество
		               |			И ТаблицаПоFIFOБезУчетаСтатуса.ВидДоговора = втПартии.ВидДоговора
		               |ГДЕ
		               |	НЕ втПартии.Организация В (&ЗапрещенныеОрганизации)
		               |	И втПартии.ДокументОснование = НЕОПРЕДЕЛЕНО
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.ВидДоговора КАК ВидДоговора,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) КАК Количество,
		               |	ПартииТоваровОстатки.СуммаРубли - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаРубли, 0) КАК СуммаРубли,
		               |	ПартииТоваровОстатки.СуммаДоллары - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаДоллары, 0) КАК СуммаДоллары,
		               |	ПартииТоваровОстатки.СуммаЕвро - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаЕвро, 0) КАК СуммаЕвро,
		               |	ПартииТоваровОстатки.СуммаБезНДС - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаБезНДС, 0) КАК СуммаБезНДС,
		               |	ПартииТоваровОстатки.Организация = &Организация КАК ЭтаОрганизация,
		               |	ПартииТоваровОстатки.СтрокаПриходаДата КАК СтрокаПриходаДата,
		               |	ПартииТоваровОстатки.ОрганизацияНаименование КАК ОрганизацияНаименование,
		               |	ПартииТоваровОстатки.ДокументОснование,
		               |	ПартииТоваровОстатки.ПустойДокументОснование КАК ПустойДокументОснование
		               |ИЗ
		               |	втПартииСвернутые КАК ПартииТоваровОстатки
		               |		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаДвиженийСвернутая КАК ТаблицаДвиженийСвернутая
		               |		ПО ПартииТоваровОстатки.Номенклатура = ТаблицаДвиженийСвернутая.Номенклатура
		               |			И ПартииТоваровОстатки.Склад = ТаблицаДвиженийСвернутая.Склад
		               |			И ПартииТоваровОстатки.Качество = ТаблицаДвиженийСвернутая.Качество
		               |			И ПартииТоваровОстатки.СтатусПартии = ТаблицаДвиженийСвернутая.СтатусПартии
		               |			И ПартииТоваровОстатки.СтрокаПрихода = ТаблицаДвиженийСвернутая.СтрокаПрихода
		               |			И ПартииТоваровОстатки.Организация = ТаблицаДвиженийСвернутая.Организация
		               |			И ПартииТоваровОстатки.ДокументОснование = ТаблицаДвиженийСвернутая.ДокументОснование
		               |ГДЕ
		               |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) > 0
		               |
		               |УПОРЯДОЧИТЬ ПО
		               |	ЭтаОрганизация УБЫВ,
		               |	ОрганизацияНаименование,
		               |	ПустойДокументОснование,
		               |	СтрокаПриходаДата";
		
				//Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
				//       |	ТаблицаПоFIFOБезУчетаСтатуса.Номенклатура КАК Номенклатура,
				//       |	ТаблицаПоFIFOБезУчетаСтатуса.Склад КАК Склад,
				//       |	ТаблицаПоFIFOБезУчетаСтатуса.Качество КАК Качество,
				//       |	ТаблицаПоFIFOБезУчетаСтатуса.ВидДоговора КАК ВидДоговора
				//       |ПОМЕСТИТЬ ТаблицаПоFIFOБезУчетаСтатуса
				//       |ИЗ
				//       |	&ТаблицаПоFIFOБезУчетаСтатуса КАК ТаблицаПоFIFOБезУчетаСтатуса
				//       |;
				//       |
				//       |////////////////////////////////////////////////////////////////////////////////
				//       |ВЫБРАТЬ
				//       |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
				//       |	ТаблицаДвижений.Склад КАК Склад,
				//       |	ТаблицаДвижений.Качество КАК Качество,
				//       |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
				//       |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
				//       |	ТаблицаДвижений.Организация КАК Организация,
				//       |	ТаблицаДвижений.Количество КАК Количество,
				//       |	ТаблицаДвижений.СуммаРубли КАК СуммаРубли,
				//       |	ТаблицаДвижений.СуммаДоллары КАК СуммаДоллары,
				//       |	ТаблицаДвижений.СуммаЕвро КАК СуммаЕвро,
				//       |	ТаблицаДвижений.СуммаБезНДС КАК СуммаБезНДС
				//       |ПОМЕСТИТЬ ТаблицаДвижений
				//       |ИЗ
				//       |	&ТаблицаДвижений КАК ТаблицаДвижений
				//       |;
				//       |
				//       |////////////////////////////////////////////////////////////////////////////////
				//       |ВЫБРАТЬ
				//       |	ТаблицаДвижений.Номенклатура КАК Номенклатура,
				//       |	ТаблицаДвижений.Склад КАК Склад,
				//       |	ТаблицаДвижений.Качество КАК Качество,
				//       |	ТаблицаДвижений.СтатусПартии КАК СтатусПартии,
				//       |	ТаблицаДвижений.СтрокаПрихода КАК СтрокаПрихода,
				//       |	ТаблицаДвижений.Организация КАК Организация,
				//       |	СУММА(ТаблицаДвижений.Количество) КАК Количество,
				//       |	СУММА(ТаблицаДвижений.СуммаРубли) КАК СуммаРубли,
				//       |	СУММА(ТаблицаДвижений.СуммаДоллары) КАК СуммаДоллары,
				//       |	СУММА(ТаблицаДвижений.СуммаЕвро) КАК СуммаЕвро,
				//       |	СУММА(ТаблицаДвижений.СуммаБезНДС) КАК СуммаБезНДС
				//       |ПОМЕСТИТЬ ТаблицаДвиженийСвернутая
				//       |ИЗ
				//       |	ТаблицаДвижений КАК ТаблицаДвижений
				//       |
				//       |СГРУППИРОВАТЬ ПО
				//       |	ТаблицаДвижений.Номенклатура,
				//       |	ТаблицаДвижений.Склад,
				//       |	ТаблицаДвижений.Качество,
				//       |	ТаблицаДвижений.СтатусПартии,
				//       |	ТаблицаДвижений.СтрокаПрихода,
				//       |	ТаблицаДвижений.Организация
				//       |
				//       |ИНДЕКСИРОВАТЬ ПО
				//       |	Номенклатура,
				//       |	Склад,
				//       |	Качество,
				//       |	СтатусПартии,
				//       |	СтрокаПрихода,
				//       |	Организация
				//       |;
				//       |
				//       |////////////////////////////////////////////////////////////////////////////////
				//       |ВЫБРАТЬ
				//       |	ПартииТоваровОстатки.Номенклатура,
				//       |	ПартииТоваровОстатки.Склад,
				//       |	ПартииТоваровОстатки.Качество,
				//       |	ПартииТоваровОстатки.Организация,
				//       |	ПартииТоваровОстатки.СтрокаПрихода,
				//       |	ВЫБОР
				//       |		КОГДА ПартииТоваровОстатки.СтрокаПрихода.ДоговорКонтрагента.ВидДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
				//       |			ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
				//       |		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ПустаяСсылка)
				//       |	КОНЕЦ КАК ВидДоговора,
				//       |	ПартииТоваровОстатки.СтатусПартии,
				//       |	СУММА(ПартииТоваровОстатки.КоличествоОстаток) КАК Количество,
				//       |	СУММА(ПартииТоваровОстатки.СуммаРублиОстаток) КАК СуммаРубли,
				//       |	СУММА(ПартииТоваровОстатки.СуммаДолларыОстаток) КАК СуммаДоллары,
				//       |	СУММА(ПартииТоваровОстатки.СуммаЕвроОстаток) КАК СуммаЕвро,
				//       |	СУММА(ПартииТоваровОстатки.СуммаБезНДСОстаток) КАК СуммаБезНДС,
				//       |	ПартииТоваровОстатки.Организация = &Организация КАК ЭтаОрганизация,
				//       |	ПартииТоваровОстатки.СтрокаПрихода.Дата КАК СтрокаПриходаДата,
				//       |	ПартииТоваровОстатки.Организация.Наименование КАК ОрганизацияНаименование
				//       |ПОМЕСТИТЬ втПартииСвернутые
				//       |ИЗ
				//       |	РегистрНакопления.ПартииТоваров.Остатки(
				//       |			&КонПериода,
				//       |			(Номенклатура, Склад, Качество, ВЫБОР
				//       |					КОГДА СтрокаПрихода.ДоговорКонтрагента.ВидДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
				//       |						ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
				//       |					ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ПустаяСсылка)
				//       |				КОНЕЦ) В
				//       |					(ВЫБРАТЬ
				//       |						ТаблицаПоFIFOБезУчетаСтатуса.Номенклатура,
				//       |						ТаблицаПоFIFOБезУчетаСтатуса.Склад,
				//       |						ТаблицаПоFIFOБезУчетаСтатуса.Качество,
				//       |						ТаблицаПоFIFOБезУчетаСтатуса.ВидДоговора
				//       |					ИЗ
				//       |						ТаблицаПоFIFOБезУчетаСтатуса)
				//       |				И НЕ Организация В (&ЗапрещенныеОрганизации)) КАК ПартииТоваровОстатки
				//       |
				//       |СГРУППИРОВАТЬ ПО
				//       |	ПартииТоваровОстатки.Номенклатура,
				//       |	ПартииТоваровОстатки.Склад,
				//       |	ПартииТоваровОстатки.Качество,
				//       |	ПартииТоваровОстатки.Организация,
				//       |	ПартииТоваровОстатки.СтрокаПрихода,
				//       |	ВЫБОР
				//       |		КОГДА ПартииТоваровОстатки.СтрокаПрихода.ДоговорКонтрагента.ВидДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
				//       |			ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ОтветХранение)
				//       |		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ПустаяСсылка)
				//       |	КОНЕЦ,
				//       |	ПартииТоваровОстатки.СтатусПартии,
				//       |	ПартииТоваровОстатки.СтрокаПрихода.Дата,
				//       |	ПартииТоваровОстатки.Организация.Наименование
				//       |
				//       |ДЛЯ ИЗМЕНЕНИЯ
				//       |	РегистрНакопления.ПартииТоваров.Остатки
				//       |;
				//       |
				//       |////////////////////////////////////////////////////////////////////////////////
				//       |ВЫБРАТЬ
				//       |	ПартииТоваровОстатки.Номенклатура,
				//       |	ПартииТоваровОстатки.Склад,
				//       |	ПартииТоваровОстатки.Качество,
				//       |	ПартииТоваровОстатки.Организация,
				//       |	ПартииТоваровОстатки.СтрокаПрихода,
				//       |	ПартииТоваровОстатки.ВидДоговора КАК ВидДоговора,
				//       |	ПартииТоваровОстатки.СтатусПартии,
				//       |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) КАК Количество,
				//       |	ПартииТоваровОстатки.СуммаРубли - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаРубли, 0) КАК СуммаРубли,
				//       |	ПартииТоваровОстатки.СуммаДоллары - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаДоллары, 0) КАК СуммаДоллары,
				//       |	ПартииТоваровОстатки.СуммаЕвро - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаЕвро, 0) КАК СуммаЕвро,
				//       |	ПартииТоваровОстатки.СуммаБезНДС - ЕСТЬNULL(ТаблицаДвиженийСвернутая.СуммаБезНДС, 0) КАК СуммаБезНДС,
				//       |	ПартииТоваровОстатки.Организация = &Организация КАК ЭтаОрганизация,
				//       |	ПартииТоваровОстатки.СтрокаПриходаДата КАК СтрокаПриходаДата,
				//       |	ПартииТоваровОстатки.ОрганизацияНаименование КАК ОрганизацияНаименование
				//       |ИЗ
				//       |	втПартииСвернутые КАК ПартииТоваровОстатки
				//       |		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаДвиженийСвернутая КАК ТаблицаДвиженийСвернутая
				//       |		ПО ПартииТоваровОстатки.Номенклатура = ТаблицаДвиженийСвернутая.Номенклатура
				//       |			И ПартииТоваровОстатки.Склад = ТаблицаДвиженийСвернутая.Склад
				//       |			И ПартииТоваровОстатки.Качество = ТаблицаДвиженийСвернутая.Качество
				//       |			И ПартииТоваровОстатки.СтатусПартии = ТаблицаДвиженийСвернутая.СтатусПартии
				//       |			И ПартииТоваровОстатки.СтрокаПрихода = ТаблицаДвиженийСвернутая.СтрокаПрихода
				//       |			И ПартииТоваровОстатки.Организация = ТаблицаДвиженийСвернутая.Организация
				//       |ГДЕ
				//       |	ПартииТоваровОстатки.Количество - ЕСТЬNULL(ТаблицаДвиженийСвернутая.Количество, 0) > 0
				//       |
				//       |УПОРЯДОЧИТЬ ПО
				//       |	ЭтаОрганизация УБЫВ,
				//       |	ОрганизацияНаименование,
				//       |	СтрокаПриходаДата";
	
		Организация = ТаблицаПоFIFOБезУчетаСтатуса.Получить(0).Организация;			   
		Запрос.УстановитьПараметр("Организация", Организация);
		Запрос.УстановитьПараметр("ЗапрещенныеОрганизации", ЗапрещенныеОрганизацииПродавцы(Организация, Реквизиты.Дата));
		ОтсортированаПоОрганизации = Организация;
	КонецЕсли;	
	
	//Если УчитыватьПоставщика Тогда 
	//	Запрос.Текст = СтрЗаменить(Запрос.Текст, "%ОтборПоПоставщику%", "И СтрокаПрихода.ТорговаяТочка.Владелец = &Поставщик");
	//	Запрос.УстановитьПараметр("Поставщик", ОбщегоНазначения.ЗначениеРеквизитаОбъекта(вхСсылкаНаДокумент, "Контрагент"));
	//Иначе
	//	Запрос.Текст = СтрЗаменить(Запрос.Текст, "%ОтборПоПоставщику%", "");
	//КонецЕсли;
	
	ОстаткиПоПартиям = Запрос.Выполнить().Выгрузить();
	ОстаткиПоПартиям.Индексы.Добавить(КолонкиРаспределения);
	
	ПередаваемыеПараметры = Новый Структура;
	ПередаваемыеПараметры.Вставить("КолонкиРаспределения", КолонкиРаспределения);
	ПередаваемыеПараметры.Вставить("ЗаполняемыеРеквизиты", ЗаполняемыеРеквизиты);
	ПередаваемыеПараметры.Вставить("КонтрольНаличияПартий", КонтрольНаличияПартий);
	ПередаваемыеПараметры.Вставить("ДатаДокумента", Реквизиты.Дата);	
	ПередаваемыеПараметры.Вставить("СписыватьТолькоПоСвоейОрганизации", СтратегияПогашенияПоОрганизации.СписыватьТолькоПоСвоейОрганизации);
	ПередаваемыеПараметры.Вставить("СтратегияПогашенияПоОрганизации", СтратегияПогашенияПоОрганизации);
	
	ПогашениеПартийТоваровНовоеФрагмент(вхСсылкаНаДокумент, ТаблицаПоFIFOБезУчетаСтатуса, ПередаваемыеПараметры, ОстаткиПоПартиям, ТаблицаДвижений, вхОтказ,,ОтсортированаПоОрганизации, ПараметрыСписания);
КонецПроцедуры

// Возращает массив организаций, которые НЕ могут продавать переданной организации на переданную дату
Функция ЗапрещенныеОрганизацииПродавцы(ОрганизацияПокупатель, ДатаПроведения) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	ПроцентыПередач.ОрганизацияПродавец
	               |ИЗ
	               |	РегистрСведений.ПроцентыПередач КАК ПроцентыПередач
	               |ГДЕ
	               |	ПроцентыПередач.ОрганизацияПокупатель = &ОрганизацияПокупатель
	               |	И ПроцентыПередач.НеИспользовать
	               |	И ПроцентыПередач.ДатаЗапрета <= &ДатаПроведения";
	Запрос.УстановитьПараметр("ОрганизацияПокупатель", ОрганизацияПокупатель);
	Запрос.УстановитьПараметр("ДатаПроведения", ДатаПроведения);
	Массив = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку(0);
	
	Возврат Массив;
	
КонецФункции

//Конец Процедуры списания по партиям

//Товары на складах
Процедура КонтрольОстатков(вхСсылкаНаДокумент, вхОтказ, СУчетомРезерва = Истина, вхПараметры = Неопределено) Экспорт 
	Перем ОтключитьКонтрольОстатков;
	
	Если ПрочитатьЗначение(вхПараметры, "ОтключитьКонтрольОстатков", ОтключитьКонтрольОстатков) Тогда 
		Возврат;
	КонецЕсли;
	
	ДатаДокумента = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(вхСсылкаНаДокумент, "Дата");
	Если ДатаДокумента < ПараметрыСеанса.ДатаНачалаРаботыТовары ИЛИ ДатаДокумента < глЗначениеПеременной("ДатаЗапускаПервогоЭтапа") Тогда
		Возврат;
	КонецЕсли;

	МетаданныеДокумента = вхСсылкаНаДокумент.Метаданные();
	ЕстьРеквизитСклад = ОбщегоНазначения.ЕстьРеквизитДокумента("Склад", МетаданныеДокумента);			
	ИмяРеквизитаСклада = "Склад";
	Если Не ЕстьРеквизитСклад Тогда 
		ЕстьРеквизитСкладОтправитель = ОбщегоНазначения.ЕстьРеквизитДокумента("СкладОтправитель", МетаданныеДокумента);
		Если Не ЕстьРеквизитСкладОтправитель Тогда 
			ВызватьИсключение "[КонтрольОстатковПоРегиструТоварыНаСкладах]: В документе не найден реквизит ""Склад"" или ""Склад-отправитель""";
		КонецЕсли;
		ИмяРеквизитаСклада = "СкладОтправитель";
	КонецЕсли;
	
	МенеджерОбъекта = ОбщегоНазначения.МенеджерОбъектаПоМетаданным(МетаданныеДокумента);	
	Товары = МенеджерОбъекта.ТаблицаДляКонтроляОстатков(вхСсылкаНаДокумент);
	
	ИмяКолонкиКоличество = "Количество";
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("втТовары", Товары);
	
	Запрос.Текст = "ВЫБРАТЬ
	               |	втТовары.Склад КАК Склад,
	               |	втТовары.Номенклатура КАК Номенклатура,
	               |	втТовары.Качество КАК Качество,
	               |	втТовары.Количество КАК Количество
	               |ПОМЕСТИТЬ втТовары
	               |ИЗ
	               |	&втТовары КАК втТовары
	               |
	               |ИНДЕКСИРОВАТЬ ПО
	               |	Номенклатура,
	               |	Склад,
	               |	Качество";
					 
	Если СУчетомРезерва Тогда
	Запрос.Текст = 
	Запрос.Текст + ";" +  
				   "ВЫБРАТЬ
	               |	РезервыТоваровОстатки.Склад КАК Склад,
	               |	РезервыТоваровОстатки.Номенклатура КАК Номенклатура,
	               |	РезервыТоваровОстатки.Качество КАК Качество,
	               |	РезервыТоваровОстатки.КоличествоОстаток
	               |ПОМЕСТИТЬ втРезервы
	               |ИЗ
	               |	РегистрНакопления.РезервыТоваров.Остатки(
	               |			&КонПериода,
	               |			(Номенклатура, Склад, Качество) В
	               |				(ВЫБРАТЬ
	               |					втТовары.Номенклатура,
	               |					втТовары.Склад,
	               |					втТовары.Качество
	               |				ИЗ
	               |					втТовары)) КАК РезервыТоваровОстатки
	               |ГДЕ
	               |	РезервыТоваровОстатки.КоличествоОстаток > 0
	               |
	               |ИНДЕКСИРОВАТЬ ПО
	               |	Номенклатура,
	               |	Склад,
	               |	Качество
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ТоварыНаСкладахОстатки.Склад КАК Склад,
	               |	ТоварыНаСкладахОстатки.Номенклатура КАК Номенклатура,
	               |	ТоварыНаСкладахОстатки.Качество КАК Качество,
	               |	ТоварыНаСкладахОстатки.КоличествоОстаток
	               |ПОМЕСТИТЬ втТоварыНаСкладах
	               |ИЗ
	               |	РегистрНакопления.ТоварыНаСкладах.Остатки(
	               |			&КонПериода,
	               |			(Номенклатура, Склад, Качество) В
	               |				(ВЫБРАТЬ
	               |					втТовары.Номенклатура,
	               |					втТовары.Склад,
	               |					втТовары.Качество
	               |				ИЗ
	               |					втТовары)) КАК ТоварыНаСкладахОстатки
	               |ГДЕ
	               |	ТоварыНаСкладахОстатки.КоличествоОстаток > 0
	               |
	               |ДЛЯ ИЗМЕНЕНИЯ
	               |	РегистрНакопления.ТоварыНаСкладах.Остатки
	               |
	               |ИНДЕКСИРОВАТЬ ПО
	               |	Номенклатура,
	               |	Склад,
	               |	Качество
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	втТовары.Склад,
	               |	втТовары.Номенклатура,
	               |	втТовары.Качество,
	               |	втТовары.Количество - ЕСТЬNULL(ТоварыНаСкладахОстатки.КоличествоОстаток, 0) + ЕСТЬNULL(втРезервы.КоличествоОстаток, 0) КАК Количество
	               |ИЗ
	               |	втТовары КАК втТовары
	               |		ЛЕВОЕ СОЕДИНЕНИЕ втТоварыНаСкладах КАК ТоварыНаСкладахОстатки
	               |		ПО втТовары.Номенклатура = ТоварыНаСкладахОстатки.Номенклатура
	               |			И втТовары.Склад = ТоварыНаСкладахОстатки.Склад
	               |			И втТовары.Качество = ТоварыНаСкладахОстатки.Качество
	               |		ЛЕВОЕ СОЕДИНЕНИЕ втРезервы КАК втРезервы
	               |		ПО втТовары.Номенклатура = втРезервы.Номенклатура
	               |			И втТовары.Склад = втРезервы.Склад
	               |			И втТовары.Качество = втРезервы.Качество
	               |ГДЕ
	               |	втТовары.Количество - ЕСТЬNULL(ТоварыНаСкладахОстатки.КоличествоОстаток, 0) + ЕСТЬNULL(втРезервы.КоличествоОстаток, 0) > 0";

	Иначе
	Запрос.Текст = 
	Запрос.Текст + ";" + 
		           "ВЫБРАТЬ
		           |	ТоварыНаСкладахОстатки.Склад КАК Склад,
		           |	ТоварыНаСкладахОстатки.Номенклатура КАК Номенклатура,
		           |	ТоварыНаСкладахОстатки.Качество КАК Качество,
		           |	ТоварыНаСкладахОстатки.КоличествоОстаток
		           |ПОМЕСТИТЬ втТоварыНаСкладах
		           |ИЗ
		           |	РегистрНакопления.ТоварыНаСкладах.Остатки(
		           |			&КонПериода,
		           |			(Номенклатура, Склад, Качество) В
		           |				(ВЫБРАТЬ
		           |					втТовары.Номенклатура,
		           |					втТовары.Склад,
		           |					втТовары.Качество
		           |				ИЗ
		           |					втТовары)) КАК ТоварыНаСкладахОстатки
		           |ГДЕ
		           |	ТоварыНаСкладахОстатки.КоличествоОстаток > 0
		           |
		           |ДЛЯ ИЗМЕНЕНИЯ
		           |	РегистрНакопления.ТоварыНаСкладах.Остатки
		           |
		           |ИНДЕКСИРОВАТЬ ПО
		           |	Номенклатура,
		           |	Склад,
		           |	Качество
		           |;
		           |
		           |////////////////////////////////////////////////////////////////////////////////
		           |ВЫБРАТЬ
		           |	втТовары.Склад,
		           |	втТовары.Номенклатура,
		           |	втТовары.Качество,
		           |	втТовары.Количество - ЕСТЬNULL(ТоварыНаСкладахОстатки.КоличествоОстаток, 0) КАК Количество
		           |ИЗ
		           |	втТовары КАК втТовары
		           |		ЛЕВОЕ СОЕДИНЕНИЕ втТоварыНаСкладах КАК ТоварыНаСкладахОстатки
		           |		ПО втТовары.Номенклатура = ТоварыНаСкладахОстатки.Номенклатура
		           |			И втТовары.Склад = ТоварыНаСкладахОстатки.Склад
		           |			И втТовары.Качество = ТоварыНаСкладахОстатки.Качество
		           |ГДЕ
		           |	втТовары.Количество - ЕСТЬNULL(ТоварыНаСкладахОстатки.КоличествоОстаток, 0) > 0";
	КонецЕсли;
					 
	Запрос.УстановитьПараметр("Ссылка", вхСсылкаНаДокумент);
	Запрос.УстановитьПараметр("КонПериода", вхСсылкаНаДокумент.МоментВремени());
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Сообщение = "";
	Успешно = Истина;
	
	Если Не РезультатЗапроса.Пустой() Тогда 
		Выборка = РезультатЗапроса.Выбрать();
		Пока Выборка.Следующий() Цикл 
			вхОтказ = Истина;
			Успешно =  Ложь;
			//#PK83-720 Kalinin V.A. ( 2018-06-01 )
			Сообщение = Сообщение + "[КонтрольОстатков]: на складе " + Выборка.Склад + " не хватает остатка номенклатуры " +
			УправлениеЗапасами.ПредставлениеНоменклатуры(Выборка.Номенклатура,,ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Выборка.Номенклатура,"Артикул")) + " с качеством " + Выборка.Качество + " в количестве " + Выборка.Количество + Символы.ПС;
		КонецЦикла;
	КонецЕсли;
	
	Если Не Успешно Тогда 
		#Если Клиент Тогда 
			Сообщить(Сообщение);
		#Иначе
			ВызватьИсключение Сообщение;
		#КонецЕсли
	КонецЕсли;
КонецПроцедуры

//Резервы товаров
Процедура СписатьРезервы(Товары, Остатки, ТаблицаДвижений, вхСсылкаНаДокумент, ТаблицаНеудалосьРаспределить = Неопределено) Экспорт
	
	лКлючАлгоритма = "ОбщийМодуль_ПроведениеДокументовКлиентСервер_СписатьРезервы";
	лЗамена = АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		Выполнить(лЗамена);
	КонецЕсли;
	
	Если ТаблицаНеудалосьРаспределить = Неопределено Тогда 
		ТаблицаНеудалосьРаспределить = Остатки.СкопироватьКолонки();
	КонецЕсли;
	
	Пока Товары.Следующий() Цикл 
		Отбор = Новый Структура("Склад,Номенклатура,Качество,СтрокаЗаявки,СтрокаПрихода");
		ЗаполнитьЗначенияСвойств(Отбор, Товары);
		Строки = Остатки.НайтиСтроки(Отбор);
		
		КоличествоРаспределить = Товары.Количество;
		ИндексСтроки = 0;
		Пока КоличествоРаспределить > 0 И ИндексСтроки < Строки.Количество() Цикл 
			СтрокаРезерва = Строки.Получить(ИндексСтроки);
			Если СтрокаРезерва.Количество > 0 Тогда 
				СписываемоеКоличество = Мин(КоличествоРаспределить, СтрокаРезерва.Количество);
				СтрокаДвижений = ТаблицаДвижений.Добавить();
				ЗаполнитьЗначенияСвойств(СтрокаДвижений, СтрокаРезерва);
				СтрокаДвижений.Количество = СписываемоеКоличество;
				СтрокаРезерва.Количество = СтрокаРезерва.Количество - СписываемоеКоличество;
				КоличествоРаспределить = КоличествоРаспределить - СписываемоеКоличество;
			КонецЕсли;
			ИндексСтроки = ИндексСтроки + 1;
		КонецЦикла;
		Если КоличествоРаспределить > 0 Тогда 
			НоваяСтрока = ТаблицаНеудалосьРаспределить.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, Товары);
			НоваяСтрока.Количество = КоличествоРаспределить;
		КонецЕсли;
	КонецЦикла;
	
	Для Каждого Строка Из ТаблицаНеудалосьРаспределить Цикл 
		Отбор = Новый Структура("Склад,Номенклатура,Качество,СтрокаЗаявки");
		ЗаполнитьЗначенияСвойств(Отбор, Строка);
		Строки = Остатки.НайтиСтроки(Отбор);
		
		КоличествоРаспределить = Строка.Количество;
		ИндексСтроки = 0;
		Пока КоличествоРаспределить > 0 И ИндексСтроки < Строки.Количество() Цикл
			СтрокаРезерва = Строки.Получить(ИндексСтроки);
			Если СтрокаРезерва.Количество > 0 Тогда 
				СписываемоеКоличество = Мин(КоличествоРаспределить, СтрокаРезерва.Количество);
				СтрокаДвижений = ТаблицаДвижений.Добавить();
				ЗаполнитьЗначенияСвойств(СтрокаДвижений, СтрокаРезерва);
				СтрокаДвижений.Количество = СписываемоеКоличество;
				СтрокаРезерва.Количество = СтрокаРезерва.Количество - СписываемоеКоличество;
				КоличествоРаспределить = КоличествоРаспределить - СписываемоеКоличество;
				Строка.Количество = Строка.Количество - КоличествоРаспределить;
			КонецЕсли;
			ИндексСтроки = ИндексСтроки + 1;
		КонецЦикла;
	КонецЦикла;
	
	ТаблицаДвижений.ЗаполнитьЗначения(вхСсылкаНаДокумент, "Регистратор");
	ТаблицаДвижений.ЗаполнитьЗначения(ОбщегоНазначения.ЗначениеРеквизитаОбъекта(вхСсылкаНаДокумент, "Дата"), "Период");
	ТаблицаДвижений.ЗаполнитьЗначения(ВидДвиженияНакопления.Расход, "ВидДвижения");

КонецПроцедуры

Процедура ОчиститьДвиженияПриСдвигеДаты(ДокументОбъект, РежимЗаписи, ОчищаемыеРегистры) Экспорт
	
	Если Не ДокументОбъект.ЭтоНовый() И РежимЗаписи = РежимЗаписиДокумента.Проведение //ИЛИ РежимЗаписи = РежимЗаписиДокумента.Запись и ДокументОбъект.Проведен) 
		Тогда 
		
		МетаданныеДокумента = ДокументОбъект.Метаданные();
		лОчищаемыеРегистры = Новый Структура(ОчищаемыеРегистры);
		Для Каждого МетаданныеРегистра Из МетаданныеДокумента.Движения цикл
			
			Если Не лОчищаемыеРегистры.Свойство(МетаданныеРегистра.Имя) тогда
				Продолжить;
			КонецЕсли;
			
			//Для Каждого КлючЗначение Из лОчищаемыеРегистры Цикл 
				Запрос = Новый Запрос;
				Запрос.Текст =  "ВЫБРАТЬ ПЕРВЫЕ 1
				                |	Рег.Регистратор
				                |ИЗ
				                |	" + МетаданныеРегистра.ПолноеИмя() + " КАК Рег
				                |ГДЕ
				                |	Рег.Регистратор = &Регистратор
				                |	И Рег.Период < &Период";
				Запрос.УстановитьПараметр("Период", ДокументОбъект.Дата);
				Запрос.УстановитьПараметр("Регистратор", ДокументОбъект.Ссылка); 
				РезультатЗапроса = Запрос.Выполнить();
				//ДатаДо = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДокументОбъект.Ссылка, "Дата");
				//Если ДатаДо < ДокументОбъект.Дата И ДокументОбъект.Дата >= глЗначениеПеременной("ДатаЗапускаПервогоЭтапа") Тогда  
				Если Не РезультатЗапроса.Пустой() Тогда 
					ПроведениеДокументовКлиентСервер.ОчиститьДвиженияДокумента(ДокументОбъект.Ссылка, МетаданныеРегистра.Имя);
				КонецЕсли;  
			//КонецЦикла;
		КонецЦикла;
	КонецЕсли;

КонецПроцедуры// Конец  Валиахметов А.А.

Функция НеобходимоОчиститьДвиженияПартииТоваров(вхСсылкаНаДокумент, вхФильтр = Неопределено) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1
	               |	ПартииТоваров.Регистратор
	               |ИЗ
	               |	РегистрНакопления.ПартииТоваров КАК ПартииТоваров
	               |ГДЕ
	               |	ПартииТоваров.Регистратор = &Регистратор 
	               |	И ПартииТоваров.Период < &Период %УсловиеПоНоменклатуре%
	               |
	               |ДЛЯ ИЗМЕНЕНИЯ
	               |	РегистрНакопления.ПартииТоваров";
	Запрос.УстановитьПараметр("Период", ОбщегоНазначения.ЗначениеРеквизитаОбъекта(вхСсылкаНаДокумент, "Дата"));
	Запрос.УстановитьПараметр("Регистратор", вхСсылкаНаДокумент);
	
	Если ТипЗнч(вхФильтр) = Тип("Структура") И вхФильтр.Свойство("Номенклатура") Тогда 
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "%УсловиеПоНоменклатуре%", " И ПартииТоваров.Номенклатура = &Номенклатура");
		Запрос.УстановитьПараметр("Номенклатура", вхФильтр.Номенклатура);
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "%УсловиеПоНоменклатуре%", "");
	КонецЕсли;
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Возврат Не РезультатЗапроса.Пустой();
	
КонецФункции

Функция НеобходимоОчиститьДвиженияВзаиморасчеты(вхСсылкаНаДокумент) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1
	               |	Взаиморасчеты.Регистратор
	               |ИЗ
	               |	РегистрНакопления.Взаиморасчеты КАК Взаиморасчеты
	               |ГДЕ
	               |	Взаиморасчеты.Регистратор = &Регистратор
	               |	И Взаиморасчеты.Период < &Период
	               |
	               |ДЛЯ ИЗМЕНЕНИЯ
	               |	РегистрНакопления.Взаиморасчеты";
	Запрос.УстановитьПараметр("Период", ОбщегоНазначения.ЗначениеРеквизитаОбъекта(вхСсылкаНаДокумент, "Дата"));
	Запрос.УстановитьПараметр("Регистратор", вхСсылкаНаДокумент);
		
	РезультатЗапроса = Запрос.Выполнить();
	
	Возврат Не РезультатЗапроса.Пустой();
	
КонецФункции

Процедура ЗаписатьИзмененныеДвижения(вхСсылкаНаДокумент, вхФильтр, вхТребуемая, вхМетаданныеРегистра) Экспорт
	
	лБазовая = ПроведениеДокументовКлиентСервер.ЗначенияДвиженийДокумента(вхСсылкаНаДокумент, вхМетаданныеРегистра);	
	лРазделенныеБазовая = РаботаСПоследовательностямиКлиентСервер.РазделенныеДанные(лБазовая, вхФильтр);
	лИсходная = лРазделенныеБазовая.Включенные;
	
	//Удалим служебные колонки 
	ОбщегоНазначения.УдалитьКолонки(лИсходная, вхТребуемая);
	
	лРазностныеДанные = РаботаСПоследовательностямиКлиентСервер.РазностныеДанные(лИсходная, вхТребуемая); 
	ПроведениеДокументовКлиентСервер.ЗаписатьДвижения(вхСсылкаНаДокумент, вхМетаданныеРегистра,
	лРазностныеДанные, лРазделенныеБазовая.Исключенные);

КонецПроцедуры

Процедура ТаблицаУникальности(ПолноеИмяМетаданных, МассивДокументов, АдресХранилища) Экспорт 
	//УстановитьПривилегированныйРежим(Истина);
	
	Соответствие = Новый Соответствие;
	
	Запрос = Новый Запрос;
	Если ПолноеИмяМетаданных = "Документ.ПерестикеровкаПереоценка" Тогда 
		Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
		               |	ПерестикеровкаПереоценкаТовары.Ссылка КАК Документ,
		               |	ПерестикеровкаПереоценкаТовары.Ссылка.Склад,
		               |	ПерестикеровкаПереоценкаТовары.Номенклатура
		               |ИЗ
		               |	Документ.ПерестикеровкаПереоценка.Товары КАК ПерестикеровкаПереоценкаТовары
		               |ГДЕ
		               |	ПерестикеровкаПереоценкаТовары.Ссылка В(&МассивДокументов)
		               |
		               |ОБЪЕДИНИТЬ
		               |
		               |ВЫБРАТЬ
		               |	ПерестикеровкаПереоценкаТовары.Ссылка,
		               |	ПерестикеровкаПереоценкаТовары.Ссылка.СкладОприходования,
		               |	ВЫБОР
		               |		КОГДА ПерестикеровкаПереоценкаТовары.Ссылка.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийУценки.УценкаПоКачеству)
		               |			ТОГДА ПерестикеровкаПереоценкаТовары.Номенклатура
		               |		ИНАЧЕ ПерестикеровкаПереоценкаТовары.НоменклатураНовая
		               |	КОНЕЦ
		               |ИЗ
		               |	Документ.ПерестикеровкаПереоценка.Товары КАК ПерестикеровкаПереоценкаТовары
		               |ГДЕ
		               |	ПерестикеровкаПереоценкаТовары.Ссылка В(&МассивДокументов)
		               |ИТОГИ ПО
		               |	Документ";
	ИначеЕсли ПолноеИмяМетаданных = "Документ.ПеремещениеТоваров" Тогда 
		Запрос = Новый Запрос;
		Запрос.Текст =  "ВЫБРАТЬ РАЗЛИЧНЫЕ
		                |	ПеремещениеТоваровТовары.Ссылка.СкладОтправитель КАК Склад,
		                |	ПеремещениеТоваровТовары.Номенклатура,
		                |	ПеремещениеТоваровТовары.Ссылка.Ссылка КАК Документ
		                |ИЗ
		                |	Документ.ПеремещениеТоваров.Товары КАК ПеремещениеТоваровТовары
		                |ГДЕ
		                |	ПеремещениеТоваровТовары.Ссылка В(&МассивДокументов)
		                |
		                |ОБЪЕДИНИТЬ
		                |
		                |ВЫБРАТЬ
		                |	ПеремещениеТоваровТовары.Ссылка.СкладПолучатель,
		                |	ПеремещениеТоваровТовары.Номенклатура,
		                |	ПеремещениеТоваровТовары.Ссылка
		                |ИЗ
		                |	Документ.ПеремещениеТоваров.Товары КАК ПеремещениеТоваровТовары
		                |ГДЕ
		                |	ПеремещениеТоваровТовары.Ссылка В(&МассивДокументов)
		                |ИТОГИ ПО
		                |	Документ"
	Иначе
		Запрос = Новый Запрос;
		Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
						|	Док.Номенклатура,
						|	Док.Ссылка.Склад КАК Склад,
						|   Док.Ссылка КАК Документ
						|ИЗ
						|	" + ПолноеИмяМетаданных + ".Товары КАК Док
						|ГДЕ
						|	Док.Ссылка В(&МассивДокументов) ИТОГИ ПО Документ"
	КонецЕсли;
	Запрос.УстановитьПараметр("МассивДокументов" , МассивДокументов);
	
	ВыборкаПоДокументам = Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам, "Документ");
	Пока ВыборкаПоДокументам.Следующий() Цикл 
		Таблица = Новый ТаблицаЗначений;
		Таблица.Колонки.Добавить("Номенклатура", Новый ОписаниеТипов("СправочникСсылка.Номенклатура"));
		Таблица.Колонки.Добавить("Склад", Новый ОписаниеТипов("СправочникСсылка.Склады"));
		Выборка = ВыборкаПоДокументам.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		Пока Выборка.Следующий() Цикл 
			ЗаполнитьЗначенияСвойств(Таблица.Добавить(), Выборка);	
		КонецЦикла;
		Соответствие.Вставить(ВыборкаПоДокументам.Документ, Таблица);
	КонецЦикла;
	
	ПоместитьВоВременноеХранилище(Соответствие, АдресХранилища);
	//УстановитьПривилегированныйРежим(Ложь);
КонецПроцедуры

Процедура ПровестиДокументыПоПартиям(ТаблицаДокументов) Экспорт
	Для Каждого Строка Из ТаблицаДокументов Цикл 
		Документ = Строка.Документ;
		
		Отказ = Ложь;
		Параметры = Новый Структура;
		Параметры.Вставить("РегистрыДвижений", "ПартииТоваров");
		МенеджерОбъекта = ОбщегоНазначения.МенеджерОбъектаПоСсылке(Документ);
		НачатьТранзакцию(РежимУправленияБлокировкойДанных.Автоматический);
		Попытка
			Если Строка.ОчищатьДвижения Тогда  
				МенеджерОбъекта.ВыполнитьОтменуПроведения(Документ,Отказ,Параметры);
			Иначе
				МенеджерОбъекта.ВыполнитьПроведение(Документ,Отказ,Параметры);
			КонецЕсли;
			
			Если Отказ Тогда
				ВызватьИсключение "Документ не проведен";
			КонецЕсли;
			
			нз = РегистрыСведений.ОтложенноеПроведениеПоРегиструПартииТоваров.СоздатьНаборЗаписей();
			нз.Отбор.СсылкаНаДокумент.Установить(Документ);
			нз.Записать();
			ЗафиксироватьТранзакцию();
		Исключение
			ОтменитьТранзакцию();
			нз = РегистрыСведений.ОтложенноеПроведениеПоРегиструПартииТоваров.СоздатьНаборЗаписей();
			нз.Отбор.СсылкаНаДокумент.Установить(Документ);
			нз.Прочитать();
			Для Каждого зап из нз цикл
				зап.Ошибка = Истина;
			КонецЦикла;
			нз.Записать(Истина);
		КонецПопытки;
	КонецЦикла;
КонецПроцедуры

Процедура ПровестиДокументыПоЗаявкам(ТаблицаДокументов) Экспорт
	Для Каждого Строка Из ТаблицаДокументов Цикл 
		Документ = Строка.Документ;
		
		Отказ = Ложь;
		Параметры = Новый Структура;
		Параметры.Вставить("РегистрыДвижений", "ЗаявкиПокупателей");
		МенеджерОбъекта = ОбщегоНазначения.МенеджерОбъектаПоСсылке(Документ);
		НачатьТранзакцию(РежимУправленияБлокировкойДанных.Автоматический);
		Попытка
			Если Строка.ОчищатьДвижения Тогда  
				МенеджерОбъекта.ВыполнитьОтменуПроведения(Документ,Отказ,Параметры);
			Иначе
				МенеджерОбъекта.ВыполнитьПроведение(Документ,Отказ,Параметры);
			КонецЕсли;
			
			Если Отказ Тогда
				ВызватьИсключение "Документ не проведен";
			КонецЕсли;
			
			нз = РегистрыСведений.ОтложенноеПроведениеПоРегистрамЗаявкиЗаказы.СоздатьНаборЗаписей();
			нз.Отбор.СсылкаНаДокумент.Установить(Документ);
			нз.Записать();
			ЗафиксироватьТранзакцию();
		Исключение
			ОтменитьТранзакцию();
			нз = РегистрыСведений.ОтложенноеПроведениеПоРегистрамЗаявкиЗаказы.СоздатьНаборЗаписей();
			нз.Отбор.СсылкаНаДокумент.Установить(Документ);
			нз.Прочитать();
			Для Каждого зап из нз цикл
				зап.Ошибка = Истина;
			КонецЦикла;
			нз.Записать(Истина);
		КонецПопытки;
	КонецЦикла;
КонецПроцедуры

Процедура ПровестиДокументыПоТоварнымРегистрам(ТаблицаДокументов) Экспорт
	Для Каждого Строка Из ТаблицаДокументов Цикл 
		Документ = Строка.Документ;
		
		Отказ = Ложь;
		Параметры = Новый Структура;
		Параметры.Вставить("РегистрыДвижений", "ТоварыНаСкладах,ТоварыКРезервированию,РезервыТоваров");
		МенеджерОбъекта = ОбщегоНазначения.МенеджерОбъектаПоСсылке(Документ);
		НачатьТранзакцию(РежимУправленияБлокировкойДанных.Автоматический);
		Попытка
			Если Строка.ОчищатьДвижения Тогда  
				МенеджерОбъекта.ВыполнитьОтменуПроведения(Документ,Отказ,Параметры);
			Иначе
				МенеджерОбъекта.ВыполнитьПроведение(Документ,Отказ,Параметры);
			КонецЕсли;
			
			Если Отказ Тогда
				ВызватьИсключение "Документ не проведен";
			КонецЕсли;
			
			нз = РегистрыСведений.ОтложенноеПроведениеПоТоварнымРегистрам.СоздатьНаборЗаписей();
			нз.Отбор.СсылкаНаДокумент.Установить(Документ);
			нз.Записать();
			ЗафиксироватьТранзакцию();
		Исключение
			ОтменитьТранзакцию();
			нз = РегистрыСведений.ОтложенноеПроведениеПоТоварнымРегистрам.СоздатьНаборЗаписей();
			нз.Отбор.СсылкаНаДокумент.Установить(Документ);
			нз.Прочитать();
			Для Каждого зап из нз цикл
				зап.Ошибка = Истина;
			КонецЦикла;
			нз.Записать(Истина);
		КонецПопытки;
	КонецЦикла;
КонецПроцедуры

Процедура ЗарегистрироватьДокументыВРегистрОтложПроведения(ИмяРегистра, ТаблицаДокументов) Экспорт 
	
	МенеджерОбъекта = ОбщегоНазначения.МенеджерОбъектаПоПолномуИмени("РегистрСведений." + ИмяРегистра);
	
	Для Каждого Строка Из ТаблицаДокументов Цикл 
		Набор = МенеджерОбъекта.СоздатьНаборЗаписей();
		Набор.Отбор.СсылкаНаДокумент.Установить(Строка.СсылкаНаДокумент);
		Запись = Набор.Добавить();
		ЗаполнитьЗначенияСвойств(Запись, Строка);
		Набор.Записать();
	КонецЦикла;
	
КонецПроцедуры

// Регистры куда пишутся только измененые движения
Функция РегистрыИзмененныхДвижений() Экспорт 
	
	Соответствие = Новый Соответствие;
	Соответствие.Вставить(Метаданные.РегистрыНакопления.ЗаказыПоставщикам, Истина);
	Соответствие.Вставить(Метаданные.РегистрыНакопления.Закупки, Истина);
	Соответствие.Вставить(Метаданные.РегистрыНакопления.ЗаявкиПокупателей, Истина);
	Соответствие.Вставить(Метаданные.РегистрыНакопления.ОтказыПоЗаявкам, Истина);
	Соответствие.Вставить(Метаданные.РегистрыНакопления.ПополнениеСклада, Истина);
	Соответствие.Вставить(Метаданные.РегистрыНакопления.Продажи, Истина);
	Соответствие.Вставить(Метаданные.РегистрыНакопления.РазмещенияСтрокЗаказов, Истина);
	Соответствие.Вставить(Метаданные.РегистрыНакопления.РезервыТоваров, Истина);
	Соответствие.Вставить(Метаданные.РегистрыНакопления.ТоварыКОтгрузке, Истина);
	Соответствие.Вставить(Метаданные.РегистрыНакопления.ТоварыКРезервированию, Истина);
	Соответствие.Вставить(Метаданные.РегистрыНакопления.ТоварыНаСкладах, Истина);
		
	Возврат Соответствие;	
	
КонецФункции

Функция СписатьПартииБезПерепроведения(вхСсылкаНаДокумент, вхПараметры, вхБазовая, СтруктураТаблиц) Экспорт 
	
	лКлючАлгоритма = "ОбщийМодуль_ПроведениеДокументовКлиентСервер_СписатьПартииБезПерепроведения";
	лЗамена = АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		АлгоритмыЗначениеВозврата = Неопределено;
		Выполнить(лЗамена);
		Возврат АлгоритмыЗначениеВозврата;
	КонецЕсли;	
	
	ДатаДокумента = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(вхСсылкаНаДокумент, "Дата");	
	
	ТаблицаДвижений = Неопределено;
	ОбщегоНазначения.СоздатьСтруктуруРегистраНакопления("ПартииТоваров", ТаблицаДвижений);
	
	ТаблицаДвиженийVMI = Неопределено;
	ОбщегоНазначения.СоздатьСтруктуруРегистраНакопления("ПартииТоваровVMI", ТаблицаДвиженийVMI);
	
	ТаблицаДвиженийТвП = Неопределено;
	ОбщегоНазначения.СоздатьСтруктуруРегистраНакопления("ПартииТоваровВПути", ТаблицаДвиженийТвП);
	
	МенеджерОбъекта = ОбщегоНазначения.МенеджерОбъектаПоМетаданным(вхСсылкаНаДокумент.Метаданные());	

	ТаблицаДляРасчетаСписанияПоПартиям = МенеджерОбъекта.ТаблицыДляРасчетаСписанияПоПартиям(вхСсылкаНаДокумент, Неопределено, вхПараметры);
	//НормализацияТаблицыДляРасчетаСписанияПоПартиям(ТаблицаДляРасчетаСписанияПоПартиям);
	
	ТаблицаОстатков = вхБазовая.Скопировать(вхБазовая.НайтиСтроки(Новый Структура("ВидДвижения", ВидДвиженияНакопления.Расход)));
	ТаблицаОстатков.Колонки.Добавить("Поставщик", Новый ОписаниеТипов("СправочникСсылка.Контрагенты"));
	
	Для Каждого СтрокаТЧ Из ТаблицаОстатков Цикл 
		СтрокаТЧ.Поставщик = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СтрокаТЧ.СтрокаПрихода, "ТорговаяТочка.Владелец");	
	КонецЦикла;
		
	Успешно = Истина;
	
	ТаблицаДвижений.Колонки.Добавить("ОприходоватьПоVMI", Новый ОписаниеТипов("Булево"));
	ЗаполняемыеРеквизиты = "ВнутреннееПеремещение,НомерСтрокиВДокументе,ОприходоватьПоVMI"; 
	
	Для Каждого СтрокаТовары из ТаблицаДляРасчетаСписанияПоПартиям Цикл 
		Отбор = Новый Структура("Номенклатура,Качество,Организация,ДокументОснование");
		Если Не СтрокаТовары.ИгнорироватьСтатусПартии Тогда 
			Отбор.Вставить("СтатусПартии");
		КонецЕсли;
		Если СтрокаТовары.УчитыватьПоставщика Тогда 
			Отбор.Вставить("Поставщик");
		КонецЕсли;
		
		ЗаполнитьЗначенияСвойств(Отбор, СтрокаТовары);
		Строки = ТаблицаОстатков.НайтиСтроки(Отбор);
		
		КоличествоРаспределить = СписатьПартииПоСтрокеТаблицеСписания(вхСсылкаНаДокумент, ДатаДокумента, ЗаполняемыеРеквизиты, СтрокаТовары, Строки, ТаблицаДвижений);
	   
		Если КоличествоРаспределить > 0 И ЗначениеЗаполнено(Отбор.ДокументОснование) Тогда 
			Отбор.Вставить("ДокументОснование", Неопределено);
			Строки = ТаблицаОстатков.НайтиСтроки(Отбор);
			
			КоличествоРаспределить = СписатьПартииПоСтрокеТаблицеСписания(вхСсылкаНаДокумент, ДатаДокумента, ЗаполняемыеРеквизиты, СтрокаТовары, Строки, ТаблицаДвижений);
		КонецЕсли;
		
		Если КоличествоРаспределить > 0 Тогда 
			Успешно = Ложь;
		КонецЕсли;
	КонецЦикла;
	
		
	Если ТаблицаДвижений.Колонки.Найти("ОприходоватьПоVMI") <> Неопределено Тогда 
		СтрокиVMI = ТаблицаДвижений.НайтиСтроки(Новый Структура("СтатусПартии, ВидДвижения, ОприходоватьПоVMI", Перечисления.СтатусыПартии.ПринятыйНаОтветХранение, ВидДвиженияНакопления.Расход, Истина));
		Если СтрокиVMI.Количество() > 0 Тогда 
			Для Каждого Строка Из СтрокиVMI Цикл 
				ЗаполнитьЗначенияСвойств(ТаблицаДвиженийVMI.Добавить(), Строка);
			КонецЦикла;
			
			Запрос = Новый Запрос;
			Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	ВЫРАЗИТЬ(ТаблицаДвиженийVMI.СтрокаПрихода КАК Справочник.ИдентификаторыСтрокПриходов) КАК СтрокаПрихода
			|ПОМЕСТИТЬ ТаблицаДвиженийVMI
			|ИЗ
			|	&ТаблицаДвиженийVMI КАК ТаблицаДвиженийVMI
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	ТаблицаДвиженийVMI.СтрокаПрихода,
			|	ТаблицаДвиженийVMI.СтрокаПрихода.ДоговорКонтрагента КАК ДоговорКонтрагента
			|ИЗ
			|	ТаблицаДвиженийVMI КАК ТаблицаДвиженийVMI";
			Запрос.УстановитьПараметр("ТаблицаДвиженийVMI", ТаблицаДвиженийVMI);
			ДопТаблица = Запрос.Выполнить().Выгрузить();
			Для Каждого СтрокаДвижений Из ТаблицаДвиженийVMI Цикл
				СтрокаДвижений.ВидДвижения = ВидДвиженияНакопления.Приход;
				СтрокаДопТаблицы = ДопТаблица.Найти(СтрокаДвижений.СтрокаПрихода, "СтрокаПрихода");
				СтрокаДвижений.ДоговорКонтрагента = СтрокаДопТаблицы.ДоговорКонтрагента;
				СтрокаДвижений.КредДокумент = вхСсылкаНаДокумент;
				
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;
	
	СтруктураТаблиц = Новый Структура;
	СтруктураТаблиц.Вставить("ПартииТоваров",     ТаблицаДвижений);
	СтруктураТаблиц.Вставить("ПартииТоваровVMI",  ТаблицаДвиженийVMI);
	СтруктураТаблиц.Вставить("ПартииТоваровВПути",ТаблицаДвиженийТвП);
	
	Возврат Успешно;
	
КонецФункции

Функция СписатьПартииПоСтрокеТаблицеСписания(Знач вхСсылкаНаДокумент, Знач ДатаДокумента, Знач ЗаполняемыеРеквизиты,  СтрокаТовары, Строки, ТаблицаДвижений)
		
	лКлючАлгоритма = "ОбщийМодуль_ПроведениеДокументовКлиентСервер_СписатьПартииПоСтрокеТаблицеСписания";
	лЗамена = АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		АлгоритмыЗначениеВозврата = Неопределено;
		Выполнить(лЗамена);
		Возврат АлгоритмыЗначениеВозврата;
	КонецЕсли;	

	КоличествоРаспределить = СтрокаТовары.Количество;
	Индекс = 0;
	Пока КоличествоРаспределить > 0 И Индекс < Строки.Количество() Цикл 
		СтрокаОст = Строки.Получить(Индекс);
		СписываемоеКоличество = Мин(КоличествоРаспределить, СтрокаОст.Количество);
		Если СписываемоеКоличество > 0 Тогда 
			СтрокаДвижений = ТаблицаДвижений.Добавить();
			ЗаполнитьЗначенияСвойств(СтрокаДвижений, СтрокаОст);
			
			СтрокаДвижений.ВидДвижения = ВидДвиженияНакопления.Расход;
			СтрокаДвижений.Количество = СписываемоеКоличество;
			СтрокаДвижений.Регистратор = вхСсылкаНаДокумент;
			СтрокаДвижений.Период = ДатаДокумента;
			ЗаполнитьЗначенияСвойств(СтрокаДвижений, СтрокаТовары, ЗаполняемыеРеквизиты);
			Если СтрокаДвижений.Количество <> СтрокаОст.Количество Тогда 
				СтрокаДвижений.СуммаРубли   = СтрокаДвижений.Количество * СтрокаДвижений.СуммаРубли/СтрокаОст.Количество;
				СтрокаДвижений.СуммаДоллары = СтрокаДвижений.Количество * СтрокаДвижений.СуммаДоллары/СтрокаОст.Количество;
				СтрокаДвижений.СуммаЕвро 	= СтрокаДвижений.Количество * СтрокаДвижений.СуммаЕвро/СтрокаОст.Количество;
				СтрокаДвижений.СуммаБезНДС 	= СтрокаДвижений.Количество * СтрокаДвижений.СуммаБезНДС/СтрокаОст.Количество;
			КонецЕсли;
			
			СтрокаОст.Количество   = СтрокаОст.Количество - СписываемоеКоличество;	
			СтрокаОст.СуммаРубли   = СтрокаОст.СуммаРубли - СтрокаДвижений.СуммаРубли;	
			СтрокаОст.СуммаДоллары = СтрокаОст.СуммаДоллары - СтрокаДвижений.СуммаДоллары;
			СтрокаОст.СуммаЕвро    = СтрокаОст.СуммаЕвро - СтрокаДвижений.СуммаЕвро;
			СтрокаОст.СуммаБезНДС    = СтрокаОст.СуммаБезНДС - СтрокаДвижений.СуммаБезНДС;
			
			КоличествоРаспределить = КоличествоРаспределить - СписываемоеКоличество;
			Если СтрокаТовары.ВидСписания = "Перемещение" Тогда 
				СтрокаДвиженийПриход = ТаблицаДвижений.Добавить();
				ЗаполнитьЗначенияСвойств(СтрокаДвиженийПриход, СтрокаДвижений);
				СтрокаДвиженийПриход.Склад = СтрокаТовары.СкладПеремещения;
				СтрокаДвиженийПриход.Качество = СтрокаТовары.КачествоПеремещения;
				СтрокаДвиженийПриход.ВидДвижения = ВидДвиженияНакопления.Приход;
				СтрокаДвиженийПриход.СтатусПартии = СтрокаТовары.СтатусПартииПеремещения;	
				СтрокаДвиженийПриход.ДокументОснование = СтрокаТовары.ДокументОснованиеПеремещения
			КонецЕсли;
		КонецЕсли;
		Индекс = Индекс + 1;
	КонецЦикла;
	
	СтрокаТовары.Количество = КоличествоРаспределить;
	
	Возврат КоличествоРаспределить;

КонецФункции

Функция ПогашениеПартийТоваровНовое2(вхСсылкаНаДокумент, вхОтказ, КонтрольНаличияПартий = Истина, вхФильтр = Неопределено, ПараметрыСписания = Неопределено) Экспорт 
	
	лКлючАлгоритма = "ОбщийМодуль_ПроведениеДокументовКлиентСервер_ПогашениеПартийТоваровНовое2";
	лЗамена = АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		АлгоритмыЗначениеВозврата = Неопределено;
		Выполнить(лЗамена);
		Возврат АлгоритмыЗначениеВозврата;
	КонецЕсли;	
	
	Если ПараметрыСписания = Неопределено Тогда
		 ПараметрыСписания = Новый Структура;   
	КонецЕсли;
	
	ДатаДокумента = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(вхСсылкаНаДокумент, "Дата");

	МетаданныеДокумента = вхСсылкаНаДокумент.Метаданные();
	
	//УчитыватьПоставщика = Ложь;  //Для не возвратов поставщику, поставщика не учитываем

	//Если МетаданныеДокумента = Метаданные.Документы.ВозвратТоваровПоставщику Тогда 
	//	Если ДатаДокумента < глЗначениеПеременной("ДатаВозвратыПоставщиковСоздаютсяВ83") Тогда 
	//		УчитыватьПоставщика = Ложь; //Если возвраты поставщиков не создаются в 8.3, то не учитываем поставщика  
	//	Иначе
	//		Запрос = Новый Запрос;
	//		Запрос.Текст = "ВЫБРАТЬ
	//		|	ВозвратТоваровПоставщику.Контрагент.Организация КАК СобственнаяОрганизация
	//		|ИЗ
	//		|	Документ.ВозвратТоваровПоставщику КАК ВозвратТоваровПоставщику
	//		|ГДЕ
	//		|	ВозвратТоваровПоставщику.Ссылка = &Ссылка";
	//		Запрос.УстановитьПараметр("Ссылка", вхСсылкаНаДокумент);
	//		Выборка = Запрос.Выполнить().Выбрать();
	//		Если Выборка.Следующий() Тогда 
	//			УчитыватьПоставщика = Не ЗначениеЗаполнено(Выборка.СобственнаяОрганизация); //Не учитываем поставщика партии, если поставщик - наша организация
	//		КонецЕсли;
	//	КонецЕсли;
	//КонецЕсли;
		
	
	ТаблицаДвижений = Неопределено;
	ОбщегоНазначения.СоздатьСтруктуруРегистраНакопления("ПартииТоваров", ТаблицаДвижений);
	
	ТаблицаДвижений.Колонки.Добавить("ВидСписания", Новый ОписаниеТипов("Строка"));
	
	ТаблицаДвиженийVMI = Неопределено;
	ОбщегоНазначения.СоздатьСтруктуруРегистраНакопления("ПартииТоваровVMI", ТаблицаДвиженийVMI);
	
	
	Если ДатаДокумента < ПараметрыСеанса.ДатаНачалаРаботыТовары 
		ИЛИ ДатаДокумента < глЗначениеПеременной("ДатаЗапускаПроведенияПоПартиямРезервам")
		Тогда
		СтруктураТаблиц = Новый Структура;
		
		СтруктураТаблиц.Вставить("ПартииТоваров",    ТаблицаДвижений);
		СтруктураТаблиц.Вставить("ПартииТоваровVMI", ТаблицаДвиженийVMI);
		Возврат СтруктураТаблиц;
	КонецЕсли;
		
	Если Не ПараметрыСеанса.ОпределятьСтратегиюПогашенияПартийТоваровПоСкладу Тогда
		ВызватьИсключение "[ПогашениеПартийТоваров]: Реализовано погашение партий только при использовании стратегии погашения партий товаров по складу";
	КонецЕсли;
	
	МенеджерОбъекта = ОбщегоНазначения.МенеджерОбъектаПоМетаданным(МетаданныеДокумента);	
	
	//Если в параметрах задана таблица товаров, то повторно получать её не надо
	Товары = Неопределено;
	ПараметрыСписания.Свойство("Товары", Товары);
	Если Товары = Неопределено Тогда
		Товары = МенеджерОбъекта.ТаблицыДляРасчетаСписанияПоПартиям(вхСсылкаНаДокумент, вхФильтр);
	КонецЕсли;
	
	//Нормализация таблицы значений. Добавляем отсутствующие колонки и заполняем их
	
	НормализацияТаблицыДляРасчетаСписанияПоПартиям(Товары);

	//СписыватьТолькоПоСвоейОрганизации = Истина;
	//Если ТипЗнч(вхСсылкаНаДокумент) = Тип("ДокументСсылка.РеализацияТоваровУслуг") И ДатаДокумента >= глЗначениеПеременной("ДатаЗапускаПроведенияПоПартиямРезервам") Тогда 
	//	СписыватьТолькоПоСвоейОрганизации = Ложь;
	//КонецЕсли;
	
	//Реквизиты, которые переносятся в таблицу движений
	ЗаполняемыеРеквизиты = "ВидСписания,НомерСтрокиВДокументе"; 
	ВозможныеКолонки = Новый Массив;
	ВозможныеКолонки.Добавить("ОприходоватьПоVMI");
	ВозможныеКолонки.Добавить("ВнутреннееПеремещение");
	Для Каждого Колонка Из ВозможныеКолонки Цикл 
		лКолонка = Товары.Колонки.Найти(Колонка);
		Если лКолонка <> Неопределено Тогда 
			Если ТаблицаДвижений.Колонки.Найти(Колонка) = Неопределено Тогда 
				ТаблицаДвижений.Колонки.Добавить(лКолонка.Имя, лКолонка.ТипЗначения);
			КонецЕсли;
			ЗаполняемыеРеквизиты = ЗаполняемыеРеквизиты + "," + лКолонка.Имя;
		КонецЕсли;
	КонецЦикла;
	
	Товары.Индексы.Добавить("ИгнорироватьСтатусПартии,ПустаяСтрокаПрихода,УчитыватьПоставщика");		               

	ТаблицаПоСтрокамПриходаПоПоcтавщику 	= Товары.Скопировать(Товары.НайтиСтроки(Новый Структура("ИгнорироватьСтатусПартии, ПустаяСтрокаПрихода, УчитыватьПоставщика", Ложь,   Ложь, Истина)));	
	ТаблицаПоСтрокамПрихода 				= Товары.Скопировать(Товары.НайтиСтроки(Новый Структура("ИгнорироватьСтатусПартии, ПустаяСтрокаПрихода, УчитыватьПоставщика", Ложь,   Ложь, Ложь)));
	ТаблицаПоFIFOПоПоставщику				= Товары.Скопировать(Товары.НайтиСтроки(Новый Структура("ИгнорироватьСтатусПартии, ПустаяСтрокаПрихода, УчитыватьПоставщика", Ложь,   Истина, Истина)));
	ТаблицаПоFIFO 							= Товары.Скопировать(Товары.НайтиСтроки(Новый Структура("ИгнорироватьСтатусПартии, ПустаяСтрокаПрихода, УчитыватьПоставщика", Ложь,   Истина, Ложь)));
	
	ТаблицаПоСтрокамПриходаБезУчетаСтатусаПоПоставщику  = Товары.Скопировать(Товары.НайтиСтроки(Новый Структура("ИгнорироватьСтатусПартии, ПустаяСтрокаПрихода, УчитыватьПоставщика", Истина, Ложь, Истина)));	
	ТаблицаПоСтрокамПриходаБезУчетаСтатуса  = Товары.Скопировать(Товары.НайтиСтроки(Новый Структура("ИгнорироватьСтатусПартии, ПустаяСтрокаПрихода, УчитыватьПоставщика", Истина, Ложь, Ложь)));	
	ТаблицаПоFIFOБезУчетаСтатусаПоПоставщику= Товары.Скопировать(Товары.НайтиСтроки(Новый Структура("ИгнорироватьСтатусПартии, ПустаяСтрокаПрихода, УчитыватьПоставщика", Истина, Истина, Истина)));
	ТаблицаПоFIFOБезУчетаСтатуса  			= Товары.Скопировать(Товары.НайтиСтроки(Новый Структура("ИгнорироватьСтатусПартии, ПустаяСтрокаПрихода, УчитыватьПоставщика", Истина, Истина, Ложь)));	
	
	СтратегияПогашенияПоОрганизации = СтратегияПогашенияПоОрганизации(вхСсылкаНаДокумент, ДатаДокумента);
	
	//Если в параметрах списания задана политика списания по организации, то используем её
	СписыватьТолькоПоСвоейОрганизацииПараметр = Неопределено;
	ПараметрыСписания.Свойство("СписыватьТолькоПоСвоейОрганизации", СписыватьТолькоПоСвоейОрганизацииПараметр);
	Если СписыватьТолькоПоСвоейОрганизацииПараметр <> Неопределено Тогда
		СтратегияПогашенияПоОрганизации.СписыватьТолькоПоСвоейОрганизации 						 		= СписыватьТолькоПоСвоейОрганизацииПараметр;
		Если ТипЗнч(СтратегияПогашенияПоОрганизации.ПараметрыПолитикиМФП) = Тип("Структура") Тогда
			СтратегияПогашенияПоОрганизации.ПараметрыПолитикиМФП.УчитыватьОрганизациюТаблицыСписания 	= СписыватьТолькоПоСвоейОрганизацииПараметр;
		КонецЕсли;
	КонецЕсли;

	//Если в параметрах списания заданы организации для списания партий, то подставим их в политику списания
	ОрганизацииДляЗакупкиПараметр = Неопределено;
	ПараметрыСписания.Свойство("ОрганизацииДляЗакупки", ОрганизацииДляЗакупкиПараметр);
	Если ОрганизацииДляЗакупкиПараметр <> Неопределено И ТипЗнч(СтратегияПогашенияПоОрганизации.ПараметрыПолитикиМФП) = Тип("Структура") Тогда
		 СтратегияПогашенияПоОрганизации.ПараметрыПолитикиМФП.ОрганизацииДляЗакупки = ОрганизацииДляЗакупкиПараметр;
	КонецЕсли;
		
	Если ТаблицаПоСтрокамПриходаПоПоcтавщику.Количество() > 0 Тогда 
		//СписыватьТолькоПоСвоейОрганизации = ?(СписыватьТолькоПоСвоейОрганизации = Неопределено, Истина, СписыватьТолькоПоСвоейОрганизации);
		СписатьПоСтрокамПриходаПоПоставщику(вхСсылкаНаДокумент, ТаблицаДвижений, ТаблицаПоСтрокамПриходаПоПоcтавщику, ТаблицаПоFIFOПоПоставщику, СтратегияПогашенияПоОрганизации, ЗаполняемыеРеквизиты, КонтрольНаличияПартий, вхОтказ, ПараметрыСписания);
	КонецЕсли;
	
	Если ТаблицаПоСтрокамПрихода.Количество() > 0 Тогда 
		//СписыватьТолькоПоСвоейОрганизации = ?(СписыватьТолькоПоСвоейОрганизации = Неопределено, Истина, СписыватьТолькоПоСвоейОрганизации);
		СписатьПоСтрокамПрихода(вхСсылкаНаДокумент, ТаблицаДвижений, ТаблицаПоСтрокамПрихода, ТаблицаПоFIFO, СтратегияПогашенияПоОрганизации, ЗаполняемыеРеквизиты, КонтрольНаличияПартий, вхОтказ, ПараметрыСписания);
	КонецЕсли;
	
	Если ТаблицаПоFIFOПоПоставщику.Количество() > 0 Тогда 
		//СписыватьТолькоПоСвоейОрганизации = ?(СписыватьТолькоПоСвоейОрганизации = Неопределено, СтратегияПогашенияПоОрганизации(вхСсылкаНаДокумент, ДатаДокумента), СписыватьТолькоПоСвоейОрганизации);
		СписатьПоFIFOПоПоставщику(вхСсылкаНаДокумент, ТаблицаДвижений, ТаблицаПоFIFOПоПоставщику, СтратегияПогашенияПоОрганизации, ЗаполняемыеРеквизиты, КонтрольНаличияПартий, вхОтказ, ПараметрыСписания, ТаблицаПоFIFO);
	КонецЕсли;
	
	Если ТаблицаПоFIFO.Количество() > 0 Тогда 
		//СписыватьТолькоПоСвоейОрганизации = ?(СписыватьТолькоПоСвоейОрганизации = Неопределено, СтратегияПогашенияПоОрганизации(вхСсылкаНаДокумент, ДатаДокумента), СписыватьТолькоПоСвоейОрганизации);
		СписатьПоFIFO(вхСсылкаНаДокумент, ТаблицаДвижений, ТаблицаПоFIFO, СтратегияПогашенияПоОрганизации, ЗаполняемыеРеквизиты, КонтрольНаличияПартий, вхОтказ, ПараметрыСписания);
	КонецЕсли;
	
	Если ТаблицаПоСтрокамПриходаБезУчетаСтатусаПоПоставщику.Количество() > 0 Тогда 
		//СписыватьТолькоПоСвоейОрганизации = ?(СписыватьТолькоПоСвоейОрганизации = Неопределено, Истина, СписыватьТолькоПоСвоейОрганизации);
		СписатьПоСтрокамПриходаБезУчетаСтатусаПоПоставщику(вхСсылкаНаДокумент, ТаблицаДвижений, ТаблицаПоСтрокамПриходаБезУчетаСтатусаПоПоставщику, ТаблицаПоFIFOБезУчетаСтатусаПоПоставщику, СтратегияПогашенияПоОрганизации, ЗаполняемыеРеквизиты, КонтрольНаличияПартий, вхОтказ, ПараметрыСписания)
	КонецЕсли;

	Если ТаблицаПоСтрокамПриходаБезУчетаСтатуса.Количество() > 0 Тогда 
		//СписыватьТолькоПоСвоейОрганизации = ?(СписыватьТолькоПоСвоейОрганизации = Неопределено, Истина, СписыватьТолькоПоСвоейОрганизации);
		СписатьПоСтрокамПриходаБезУчетаСтатуса(вхСсылкаНаДокумент, ТаблицаДвижений, ТаблицаПоСтрокамПриходаБезУчетаСтатуса, ТаблицаПоFIFOБезУчетаСтатуса, СтратегияПогашенияПоОрганизации, ЗаполняемыеРеквизиты, КонтрольНаличияПартий, вхОтказ, ПараметрыСписания)
	КонецЕсли;
	
	Если ТаблицаПоFIFOБезУчетаСтатусаПоПоставщику.Количество() > 0 Тогда 
		//СписыватьТолькоПоСвоейОрганизации = ?(СписыватьТолькоПоСвоейОрганизации = Неопределено, СтратегияПогашенияПоОрганизации(вхСсылкаНаДокумент, ДатаДокумента), СписыватьТолькоПоСвоейОрганизации);
		СписатьПоFIFOБезУчетаСтатусаПоПоставщику(вхСсылкаНаДокумент, ТаблицаДвижений, ТаблицаПоFIFOБезУчетаСтатусаПоПоставщику, СтратегияПогашенияПоОрганизации, ЗаполняемыеРеквизиты, КонтрольНаличияПартий, вхОтказ, ПараметрыСписания)	
	КонецЕсли;
	
	Если ТаблицаПоFIFOБезУчетаСтатуса.Количество() > 0 Тогда 
		//СписыватьТолькоПоСвоейОрганизации = ?(СписыватьТолькоПоСвоейОрганизации = Неопределено, СтратегияПогашенияПоОрганизации(вхСсылкаНаДокумент, ДатаДокумента), СписыватьТолькоПоСвоейОрганизации);
		СписатьПоFIFOБезУчетаСтатуса(вхСсылкаНаДокумент, ТаблицаДвижений, ТаблицаПоFIFOБезУчетаСтатуса, СтратегияПогашенияПоОрганизации, ЗаполняемыеРеквизиты, КонтрольНаличияПартий, вхОтказ, ПараметрыСписания)	
	КонецЕсли;
	
	Если ТаблицаДвижений.Колонки.Найти("ОприходоватьПоVMI") <> Неопределено Тогда 
		СтрокиVMI = ТаблицаДвижений.НайтиСтроки(Новый Структура("СтатусПартии, ВидДвижения, ОприходоватьПоVMI", Перечисления.СтатусыПартии.ПринятыйНаОтветХранение, ВидДвиженияНакопления.Расход, Истина));
		Если СтрокиVMI.Количество() > 0 Тогда 
			Для Каждого Строка Из СтрокиVMI Цикл 
				ЗаполнитьЗначенияСвойств(ТаблицаДвиженийVMI.Добавить(), Строка);
			КонецЦикла;
			
			Запрос = Новый Запрос;
			Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
			               |	ВЫРАЗИТЬ(ТаблицаДвиженийVMI.СтрокаПрихода КАК Справочник.ИдентификаторыСтрокПриходов) КАК СтрокаПрихода
			               |ПОМЕСТИТЬ ТаблицаДвиженийVMI
			               |ИЗ
			               |	&ТаблицаДвиженийVMI КАК ТаблицаДвиженийVMI
			               |;
			               |
			               |////////////////////////////////////////////////////////////////////////////////
			               |ВЫБРАТЬ
			               |	ТаблицаДвиженийVMI.СтрокаПрихода,
			               |	ТаблицаДвиженийVMI.СтрокаПрихода.ДоговорКонтрагента КАК ДоговорКонтрагента
			               |ИЗ
			               |	ТаблицаДвиженийVMI КАК ТаблицаДвиженийVMI";
			Запрос.УстановитьПараметр("ТаблицаДвиженийVMI", ТаблицаДвиженийVMI);
			ДопТаблица = Запрос.Выполнить().Выгрузить();
			Для Каждого СтрокаДвижений Из ТаблицаДвиженийVMI Цикл
				СтрокаДвижений.ВидДвижения = ВидДвиженияНакопления.Приход;
				СтрокаДопТаблицы = ДопТаблица.Найти(СтрокаДвижений.СтрокаПрихода, "СтрокаПрихода");
				СтрокаДвижений.ДоговорКонтрагента = СтрокаДопТаблицы.ДоговорКонтрагента;
				СтрокаДвижений.КредДокумент = вхСсылкаНаДокумент;
				
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;
	
	// 19.02.19 Строганов Роман > XX-1835
	Если ПараметрыСписания <> Неопределено И ПараметрыСписания.Свойство("СобственнаяПартия") И ПараметрыСписания.СобственнаяПартия Тогда
		Для Каждого СтрокаДвижений Из ТаблицаДвижений Цикл
			Если СтрокаДвижений.ВидДвижения = ВидДвиженияНакопления.Приход Тогда
				СтрокаДвижений.СтатусПартии = ПредопределенноеЗначение("Перечисление.СтатусыПартии.Собственный");
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	// 19.02.19 Строганов Роман < XX-1835
	
	СтруктураТаблиц = Новый Структура;
	
	СтруктураТаблиц.Вставить("ПартииТоваров",    ТаблицаДвижений);
	СтруктураТаблиц.Вставить("ПартииТоваровVMI", ТаблицаДвиженийVMI);
	
	Возврат СтруктураТаблиц;
	
КонецФункции


// Конец Валиахметов А.А.

// + Пушкин 20180503
Процедура ОповещениеОбОтказахПриАвтоПроведенииТоварныхДокументовОбработкаПроведения(Источник, Отказ, РежимПроведения) Экспорт
	
	Если Отказ тогда
		#Если Клиент Тогда 
		#Иначе
			ОповеститьЧтоАвтоматСбоит("err: ошибка проведения документа: [" + СокрЛП(Источник) + "] РежимПроведения [" + СокрЛП(РежимПроведения) + "]")
		#КонецЕсли
	КонецЕсли;
	
КонецПроцедуры

Процедура ОповещениеОбОтказахПриАвтоПроведенииТоварныхДокументов1ПриЗаписи(Источник, Отказ) Экспорт
	
	Если Отказ тогда
		#Если Клиент Тогда 
		#Иначе
			ОповеститьЧтоАвтоматСбоит("err: ошибка записи документа: [" + СокрЛП(Источник) + "]")
		#КонецЕсли
	КонецЕсли;
	
КонецПроцедуры

Процедура ОповеститьЧтоАвтоматСбоит(пар_Аларм)
	
	Попытка
		РассылкаСообщенийОбОшибках.ОтправитьЭлектронноеСообщениеБезСохранения(Справочники.СобытияДляОтправкиЭлектронныхПисем.ОшибкаАвтоОбработкиДокумента,пар_Аларм,"err автобработка документов на стороне сервера");
	Исключение
	КонецПопытки;
	
КонецПроцедуры
	
// - Пушкин 20180503

Функция ИспользованиеСобственногоСписанияПартийДляРТУ(вхСсылкаНаДокумент) Экспорт
	
	ИспользованиеСобственногоСписанияПартийДляРТУ = Ложь;
	
	ДатаДокумента = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(вхСсылкаНаДокумент, "Дата");
	ДатаНачала = Константы.ИспользованиеСобственногоСписанияПартийДляРТУ.Получить();
	
	Если ЗначениеЗаполнено(ДатаНачала) И ДатаДокумента >= ДатаНачала Тогда
		ИспользованиеСобственногоСписанияПартийДляРТУ = Истина;
	КонецЕсли;
	
	Возврат ИспользованиеСобственногоСписанияПартийДляРТУ;
	
КонецФункции

//Служебные функции 
Функция КорректноеРазмещениеПоЗаявкам(ДокументОбъект) Экспорт
	
	//Проверка на размещение
	_Товары = ДокументОбъект.Товары.Выгрузить(, "НомерСтроки,СтрокаПрихода,Количество");
	_Товары.Свернуть("НомерСтроки,СтрокаПрихода", "Количество");
	
	_Разм = ДокументОбъект.РазмещениеСтрокПрихода.Выгрузить(, "СтрокаПрихода,Количество");
	_Разм.Свернуть("СтрокаПрихода", "Количество");
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("_Товары", _Товары);
	Запрос.УстановитьПараметр("_Разм", _Разм);
	Запрос.Текст = "ВЫБРАТЬ
	               |	_Товары.НомерСтроки,
	               |	_Товары.СтрокаПрихода,
	               |	_Товары.Количество
	               |ПОМЕСТИТЬ _Товары
	               |ИЗ
	               |	&_Товары КАК _Товары
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	_Разм.СтрокаПрихода,
	               |	_Разм.Количество
	               |ПОМЕСТИТЬ _Разм
	               |ИЗ
	               |	&_Разм КАК _Разм
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ЕСТЬNULL(_Товары.НомерСтроки, ""отсутствует"") КАК НомерСтроки,
	               |	ЕСТЬNULL(_Товары.СтрокаПрихода, _Разм.СтрокаПрихода) КАК СтрокаПрихода,
	               |	ЕСТЬNULL(_Разм.Количество, 0) КАК КоличествоРазмещено,
	               |	ЕСТЬNULL(_Товары.Количество, 0) КАК Количество
	               |ИЗ
	               |	_Товары КАК _Товары
	               |		ПОЛНОЕ СОЕДИНЕНИЕ _Разм КАК _Разм
	               |		ПО _Товары.СтрокаПрихода = _Разм.СтрокаПрихода
	               |ГДЕ
	               |	ЕСТЬNULL(_Товары.Количество, 0) - ЕСТЬNULL(_Разм.Количество, 0) <> 0";
				   
	РезультатЗапроса = Запрос.Выполнить();
	
	Ответ = Новый Структура("Корректно,РезультатЗапроса", РезультатЗапроса.Пустой(),РезультатЗапроса);
	
	Возврат Ответ;
	
КонецФункции

Функция ПерваяВыгрузка (ДокументОбъект) Экспорт 
	
	Если ДокументОбъект.ЭтоНовый() Тогда 
		Возврат Истина;	
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Ссылка", ДокументОбъект.Ссылка);
	Запрос.Текст = "ВЫБРАТЬ
	               |	ИсторияОбменаСТопЛогПоОбъектамСрезПоследних.Объект
	               |ИЗ
	               |	РегистрСведений.ИсторияОбменаСТопЛогПоОбъектам.СрезПоследних(
	               |			,
	               |			Объект = &Ссылка
	               |				И НЕ ЕстьОшибки) КАК ИсторияОбменаСТопЛогПоОбъектамСрезПоследних";
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Возврат РезультатЗапроса.Пустой();
	
КонецФункции

Функция ЧастичноеСписаниеРазмещений(вхСсылкаНаОбъект) Экспорт
	
	Если ТипЗнч(вхСсылкаНаОбъект) = Тип("ДокументСсылка.ПеремещениеТоваров") И Константы.ИспользоватьЧастичноеСписаниеПартийВРазмещениях.Получить() Тогда 
		НаименованиеСклада = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(вхСсылкаНаОбъект, "СкладОтправитель.Наименование");
		Если СтрНачинаетсяС(НаименованиеСклада, "Приемка") //Или СтрНачинаетсяС(НаименованиеСклада, "Товар в пути") 
			Тогда 
			Возврат Истина;	
		КонецЕсли;
	КонецЕсли;
	
	Возврат Ложь;
КонецФункции

Функция НовоеСписаниеПоПартиямИТоварамДляРазмещений(вхСсылкаНаДокумент) Экспорт  
	ТаблицаДвижений = Неопределено;
	ОбщегоНазначения.СоздатьСтруктуруРегистраНакопления("ПартииТоваров", ТаблицаДвижений);
	ТаблицаДвижений.Колонки.Добавить("ВидСписания", Новый ОписаниеТипов("Строка"));
	
	ТаблицаДвиженийVMI = Неопределено;
	ОбщегоНазначения.СоздатьСтруктуруРегистраНакопления("ПартииТоваровVMI", ТаблицаДвиженийVMI);
	
	ТаблицаДвиженийТвП = Неопределено;
	ОбщегоНазначения.СоздатьСтруктуруРегистраНакопления("ПартииТоваровВПути", ТаблицаДвиженийТвП);
	
	ТаблицаДвиженийТвС = Неопределено;
	ОбщегоНазначения.СоздатьСтруктуруРегистраНакопления("ТоварыНаСкладах", ТаблицаДвиженийТвС);
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	ПеремещениеТоваровТовары.Номенклатура КАК Номенклатура,
	               |	ПеремещениеТоваровТовары.Ссылка.СкладОтправитель КАК Склад,
	               |	ПеремещениеТоваровТовары.Качество КАК Качество,
	               |	СУММА(ПеремещениеТоваровТовары.Количество) КАК Количество,
	               |	ПеремещениеТоваровТовары.НомерСтроки КАК НомерСтрокиВДокументе,
	               |	ИСТИНА КАК ВнутреннееПеремещение,
	               |	""Перемещение"" КАК ВидСписания,
	               |	ПеремещениеТоваровТовары.Ссылка.СкладПолучатель КАК СкладПеремещения,
	               |	ВЫБОР
	               |		КОГДА ПеремещениеТоваровТовары.Ссылка.СкладПолучатель.СкладVMI
	               |			ТОГДА &СтатусПартииОтветХранение
	               |		ИНАЧЕ &СтатусПартииСобственный
	               |	КОНЕЦ КАК СтатусПартииПеремещения,
	               |	ПеремещениеТоваровТовары.Качество КАК КачествоПеремещения
	               |ПОМЕСТИТЬ втТоварыСвернутая
	               |ИЗ
	               |	Документ.ПеремещениеТоваров.Товары КАК ПеремещениеТоваровТовары
	               |ГДЕ
	               |	ПеремещениеТоваровТовары.Ссылка = &Ссылка
	               |	И (ПеремещениеТоваровТовары.Ссылка.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийПеремещенияТоваров.ПриемкаТопЛог)
	               |			ИЛИ ПеремещениеТоваровТовары.Ссылка.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийПеремещенияТоваров.СвободноеПеремещение)
				   |			ИЛИ ПеремещениеТоваровТовары.Ссылка.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийПеремещенияТоваров.ВозвратВПродажу)
				   |			ИЛИ ПеремещениеТоваровТовары.Ссылка.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийПеремещенияТоваров.НаСкладВозвратаПоставщику))
				   |	И ПеремещениеТоваровТовары.Ссылка.СтатусДокумента = ЗНАЧЕНИЕ(Справочник.СтатусыДокументов.ПеремещениеТоваровПоступил)
	               |	И ПеремещениеТоваровТовары.Количество > 0
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	ПеремещениеТоваровТовары.Ссылка.СкладОтправитель,
	               |	ПеремещениеТоваровТовары.Номенклатура,
	               |	ПеремещениеТоваровТовары.Качество,
	               |	ПеремещениеТоваровТовары.НомерСтроки,
	               |	ПеремещениеТоваровТовары.Ссылка.СкладПолучатель,
	               |	ВЫБОР
	               |		КОГДА ПеремещениеТоваровТовары.Ссылка.СкладПолучатель.СкладVMI
	               |			ТОГДА &СтатусПартииОтветХранение
	               |		ИНАЧЕ &СтатусПартииСобственный
	               |	КОНЕЦ,
	               |	ПеремещениеТоваровТовары.Качество
	               |
	               |ИНДЕКСИРОВАТЬ ПО
	               |	Номенклатура,
	               |	Склад,
	               |	Качество
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ТоварыНаСкладахОстатки.Склад КАК Склад,
	               |	ТоварыНаСкладахОстатки.Номенклатура КАК Номенклатура,
	               |	ТоварыНаСкладахОстатки.Качество КАК Качество,
	               |	ТоварыНаСкладахОстатки.КоличествоОстаток КАК Количество
	               |ИЗ
	               |	РегистрНакопления.ТоварыНаСкладах.Остатки(
	               |			&КонПериода,
	               |			(Номенклатура, Склад, Качество) В
	               |				(ВЫБРАТЬ РАЗЛИЧНЫЕ
	               |					втТоварыСвернутая.Номенклатура,
	               |					втТоварыСвернутая.Склад,
	               |					втТоварыСвернутая.Качество
	               |				ИЗ
	               |					втТоварыСвернутая)) КАК ТоварыНаСкладахОстатки
	               |ГДЕ
	               |	ТоварыНаСкладахОстатки.КоличествоОстаток > 0
	               |
	               |ДЛЯ ИЗМЕНЕНИЯ
	               |	РегистрНакопления.ТоварыНаСкладах.Остатки
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	втТоварыСвернутая.Номенклатура,
	               |	втТоварыСвернутая.Склад,
	               |	втТоварыСвернутая.Качество,
	               |	втТоварыСвернутая.Количество,
	               |	втТоварыСвернутая.НомерСтрокиВДокументе КАК НомерСтрокиВДокументе,
	               |	втТоварыСвернутая.ВнутреннееПеремещение,
	               |	втТоварыСвернутая.ВидСписания,
	               |	втТоварыСвернутая.СкладПеремещения,
	               |	втТоварыСвернутая.СтатусПартииПеремещения,
	               |	втТоварыСвернутая.КачествоПеремещения
	               |ИЗ
	               |	втТоварыСвернутая КАК втТоварыСвернутая
	               |
	               |УПОРЯДОЧИТЬ ПО
	               |	НомерСтрокиВДокументе";
	
	Запрос.УстановитьПараметр("Ссылка", вхСсылкаНаДокумент);
	Запрос.УстановитьПараметр("КонПериода", вхСсылкаНаДокумент.МоментВремени());
	Запрос.УстановитьПараметр("СтатусПартииОтветХранение", Перечисления.СтатусыПартии.ПринятыйНаОтветХранение);
	Запрос.УстановитьПараметр("СтатусПартииСобственный", Перечисления.СтатусыПартии.Собственный);
	Результаты = Запрос.ВыполнитьПакет();
	ОстаткиПоТоварамНаСкладах = Результаты[1].Выгрузить();
	НачТаблицаДляРаспределения = Результаты[2].Выгрузить();
	ТаблицаДляРаспределения	= НачТаблицаДляРаспределения.СкопироватьКолонки();
	
	Для Каждого СтрокаТЧ Из ОстаткиПоТоварамНаСкладах Цикл 
		Отбор = Новый Структура("Номенклатура,Склад,Качество");
		ЗаполнитьЗначенияСвойств(Отбор, СтрокаТЧ);
		
		Строки = НачТаблицаДляРаспределения.НайтиСтроки(Отбор);
		КоличествоРаспределить = СтрокаТЧ.Количество;
		Индекс = 0;
		Пока КоличествоРаспределить > 0 И Индекс < Строки.Количество() Цикл 
			СтрокаДок = Строки.Получить(Индекс);
			СписываемоеКоличество = Мин(КоличествоРаспределить, СтрокаДок.Количество);
			Если СписываемоеКоличество > 0 Тогда 
				НоваяСтрока = ТаблицаДляРаспределения.Добавить();
				ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаДок);
				НоваяСтрока.Количество = СписываемоеКоличество;
			КонецЕсли;
			Индекс = Индекс + 1;
		КонецЦикла;
	КонецЦикла;
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	ПоступлениеТоваровУслугТовары.СтрокаПрихода
	               |ПОМЕСТИТЬ втСтрокиПрихода
	               |ИЗ
	               |	Документ.ПоступлениеТоваровУслуг.Товары КАК ПоступлениеТоваровУслугТовары
	               |ГДЕ
	               |	ПоступлениеТоваровУслугТовары.Ссылка = &Ссылка
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	втТовары.Номенклатура,
	               |	втТовары.Склад,
	               |	втТовары.Качество
	               |ПОМЕСТИТЬ втТовары
	               |ИЗ
	               |	&втТовары КАК втТовары
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ПартииТоваровОстатки.Номенклатура,
	               |	ПартииТоваровОстатки.Склад,
	               |	ПартииТоваровОстатки.Качество,
	               |	ПартииТоваровОстатки.СтатусПартии,
	               |	ПартииТоваровОстатки.СтрокаПрихода,
	               |	ПартииТоваровОстатки.Организация,
	               |	ПартииТоваровОстатки.КоличествоОстаток КАК Количество,
	               |	ПартииТоваровОстатки.СуммаРублиОстаток КАК СуммаРубли,
	               |	ПартииТоваровОстатки.СуммаДолларыОстаток КАК СуммаДоллары,
	               |	ПартииТоваровОстатки.СуммаЕвроОстаток КАК СуммаЕвро,
	               |	ПартииТоваровОстатки.СуммаБезНДСОстаток КАК СуммаБезНДС
	               |ИЗ
	               |	РегистрНакопления.ПартииТоваров.Остатки(
	               |			&КонПериода,
	               |			(Номенклатура, Склад, Качество) В
	               |					(ВЫБРАТЬ Различные
	               |						втТовары.Номенклатура,
	               |						втТовары.Склад,
	               |						втТовары.Качество
	               |					ИЗ
	               |						втТовары)
	               |				И СтрокаПрихода В
	               |					(ВЫБРАТЬ
	               |						втСтрокиПрихода.СтрокаПрихода
	               |					ИЗ
	               |						втСтрокиПрихода)) КАК ПартииТоваровОстатки";
	Запрос.УстановитьПараметр("Ссылка", ОбщегоНазначения.ЗначениеРеквизитаОбъекта(вхСсылкаНаДокумент, "ДокументОснование"));
	Запрос.УстановитьПараметр("КонПериода", вхСсылкаНаДокумент.МоментВремени());
	Запрос.УстановитьПараметр("втТовары", ТаблицаДляРаспределения);
	
	ОстаткиПоПартиям = Запрос.Выполнить().Выгрузить();
	КолонкиРаспределения = "Номенклатура,Склад,Качество";	
	ДатаДокумента = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(вхСсылкаНаДокумент, "Дата");
	
	ЗаполняемыеРеквизиты = "ВидСписания,НомерСтрокиВДокументе,ВнутреннееПеремещение"; 

	Для Каждого СтрокаТовары Из ТаблицаДляРаспределения Цикл 
				
		Отбор = Новый Структура(КолонкиРаспределения);
		ЗаполнитьЗначенияСвойств(Отбор, СтрокаТовары);
		СтрокиОстатков = ОстаткиПоПартиям.НайтиСтроки(Отбор);
		
		КоличествоРаспределить = СтрокаТовары.Количество;
		ИндексСтроки = 0;
		
		
		Пока КоличествоРаспределить > 0 И ИндексСтроки < СтрокиОстатков.Количество() Цикл  
			СтрокаОст = СтрокиОстатков.Получить(ИндексСтроки);
			Если СтрокаОст.Количество > 0 Тогда 
				СписываемоеКоличество = Мин(КоличествоРаспределить, СтрокаОст.Количество);
				
				СтрокаДвижений = ТаблицаДвижений.Добавить();
				ЗаполнитьЗначенияСвойств(СтрокаДвижений, СтрокаОст);
				
				СтрокаДвижений.ВидДвижения = ВидДвиженияНакопления.Расход;
				СтрокаДвижений.Количество = СписываемоеКоличество;
				СтрокаДвижений.Регистратор = вхСсылкаНаДокумент;
				СтрокаДвижений.Период = ДатаДокумента;
				ЗаполнитьЗначенияСвойств(СтрокаДвижений, СтрокаТовары, ЗаполняемыеРеквизиты);
				Если СтрокаДвижений.Количество <> СтрокаОст.Количество Тогда 
					СтрокаДвижений.СуммаРубли   = СтрокаДвижений.Количество * СтрокаДвижений.СуммаРубли/СтрокаОст.Количество;
					СтрокаДвижений.СуммаДоллары = СтрокаДвижений.Количество * СтрокаДвижений.СуммаДоллары/СтрокаОст.Количество;
					СтрокаДвижений.СуммаЕвро 	= СтрокаДвижений.Количество * СтрокаДвижений.СуммаЕвро/СтрокаОст.Количество;
					СтрокаДвижений.СуммаБезНДС 	= СтрокаДвижений.Количество * СтрокаДвижений.СуммаБезНДС/СтрокаОст.Количество;
				КонецЕсли;
				
				СтрокаОст.Количество   = СтрокаОст.Количество - СписываемоеКоличество;	
				СтрокаОст.СуммаРубли   = СтрокаОст.СуммаРубли - СтрокаДвижений.СуммаРубли;	
				СтрокаОст.СуммаДоллары = СтрокаОст.СуммаДоллары - СтрокаДвижений.СуммаДоллары;
				СтрокаОст.СуммаЕвро    = СтрокаОст.СуммаЕвро - СтрокаДвижений.СуммаЕвро;
				СтрокаОст.СуммаБезНДС    = СтрокаОст.СуммаБезНДС - СтрокаДвижений.СуммаБезНДС;
				
				КоличествоРаспределить = КоличествоРаспределить - СписываемоеКоличество;
				Если СтрокаТовары.ВидСписания = "Перемещение" Тогда 
					СтрокаДвиженийПриход = ТаблицаДвижений.Добавить();
					ЗаполнитьЗначенияСвойств(СтрокаДвиженийПриход, СтрокаДвижений);
					СтрокаДвиженийПриход.Склад = СтрокаТовары.СкладПеремещения;
					СтрокаДвиженийПриход.Качество = СтрокаТовары.КачествоПеремещения;
					СтрокаДвиженийПриход.ВидДвижения = ВидДвиженияНакопления.Приход;
					СтрокаДвиженийПриход.СтатусПартии = СтрокаТовары.СтатусПартииПеремещения;	
				КонецЕсли;
			КонецЕсли;
			ИндексСтроки = ИндексСтроки + 1;
		КонецЦикла;
	КонецЦикла;
	
	ОбщегоНазначения.ЗагрузитьВТаблицуЗначений(ТаблицаДвижений, ТаблицаДвиженийТвС);
	
	СтруктураТаблиц = Новый Структура;
	
	СтруктураТаблиц.Вставить("ПартииТоваров",     ТаблицаДвижений);
	СтруктураТаблиц.Вставить("ПартииТоваровVMI",  ТаблицаДвиженийVMI);
	СтруктураТаблиц.Вставить("ПартииТоваровВПути",ТаблицаДвиженийТвП);
	СтруктураТаблиц.Вставить("ТоварыНаСкладах", ТаблицаДвиженийТвС);
	
	Возврат СтруктураТаблиц
КонецФункции

Функция РазрешитьПревышениеКоличестваПлан() Экспорт
	Возврат Константы.РазрешитьПревышениеКоличестваПлан.Получить();
КонецФункции

Функция ПеремещатьНаФизическийСкладВсеОтказыVMI(ДатаДокумента) Экспорт
	
	ПеремещатьНаФизическийСкладВсеОтказыVMI = Константы.ПеремещатьНаФизическийСкладВсеОтказыVMI.Получить();
	ПереноситьНедостачиБракVMIНаСкладНедостач = Константы.ПереноситьНедостачиБракVMIНаСкладНедостач.Получить();
		
	Если ЗначениеЗаполнено(ПеремещатьНаФизическийСкладВсеОтказыVMI)
			И ДатаДокумента >= ПеремещатьНаФизическийСкладВсеОтказыVMI 
			И (ДатаДокумента < ПереноситьНедостачиБракVMIНаСкладНедостач Или 
			Не ЗначениеЗаполнено(ПереноситьНедостачиБракVMIНаСкладНедостач))Тогда
		Возврат Истина;
	Иначе
		Возврат Ложь;
	КонецЕсли;	
	
	// Закомментировал Валиахметов XX-2091 При недостаче товара на складе ответ. хранения перемещать на склад недостачи
КонецФункции

Функция ЭтоРазмещение(вхСсылкаНаДокумент)
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	ПеремещениеТоваров.Ссылка
	               |ИЗ
	               |	Документ.ПеремещениеТоваров КАК ПеремещениеТоваров
	               |ГДЕ
	               |	ПеремещениеТоваров.Ссылка = &Ссылка
	               |	И (ПеремещениеТоваров.СкладОтправитель.Наименование ПОДОБНО ""Приемка""
	               |			ИЛИ ПеремещениеТоваров.СкладОтправитель.Наименование ПОДОБНО ""Товар в пути"")";
	Запрос.УстановитьПараметр("Ссылка", вхСсылкаНаДокумент);
	
	Возврат Не Запрос.Выполнить().Пустой();
	
КонецФункции

Функция НовоеСписаниеПеремещенийПоПартиям(вхСсылкаНаДокумент) Экспорт  
	
	ДокументОснование = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(вхСсылкаНаДокумент, "ДокументОснование");
	
	Если ТипЗнч(ДокументОснование) = Тип("ДокументСсылка.ПоступлениеТоваровУслуг") Тогда 
		Запрос = Новый Запрос;
		Запрос.Текст = "ВЫБРАТЬ
		               |	ПоступлениеТоваровУслугТовары.СтрокаПрихода
		               |ПОМЕСТИТЬ втСтрокиПрихода
		               |ИЗ
		               |	Документ.ПоступлениеТоваровУслуг.Товары КАК ПоступлениеТоваровУслугТовары
		               |ГДЕ
		               |	ПоступлениеТоваровУслугТовары.Ссылка = &ДокументОснование
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПеремещениеТоваровТовары.Номенклатура,
		               |	ПеремещениеТоваровТовары.Ссылка.СкладОтправитель КАК Склад,
		               |	ПеремещениеТоваровТовары.Качество
		               |ПОМЕСТИТЬ втНоменклатура
		               |ИЗ
		               |	Документ.ПеремещениеТоваров.Товары КАК ПеремещениеТоваровТовары
		               |ГДЕ
		               |	ПеремещениеТоваровТовары.Ссылка = &Ссылка
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОбороты.Номенклатура,
		               |	ПартииТоваровОбороты.Склад,
		               |	ПартииТоваровОбороты.Качество,
		               |	ПартииТоваровОбороты.СтатусПартии,
		               |	ПартииТоваровОбороты.СтрокаПрихода,
		               |	ПартииТоваровОбороты.Организация,
		               |	ПартииТоваровОбороты.КоличествоРасход КАК Количество,
		               |	ПартииТоваровОбороты.СуммаРублиРасход КАК СуммаРубли,
		               |	ПартииТоваровОбороты.СуммаДолларыРасход КАК СуммаДоллары,
		               |	ПартииТоваровОбороты.СуммаЕвроРасход КАК СуммаЕвро,
		               |	ПартииТоваровОбороты.СуммаБезНДСРасход КАК СуммаБезНДС
		               |ПОМЕСТИТЬ втДвижения
		               |ИЗ
		               |	РегистрНакопления.ПартииТоваров.Обороты(, , Регистратор, ) КАК ПартииТоваровОбороты
		               |ГДЕ
		               |	ПартииТоваровОбороты.Регистратор = &Ссылка
		               |	И ПартииТоваровОбороты.КоличествоРасход > 0
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПартииТоваровОстатки.Номенклатура,
		               |	ПартииТоваровОстатки.Склад,
		               |	ПартииТоваровОстатки.Качество,
		               |	ПартииТоваровОстатки.СтатусПартии,
		               |	ПартииТоваровОстатки.СтрокаПрихода,
		               |	ПартииТоваровОстатки.Организация,
		               |	ПартииТоваровОстатки.КоличествоОстаток,
		               |	ПартииТоваровОстатки.СуммаРублиОстаток,
		               |	ПартииТоваровОстатки.СуммаДолларыОстаток,
		               |	ПартииТоваровОстатки.СуммаЕвроОстаток,
		               |	ПартииТоваровОстатки.СуммаБезНДСОстаток
		               |ПОМЕСТИТЬ втОстатки
		               |ИЗ
		               |	РегистрНакопления.ПартииТоваров.Остатки(
		               |			,
		               |			(Номенклатура, Склад, Качество) В
		               |					(ВЫБРАТЬ
		               |						втНоменклатура.Номенклатура,
		               |						втНоменклатура.Склад,
		               |						втНоменклатура.Качество
		               |					ИЗ
		               |						втНоменклатура)
		               |				И СтрокаПрихода В
		               |					(ВЫБРАТЬ
		               |						втСтрокиПрихода.СтрокаПрихода
		               |					ИЗ
		               |						втСтрокиПрихода)) КАК ПартииТоваровОстатки
		               |ГДЕ
		               |	ПартииТоваровОстатки.КоличествоОстаток > 0
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	втОстатки.Номенклатура,
		               |	втОстатки.Склад,
		               |	втОстатки.Качество,
		               |	втОстатки.СтатусПартии,
		               |	втОстатки.СтрокаПрихода,
		               |	втОстатки.Организация,
		               |	втОстатки.КоличествоОстаток + ЕСТЬNULL(втДвижения.Количество, 0) КАК Количество,
		               |	втОстатки.СуммаРублиОстаток + ЕСТЬNULL(втДвижения.СуммаРубли, 0) КАК СуммаРубли,
		               |	втОстатки.СуммаДолларыОстаток + ЕСТЬNULL(втДвижения.СуммаДоллары, 0) КАК СуммаДоллары,
		               |	втОстатки.СуммаЕвроОстаток + ЕСТЬNULL(втДвижения.СуммаЕвро, 0) КАК СуммаЕвро,
		               |	втОстатки.СуммаБезНДСОстаток + ЕСТЬNULL(втДвижения.СуммаБезНДС, 0) КАК СуммаБезНДС
		               |ИЗ
		               |	втОстатки КАК втОстатки
		               |		ЛЕВОЕ СОЕДИНЕНИЕ втДвижения КАК втДвижения
		               |		ПО втОстатки.Номенклатура = втДвижения.Номенклатура
		               |			И втОстатки.Склад = втДвижения.Склад
		               |			И втОстатки.Качество = втДвижения.Качество
		               |			И втОстатки.СтатусПартии = втДвижения.СтатусПартии
		               |			И втОстатки.СтрокаПрихода = втДвижения.СтрокаПрихода
		               |			И втОстатки.Организация = втДвижения.Организация
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ПеремещениеТоваровТовары.НомерСтроки,
		               |	ПеремещениеТоваровТовары.Номенклатура,
		               |	ПеремещениеТоваровТовары.Ссылка.СкладОтправитель КАК Склад,
		               |	ПеремещениеТоваровТовары.Качество,
		               |	ПеремещениеТоваровТовары.Количество
		               |ИЗ
		               |	Документ.ПеремещениеТоваров.Товары КАК ПеремещениеТоваровТовары";
		
		Результаты = Запрос.ВыполнитьПакет();
		
		ОстаткиПоПартиям = Результаты.Получить(Результаты.ВГраница() - 1).Выгрузить();
		ТаблицаДляРаспределения = Результаты.Получить(Результаты.ВГраница()).Выгрузить();

		Для Каждого СтрокаТЧ Из ТаблицаДляРаспределения Цикл 
			Отбор = Новый Структура("Номенклатура,Склад,Качество");
			ЗаполнитьЗначенияСвойств(Отбор, СтрокаТЧ);
			Строки = ОстаткиПоПартиям.НайтиСтроки(Отбор);
			КоличествоРаспределить = СтрокаТЧ.Количество;
			Индекс = 0;
			Пока КоличествоРаспределить > 0 И Индекс < Строки.Количество() Цикл 
				СтрокаОст = Строки.Получить(Индекс);
				СписываемоеКоличество = Мин(СтрокаОст.Количество, КоличествоРаспределить); 
				Индекс = Индекс + 1;	
			КонецЦикла;
			
		КонецЦикла;
		
		
	
	ИначеЕсли ТипЗнч(ДокументОснование) = Тип("ДокументСсылка.ПеремещениеТоваров") Тогда 
			
	КонецЕсли;
	
КонецФункции	

Функция ДатаНачалаИспользованияМФП() Экспорт
	
	Возврат Константы.ДатаНачалаИспользованияМФП.Получить();
	
КонецФункции

Функция НоваяСхемаМФПДляВозвратов() Экспорт
	
	Возврат Константы.НоваяСхемаМФПДляВозвратов.Получить();
	
КонецФункции

Функция ИспользуетсяНоваяСхемаМФПДляВозвратов(ДатаПроверки) Экспорт
	
	НоваяСхемаМФПДляВозвратов = НоваяСхемаМФПДляВозвратов();
	
	ИспользуетсяНоваяСхемаМФПДляВозвратов = ЗначениеЗаполнено(НоваяСхемаМФПДляВозвратов) И ДатаПроверки >= НоваяСхемаМФПДляВозвратов;
	
	Возврат ИспользуетсяНоваяСхемаМФПДляВозвратов;
	
КонецФункции

Функция ИспользуютсяМФП(ДатаПроверки) Экспорт
	
	ДатаНачалаИспользованияМФП = ДатаНачалаИспользованияМФП();
	
	ИспользуютсяМФП = ЗначениеЗаполнено(ДатаНачалаИспользованияМФП) И ДатаПроверки >= ДатаНачалаИспользованияМФП;
	
	Возврат ИспользуютсяМФП;
	
КонецФункции

Функция ГраницаЗапретаИзмененияПартий() Экспорт
	
	ГраницаЗапретаИзмененияПартий = Константы.ГраницаЗапретаИзмененияПартий.Получить();
	
	Если ЗначениеЗаполнено(ГраницаЗапретаИзмененияПартий) Тогда
		ГраницаЗапретаИзмененияПартий = КонецДня(ГраницаЗапретаИзмененияПартий);
	КонецЕсли;
	
	Возврат ГраницаЗапретаИзмененияПартий;
	
КонецФункции

Процедура ПередЗаписьюПартииТоваровСохранитьДатуДляМФППередЗаписью(Источник, Отказ, Замещение) Экспорт
	
	лКлючАлгоритма = "ОбщийМодуль_ПроведениеДокументовКлиентСервер_ПередЗаписьюПартииТоваровСохранитьДатуДляМФППередЗаписью";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		Выполнить(лЗамена);
		Возврат;
	КонецЕсли;
	///////////////////////////////////////////////////////////////////////////

	МетаданныеНабора = Источник.Метаданные();		

	СтруктураПараметров = Новый Структура();
	СтруктураПараметров.Вставить("МетаданныеНабора", МетаданныеНабора);
	
	//Отметим дни за которые нужно переформировать МФП
	
	ПараметрыСохраненияПериода = НужноСохранитьДатуДляФормированияМФП(Источник, СтруктураПараметров);
	Если ПараметрыСохраненияПериода.СохранитьСтаруюДату ИЛИ ПараметрыСохраненияПериода.СохранитьНовуюДату Тогда
		
		Регистратор = Источник.Отбор.Регистратор.Значение;
		
		МассивДат = Новый Массив;
		
		//ХудинВВ XX-2357 31052019
		Если  ПараметрыСохраненияПериода.СохранитьСтаруюДату Тогда
			//Возьмем дату из старого набора
			Запрос = Новый Запрос;
			Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1
			|	НАЧАЛОПЕРИОДА(Набор.Период, ДЕНЬ) КАК Период
			|ИЗ
			|	РегистрНакопления.ПартииТоваров КАК Набор
			|ГДЕ
			|	Набор.Регистратор = &Регистратор";
			
			Запрос.УстановитьПараметр("Регистратор", Регистратор);				
			
			МассивДат = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Период");
		КонецЕсли;
		
		//ХудинВВ XX-2357 31052019
		Если ПараметрыСохраненияПериода.СохранитьНовуюДату Тогда
			
			//Добавим дату из нового набора
			НоваяДата = Дата(1,1,1);
			Если Источник.Количество() > 0 Тогда
				НоваяДата = НачалоДня(Источник[0].Период);
			КонецЕсли;
			
			Если ЗначениеЗаполнено(НоваяДата) И МассивДат.Найти(НоваяДата) = Неопределено Тогда
				МассивДат.Добавить(НоваяДата);
			КонецЕсли;
			
		КонецЕсли;
		
		//По этим датам нужно будет сформировать МФП
		Для Каждого ДатаКонтроля ИЗ МассивДат Цикл
			РегистрыСведений.ГраницаМФП.ДобавитьЗапись(Регистратор, ДатаКонтроля);			
		КонецЦикла;
		
	КонецЕсли;
	
	
КонецПроцедуры

Функция НужноСохранитьДатуДляФормированияМФП(НаборЗаписей, СтруктураПараметров) Экспорт
	
	лКлючАлгоритма = "ОбщийМодуль_ПроведениеДокументовКлиентСервер_НужноСохранитьДатуДляФормированияМФП";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		АлгоритмыЗначениеВозврата = Неопределено;		
		Выполнить(лЗамена);		
		Возврат АлгоритмыЗначениеВозврата;		
	КонецЕсли;	
	///////////////////////////////////////////////////////////////////////////
	
	ВозвращаемоеЗначение = Новый Структура("СохранитьСтаруюДату, СохранитьНовуюДату", Ложь, Ложь);
	
	Регистратор = НаборЗаписей.Отбор.Регистратор.Значение;
	
	Если ТипЗнч(Регистратор) = Тип("ДокументСсылка.РеализацияТоваровУслуг") Тогда
		
		Реквизиты = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Регистратор, "ВидОперации, СтатусДокумента");
		
		Если НЕ (Реквизиты.ВидОперации = Перечисления.ВидыОперацийРеализацияТоваров.МФП
			ИЛИ Реквизиты.ВидОперации = Перечисления.ВидыОперацийРеализацияТоваров.МФПКомиссия) Тогда
			
			//ХудинВВ XX-2357 31052019
			СтатусДокументаСтароеЗначение = Неопределено;
			НаборЗаписей.ДополнительныеСвойства.Свойство("СтатусДокументаСтароеЗначение", СтатусДокументаСтароеЗначение);
			
			//Переформировывать мфп за период существующих движений нужно только если эти движения были сформированы РТУ в статусе "Отгружен"
			//Т.е. по ним могли быть сформированы МФП
			Если СтатусДокументаСтароеЗначение = Справочники.СтатусыДокументов.РеализацияТоваровУслугОтгружен Тогда
				ВозвращаемоеЗначение.СохранитьСтаруюДату = Истина;
			КонецЕсли;
			
			//Формируем мфп по движениям, если статус документа "Отгружен"
			Если Реквизиты.СтатусДокумента = Справочники.СтатусыДокументов.РеализацияТоваровУслугОтгружен Тогда
				ВозвращаемоеЗначение.СохранитьНовуюДату = Истина;
			КонецЕсли;
			
		КонецЕсли;
		
	ИначеЕсли ТипЗнч(Регистратор) = Тип("ДокументСсылка.ВозвратТоваровОтПокупателя")
		И НЕ ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Регистратор, "ВидОперации") = Перечисления.ВидыОперацийВозвратаОтПокупателя.МФП Тогда
		
		//В идеале нужно переформировывать, только если организация в старых движениях отличается от старой организации в документе
		//или организация в текущих движениях отличается от текущей организации в документе
		//Не будем достигать идеала, на всякий случай переформируем, так надежнее
		ВозвращаемоеЗначение.СохранитьСтаруюДату = Истина;
		ВозвращаемоеЗначение.СохранитьНовуюДату = Истина;
		
	ИначеЕсли ТипЗнч(Регистратор) = Тип("ДокументСсылка.ВозвратТоваровПоставщику") Тогда
		
		//ХудинВВ XX-2357 31052019
		Реквизиты = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Регистратор, "ВидОперации, ОрганизацияДляСписанияПартий");
		
		Если НЕ Реквизиты.ВидОперации = Перечисления.ВидыОперацийВозвратПоставщику.МФП Тогда
			
			//В идеале нужно переформировывать, только если организация в старых движениях отличается от старой организации в документе
			//или организация в текущих движениях отличается от текущей организации в документе
			//Не будем достигать идеала, на всякий случай переформируем, так надежнее
			ВозвращаемоеЗначение.СохранитьСтаруюДату = Истина;
			ВозвращаемоеЗначение.СохранитьНовуюДату = Истина;
			
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат ВозвращаемоеЗначение;
	
КонецФункции

Функция ОперативноеПроведение(вхПараметры) Экспорт 
	
	Если ТипЗнч(вхПараметры) = Тип("Структура") И вхПараметры.Свойство("ОперативноеПроведение") И вхПараметры.ОперативноеПроведение Тогда 
		Возврат Истина;
	КонецЕсли;
	
	Возврат Ложь;
	
КонецФункции

//Семенов И.П. 17.12.2018(
Процедура ЗапретПроведенияПоДатеВОрганизации(ДокументОбъект, РежимЗаписи, Отказ) Экспорт
	
	ДатаНачалаПроведенияДокументов = ДокументОбъект.Организация.ДатаНачалаПроведенияДокументов;
	ДатаДокумента = ?(ДокументОбъект.ЭтоНовый(),ДокументОбъект.Дата,ДокументОбъект.Ссылка.Дата);
	Если НЕ ДокументОбъект.ДополнительныеСвойства.Свойство("НеПроверятьДатуНачалаПроведения")
		И РежимЗаписи <> РежимЗаписиДокумента.Запись 
		И ЗначениеЗаполнено(ДатаНачалаПроведенияДокументов)
		И ДатаДокумента < ДатаНачалаПроведенияДокументов
		Тогда
		
		Отказ = Истина;
		
		Сообщить("По организации "+ДокументОбъект.Организация+" запрещенно проводить или отменять проведение документов введенных раньше "+ДатаНачалаПроведенияДокументов,СтатусСообщения.Важное);
		
	КонецЕсли;
	
КонецПроцедуры
//)Семенов И.П.




Процедура ИнициализироватьДополнительныеСвойстваДляПроведения(ДокументСсылка, ДополнительныеСвойства, РежимПроведения = Неопределено) Экспорт

	// В структуре "ДополнительныеСвойства" создаются свойства с ключами "ТаблицыДляДвижений", "ДляПроведения".

	// "ТаблицыДляДвижений" - структура, которая будет содержать таблицы значений с данными для выполнения движений.
	ДополнительныеСвойства.Вставить("ТаблицыДляДвижений", Новый Структура);

	// "ДляПроведения" - структура, содержащая свойства и реквизиты документа, необходимые для проведения.
	ДополнительныеСвойства.Вставить("ДляПроведения", Новый Структура);
	
	// Структура, содержащая ключ с именем "МенеджерВременныхТаблиц", в значении которого хранится менеджер временных таблиц.
	// Содержит для каждой временной таблицы ключ (имя временной таблицы) и значение (признак наличия записей во временной таблице).
	ДополнительныеСвойства.ДляПроведения.Вставить("СтруктураВременныеТаблицы", Новый Структура("МенеджерВременныхТаблиц", Новый МенеджерВременныхТаблиц));
	ДополнительныеСвойства.ДляПроведения.Вставить("РежимПроведения",           РежимПроведения);
	ДополнительныеСвойства.ДляПроведения.Вставить("МетаданныеДокумента",       ДокументСсылка.Метаданные());
	ДополнительныеСвойства.ДляПроведения.Вставить("Ссылка",                    ДокументСсылка);
	
КонецПроцедуры



// Процедура выполняет контроль результатов проведения.
// Процедура вызывается из модуля документов при проведении.
//
Процедура ВыполнитьКонтрольРезультатовПроведения(Объект, Отказ) Экспорт
		
	Если Объект.ДополнительныеСвойства.ДляПроведения.РегистрыДляКонтроля.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;

	РегистрыДляКонтроля    =  Объект.ДополнительныеСвойства.ДляПроведения.РегистрыДляКонтроля;
	

	
	ПакетЗапросов   = Новый Запрос;

	ПакетЗапросов.УстановитьПараметр("Период",Новый Граница(Объект.МоментВремени(),ВидГраницы.Включая));
	
	МассивКонтролей = Новый Массив;
	
	ЗапросВремТаблиц  = Новый Запрос;
	ЗапросВремТаблиц.УстановитьПараметр("ДокументСсылка",Объект.Ссылка);		
	МенеджерВремТаблиц = новый МенеджерВременныхТаблиц;
	ЗапросВремТаблиц.МенеджерВременныхТаблиц  = МенеджерВремТаблиц;
	
	ТекстЗапроса    = "";

	Для каждого РегистрКонтроля из РегистрыДляКонтроля цикл 		
	ИмяРегистра  = РегистрКонтроля.Ключ;
	ДобавитьНаборЗаписейИзмененийвЗапрос(ЗапросВремТаблиц,ИмяРегистра,РегистрКонтроля.Значение);		
	ТекстЗапроса = ТекстЗапроса + РегистрыНакопления[ИмяРегистра].ПолучитьЗапросПроверки(МассивКонтролей);		
	КонецЦикла;
	
	ЗапросВремТаблиц.Выполнить();
	
	
	Если МассивКонтролей.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	ПакетЗапросов.Текст = ТекстЗапроса;
	ПакетЗапросов.МенеджерВременныхТаблиц = МенеджерВремТаблиц;
	МассивРезультатов = ПакетЗапросов.ВыполнитьПакет();

	Итератор = -1;
	Для Каждого Результат Из МассивРезультатов Цикл

		Итератор = Итератор + 1;
		Если Результат.Пустой() Тогда
			Продолжить;
		КонецЕсли;

		ИмяКонтроля = МассивКонтролей[Итератор];

		Если РегистрыДляКонтроля.Свойство(ИмяКонтроля) тогда
			 РегистрыНакопления[ИмяКонтроля].СообщитьОбошибке(Результат,Объект,Отказ);					
	
		КонецЕсли;
		
	КонецЦикла;

	Если Отказ Тогда

		Если Объект.ДополнительныеСвойства.РежимЗаписи = РежимЗаписиДокумента.Проведение Тогда
			ТекстСообщения = НСтр("ru = 'Проведение не выполнено %ПредставлениеОбъекта%'");
		Иначе
			ТекстСообщения = НСтр("ru = 'Отмена проведения не выполнена %ПредставлениеОбъекта%'");
		КонецЕсли;

		ТекстСообщения = СтрЗаменить(ТекстСообщения, "%ПредставлениеОбъекта%", Строка(Объект));
		
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения, Объект);

	КонецЕсли;

КонецПроцедуры


Процедура ДобавитьНаборЗаписейИзмененийвЗапрос(Запрос,ИмяРегистра,НаборЗаписей)
	
	ТекстЗапросаПоРегистру = "ВЫБРАТЬ  * 
	| ПОМЕСТИТЬ %1Изменение 
	|ИЗ
	|	РегистрНакопления.%1 КАК %1
	|ГДЕ
	|	%1.Регистратор = &ДокументСсылка
	| ;
	| " ;
	
	
	Запрос.Текст =Запрос.Текст + СтрШаблон(ТекстЗапросаПоРегистру,ИмяРегистра);				  
					  
КонецПроцедуры	

Функция ПереноситьНедостачиБракVMIНаСкладНедостач(ДатаДокумента) Экспорт
	
	ПереноситьНедостачиБракVMIНаСкладНедостач = Константы.ПереноситьНедостачиБракVMIНаСкладНедостач.Получить();
	
	Если ЗначениеЗаполнено(ПереноситьНедостачиБракVMIНаСкладНедостач)
			И ДатаДокумента >= ПереноситьНедостачиБракVMIНаСкладНедостач Тогда
		Возврат Истина;
	Иначе
		Возврат Ложь;
	КонецЕсли;	
	
КонецФункции

//Валиахметов http://jira.part-kom.ru/browse/XX-2529 03.06.201	
Функция ВозвратПоставщику_НовыеСтатусыВДокументе (ДатаДокумента) Экспорт 
	
	лКлючАлгоритма = "ОбщийМодуль_ПроведениеДокументовКлиентСервера_ВозвратПоставщику_НовыеСтатусыВДокументе";
	лЗамена =  АлгоритмыПолучитьЗамену(лКлючАлгоритма);
	Если Не лЗамена = Неопределено Тогда
		АлгоритмыЗначениеВозврата = Неопределено;		
		Выполнить(лЗамена);		
		Возврат АлгоритмыЗначениеВозврата;		
	КонецЕсли;	
	
	ДатаНачалаИспользованияСтатусовВВозвратеПоставщику = глЗначениеПеременной("ДатаНачалаИспользованияСтатусовВВозвратеПоставщику");
	
	Возврат ДатаДокумента >=  ДатаНачалаИспользованияСтатусовВВозвратеПоставщику И ЗначениеЗаполнено(ДатаНачалаИспользованияСтатусовВВозвратеПоставщику);
	
КонецФункции
//Конец Валиахметов http://jira.part-kom.ru/browse/XX-2529 03.06.201	
