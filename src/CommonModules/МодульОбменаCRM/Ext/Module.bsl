
Функция ПроверитьСуществованиеКаталога(ИмяКаталога) Экспорт
    КаталогНаДиске = Новый Файл(ИмяКаталога);
    Если КаталогНаДиске.Существует() Тогда
        Возврат Истина;
    Иначе
		Попытка
			СоздатьКаталог(ИмяКаталога);
		Исключение
		КонецПопытки;	
        Возврат Ложь;
    КонецЕсли;
КонецФункции

Процедура ОбменCRM() Экспорт
	// Вставить содержимое обработчика.
	Результат = Ложь;
	
	вхИдентификаторУзлаОбмена=2;
	лОтправитель = ОбменДаннымиКлиентСервер.ПолучитьИсходящийУзелОбмена(Метаданные.ПланыОбмена.ОбменПартКом83_CRM, вхИдентификаторУзлаОбмена);
	
	вхИдентификаторУзлаОбмена=2;
	лПолучатель = ОбменДаннымиКлиентСервер.ПолучитьВходящийУзелОбмена(Метаданные.ПланыОбмена.ОбменПартКом83_CRM, вхИдентификаторУзлаОбмена);
	лПолучатель=лПолучатель.ПолучитьОбъект();		
	
	ПутьЗагрузки = лОтправитель.Путь;
	ПутьВыгрузки = лПолучатель.Путь;
	
	ПравилаОбмена = лОтправитель.ПравилаОбмена.Получить();
	МаскаФайлаЗагрузки = "CRM-Partkom*.zip";
	
	МассивФайлов=НайтиФайлы(ПутьЗагрузки,МаскаФайлаЗагрузки);

	лИмяФайлаДанных = ПолучитьИмяВременногоФайла();
	лИмяФайлаПротоколаОбмена = ПолучитьИмяВременногоФайла();
	
	ПапкаАрхива=Формат(ТекущаяДата(),"ДФ=yyyy-MM-dd");
	ПроверитьСуществованиеКаталога(ПутьЗагрузки+"\Archive\"+ПапкаАрхива);
	Каталог=ПутьЗагрузки+"\Archive\"+ПапкаАрхива;
	ПроверитьСуществованиеКаталога(ПутьЗагрузки+"\temp");
	КоличествоФайлов=0;
	Для каждого ФайлВМассиве Из МассивФайлов Цикл
		
		ЧтениеZip			= Новый ЧтениеZipФайла(ФайлВМассиве.ПолноеИмя);
		ЧтениеZip.ИзвлечьВсе(ПутьЗагрузки+"\temp", РежимВосстановленияПутейФайловZIP.Восстанавливать);
		РФ = ПутьЗагрузки+"\temp\"+ФайлВМассиве.ИмяБезРасширения+".XML";
		
		лОбработкаОбъект = Обработки.УниверсальныйОбменДаннымиXML.Создать();
		лОбработкаОбъект.РежимОбмена = "Загрузка";
		лОбработкаОбъект.ИмяФайлаОбмена = РФ;
		лОбработкаОбъект.ИмяФайлаПротоколаОбмена = лИмяФайлаПротоколаОбмена;
		лОбработкаОбъект.ВыводВПротоколИнформационныхСообщений = Ложь;
		лОбработкаОбъект.ВыводВПротоколСообщенийОбОшибках = Истина;
		лОбработкаОбъект.ВыполнитьЗагрузку();
		
		выхИсходящиеДанные = Новый Структура;
		// протокол загрузки
		лТекст = Новый ТекстовыйДокумент;
		лТекст.Прочитать(лИмяФайлаПротоколаОбмена, "windows-1251");
		лТекстПротоколаОбмена = лТекст.ПолучитьТекст();
		лТекст = Неопределено;
		Результат = НЕ лОбработкаОбъект.ФлагОшибки;
		
		Отказ=Ложь;
		Если Не Отказ Тогда 
			УдалитьФайлы(лИмяФайлаПротоколаОбмена);
			УдалитьФайлы(лИмяФайлаДанных);
		КонецЕсли;	
		ЧтениеZip.Закрыть();
		Попытка
			лПолучатель.НомерПринятого=лОбработкаОбъект.Параметры.MessageNo;
			лПолучатель.Записать();
		Исключение
		КонецПопытки;	
		
		ОБМОчистка=ОбменДаннымиКлиентСервер.ПолучитьВходящийУзелОбмена(Метаданные.ПланыОбмена.ОбменПартКом83_CRM, 2);
		Попытка
			ПланыОбмена.УдалитьРегистрациюИзменений(ОБМОчистка.Ссылка, лОбработкаОбъект.Параметры.RecivedNo-1);
		Исключение
		КонецПопытки;	
		УдалитьФайлы(РФ);
		
		ДвоичныеДанныеИсточникФайл=Новый ДвоичныеДанные(ФайлВМассиве.ПолноеИмя);
		
		
		КоличествоФайлов=КоличествоФайлов+1;
		ПереместитьФайл(ФайлВМассиве.ПолноеИмя,ПутьЗагрузки+"\Archive\"+ПапкаАрхива+"\"+ФайлВМассиве.Имя);
		
	КонецЦикла;
	
	РезультатВыгрузки=ЗаписатьДанныеОбмена(ПравилаОбмена);	
КонецПроцедуры

Функция ЗаписатьДанныеОбмена(ПравилаОбмена)
	
	Результат = Ложь;
	ПланОбмена=ПланыОбмена.ОбменПартКом83_CRM.НайтиПоКоду("002");
	
	ИмяФайлаОбмена = ПланОбмена.Путь+"\"+"Partkom-CRM_"+(ПланОбмена.НомерОтправленного+1)+".XML";//ПолучитьИмяВременногоФайла(".XML");
	
	ИмяФайлаПравилОбмена = ПолучитьИмяВременногоФайла();
	лИмяФайлаПротоколаОбмена = ПолучитьИмяВременногоФайла();
	

	//Записываем правила из узла обмена в файл
	ЗаписьТекста = Новый ЗаписьТекста(ИмяФайлаПравилОбмена, "utf-8");
	ЗаписьТекста.Записать(ПравилаОбмена);
	ЗаписьТекста.Закрыть();		

	лОбработкаОбъект = Обработки.УниверсальныйОбменДаннымиXML.Создать();
	лОбработкаОбъект.РежимОбмена = "Выгрузка";
	лОбработкаОбъект.ИмяФайлаПравилОбмена = ИмяФайлаПравилОбмена;
	лОбработкаОбъект.ИмяФайлаОбмена = ИмяФайлаОбмена;//ПланОбмена.Путь+"\"+"Partkom-CRM_"+(ПланОбмена.НомерОтправленного+1)+".XML";
	лОбработкаОбъект.ИмяФайлаПротоколаОбмена = лИмяФайлаПротоколаОбмена;
	
	лЗаписьХМЛ = Новый ЗаписьXML;
	лЗаписьХМЛ.УстановитьСтроку("utf-8");
	лЗаписьСообщения = ПланыОбмена.СоздатьЗаписьСообщения();
	лЗаписьСообщения.НачатьЗапись(лЗаписьХМЛ, ПланОбмена);
	Попытка
		
		лОбработкаОбъект.ЗагрузитьПравилаОбмена();
		// параметры
		ДобавитьПараметрВТаблицуНастройкиПараметров(лОбработкаОбъект, "РазностнаяВыгрузка", Истина);
		ДобавитьПараметрВТаблицуНастройкиПараметров(лОбработкаОбъект, "ExchangeID",         ПланОбмена.ИдентификаторУзла);
		ДобавитьПараметрВТаблицуНастройкиПараметров(лОбработкаОбъект, "MessageNo",          лЗаписьСообщения.НомерСообщения);
		ДобавитьПараметрВТаблицуНастройкиПараметров(лОбработкаОбъект, "RecivedNo",          лЗаписьСообщения.НомерПринятого);
				
		лОбработкаОбъект.ВыполнитьВыгрузку();		
		лЗаписьСообщения.ЗакончитьЗапись();
		Результат = НЕ лОбработкаОбъект.ФлагОшибки;
	
		ЗаписьZIP = Новый ЗаписьZipФайла(Лев(ИмяФайлаОбмена,СтрДлина(ИмяФайлаОбмена)-3)+"zip");
		ЗаписьZIP.Добавить(ИмяФайлаОбмена, РежимСохраненияПутейZIP.НеСохранятьПути);
		ЗаписьZIP.Записать();
		
	Исключение
		Результат = Ложь;
		лЗаписьСообщения.ПрерватьЗапись();
		Док = Новый ЗаписьТекста(Лев(ИмяФайлаОбмена,СтрДлина(ИмяФайлаОбмена)-3)+"txt", КодировкаТекста.ANSI);//UTF8); 
		Попытка
			Док.ЗаписатьСтроку("Ошибка обмена "+ОписаниеОшибки());
			Док.Закрыть();
		Исключение
		КонецПопытки;
	КонецПопытки;	
	
	
	УдалитьФайлы(лИмяФайлаПротоколаОбмена);
	УдалитьФайлы(ИмяФайлаОбмена);
	УдалитьФайлы(ИмяФайлаПравилОбмена);
	
	Возврат Результат;
	
КонецФункции

Процедура ДобавитьПараметрВТаблицуНастройкиПараметров(мОбработкаОбъект, ИмяПараметра, ЗначениеПараметра)
	
	Если мОбработкаОбъект.ТаблицаНастройкиПараметров.Найти(ИмяПараметра, "Имя") = Неопределено Тогда
		НСтр = мОбработкаОбъект.ТаблицаНастройкиПараметров.Добавить();
		НСтр.Имя          = ИмяПараметра;
		НСтр.Наименование = ИмяПараметра;
		НСтр.Значение     = ЗначениеПараметра;    			
		
		НСтр.ПередаватьПараметрПриВыгрузке = Истина;
	КонецЕсли;
	
КонецПроцедуры
